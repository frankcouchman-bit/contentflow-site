<!doctype html>
<html lang="en" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>ContentRepurpose.pro — AI Content Repurposing Tool & Generator</title>
  <meta name="description" content="Content repurposing AI that turns one idea into LinkedIn, X, Email & Instagram drafts. Export to Notion & Trello. BYOK supported." />
  <link rel="canonical" href="https://contentrepurpose.pro/">
  <meta name="theme-color" content="#0a0d18">
  <meta name="color-scheme" content="dark light">
  <meta name="robots" content="index,follow,max-video-preview:-1,max-image-preview:large,max-snippet:-1">

  <!-- Open Graph -->
  <meta property="og:type" content="website">
  <meta property="og:title" content="ContentRepurpose.pro — AI Content Repurposing Tool">
  <meta property="og:description" content="Repurpose content with AI. Paste once → get LinkedIn, X, Email & Instagram drafts. Export to Notion & Trello. BYOK supported.">
  <meta property="og:url" content="https://contentrepurpose.pro/">
  <meta property="og:image" content="/og-cover.png">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="ContentRepurpose.pro — AI Content Generator">
  <meta name="twitter:description" content="Content repurposing AI for multi-channel drafts. Export to Notion & Trello. BYOK supported.">
  <meta name="twitter:image" content="/og-cover.png">

  <!-- Fonts + Tailwind -->
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Global CSS -->
  <style>
    :root{ --brandA:#7AA2FF; --brandB:#FF2D2D; --ink:#0a0d18 }
    html,body{font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .txt-grad{background:linear-gradient(135deg,var(--brandA),var(--brandB));-webkit-background-clip:text;background-clip:text;color:transparent}
    .bg-grad{background:linear-gradient(135deg,var(--brandA),var(--brandB))}
    .card{border-radius:1.25rem;border:1px solid rgba(15,23,42,.10);background:rgba(255,255,255,.80);box-shadow:0 12px 40px rgba(2,6,23,.08)}
    .badge{display:inline-flex;align-items:center;gap:.5rem;padding:.35rem .6rem;border-radius:9999px;border:1px solid rgba(255,255,255,.15);font-size:.75rem;background:rgba(255,255,255,.65)}
    .chip{font-size:.7rem;padding:.2rem .5rem;border-radius:9999px;border:1px solid rgba(148,163,184,.35)}
    .btn{padding:.6rem .9rem;border-radius:.9rem;border:1px solid rgba(148,163,184,.35)}
    .btn-primary{background:black;color:white}
    .glass{backdrop-filter: blur(12px); background:rgba(255,255,255,.62)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    .halo{position:absolute;filter:blur(60px);opacity:.55;pointer-events:none;transform:translateZ(0);
      background:radial-gradient(50% 50% at 50% 50%, rgba(122,162,255,.8), rgba(255,45,45,.65) 60%, transparent 70%);
      width:42rem;height:42rem;border-radius:50%;animation:float 16s ease-in-out infinite;}
    .halo.h2{width:34rem;height:34rem;right:-12rem;top:-6rem;animation-duration:18s;opacity:.5}
    .halo.h3{width:28rem;height:28rem;left:-10rem;top:26rem;animation-duration:22s;opacity:.45}
    @keyframes float{ 0%,100%{ transform: translate3d(0,0,0) } 50%{ transform: translate3d(0,-20px,0) } }
    .orbit{position:absolute;inset:-32px;border-radius:24px;pointer-events:none;
      background: conic-gradient(from 0deg, rgba(122,162,255,.25), rgba(255,45,45,.18), rgba(122,162,255,.25));
      -webkit-mask: radial-gradient(closest-side, transparent 88%, black 89%); mask: radial-gradient(closest-side, transparent 88%, black 89%);
      animation: spin 18s linear infinite;}
    @keyframes spin{ to{ transform: rotate(360deg) } }
    .mock{border-radius:1rem;border:1px solid rgba(255,255,255,.12); background:linear-gradient(180deg,rgba(255,255,255,.75),rgba(255,255,255,.6));}
    @media (prefers-color-scheme:dark){ body{background:var(--ink);color:#e9eef6} .card{background:rgba(14,16,22,.6);border-color:rgba(255,255,255,.08);box-shadow:0 24px 96px rgba(122,162,255,.08),0 14px 60px rgba(255,45,45,.06)} .badge{background:rgba(255,255,255,.06);border-color:rgba(255,255,255,.12)} .mock{ background:linear-gradient(180deg,rgba(17,20,31,.88),rgba(17,20,31,.72)); } }
    .marquee{ display:grid; grid-auto-flow:column; gap:2rem; align-items:center; animation: scrollx 26s linear infinite }
    .marquee:hover{ animation-play-state: paused } @keyframes scrollx{ from{ transform: translateX(0) } to{ transform: translateX(-50%) } }
    .nav-sheet{position:fixed; inset:0 0 auto 0; background:rgba(0,0,0,.6); backdrop-filter:blur(8px); display:none}
    .nav-panel{position:absolute; top:0; right:0; width:82vw; max-width:380px; height:100%; background:rgba(14,16,22,.96); border-left:1px solid rgba(255,255,255,.08); padding:1rem}
    .nav-open .nav-sheet{display:block}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
    .icon { width: 1rem; height: 1rem; display: inline-block; vertical-align: -0.15em; }
    /* Utilities for section gating */
    [data-gate="member"]{ display:none; }
    body[data-auth="member"] [data-gate="member"]{ display:block; }
    body[data-auth="member"] [data-gate="guest"]{ display:none; }
  </style>

  <!-- JSON-LD -->
  <script type="application/ld+json">{"@context":"https://schema.org","@type":"Organization","name":"ContentRepurpose.pro","url":"https://contentrepurpose.pro/","logo":"https://contentrepurpose.pro/logo.svg","sameAs":["https://x.com/contentrepurpose","https://www.linkedin.com/company/contentrepurpose"]}</script>
  <script type="application/ld+json">{"@context":"https://schema.org","@type":"WebSite","url":"https://contentrepurpose.pro/","name":"ContentRepurpose.pro","potentialAction":{"@type":"SearchAction","target":"https://contentrepurpose.pro/search?q={q}","query-input":"required name=q"}}</script>
  <script type="application/ld+json">{"@context":"https://schema.org","@type":"SoftwareApplication","name":"ContentRepurpose.pro","applicationCategory":"ContentCreationApplication","operatingSystem":"Web","offers":{"@type":"Offer","price":"0","priceCurrency":"USD"}}</script>

  <!-- IMPORTANT: Worker base -->
  <script>
    window.WORKER_BASE = "https://contentflow-worker.frank-couchman.workers.dev";
    window.SITE_ORIGIN = "https://contentrepurpose.pro";
  </script>

  <!-- === Supabase auth boot (Google OAuth + Magic Link) === -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // ---- Supabase init (from your values)
    const SUPABASE_URL  = "https://ynkoavaeadlzlwylmfmu.supabase.co";
    const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlua29hdmFlYWRsemx3eWxtZm11Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5OTAxNDgsImV4cCI6MjA3MzU2NjE0OH0.1yM5yDo0MI9Upzt4GkLyf1mqvDXfb3DXvC0ouOLtRoU";
    const { createClient } = window.supabase;
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON);

    // ---- Simple helpers (no name collisions to avoid call-stack issues)
    window.getAuthSession = async ()=> (await supabase.auth.getSession()).data.session || null;
    window.getAuth = async ()=>{
      const s = await window.getAuthSession();
      return { token: s?.access_token || "", userId: s?.user?.id || null, email: s?.user?.email || null };
    };
    window.authHeaders = async ()=>{
      const { token, userId } = await window.getAuth();
      const h = { "Content-Type":"application/json" };
      if (token)  h.Authorization = `Bearer ${token}`;
      if (userId) h["X-User-Id"] = userId;
      return h;
    };

    // ---- UI gating + badge refresh after auth changes
    async function refreshAfterAuth(){
      const body = document.body;
      const s = await window.getAuthSession();
      body?.setAttribute("data-auth", s ? "member" : "guest");

      // Update plan badge from backend (uses bearer)
      try{
        const r = await fetch(`${window.WORKER_BASE}/api/billing/status`, { headers: await window.authHeaders() });
        const j = await r.json();
        const plan = (j.plan || "free").toLowerCase();
        const b1 = document.getElementById("planbadge");
        const b2 = document.getElementById("planbadge_m");
        if (b1) b1.textContent = `Plan: ${plan.charAt(0).toUpperCase()+plan.slice(1)}`;
        if (b2) b2.textContent = `Plan: ${plan.charAt(0).toUpperCase()+plan.slice(1)}`;
        // Show manage billing for paid tiers
        ["manageBilling","manageBilling_m","manageBilling2"].forEach(id=>{
          const el = document.getElementById(id);
          if (!el) return;
          if (plan !== "free") el.classList.remove("hidden");
          else el.classList.add("hidden");
        });
      }catch{}
      // If newly signed-in, route to dashboard section
      if (s) location.hash = "member";
    }

    supabase.auth.onAuthStateChange((_event, _session)=>{ refreshAfterAuth(); });

    // ---- Public sign-in/out helpers
    window.openAuthDialog = function openAuthDialog(){
      const dlg = document.getElementById("auth");
      if (dlg && typeof dlg.showModal === "function") dlg.showModal();
    };

    window.signInWithGoogle = async function signInWithGoogle(){
      try{
        const { error } = await supabase.auth.signInWithOAuth({
          provider: "google",
          options: {
            redirectTo: location.origin + "/auth/callback",
            queryParams: { access_type: "offline", prompt: "select_account" }
          }
        });
        if (error) throw error;
      }catch(e){ alert(e.message || "Google sign-in failed"); }
    };

    window.sendMagicLink = async function sendMagicLink(email, btn){
      if (!email){ alert("Enter your email"); return; }
      if (btn){ btn.disabled = true; const old=btn.textContent; btn.textContent="Sending…"; btn.dataset._old=old; }
      try{
        const { error } = await supabase.auth.signInWithOtp({
          email,
          options: { emailRedirectTo: location.origin + "/auth/callback" }
        });
        if (error) throw error;
        const note = document.getElementById("authNote");
        if (note) note.textContent = "Magic link sent. Check your inbox.";
      }catch(e){
        alert(e.message || "Could not send magic link");
      }finally{
        if (btn){ btn.disabled=false; btn.textContent = btn.dataset._old || "Send magic link"; }
      }
    };

    window.signOutAll = async function signOutAll(){
      try{ await supabase.auth.signOut(); }catch{}
    };

    // ---- Expose a unified launcher used elsewhere
    window.doSignIn = function doSignIn(provider){
      if (provider === "google") return window.signInWithGoogle();
      return window.openAuthDialog();
    };

    // ---- Auth dialog wiring (once DOM is ready)
    document.addEventListener("DOMContentLoaded", ()=>{
      const sendBtn = document.getElementById("authSend");
      const emailEl = document.getElementById("authEmail");
      const gbtn    = document.getElementById("googleBtn");
      sendBtn?.addEventListener("click", ()=> window.sendMagicLink((emailEl?.value||"").trim(), sendBtn), { once:false });
      gbtn?.addEventListener("click", ()=> window.signInWithGoogle(), { once:false });

      // Login/Logout buttons
      ["loginBtn","loginBtn_m","heroSignIn","heroSignIn_pr"].forEach(id=>{
        const el = document.getElementById(id);
        el?.addEventListener("click", ()=> window.doSignIn());
      });
      const logoutBtns = ["logoutBtn","logoutBtn_m"];
      logoutBtns.forEach(id=>{
        const el = document.getElementById(id);
        el?.classList.remove("hidden");
        el?.addEventListener("click", ()=> window.signOutAll());
      });

      refreshAfterAuth(); // initial paint
    });
  </script>
</head>
<body class="min-h-full" data-auth="guest">
  <!-- Decorative halos -->
  <div class="halo" style="left:-14rem; top:-10rem;"></div>
  <div class="halo h2"></div>
  <div class="halo h3"></div>

  <!-- ===== HEADER ===== -->
  <header class="sticky top-0 z-40 backdrop-blur bg-white/55 dark:bg-black/20 border-b border-white/30">
    <div class="max-w-7xl mx-auto px-4 md:px-5 py-4 flex items-center justify-between">
      <a href="/" class="flex items-center gap-3" aria-label="ContentRepurpose home">
        <svg width="36" height="36" viewBox="0 0 48 48" class="rounded-xl" aria-hidden="true">
          <defs><linearGradient id="g" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#7AA2FF"/><stop offset="100%" stop-color="#FF2D2D"/></linearGradient></defs>
          <rect x="0" y="0" width="48" height="48" rx="12" fill="url(#g)"/>
          <path d="M14 16h10a6 6 0 0 1 0 12H20v4h-6V16zm6 6v4h4a2 2 0 1 0 0-4h-4z" fill="white"/>
          <path d="M28 16h6v16h-6z" fill="white" opacity=".9"/>
        </svg>
        <span class="font-semibold tracking-tight">Content<span class="txt-grad">Repurpose</span></span>
      </a>

      <nav class="hidden md:flex items-center gap-6 text-sm">
        <a href="#demo" class="hover:opacity-80" data-nav="demo">Live Demo</a>
        <a href="#templates" class="hover:opacity-80">Templates</a>
        <a href="#use-cases" class="hover:opacity-80">Use cases</a>
        <a href="#best-picks" class="hover:opacity-80">Best picks</a>
        <a href="#pricing" class="hover:opacity-80" data-nav="pricing">Pricing</a>
        <a href="/blog" class="hover:opacity-80">Blog</a>

        <span id="planbadge" class="px-3 py-1 rounded-full text-xs bg-white/70 dark:bg-white/10 border border-white/50">Plan: Free</span>
        <button id="manageBilling" class="px-3 py-1 rounded-lg border hidden" data-portal="stripe">Manage billing</button>

        <div class="flex items-center gap-2">
          <button id="loginBtn" class="px-3 py-1 rounded-lg border">Sign in</button>
          <button id="logoutBtn" class="px-3 py-1 rounded-lg border hidden">Sign out</button>
        </div>
      </nav>

      <button id="navToggle" class="md:hidden touch-target px-3 py-2 rounded-lg border" aria-expanded="false" aria-controls="mobileNav" aria-label="Open menu">☰</button>
    </div>

    <!-- Promo strip -->
    <div class="border-top border-white/40 bg-white/70 dark:bg-white/10">
      <div class="max-w-7xl mx-auto px-4 md:px-5 py-2 flex flex-wrap items-center justify-between gap-3 text-sm">
        <div class="flex items-center gap-2">
          <span class="px-2 py-0.5 rounded-full text-[11px] bg-black/80 text-white">LIMITED</span>
          <span>Use <strong class="mono">CONTENTOFF90</strong> for <strong>90% off</strong> the Creator plan.</span>
        </div>
        <div class="flex items-center gap-2">
          <button id="copyPromoBtn" class="px-3 py-1 rounded-lg border">Copy code</button>
          <a href="#pricing" class="px-3 py-1 rounded-lg bg-black text-white" data-nav="pricing">See pricing</a>
        </div>
      </div>
    </div>

    <!-- Mobile sheet -->
    <div id="mobileNav" class="nav-sheet" aria-hidden="true">
      <div class="nav-panel text-sm text-white">
        <div class="flex items-center justify-between">
          <span class="font-semibold">Menu</span>
          <button id="navClose" class="touch-target px-3 py-2 rounded-lg border border-white/20" aria-label="Close menu">✕</button>
        </div>
        <nav class="mt-4 grid gap-2">
          <a href="#demo" class="px-3 py-2 rounded-lg hover:bg-white/10" data-nav="demo_m">Live Demo</a>
          <a href="#templates" class="px-3 py-2 rounded-lg hover:bg-white/10">Templates</a>
          <a href="#use-cases" class="px-3 py-2 rounded-lg hover:bg-white/10">Use cases</a>
          <a href="#best-picks" class="px-3 py-2 rounded-lg hover:bg-white/10">Best picks</a>
          <a href="#pricing" class="px-3 py-2 rounded-lg hover:bg-white/10" data-nav="pricing_m">Pricing</a>
          <a href="/blog" class="px-3 py-2 rounded-lg hover:bg-white/10">Blog</a>
        </nav>
        <div class="mt-6 grid gap-2">
          <span id="planbadge_m" class="px-3 py-1 rounded-full text-xs bg-white/10 border border-white/20 w-fit">Plan: Free</span>
          <button id="manageBilling_m" class="px-3 py-2 rounded-lg border border-white/20 hidden" data-portal="stripe">Manage billing</button>
          <button id="loginBtn_m" class="px-3 py-2 rounded-lg border border-white/20">Sign in</button>
          <button id="logoutBtn_m" class="px-3 py-2 rounded-lg border border-white/20 hidden">Sign out</button>
        </div>
      </div>
    </div>
  </header>

  <!-- ===== HERO ===== -->
  <section id="hero" class="relative">
    <div class="max-w-7xl mx-auto px-4 md:px-5 pt-10 md:pt-16 grid lg:grid-cols-2 gap-8 md:gap-10 items-center">
      <!-- Left copy + CTAs (guest gate shows for all; member will be routed to #member) -->
      <div data-gate="guest">
        <div id="heroBadgeWrap" class="inline-flex items-center gap-2 px-3 py-1 rounded-full text-xs bg-white/70 dark:bg-white/10 border border-white/40">
          <span class="w-2 h-2 rounded-full bg-emerald-500"></span>
          <span id="heroBadge">Demo — <strong class="mx-1">5 runs / month</strong> (no login)</span>
        </div>

        <h1 class="mt-4 text-3xl md:text-5xl font-black leading-tight tracking-tight">
          AI <span class="txt-grad">Content Repurposing Tool</span> — turn one idea into everywhere content.
        </h1>

        <p class="mt-4 text-slate-600 dark:text-slate-300 max-w-xl">
          Paste content → get <strong>LinkedIn</strong>, <strong>X</strong>, <strong>Email</strong> &amp; <strong>Instagram</strong> drafts.
          Export to <strong>Notion</strong> or <strong>Trello</strong>. BYOK supported.
        </p>

        <div class="mt-6 flex flex-wrap gap-3">
          <a href="#demo" class="px-4 py-3 rounded-xl font-semibold text-white bg-black hover:opacity-90" data-action="scroll-demo" id="ctaTryDemo">
            Try the Live Demo
          </a>
          <a href="#pricing" class="px-4 py-3 rounded-xl font-semibold border border-slate-300/60 hover:bg-white/50" data-nav="pricing">
            See pricing
          </a>
          <button id="heroSignIn" class="px-4 py-3 rounded-xl font-semibold border border-slate-300/60" data-action="open-auth">
            Sign in
          </button>
        </div>

        <div class="mt-6 flex items-center gap-3 text-xs text-slate-500 dark:text-slate-400">
          <span class="badge">AI Content Generator</span>
          <span class="badge">Repurposing Tool</span>
          <span class="badge">SEO-ready</span>
          <span class="badge">BYOK</span>
        </div>

        <!-- Trust strip -->
        <div class="mt-8 overflow-hidden">
          <div class="flex items-center gap-4 text-[11px] uppercase tracking-widest text-slate-500">
            <span class="chip">Creators</span>
            <span class="chip">Marketers</span>
            <span class="chip">Newsletters</span>
            <span class="chip">Teams</span>
          </div>
          <div class="relative mt-4">
            <div class="marquee opacity-70">
              <div class="chip">LinkedIn-first</div>
              <div class="chip">Editorial-friendly</div>
              <div class="chip">Email copy</div>
              <div class="chip">Instagram captions</div>
              <div class="chip">Notion export</div>
              <div class="chip">Trello sync</div>
              <div class="chip">Keyword-aware</div>
              <div class="chip">Tone controls</div>
              <!-- duplicate for seamless scroll -->
              <div class="chip">LinkedIn-first</div>
              <div class="chip">Editorial-friendly</div>
              <div class="chip">Email copy</div>
              <div class="chip">Instagram captions</div>
              <div class="chip">Notion export</div>
              <div class="chip">Trello sync</div>
              <div class="chip">Keyword-aware</div>
              <div class="chip">Tone controls</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Right: visual mocks -->
      <div class="relative">
        <div class="orbit" aria-hidden="true"></div>
        <div class="grid gap-4">
          <div class="mock p-4 card">
            <div class="text-xs text-slate-400">Command</div>
            <pre class="mono text-xs bg-black/85 text-emerald-200 rounded-xl p-4 h-40 overflow-auto" aria-label="CLI Preview">repurpose generate --channels linkedin,x,email,instagram
? outline created
? 3 social variants
? email subject + body ready
? instagram caption + hashtags</pre>
          </div>
          <div class="grid md:grid-cols-2 gap-4">
            <div class="mock p-4 card">
              <div class="text-xs text-slate-400">LinkedIn</div>
              <div class="mt-2 h-24 text-sm text-slate-200/90 leading-relaxed">
                • Hook that earns the scroll<br>
                • 6–10 crisp lines, one CTA<br>
                • On-brand tone &amp; keywords
              </div>
            </div>
            <div class="mock p-4 card">
              <div class="text-xs text-slate-400">X (Twitter)</div>
              <div class="mt-2 h-24 text-sm text-slate-200/90 leading-relaxed">
                Two fast variants<br>
                Always ≤ 280 chars<br>
                Ready to post ✓
              </div>
            </div>
          </div>
          <div class="grid md:grid-cols-2 gap-4">
            <div class="mock p-4 card">
              <div class="text-xs text-slate-400">Email</div>
              <div class="mt-2 h-20 text-sm text-slate-200/90 leading-relaxed">
                Subject &amp; body prepped<br>
                Preview &amp; send from your client
              </div>
            </div>
            <div class="mock p-4 card">
              <div class="text-xs text-slate-400">Instagram</div>
              <div class="mt-2 h-20 text-sm text-slate-200/90 leading-relaxed">
                Caption + 3–5 hashtags<br>
                Short, skimmable, on-brand
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Live activity strip -->
    <div class="mt-8 md:mt-10">
      <div class="max-w-7xl mx-auto px-4 md:px-5">
        <div class="card p-4 md:p-5">
          <div class="flex items-center justify-between flex-wrap gap-3">
            <div class="flex items-center gap-2">
              <span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span>
              <strong class="tracking-tight">Generations today</strong>
              <span id="liveCount" class="chip">–</span>
            </div>
            <div class="text-xs text-slate-500">Real results update every 30s</div>
          </div>
          <div class="mt-3 overflow-hidden">
            <div id="liveFeed" class="flex gap-3 whitespace-nowrap text-[13px] will-change-transform" style="animation: scrollx 28s linear infinite"></div>
          </div>
        </div>
      </div>
    </div>
  </section>
  <!-- ===== LIVE DEMO ===== -->
  <section id="demo" class="relative scroll-mt-24" data-gate="guest">
    <div class="max-w-7xl mx-auto px-4 md:px-5 py-14 md:py-20">
      <div class="flex items-end justify-between gap-4 mb-6">
        <div>
          <h2 class="text-2xl md:text-3xl font-black tracking-tight">Live Demo</h2>
          <p class="mt-1 text-slate-500 dark:text-slate-300 text-sm">
            No login needed — <span class="font-semibold">5 runs/month</span> on the public pool.
          </p>
        </div>
        <div class="flex items-center gap-3">
          <a href="#pricing" class="btn">See pricing</a>
          <button id="heroSignIn_pr" class="btn btn-primary">Sign in</button>
        </div>
      </div>

      <!-- Demo CTA rail (upsell + sign-in) -->
      <div class="card p-4 md:p-5 mb-6">
        <div class="flex flex-wrap items-center justify-between gap-3">
          <div class="flex items-center gap-2 text-sm">
            <span class="badge">LIMITED</span>
            <span>Use <strong class="mono">CONTENTOFF90</strong> for <strong>90% off</strong> the Creator plan.</span>
          </div>
          <div class="flex items-center gap-2">
            <button id="copyPromoBtn2" class="btn">Copy code</button>
            <a class="btn btn-primary" href="#pricing">Upgrade</a>
          </div>
        </div>
      </div>

      <!-- Demo Form -->
      <div class="card p-5 md:p-6">
        <form id="demoForm" class="grid gap-6" autocomplete="off">
          <!-- Source selector -->
          <fieldset>
            <legend class="text-sm font-semibold">Source</legend>
            <div class="mt-2 grid md:grid-cols-3 gap-3">
              <label class="tab flex items-center justify-between">
                <span class="flex items-center gap-2">
                  <input type="radio" name="sourceType" value="paragraph" checked>
                  Paragraph / Notes
                </span>
                <span class="chip">fastest</span>
              </label>
              <label class="tab flex items-center">
                <input type="radio" name="sourceType" value="blog" class="mr-2">
                Full Blog
              </label>
              <label class="tab flex items-center">
                <input type="radio" name="sourceType" value="url" class="mr-2">
                URL
              </label>
            </div>
            <div class="mt-3">
              <textarea id="sourceText" class="w-full rounded-xl border p-4 min-h-[140px]"
                placeholder="Paste your paragraph or blog. If you selected URL, paste it here."></textarea>
            </div>
          </fieldset>

          <!-- Optimizer options -->
          <fieldset>
            <legend class="text-sm font-semibold">Article Optimizer (optional)</legend>
            <div class="mt-2 grid sm:grid-cols-2 lg:grid-cols-3 gap-2">
              <label class="flex items-center gap-2"><input type="checkbox" name="opt_humanize" checked> Humanize content</label>
              <label class="flex items-center gap-2"><input type="checkbox" name="opt_lengthen"> Lengthen content</label>
              <label class="flex items-center gap-2"><input type="checkbox" name="opt_faqs"> Add FAQs (+ JSON-LD)</label>
              <label class="flex items-center gap-2"><input type="checkbox" name="opt_headings" checked> Auto-headings (H2/H3)</label>
              <label class="flex items-center gap-2"><input type="checkbox" name="opt_svg"> Add platform-fit SVG image ideas</label>
              <label class="flex items-center gap-2"><input type="checkbox" name="opt_seo"> Check SEO basics (title/meta/alt-text)</label>
            </div>
          </fieldset>

          <!-- Channels -->
          <fieldset>
            <legend class="text-sm font-semibold">Channels to generate</legend>
            <div class="mt-2 grid sm:grid-cols-2 lg:grid-cols-4 gap-2">
              <label class="flex items-center gap-2"><input type="checkbox" name="ch_linkedin" checked> LinkedIn</label>
              <label class="flex items-center gap-2"><input type="checkbox" name="ch_x" checked> X (Twitter)</label>
              <label class="flex items-center gap-2"><input type="checkbox" name="ch_email" checked> Email</label>
              <label class="flex items-center gap-2"><input type="checkbox" name="ch_instagram"> Instagram</label>
              <label class="flex items-center gap-2"><input type="checkbox" name="ch_reddit" checked> Reddit</label>
              <label class="flex items-center gap-2"><input type="checkbox" name="ch_facebook"> Facebook</label>
              <label class="flex items-center gap-2"><input type="checkbox" name="ch_quora"> Quora</label>
              <label class="flex items-center gap-2"><input type="checkbox" name="ch_tiktok"> TikTok</label>
            </div>
          </fieldset>

          <!-- Channel-specific extras -->
          <div class="grid md:grid-cols-2 gap-6">
            <fieldset class="card p-4">
              <legend class="text-sm font-semibold">LinkedIn</legend>
              <label class="flex items-center gap-2 mt-2"><input type="checkbox" name="li_article"> Also generate a LinkedIn Article</label>
            </fieldset>

            <fieldset class="card p-4">
              <legend class="text-sm font-semibold">X (Twitter)</legend>
              <div class="mt-2 flex items-center gap-3">
                <label class="flex items-center gap-2"><input type="checkbox" name="x_sequence" checked> Output as sequence</label>
                <label class="flex items-center gap-2">
                  Max posts:
                  <select name="x_posts" class="border rounded-lg px-2 py-1">
                    <option>2</option><option selected>4</option><option>6</option>
                  </select>
                </label>
              </div>
            </fieldset>

            <fieldset class="card p-4">
              <legend class="text-sm font-semibold">Reddit</legend>
              <label class="flex items-center gap-2 mt-2"><input type="checkbox" name="rdt_communities" checked> Suggest best communities (with rules & flair tips)</label>
              <label class="flex items-center gap-2 mt-2"><input type="checkbox" name="rdt_comments" checked> Include 3 starter comment angles</label>
            </fieldset>

            <fieldset class="card p-4">
              <legend class="text-sm font-semibold">TikTok</legend>
              <label class="flex items-center gap-2 mt-2"><input type="checkbox" name="tt_hooks" checked> Provide 3 hook variants</label>
              <label class="flex items-center gap-2 mt-2"><input type="checkbox" name="tt_onscreen" checked> Include on-screen text plan</label>
            </fieldset>
          </div>

          <!-- Actions -->
          <div class="flex flex-wrap items-center gap-3">
            <button id="generateBtn" type="submit" class="px-4 py-3 rounded-xl font-semibold text-white bg-black hover:opacity-90">
              Generate
            </button>
            <button type="button" id="clearBtn" class="px-4 py-3 rounded-xl font-semibold border">Clear</button>
            <div class="text-sm text-slate-500">You have <span id="demoQuota">—</span> demo runs left.</div>
            <a href="#pricing" class="text-sm underline hover:opacity-80 ml-auto">Need more? See plans</a>
          </div>
        </form>
      </div>

      <!-- OUTPUT -->
      <div id="demoOutput" class="mt-8 grid gap-6" aria-live="polite" aria-busy="false"></div>

      <!-- Live strip -->
      <div class="mt-8 md:mt-10">
        <div class="card p-4 md:p-5">
          <div class="flex items-center justify-between flex-wrap gap-3">
            <div class="flex items-center gap-2">
              <span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span>
              <strong class="tracking-tight">Generations today</strong>
              <span id="liveCount" class="chip">–</span>
            </div>
            <div class="text-xs text-slate-500">Real results update every 30s</div>
          </div>
          <div class="mt-3 overflow-hidden">
            <div id="liveFeed" class="flex gap-3 whitespace-nowrap text-[13px] will-change-transform" style="animation: scrollx 28s linear infinite"></div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- ===== DEMO SCRIPTS (namespaced to avoid collisions) ===== -->
  <script>
  (function CRPDemo(){
    const W = window, D = document;
    const WORKER_BASE = W.WORKER_BASE || "https://contentflow-worker.frank-couchman.workers.dev";

    // Tiny helpers (scoped; do not leak globals)
    const qs  = (sel, el=D)=> el.querySelector(sel);
    const qsa = (sel, el=D)=> Array.from(el.querySelectorAll(sel));
    const byId= (id)=> D.getElementById(id);
    const toast = (msg)=> {
      const t = byId("toast"), m = byId("toastMsg");
      if (!t || !m) return console.log("[toast]", msg);
      m.textContent = msg; t.classList.remove("hidden");
      setTimeout(()=> t.classList.add("hidden"), 1800);
    };

    // Live stats ticker (light)
    (async function liveStats(){
      const countEl = byId("liveCount");
      const feedEl  = byId("liveFeed");
      if (!countEl || !feedEl) return;
      async function tick(){
        try{
          const r = await fetch(`${WORKER_BASE}/api/stats/today`);
          const j = await r.json();
          if (r.ok && typeof j.today_count === "number"){
            countEl.textContent = String(j.today_count);
          }
          if (Array.isArray(j.recent) && j.recent.length){
            feedEl.innerHTML = j.recent.map(x=> `<span class="chip">${x}</span>`).join("");
          }
        }catch{}
      }
      tick(); setInterval(tick, 30000);
    })();

    // Quota paint (guest/demo)
    (async function paintQuota(){
      const quotaEl = byId("demoQuota");
      if (!quotaEl) return;
      try{
        const r = await fetch(`${WORKER_BASE}/api/billing/status`, { headers: await (W.authHeaders?.() || {"Content-Type":"application/json"}) });
        const j = await r.json();
        if (r.ok){
          if (j.scope==="ip"){ // no session (demo quota by IP/month)
            const cap = j.platform?.monthly?.cap ?? 5;
            const used = j.platform?.monthly?.used ?? 0;
            quotaEl.textContent = Math.max(0, cap - used);
          }else{
            const capD = j.platform?.daily?.cap ?? 5;
            const usedD = j.platform?.daily?.used ?? 0;
            quotaEl.textContent = (capD==null) ? "∞" : Math.max(0, capD - usedD);
          }
        }
      }catch{}
    })();

    // Demo form wiring
    (function wireDemo(){
      const form = byId("demoForm");
      const src  = byId("sourceText");
      const out  = byId("demoOutput");
      const gen  = byId("generateBtn");
      const clr  = byId("clearBtn");
      if (!form || !src || !out) return;

      clr?.addEventListener("click", ()=>{
        src.value = "";
        out.innerHTML = "";
      });

      // Safe JSON extractor — prevents stack overflow with tight regex recursion
      function safeJSON(maybe){
        if (!maybe) return null;
        // Try direct parse first
        try{ return JSON.parse(maybe); }catch{}
        // Attempt to locate last JSON object/array block
        const start = maybe.indexOf("{");
        const astart= maybe.indexOf("[");
        const s = (start === -1) ? astart : (astart === -1 ? start : Math.min(start, astart));
        if (s === -1) return null;
        const tail = maybe.slice(s);
        // Trim to last closing brace/bracket
        const e1 = tail.lastIndexOf("}");
        const e2 = tail.lastIndexOf("]");
        const e  = Math.max(e1, e2);
        if (e === -1) return null;
        const slice = tail.slice(0, e+1);
        try{ return JSON.parse(slice); }catch{ return null; }
      }

      function readToggles(){
        const g = (n)=> form.elements[n];
        return {
          opt: {
            humanize:  !!g("opt_humanize")?.checked,
            lengthen:  !!g("opt_lengthen")?.checked,
            faqs:      !!g("opt_faqs")?.checked,
            headings:  !!g("opt_headings")?.checked,
            svg:       !!g("opt_svg")?.checked,
            seo:       !!g("opt_seo")?.checked,
          },
          ch: {
            linkedin:  !!g("ch_linkedin")?.checked,
            x:         !!g("ch_x")?.checked,
            email:     !!g("ch_email")?.checked,
            instagram: !!g("ch_instagram")?.checked,
            reddit:    !!g("ch_reddit")?.checked,
            facebook:  !!g("ch_facebook")?.checked,
            quora:     !!g("ch_quora")?.checked,
            tiktok:    !!g("ch_tiktok")?.checked,
          },
          extras: {
            li_article:       !!g("li_article")?.checked,
            x_sequence:       !!g("x_sequence")?.checked,
            x_posts:          g("x_posts")?.value || "4",
            rdt_communities:  !!g("rdt_communities")?.checked,
            rdt_comments:     !!g("rdt_comments")?.checked,
            tt_hooks:         !!g("tt_hooks")?.checked,
            tt_onscreen:      !!g("tt_onscreen")?.checked,
          }
        };
      }

      function buildMessages(raw, tog, srcType){
        const channels = Object.entries(tog.ch).filter(([,v])=>v).map(([k])=>k).join(", ");
        const sys = {
          role:"system",
          content:
`You are a senior social copywriter.
Return ONLY valid JSON with this shape:
{
  "outline": string,
  "linkedin": string|null,
  "x": string[]|null,
  "email": { "subject": string, "body": string }|null,
  "instagram": { "caption": string, "hashtags": string[] }|null,
  "reddit": { "title": string, "body": string, "communities": string[], "starter_comments": string[] }|null,
  "facebook": { "primary": string, "meta": { "headline": string, "description": string } }|null,
  "quora": { "answer": string, "followups": string[] }|null,
  "tiktok": { "hooks": string[], "script": string, "onscreen": string[] }|null,
  "linkedin_article_html": string|null
}
Respect these toggles: 
- Humanize: ${tog.opt.humanize ? "on" : "off"}
- Lengthen: ${tog.opt.lengthen ? "on" : "off"}
- Add FAQs: ${tog.opt.faqs ? "on" : "off"}
- Auto-headings: ${tog.opt.headings ? "on" : "off"}
- SVG ideas: ${tog.opt.svg ? "on" : "off"}
- SEO basics: ${tog.opt.seo ? "on" : "off"}
- X posts max: ${tog.extras.x_posts}
- X sequence format: ${tog.extras.x_sequence ? "on (Post 1…N)" : "off"}
- LinkedIn Article: ${tog.extras.li_article ? "on" : "off"}
- Reddit communities: ${tog.extras.rdt_communities ? "include" : "skip"}
- Reddit starter comments: ${tog.extras.rdt_comments ? "include" : "skip"}
- TikTok hooks: ${tog.extras.tt_hooks ? "3 variants" : "1 variant"}
- TikTok on-screen text: ${tog.extras.tt_onscreen ? "include" : "skip"}

Rules:
- Keep posts concise and native.
- X posts ≤ 280 chars when possible; prefix "Post N:" in sequences.
- Provide 3–5 meaningful hashtags for Instagram.
- If a channel wasn't requested, set it to null.
- NO prose outside the JSON.`
        };
        const head = srcType==="url" ? "URL" : (srcType==="blog" ? "Full Blog" : "Paragraph/Notes");
        const usr = {
          role:"user",
          content:
`${head}:
${raw}

Task:
1) Create a one-line outline.
2) Generate content ONLY for these channels: ${channels || "linkedin,x,email"}.
3) Apply the toggles and extras exactly.`
        };
        return [sys, usr];
      }

      function renderOutput(j){
        out.innerHTML = ""; // clear
        const blocks = [];

        // helper to add copyable card
        const addCard = (title, content, extraNote="")=>{
          const id = "copy_"+Math.random().toString(36).slice(2);
          blocks.push(`
            <div class="card p-5">
              <div class="flex justify-between items-center gap-2 flex-wrap">
                <strong class="tracking-tight">${title}</strong>
                <button class="btn" data-copy="#${id}">Copy</button>
              </div>
              <pre id="${id}" class="whitespace-pre-wrap text-sm mt-3">${content}</pre>
              ${extraNote ? `<div class="text-xs text-slate-500 mt-2">${extraNote}</div>` : ""}
            </div>`);
        };

        if (j.linkedin) addCard("LinkedIn", j.linkedin);
        if (Array.isArray(j.x) && j.x.length){
          const seq = j.x.map((t,i)=>`Post ${i+1}: ${t}`).join("\n\n");
          addCard("X (Twitter)", seq, 'Sequence format: “Post 1 … Post N”.');
        }
        if (j.email && (j.email.subject || j.email.body)){
          addCard("Email", `Subject:\n${j.email.subject||""}\n\nBody:\n${j.email.body||""}`);
        }
        if (j.instagram){
          const cap = j.instagram.caption||"";
          const tags = (j.instagram.hashtags||[]).map(h=> h.startsWith("#")?h:"#"+h).join(" ");
          addCard("Instagram", `${cap}\n\n${tags}`);
        }
        if (j.reddit){
          const subs = (j.reddit.communities||[]).map(s=>`r/${s}`).join(", ");
          const starters = (j.reddit.starter_comments||[]).map((c)=>`• ${c}`).join("\n");
          addCard("Reddit",
            `**${j.reddit.title||""}**\n\n${j.reddit.body||""}\n\nSuggested communities:\n${subs||"—"}\n\nStarter comments:\n${starters||"—"}`);
        }
        if (j.facebook){
          addCard("Facebook", `Primary:\n${j.facebook.primary||""}\n\nHeadline/Description:\n${j.facebook.meta?.headline||""}\n${j.facebook.meta?.description||""}`);
        }
        if (j.quora){
          const follow = (j.quora.followups||[]).map(f=>`• ${f}`).join("\n");
          addCard("Quora", `Answer:\n${j.quora.answer||""}\n\nFollow-ups:\n${follow||"—"}`);
        }
        if (j.tiktok){
          const hooks = (j.tiktok.hooks||[]).map(h=>`• ${h}`).join("\n");
          const ons   = (j.tiktok.onscreen||[]).map(o=>`• ${o}`).join("\n");
          addCard("TikTok", `Script:\n${j.tiktok.script||""}\n\nHooks:\n${hooks||"—"}\n\nOn-screen:\n${ons||"—"}`);
        }
        if (j.linkedin_article_html){
          blocks.push(`<div class="card p-5"><strong class="tracking-tight">LinkedIn Article</strong><div class="prose prose-invert mt-3">${j.linkedin_article_html}</div></div>`);
        }

        if (!blocks.length){
          out.innerHTML = `<div class="card p-5 text-sm text-slate-500">No channels were generated. Check your selections and try again.</div>`;
        }else{
          out.innerHTML = blocks.join("");
          // Copy buttons
          qsa("[data-copy]").forEach(btn=>{
            btn.addEventListener("click", async ()=>{
              try{
                const target = qs(btn.getAttribute("data-copy"));
                await navigator.clipboard.writeText(target?.innerText || "");
                toast("Copied ✅");
              }catch{ toast("Copy failed"); }
            });
          });
        }
      }

      form.addEventListener("submit", async (e)=>{
        e.preventDefault();
        const raw = (src.value||"").trim();
        if (!raw){ toast("Paste some content first"); return; }

        const srcType = form.elements["sourceType"]?.value || "paragraph";
        const tog = readToggles();

        try{
          gen.disabled = true; gen.textContent = "Generating…";
          out.innerHTML = `<div class="card p-5 text-sm text-slate-500">Working…</div>`;

          const messages = buildMessages(raw, tog, srcType);
          const headers  = await (window.authHeaders?.() || { "Content-Type":"application/json" });

          const r = await fetch(`${WORKER_BASE}/api/generate`,{
            method:"POST",
            headers,
            body: JSON.stringify({ plan: "free", temperature: 0.5, messages })
          });

          // Handle non-JSON or network issues gracefully
          let data = null;
          try{ data = await r.json(); }catch{ throw new Error("Bad response from server"); }
          if (!r.ok) throw new Error(data?.error?.message || "Generation failed");

          const content = data?.choices?.[0]?.message?.content || "";
          const j = safeJSON(content);
          if (!j) throw new Error("Model did not return JSON");

          renderOutput(j);
          toast("Done ✅");
        }catch(e){
          out.innerHTML = `<div class="card p-5 text-sm text-red-500">Error: ${e.message || e}</div>`;
        }finally{
          gen.disabled = false; gen.textContent = "Generate";
        }
      });
    })();
  </script>
  <!-- ===== PRICING ===== -->
  <section id="pricing" class="relative scroll-mt-24" data-gate="guest">
    <div class="max-w-7xl mx-auto px-4 md:px-5 py-14 md:py-20">
      <div class="text-center mb-10">
        <h2 class="text-3xl md:text-4xl font-black tracking-tight">Simple, honest pricing</h2>
        <p class="mt-2 text-slate-600 dark:text-slate-300">Start free. Add power when you need it.</p>
      </div>

      <!-- Conversion rail -->
      <div class="card p-4 md:p-5 mb-6 flex flex-wrap items-center justify-between gap-3">
        <div class="flex items-center gap-2 text-sm">
          <span class="badge">LIMITED</span>
          <span>Use <strong class="mono">CONTENTOFF90</strong> for <strong>90% off</strong> your first month of <strong>Creator</strong>.</span>
        </div>
        <div class="flex items-center gap-2">
          <button id="copyPromoBtn_pr" class="btn">Copy code</button>
          <a href="#demo" class="btn">Try Demo</a>
          <button id="heroSignIn_pr" class="btn">Sign in</button>
          <a href="#pricing" class="btn btn-primary">See plans</a>
        </div>
      </div>

      <div class="grid lg:grid-cols-4 gap-6">
        <!-- FREE -->
        <div class="card p-6 flex flex-col">
          <div class="text-sm px-3 py-1 rounded-full bg-white/70 dark:bg-white/10 border w-fit">Free</div>
          <h3 class="mt-3 text-xl font-bold">Demo + Account</h3>
          <div class="mt-2 text-3xl font-extrabold">$0<span class="text-sm text-slate-500">/forever</span></div>
          <ul class="mt-4 text-sm space-y-2">
            <li>• Demo (no login): <strong>5 runs / month</strong></li>
            <li>• Free account: <strong>5 runs / day</strong></li>
            <li>• 1× <strong>Article Optimizer</strong> (once after verification)</li>
            <li>• BYOK: <strong>5 / day</strong></li>
            <li>• CSV/Markdown export</li>
          </ul>
          <a href="#demo" class="mt-6 block text-center btn">Start free</a>
        </div>

        <!-- STARTER -->
        <div class="card p-6 flex flex-col">
          <div class="text-sm px-3 py-1 rounded-full bg-white/70 dark:bg-white/10 border w-fit">Starter</div>
          <h3 class="mt-3 text-xl font-bold">Solo Creator</h3>
          <div class="mt-2 text-3xl font-extrabold">$9<span class="text-sm text-slate-500">/mo</span></div>
          <ul class="mt-4 text-sm space-y-2">
            <li>• <strong>200 generations / month</strong></li>
            <li>• Batch inputs (up to 5 lines/run)</li>
            <li>• 10 saved presets</li>
            <li>• Priority models</li>
            <li>• BYOK: 50 / month (+5 daily headroom)</li>
            <li>• <strong>Scheduler</strong> (queue & calendar)</li>
            <li>• <strong>Analytics</strong> (basics)</li>
            <li>• <strong>Article Optimizer</strong>: up to 5 / day</li>
          </ul>
          <button data-checkout="stripe" data-price="price_1S7y58JYjIKHzKcjzL7cIKiB" class="mt-6 w-full btn btn-primary" type="button">Get Starter</button>
        </div>

        <!-- CREATOR (featured) -->
        <div class="card p-6 flex flex-col ring-1 ring-black/5 relative">
          <span class="absolute -top-3 left-1/2 -translate-x-1/2 text-xs px-3 py-1 rounded-full bg-grad text-white shadow">Best value</span>
          <h3 class="mt-1 text-xl font-bold">Creator</h3>
          <div class="mt-2 text-3xl font-extrabold">$19<span class="text-sm text-slate-500">/mo</span></div>
          <ul class="mt-4 text-sm space-y-2">
            <li>• <strong>500 generations / month</strong></li>
            <li>• Unlimited presets</li>
            <li>• Project pack export</li>
            <li>• Notion export & Trello boards</li>
            <li>• Push drafts to Buffer</li>
            <li>• New workflows early</li>
            <li>• BYOK: 150 / month (+10 daily)</li>
            <li>• <strong>Scheduler</strong> (multi-profile)</li>
            <li>• <strong>Analytics Pro</strong> (per-channel)</li>
            <li>• <strong>Article Optimizer</strong>: up to 15 / day</li>
          </ul>
          <button data-checkout="stripe" data-price="price_1S7y77JYjIKHzKcjKQYjiqZH" class="mt-6 w-full btn btn-primary" type="button">Get Creator</button>
        </div>

        <!-- BUSINESS -->
        <div class="card p-6 flex flex-col">
          <div class="text-sm px-3 py-1 rounded-full bg-white/70 dark:bg-white/10 border w-fit">Team</div>
          <h3 class="mt-3 text-xl font-bold">Business</h3>
          <div class="mt-2 text-3xl font-extrabold">$49<span class="text-sm text-slate-500">/mo</span></div>
          <ul class="mt-4 text-sm space-y-2">
            <li>• <strong>Unlimited</strong> (fair use)</li>
            <li>• 3 seats included</li>
            <li>• White-label export</li>
            <li>• Priority support</li>
            <li>• All Creator integrations</li>
            <li>• Team presets & shared calendar</li>
            <li>• BYOK: 300 / month (+30 daily)</li>
            <li>• <strong>Team Analytics</strong> (org-wide)</li>
            <li>• <strong>Article Optimizer</strong>: up to 30 / day</li>
          </ul>
          <button data-checkout="stripe" data-price="price_1S7y8OJYjIKHzKcjqA9uJdyh" class="mt-6 w-full btn" type="button">Get Business</button>
        </div>
      </div>
    </div>
  </section>

  <!-- ===== MEMBER DASHBOARD (authed) ===== -->
  <section id="memberView" class="relative scroll-mt-24" data-gate="member">
    <div class="max-w-7xl mx-auto px-4 md:px-5 py-14 md:py-20">
      <div class="flex items-center justify-between gap-3 mb-6">
        <div class="flex items-center gap-3">
          <span id="memberPlanBadge" class="px-3 py-1 rounded-full text-xs bg-white/70 dark:bg-white/10 border">Plan: —</span>
          <span id="quotaMember" class="chip">Today: —</span>
        </div>
        <div class="flex items-center gap-2">
          <button id="manageBilling2" class="btn hidden" data-portal="stripe">Manage billing</button>
          <button id="logoutBtn_m" class="btn hidden">Sign out</button>
        </div>
      </div>

      <!-- Quotas -->
      <div id="quotaCards" class="grid sm:grid-cols-2 lg:grid-cols-4 gap-3 mb-8">
        <!-- Filled by script -->
      </div>

      <!-- GENERATOR (member lane & BYOK lane) -->
      <div class="grid lg:grid-cols-2 gap-6">
        <div class="card p-5">
          <h3 class="font-semibold">Create</h3>
          <textarea id="source_m" class="w-full rounded-xl border p-4 min-h-[140px] mt-3"
            placeholder="Paste a paragraph, blog excerpt, or a URL."></textarea>
          <div class="mt-3 flex flex-wrap items-center gap-2">
            <button id="run_m" class="btn btn-primary">Generate</button>
            <button id="run-byok_m" class="btn">Generate with your BYOK</button>
            <button id="clear_m" class="btn">Clear</button>
            <span id="status_m" class="text-sm text-slate-500 ml-auto"></span>
          </div>

          <!-- Basic options -->
          <div class="grid grid-cols-2 gap-2 mt-4 text-sm">
            <label class="flex items-center gap-2"><input type="checkbox" id="opt_humanize_m" checked> Humanize</label>
            <label class="flex items-center gap-2"><input type="checkbox" id="opt_headings_m" checked> Auto-headings</label>
            <label class="flex items-center gap-2"><input type="checkbox" id="opt_faqs_m"> Add FAQs</label>
            <label class="flex items-center gap-2"><input type="checkbox" id="opt_lengthen_m"> Lengthen</label>
            <label class="flex items-center gap-2"><input type="checkbox" id="opt_svg_m"> SVG ideas</label>
            <label class="flex items-center gap-2"><input type="checkbox" id="opt_seo_m"> SEO basics</label>
          </div>
        </div>

        <div class="card p-5">
          <h3 class="font-semibold">Quick exports</h3>
          <div class="grid sm:grid-cols-2 gap-2 mt-3">
            <button id="li-notion" class="btn hidden">Send LinkedIn + X → Notion</button>
            <button id="li-trello" class="btn hidden">Send LinkedIn + X → Trello</button>
            <button id="publish-em_m" class="btn">Open Email in client</button>
          </div>

          <div class="mt-6 grid gap-3">
            <div class="stat">
              <div class="text-xs text-slate-500">Notion</div>
              <div id="notionState" class="k">Disconnected</div>
              <div class="mt-2 flex gap-2">
                <button id="connectNotion" class="btn">Connect</button>
                <button id="disconnectNotion" class="btn hidden">Disconnect</button>
              </div>
            </div>
            <div class="stat">
              <div class="text-xs text-slate-500">Trello</div>
              <div id="trelloState" class="k">Disconnected</div>
              <div class="mt-2 flex gap-2">
                <button id="connectTrello" class="btn">Connect</button>
                <!-- (optional) disconnect button can be added later -->
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- OUTPUTS -->
      <div class="grid lg:grid-cols-2 gap-6 mt-6">
        <div class="card p-5">
          <div class="flex items-center justify-between">
            <strong>LinkedIn</strong>
            <button id="copy-li_m" class="btn text-xs">Copy</button>
          </div>
          <pre id="out-li_m" class="mt-3 whitespace-pre-wrap text-sm"></pre>

          <div class="mt-4 border-t border-white/20 pt-4">
            <strong>LinkedIn Article</strong>
            <div id="out-li-article_m" class="mt-2 prose prose-invert max-w-none"></div>
          </div>
        </div>

        <div class="card p-5">
          <div class="flex items-center justify-between">
            <strong>X (Twitter)</strong>
            <button id="copy-x_m" class="btn text-xs">Copy</button>
          </div>
          <pre id="out-x_m" class="mt-3 whitespace-pre-wrap text-sm"></pre>
        </div>

        <div class="card p-5">
          <div class="flex items-center justify-between">
            <strong>Email</strong>
            <button id="copy-em_m" class="btn text-xs">Copy subject</button>
          </div>
          <div class="text-xs text-slate-400 mt-2">Subject</div>
          <pre id="out-em-subj_m" class="mt-1 whitespace-pre-wrap text-sm"></pre>
          <div class="text-xs text-slate-400 mt-3">Body</div>
          <pre id="out-em-body_m" class="mt-1 whitespace-pre-wrap text-sm"></pre>
        </div>

        <div class="card p-5">
          <div class="flex items-center justify-between">
            <strong>Instagram</strong>
            <button id="copy-ig_m" class="btn text-xs">Copy</button>
          </div>
          <pre id="out-ig_m" class="mt-3 whitespace-pre-wrap text-sm"></pre>
        </div>

        <div class="card p-5">
          <div class="flex items-center justify-between">
            <strong>Reddit</strong>
            <button id="copy-reddit_m" class="btn text-xs">Copy</button>
          </div>
          <pre id="out-reddit_m" class="mt-3 whitespace-pre-wrap text-sm"></pre>
          <div class="mt-3 text-xs text-slate-400">Suggested communities</div>
          <ul id="out-reddit-subs_m" class="mt-1 grid grid-cols-2 gap-1 text-sm"></ul>
          <div class="mt-3 text-xs text-slate-400">Starter comments</div>
          <pre id="out-reddit-comments_m" class="mt-1 whitespace-pre-wrap text-sm"></pre>
        </div>

        <div class="card p-5">
          <div class="flex items-center justify-between">
            <strong>Facebook</strong>
            <button id="copy-fb_m" class="btn text-xs">Copy</button>
          </div>
          <pre id="out-fb_m" class="mt-3 whitespace-pre-wrap text-sm"></pre>
          <div class="text-xs text-slate-400 mt-3">Link preview</div>
          <pre id="out-fb-meta_m" class="mt-1 whitespace-pre-wrap text-sm"></pre>
        </div>

        <div class="card p-5">
          <div class="flex items-center justify-between">
            <strong>Quora</strong>
            <button id="copy-quora_m" class="btn text-xs">Copy</button>
          </div>
          <pre id="out-quora_m" class="mt-3 whitespace-pre-wrap text-sm"></pre>
          <div class="text-xs text-slate-400 mt-3">Follow-up prompts</div>
          <pre id="out-quora-prompts_m" class="mt-1 whitespace-pre-wrap text-sm"></pre>
        </div>

        <div class="card p-5">
          <div class="flex items-center justify-between">
            <strong>TikTok</strong>
            <button id="copy-tt_m" class="btn text-xs">Copy</button>
          </div>
          <pre id="out-tt_m" class="mt-3 whitespace-pre-wrap text-sm"></pre>
          <div class="text-xs text-slate-400 mt-3">On-screen plan</div>
          <pre id="out-tt-onscreen_m" class="mt-1 whitespace-pre-wrap text-sm"></pre>
        </div>
      </div>

      <!-- Scheduler (local queue UI) -->
      <div class="card p-5 mt-6">
        <h3 class="font-semibold">Scheduler</h3>
        <div class="grid md:grid-cols-4 gap-3 mt-3">
          <select id="schedChannel" class="border rounded-lg px-2 py-2">
            <option value="linkedin">LinkedIn</option>
            <option value="x">X (Twitter)</option>
            <option value="email">Email</option>
            <option value="instagram">Instagram</option>
            <option value="reddit">Reddit</option>
            <option value="facebook">Facebook</option>
            <option value="quora">Quora</option>
            <option value="tiktok">TikTok</option>
          </select>
          <input id="schedWhen" type="datetime-local" class="border rounded-lg px-2 py-2" />
          <textarea id="schedContent" class="border rounded-lg px-2 py-2 md:col-span-2" placeholder="Paste content to queue…"></textarea>
        </div>
        <div class="flex items-center gap-2 mt-3">
          <button id="schedSave" class="btn btn-primary">Add to queue</button>
          <button id="schedClear" class="btn">Clear content</button>
        </div>
        <ul id="schedList" class="mt-3 grid gap-2"></ul>
      </div>

      <!-- Analytics (local augment + live stats) -->
      <div class="grid md:grid-cols-3 gap-6 mt-6">
        <div class="stat card p-5">
          <div class="text-xs text-slate-500">Total generations (local)</div>
          <div id="anCount" class="k text-2xl font-bold mt-2">0</div>
          <div class="text-xs text-slate-500 mt-2">Most active channel</div>
          <div id="anTop" class="mt-1">—</div>
        </div>
        <div class="stat card p-5">
          <div class="text-xs text-slate-500">Recent activity</div>
          <ul id="anRecent" class="mt-2 grid gap-2 text-xs"></ul>
        </div>
        <div class="stat card p-5">
          <div class="text-xs text-slate-500">Volume (last 7d)</div>
          <div id="anChart" class="mt-3 text-sm">—</div>
        </div>
      </div>

      <!-- Team (Business plan only) -->
      <div id="teamCard" class="card p-5 mt-6" style="display:none">
        <h3 class="font-semibold">Team</h3>
        <div class="grid md:grid-cols-2 gap-3 mt-3">
          <div>
            <label class="text-xs text-slate-500">Invite a teammate</label>
            <div class="mt-1 flex gap-2">
              <input id="inviteEmail" type="email" class="border rounded-lg px-3 py-2 w-full" placeholder="teammate@company.com" />
              <button id="inviteBtn" class="btn">Invite</button>
            </div>
          </div>
          <div>
            <label class="text-xs text-slate-500">Seats</label>
            <ul id="seatList" class="mt-2 grid gap-2 text-sm"></ul>
          </div>
        </div>
      </div>
    </div>
  </section>
  <!-- ===== MEMBER SCRIPTS (scoped; no globals leaked) ===== -->
  <script>
  (function CRPMember(){
    const W = window, D = document;
    const WORKER_BASE = W.WORKER_BASE || "https://contentflow-worker.frank-couchman.workers.dev";
    const byId = (id)=> D.getElementById(id);
    const qs   = (s,el=D)=> el.querySelector(s);
    const qsa  = (s,el=D)=> Array.from(el.querySelectorAll(s));
    const toast = (msg)=>{
      const t = byId("toast"), m = byId("toastMsg");
      if (!t || !m) return console.log("[toast]", msg);
      m.textContent = msg; t.classList.remove("hidden");
      setTimeout(()=> t.classList.add("hidden"), 1800);
    };

    // ---------- NAV + PROMO ----------
    (function navWire(){
      const toggle = byId("navToggle");
      const sheet  = byId("mobileNav");
      const close  = byId("navClose");
      toggle?.addEventListener("click", ()=> D.body.classList.add("nav-open"));
      close?.addEventListener("click", ()=> D.body.classList.remove("nav-open"));
      qsa('a[href^="#"]').forEach(a=>{
        a.addEventListener("click", (e)=>{
          const id = a.getAttribute("href"); if (!id || id==="#") return;
          const el = qs(id); if (!el) return;
          e.preventDefault(); el.scrollIntoView({ behavior:"smooth", block:"start" });
          D.body.classList.remove("nav-open"); history.replaceState(null,"",id);
        });
      });
    })();
    ["copyPromoBtn","copyPromoBtn2","copyPromoBtn_pr"].forEach(id=>{
      const b = byId(id);
      b?.addEventListener("click", async ()=>{
        try{ await navigator.clipboard.writeText("CONTENTOFF90"); toast("Code copied ✅"); }
        catch{ toast("Copy failed"); }
      });
    });

    // ---------- BILLING: checkout + portal ----------
    qsa('[data-checkout="stripe"]').forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const price = btn.getAttribute("data-price") || "";
        if (!price) return toast("Missing price id");
        btn.disabled = true; const old = btn.textContent; btn.textContent = "Opening…";
        try{
          const r = await fetch(`${WORKER_BASE}/api/billing/checkout`,{
            method:"POST",
            headers: await (W.authHeaders?.() || { "Content-Type":"application/json" }),
            body: JSON.stringify({ price, success_url: location.origin + "/?billing=success", cancel_url: location.origin + "/?billing=cancel" })
          });
          const j = await r.json(); if (!r.ok) throw new Error(j?.error?.message || "Checkout error");
          if (j.url) location.href = j.url; else throw new Error("No checkout URL");
        }catch(e){ toast(e.message||"Checkout failed"); btn.disabled=false; btn.textContent=old; }
      });
    });
    qsa('[data-portal="stripe"]').forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        btn.disabled = true; const old = btn.textContent; btn.textContent = "Opening…";
        try{
          const r = await fetch(`${WORKER_BASE}/api/billing/portal`,{
            method:"POST",
            headers: await (W.authHeaders?.() || { "Content-Type":"application/json" }),
            body: JSON.stringify({ return_url: location.href })
          });
          const j = await r.json(); if (!r.ok) throw new Error(j?.error?.message || "Portal error");
          if (j.url) location.href = j.url; else throw new Error("No portal URL");
        }catch(e){ toast(e.message||"Portal failed"); btn.disabled=false; btn.textContent=old; }
      });
    });

    // ---------- MEMBER BOOT ----------
    async function paintStatus(){
      try{
        const r = await fetch(`${WORKER_BASE}/api/billing/status`, { headers: await (W.authHeaders?.() || {"Content-Type":"application/json"}) });
        const j = await r.json();
        if (!r.ok) throw new Error(j?.error?.message || "Status error");

        const plan = (j.plan || "free").toLowerCase();
        byId("memberPlanBadge") && (byId("memberPlanBadge").textContent = `Plan: ${plan.charAt(0).toUpperCase()+plan.slice(1)}`);

        // show manage billing for paid
        ["manageBilling2","manageBilling","manageBilling_m"].forEach(id=>{
          const el = byId(id); if (el) (plan!=="free" ? el.classList.remove("hidden") : el.classList.add("hidden"));
        });

        // top quota cards
        const qc = byId("quotaCards");
        if (qc){
          const pd = j.platform?.daily || {used:0,cap:null};
          const pm = j.platform?.monthly || {used:0,cap:null};
          const bd = j.byok?.daily || {used:0,cap:0};
          const bm = j.byok?.monthly || {used:0,cap:0};
          qc.innerHTML = `
            <div class="stat"><div class="text-xs text-slate-500">Platform • Today</div><div class="k">${pd.used}/${pd.cap ?? "∞"}</div></div>
            <div class="stat"><div class="text-xs text-slate-500">Platform • This month</div><div class="k">${pm.used}/${pm.cap ?? "∞"}</div></div>
            <div class="stat"><div class="text-xs text-slate-500">BYOK • Today</div><div class="k">${bd.used}/${bd.cap ?? "—"}</div></div>
            <div class="stat"><div class="text-xs text-slate-500">BYOK • This month</div><div class="k">${bm.used}/${bm.cap ?? "—"}</div></div>`;
        }

        // “Today: x/y” chip
        const used = j.platform?.daily?.used ?? 0;
        const cap  = j.platform?.daily?.cap ?? 5;
        byId("quotaMember") && (byId("quotaMember").textContent = `Today: ${used}/${cap ?? "∞"}`);

        // integrations states
        const iNotion = j.integrations?.notion?.connected;
        const iTrello = j.integrations?.trello?.connected;
        byId("notionState") && (byId("notionState").textContent = iNotion ? "Connected" : "Disconnected");
        byId("trelloState") && (byId("trelloState").textContent = iTrello ? "Connected" : "Disconnected");
        if (iNotion){ byId("connectNotion")?.classList.add("hidden"); byId("disconnectNotion")?.classList.remove("hidden"); }
        if (iTrello){ byId("connectTrello")?.classList.remove("hidden"); }

        // team section visibility
        const teamCard = byId("teamCard");
        if (teamCard) teamCard.style.display = (plan==="business") ? "" : "none";
        if (plan==="business") refreshOrgMembers();
      }catch(e){ /* soft fail */ }
    }
    paintStatus();

    // ---------- GENERATION (member + BYOK) ----------
    const gsrc = byId("source_m");
    const gst  = byId("status_m");
    const outIds = {
      li: "out-li_m", liArticle: "out-li-article_m",
      x: "out-x_m",
      emSubj: "out-em-subj_m", emBody:"out-em-body_m",
      ig: "out-ig_m",
      reddit: "out-reddit_m", redditSubs:"out-reddit-subs_m", redditCom:"out-reddit-comments_m",
      fb: "out-fb_m", fbMeta:"out-fb-meta_m",
      quora: "out-quora_m", quoraP:"out-quora-prompts_m",
      tt: "out-tt_m", ttOn: "out-tt-onscreen_m"
    };

    function clearMemberOutputs(){
      Object.values(outIds).forEach(id=>{
        const el = byId(id); if (!el) return;
        if (el.tagName==="UL") el.innerHTML = ""; else el.textContent = "";
      });
    }
    function readMemberToggles(){
      return {
        opt: {
          humanize:  !!byId("opt_humanize_m")?.checked,
          lengthen:  !!byId("opt_lengthen_m")?.checked,
          faqs:      !!byId("opt_faqs_m")?.checked,
          headings:  !!byId("opt_headings_m")?.checked,
          svg:       !!byId("opt_svg_m")?.checked,
          seo:       !!byId("opt_seo_m")?.checked
        }
      };
    }
    function sysMember(){
      return {
        role:"system",
        content:
`You are a social + editorial repurposer. Return ONLY valid JSON with keys:
{
  "linkedin": string|null,
  "x": string[]|null,
  "email": { "subject": string, "body": string }|null,
  "instagram": { "caption": string, "hashtags": string[] }|null,
  "reddit": { "title": string, "body": string, "communities": string[], "starter_comments": string[] }|null,
  "facebook": { "primary": string, "meta": { "headline": string, "description": string } }|null,
  "quora": { "answer": string, "followups": string[] }|null,
  "tiktok": { "hooks": string[], "script": string, "onscreen": string[] }|null,
  "linkedin_article_html": string|null
}
Guidelines: skimmable, native tone; X posts ≤ 280 chars when possible; IG hashtags 3–5; NO prose outside JSON.`
      };
    }
    function usrMember(src){
      return { role:"user", content:`Source:\n${src}\n\nGenerate drafts for LinkedIn, X, Email, Instagram, Reddit, Facebook, Quora, TikTok.` };
    }
    function safeJSON(maybe){
      if (!maybe) return null;
      try{ return JSON.parse(maybe); }catch{}
      const s1 = maybe.indexOf("{"), s2 = maybe.indexOf("[");
      const s = (s1===-1)? s2 : (s2===-1? s1 : Math.min(s1,s2));
      if (s<0) return null;
      const tail = maybe.slice(s);
      const e = Math.max(tail.lastIndexOf("}"), tail.lastIndexOf("]"));
      if (e<0) return null;
      try{ return JSON.parse(tail.slice(0,e+1)); }catch{ return null; }
    }
    function paintMember(j){
      // LI
      if (j.linkedin && byId(outIds.li)) byId(outIds.li).textContent = j.linkedin;
      if (j.linkedin_article_html && byId(outIds.liArticle)) byId(outIds.liArticle).innerHTML = j.linkedin_article_html;
      // X
      if (Array.isArray(j.x) && j.x.length && byId(outIds.x)){
        byId(outIds.x).textContent = j.x.map((t,i)=>`Post ${i+1}: ${t}`).join("\n\n");
      }
      // Email
      if (j.email){
        byId(outIds.emSubj)?.textContent = j.email.subject || "";
        byId(outIds.emBody)?.textContent = j.email.body || "";
      }
      // IG
      if (j.instagram){
        const tags = (j.instagram.hashtags||[]).map(h=> h.startsWith("#")?h:"#"+h).join(" ");
        byId(outIds.ig)?.textContent = `${j.instagram.caption||""}\n\n${tags}`;
      }
      // Reddit
      if (j.reddit){
        byId(outIds.reddit)?.textContent = `**${j.reddit.title||""}**\n\n${j.reddit.body||""}`;
        if (byId(outIds.redditSubs)) byId(outIds.redditSubs).innerHTML = (j.reddit.communities||[]).slice(0,8).map(s=>`<li>r/${s}</li>`).join("");
        byId(outIds.redditCom)?.textContent = (j.reddit.starter_comments||[]).map(c=>`• ${c}`).join("\n");
      }
      // FB
      if (j.facebook){
        byId(outIds.fb)?.textContent = j.facebook.primary || "";
        byId(outIds.fbMeta)?.textContent = `${j.facebook.meta?.headline||""}\n${j.facebook.meta?.description||""}`;
      }
      // Quora
      if (j.quora){
        byId(outIds.quora)?.textContent = j.quora.answer || "";
        byId(outIds.quoraP)?.textContent = (j.quora.followups||[]).map(x=>`• ${x}`).join("\n");
      }
      // TikTok
      if (j.tiktok){
        byId(outIds.tt)?.textContent = j.tiktok.script || "";
        byId(outIds.ttOn)?.textContent = (j.tiktok.onscreen||[]).map(x=>`• ${x}`).join("\n");
      }
    }

    async function runMember({ lane="platform" }={}){
      const raw = (gsrc?.value||"").trim();
      if (!raw){ toast("Paste an idea, excerpt, or URL first"); return; }
      const btn = (lane==="byok") ? byId("run-byok_m") : byId("run_m");
      try{
        btn && (btn.disabled=true, btn.textContent="Generating…");
        gst && (gst.textContent="Working…");
        clearMemberOutputs();

        const messages = [ sysMember(readMemberToggles()), usrMember(raw) ];
        const body = { messages, temperature: 0.4, plan: (lane==="byok" ? "byok" : "member"), ...(lane==="byok" ? { use_byok: true } : {}) };

        const r = await fetch(`${WORKER_BASE}/api/generate`,{
          method:"POST",
          headers: await (W.authHeaders?.() || { "Content-Type":"application/json" }),
          body: JSON.stringify(body)
        });
        let data=null; try{ data = await r.json(); }catch{ throw new Error("Bad response from server"); }
        if (!r.ok) throw new Error(data?.error?.message || "Generation failed");
        const content = data?.choices?.[0]?.message?.content || "";
        const j = safeJSON(content); if (!j) throw new Error("Model did not return JSON");
        paintMember(j);
        gst && (gst.textContent="Done ✅");
        bumpAnalytics("generation");
        paintStatus(); // refresh quotas
      }catch(e){
        gst && (gst.textContent = `Error: ${e.message || e}`);
      }finally{
        btn && (btn.disabled=false, btn.textContent = (lane==="byok") ? "Generate with your BYOK" : "Generate");
      }
    }
    byId("run_m")?.addEventListener("click", ()=> runMember({ lane:"platform" }));
    byId("run-byok_m")?.addEventListener("click", ()=> runMember({ lane:"byok" }));
    byId("clear_m")?.addEventListener("click", ()=>{ if (gsrc) gsrc.value=""; clearMemberOutputs(); gst && (gst.textContent=""); });

    // ---------- EXPORTS ----------
    byId("li-notion")?.classList.remove("hidden");
    byId("li-notion")?.addEventListener("click", async ()=>{
      const blocks = [];
      const li = byId(outIds.li)?.textContent || "";
      const x  = byId(outIds.x)?.textContent || "";
      if (li) blocks.push({ type:"heading", text:"LinkedIn" }, { type:"paragraph", text: li });
      if (x)  blocks.push({ type:"heading", text:"X (Twitter)" }, { type:"paragraph", text: x });
      try{
        const r = await fetch(`${WORKER_BASE}/api/integrations/notion/export`,{
          method:"POST",
          headers: await (W.authHeaders?.() || { "Content-Type":"application/json" }),
          body: JSON.stringify({ title:"Social Drafts", blocks })
        });
        const j = await r.json(); if (!r.ok) throw new Error(j?.error?.message || "Notion export failed");
        toast("Sent to Notion ✅"); if (j.url) window.open(j.url, "_blank");
      }catch(e){ toast(e.message || "Notion export failed"); }
    });

    const trelloBtn = byId("li-trello");
    const trelloDialog = byId("trelloModal");
    trelloBtn?.classList.remove("hidden");
    trelloBtn?.addEventListener("click", ()=> trelloDialog?.showModal());
    byId("trelloConfirm")?.addEventListener("click", async ()=>{
      const board_id = byId("trelloBoardId")?.value?.trim();
      const list_id  = byId("trelloListId")?.value?.trim();
      if (!list_id) return toast("Enter List ID");
      const title = "Social Draft";
      const description = [
        "LinkedIn:\n"+(byId(outIds.li)?.textContent||""),
        "\nX:\n"+(byId(outIds.x)?.textContent||"")
      ].join("\n");
      try{
        const r = await fetch(`${WORKER_BASE}/api/integrations/trello/export`,{
          method:"POST",
          headers: await (W.authHeaders?.() || { "Content-Type":"application/json" }),
          body: JSON.stringify({ board_id, list_id, title, description })
        });
        const j = await r.json(); if (!r.ok) throw new Error(j?.error?.message || "Trello export failed");
        toast("Sent to Trello ✅");
        trelloDialog?.close();
        if (j.url) window.open(j.url, "_blank");
      }catch(e){ toast(e.message || "Trello export failed"); }
    });

    // Connect/Disconnect integrations
    byId("connectTrello")?.addEventListener("click", async ()=>{
      try{
        const r = await fetch(`${WORKER_BASE}/api/integrations/trello/oauth/start`, { headers: await (W.authHeaders?.() || {"Content-Type":"application/json"}) });
        const j = await r.json(); if (!r.ok) throw new Error(j?.error?.message || "Start Trello OAuth failed");
        location.href = j.url;
      }catch(e){ toast(e.message || "Trello connect failed"); }
    });
    byId("connectNotion")?.addEventListener("click", async ()=>{
      try{
        const r = await fetch(`${WORKER_BASE}/api/integrations/notion/oauth/start`, { headers: await (W.authHeaders?.() || {"Content-Type":"application/json"}) });
        const j = await r.json(); if (!r.ok) throw new Error(j?.error?.message || "Start Notion OAuth failed");
        location.href = j.url;
      }catch(e){ toast(e.message || "Notion connect failed"); }
    });
    byId("disconnectNotion")?.addEventListener("click", async ()=>{
      try{
        const r = await fetch(`${WORKER_BASE}/api/integrations/notion/disconnect`,{ method:"POST", headers: await (W.authHeaders?.() || {"Content-Type":"application/json"}) });
        if (!r.ok){ const jj = await r.json(); throw new Error(jj?.error?.message || "Disconnect failed"); }
        toast("Notion disconnected"); paintStatus();
      }catch(e){ toast(e.message || "Notion disconnect failed"); }
    });

    // ---------- EMAIL PREVIEW ----------
    const emailDlg = byId("emailPreview");
    byId("publish-em_m")?.addEventListener("click", ()=>{
      if (!emailDlg) return;
      byId("emailSubjEdit").value = byId(outIds.emSubj)?.textContent || "";
      byId("emailBodyEdit").value = byId(outIds.emBody)?.textContent || "";
      emailDlg.showModal();
    });
    byId("emailSendBtn")?.addEventListener("click", ()=>{
      const subj = encodeURIComponent(byId("emailSubjEdit").value || "");
      const body = encodeURIComponent(byId("emailBodyEdit").value || "");
      location.href = `mailto:?subject=${subj}&body=${body}`;
    });

    // ---------- COPY buttons ----------
    function wireCopy(targetId, btnId){
      const b = byId(btnId);
      b?.addEventListener("click", async ()=>{
        try{ await navigator.clipboard.writeText(byId(targetId)?.textContent || ""); toast("Copied ✅"); }
        catch{ toast("Copy failed"); }
      });
    }
    wireCopy(outIds.li, "copy-li_m");
    wireCopy(outIds.x,  "copy-x_m");
    wireCopy(outIds.emSubj, "copy-em_m");
    wireCopy(outIds.ig, "copy-ig_m");
    wireCopy(outIds.reddit, "copy-reddit_m");
    wireCopy(outIds.fb, "copy-fb_m");
    wireCopy(outIds.quora, "copy-quora_m");
    wireCopy(outIds.tt, "copy-tt_m");

    // ---------- Scheduler (local) ----------
    const schedKey = "crp_scheduler_queue_v1";
    const schedList = byId("schedList");
    const loadSched = ()=> { try{ return JSON.parse(localStorage.getItem(schedKey)||"[]"); }catch{return [];} };
    const saveSched = (arr)=> localStorage.setItem(schedKey, JSON.stringify(arr));
    function paintSched(){
      const items = loadSched().sort((a,b)=> new Date(a.when) - new Date(b.when));
      if (!schedList) return;
      schedList.innerHTML = items.map((it,i)=> `<li class="p-2 rounded-lg border flex items-center justify-between"><span class="text-xs">${new Date(it.when).toLocaleString()} • ${it.channel}</span><button data-i="${i}" class="btn text-xs">Remove</button></li>`).join("");
      qsa("button[data-i]", schedList).forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const i = Number(btn.getAttribute("data-i"));
          const arr = loadSched(); arr.splice(i,1); saveSched(arr); paintSched();
        });
      });
    }
    byId("schedSave")?.addEventListener("click", ()=>{
      const ch = byId("schedChannel")?.value || "linkedin";
      const when = byId("schedWhen")?.value;
      const content = byId("schedContent")?.value?.trim() || "";
      if (!when || !content) return toast("Pick date/time and paste content");
      const arr = loadSched(); arr.push({ channel: ch, when, content }); saveSched(arr); paintSched(); toast("Added to queue ✅");
    });
    byId("schedClear")?.addEventListener("click", ()=>{ byId("schedContent").value = ""; toast("Cleared"); });
    paintSched();

    // ---------- Analytics (local augment) ----------
    const analyticsKey = "crp_local_analytics_v1";
    const getAn = ()=> { try{ return JSON.parse(localStorage.getItem(analyticsKey)||"{}"); }catch{return{}}; };
    const setAn = (obj)=> localStorage.setItem(analyticsKey, JSON.stringify(obj));
    function bumpAnalytics(kind){
      const an = getAn(); an.events = an.events || []; an.events.push({ t: Date.now(), kind }); setAn(an); paintAnalytics();
    }
    function paintAnalytics(){
      const an = getAn();
      const events = (an.events||[]).filter(e => Date.now() - e.t < 1000*60*60*24*90);
      const byDay = {}; events.forEach(e=>{ const d = new Date(e.t).toISOString().slice(0,10); byDay[d] = (byDay[d]||0)+1; });
      byId("anCount") && (byId("anCount").textContent = String(events.length));
      byId("anTop") && (byId("anTop").textContent = "LinkedIn"); // placeholder
      if (byId("anRecent")) byId("anRecent").innerHTML = events.slice(-5).reverse().map(e=>`<li class="p-2 rounded-lg border text-xs">Generated • ${new Date(e.t).toLocaleString()}</li>`).join("");
      byId("anChart") && (byId("anChart").textContent = "Volume (local): " + Object.values(byDay).slice(-7).join(", "));
    }
    paintAnalytics();
    W.bumpAnalytics = bumpAnalytics; // used by generator painting

    // ---------- Teams (Business) ----------
    async function refreshOrgMembers(){
      try{
        const r = await fetch(`${WORKER_BASE}/api/org/members`, { headers: await (W.authHeaders?.() || {"Content-Type":"application/json"}) });
        const j = await r.json(); if (!r.ok) throw new Error(j?.error?.message || "Org members error");
        const list = byId("seatList");
        if (list){
          list.innerHTML = (j.members||[]).map(m=> `<li class="p-2 rounded-lg border text-xs flex items-center justify-between">
            <span>${m.email || m.user_id}</span>
            ${j.owner_id===m.user_id ? `<span class="chip">Owner</span>` : `<button data-id="${m.user_id}" class="btn text-xs removeSeat">Remove</button>`}
          </li>`).join("") + (j.invites && j.invites.length ? `<li class="p-2 rounded-lg border text-xs">Invites: ${j.invites.map(i=>i.email).join(", ")}</li>` : "");
          qsa(".removeSeat", list).forEach(b=>{
            b.addEventListener("click", async ()=>{
              const uid = b.getAttribute("data-id");
              const r2 = await fetch(`${WORKER_BASE}/api/org/remove`, {
                method:"POST", headers: await (W.authHeaders?.() || {"Content-Type":"application/json"}), body: JSON.stringify({ user_id: uid })
              });
              if (!r2.ok){ const jj = await r2.json(); toast(jj?.error?.message || "Remove failed"); return; }
              toast("Removed"); refreshOrgMembers();
            });
          });
        }
      }catch(e){ /* ignore */ }
    }
    byId("inviteBtn")?.addEventListener("click", async ()=>{
      try{
        await fetch(`${WORKER_BASE}/api/org/ensure`, { method:"POST", headers: await (W.authHeaders?.() || {"Content-Type":"application/json"}), body: JSON.stringify({ name:"Your Team" }) });
        const email = byId("inviteEmail")?.value?.trim(); if (!email) return toast("Enter an email");
        const r = await fetch(`${WORKER_BASE}/api/org/invite`, { method:"POST", headers: await (W.authHeaders?.() || {"Content-Type":"application/json"}), body: JSON.stringify({ email }) });
        const j = await r.json(); if (!r.ok) throw new Error(j?.error?.message || "Invite failed");
        toast("Invite sent ✅"); byId("inviteEmail").value = ""; refreshOrgMembers();
      }catch(e){ toast(e.message || "Invite failed"); }
    });

    // ---------- Route from hash on load (go to dashboard after auth) ----------
    function routeFromHash(){
      const h = (location.hash||"").replace(/^#/, "").toLowerCase();
      if (!h) return;
      const map = { demo: byId("demo"), pricing: byId("pricing"), member: byId("memberView"), signin: byId("auth") };
      if (h==="signin" && map.signin && typeof map.signin.showModal==="function") map.signin.showModal();
      else map[h]?.scrollIntoView({ behavior:"smooth", block:"start" });
    }
    window.addEventListener("hashchange", routeFromHash);
    routeFromHash();
  })();
  </script>
  <!-- ===== AUTH DIALOG (Google + Magic Link) ===== -->
  <dialog id="auth" class="rounded-2xl p-0 w-[92vw] max-w-md border">
    <form method="dialog" class="p-4 border-b flex items-center justify-between">
      <strong>Sign in</strong>
      <button class="btn text-xs" aria-label="Close">Close</button>
    </form>

    <div class="p-5 grid gap-4">
      <!-- Continue with Google -->
      <button id="googleBtn" type="button" class="btn btn-primary flex items-center justify-center gap-2">
        <svg class="icon"><use href="#i-google"/></svg>
        Continue with Google
      </button>

      <div class="text-center text-xs text-slate-500">or</div>

      <!-- Magic link -->
      <label class="text-sm">Email</label>
      <input id="authEmail" type="email" inputmode="email" autocomplete="email"
             class="border rounded-lg px-3 py-2 w-full" placeholder="you@example.com" />

      <button id="sendMagic" type="button" class="btn w-full">Send magic link</button>
      <div id="authHint" class="text-xs text-slate-500">
        We’ll email you a sign-in link. Check spam if you don’t see it in ~10s.
      </div>
    </div>
  </dialog>

  <!-- ===== EMAIL PREVIEW DIALOG ===== -->
  <dialog id="emailPreview" class="rounded-2xl p-0 w-[92vw] max-w-2xl border">
    <form method="dialog" class="p-4 border-b flex items-center justify-between">
      <strong>Email preview</strong>
      <button class="btn text-xs" aria-label="Close">Close</button>
    </form>
    <div class="p-5 grid gap-3">
      <label class="text-xs text-slate-500">Subject</label>
      <input id="emailSubjEdit" class="border rounded-lg px-3 py-2" />
      <label class="text-xs text-slate-500">Body</label>
      <textarea id="emailBodyEdit" class="border rounded-lg px-3 py-2 min-h-[200px]"></textarea>
      <div class="flex items-center justify-end gap-2">
        <button id="emailSendBtn" class="btn btn-primary" type="button">Open in your email client</button>
      </div>
    </div>
  </dialog>

  <!-- ===== TRELLO EXPORT DIALOG ===== -->
  <dialog id="trelloModal" class="rounded-2xl p-0 w-[92vw] max-w-md border">
    <form method="dialog" class="p-4 border-b flex items-center justify-between">
      <strong>Send to Trello</strong>
      <button class="btn text-xs" aria-label="Close">Close</button>
    </form>
    <div class="p-5 grid gap-3">
      <label class="text-xs text-slate-500">Board ID (optional)</label>
      <input id="trelloBoardId" class="border rounded-lg px-3 py-2" placeholder="(optional)" />
      <label class="text-xs text-slate-500">List ID</label>
      <input id="trelloListId" class="border rounded-lg px-3 py-2" placeholder="required" />
      <div class="flex items-center justify-end gap-2">
        <button class="btn" type="submit">Cancel</button>
        <button id="trelloConfirm" type="button" class="btn btn-primary">Send</button>
      </div>
    </div>
  </dialog>

  <!-- ===== TOAST ===== -->
  <div id="toast" class="fixed bottom-4 right-4 z-50 hidden">
    <div class="px-3 py-2 rounded-xl bg-black text-white shadow-lg">
      <span id="toastMsg">—</span>
    </div>
  </div>

  <!-- ===== SVG SPRITE (icons used across the page) ===== -->
  <svg xmlns="http://www.w3.org/2000/svg" class="hidden">
    <symbol id="i-li" viewBox="0 0 24 24">
      <path d="M4.98 3.5C4.98 4.88 3.86 6 2.5 6S0 4.88 0 3.5 1.12 1 2.5 1s2.48 1.12 2.48 2.5zM.5 8h4V23h-4zM8 8h3.8v2.05h.05C12.64 8.8 14.2 8 16.35 8 20.77 8 21 10.9 21 14.7V23h-4v-7.3c0-1.74-.03-3.98-2.43-3.98-2.44 0-2.81 1.9-2.81 3.85V23h-4z"/>
    </symbol>
    <symbol id="i-x" viewBox="0 0 24 24">
      <path d="M18.9 2H22l-9.4 10.7L22.7 22h-7.1l-5.5-6.4L4.9 22H2l9.9-11.3L1.4 2h7.1l5 5.8z"/>
    </symbol>
    <symbol id="i-mail" viewBox="0 0 24 24">
      <path d="M2 4h20v16H2z" fill="none" stroke="currentColor"/><path d="M2 5l10 7 10-7" fill="none" stroke="currentColor"/>
    </symbol>
    <symbol id="i-ig" viewBox="0 0 24 24">
      <rect x="3" y="3" width="18" height="18" rx="5" ry="5" fill="none" stroke="currentColor"/>
      <circle cx="12" cy="12" r="4" fill="none" stroke="currentColor"/>
      <circle cx="17.5" cy="6.5" r="1.2"/>
    </symbol>
    <symbol id="i-reddit" viewBox="0 0 24 24">
      <circle cx="12" cy="13" r="7" fill="none" stroke="currentColor"/>
      <circle cx="9" cy="13" r="1.2"/><circle cx="15" cy="13" r="1.2"/>
      <path d="M8 16c1.2 1 3 .9 4 .9s2.8.1 4-.9" fill="none" stroke="currentColor"/>
    </symbol>
    <symbol id="i-fb" viewBox="0 0 24 24">
      <path d="M13 22V12h3l1-4h-4V6c0-1 .3-2 2-2h2V1h-3c-3 0-5 2-5 5v2H6v4h3v10h4z"/>
    </symbol>
    <symbol id="i-quora" viewBox="0 0 24 24">
      <path d="M12 2C6.9 2 3 6.3 3 11.4S6.9 21 12 21c1.6 0 3-.4 4.3-1.1l1.6 2.1 2.1-1.6-1.7-2.2c1.6-1.8 2.6-4.2 2.6-6.8C21 6.3 17.1 2 12 2zm0 3c3.6 0 6.5 2.9 6.5 6.4S15.6 18.3 12 18.3 5.5 15.5 5.5 11.4 8.4 5 12 5z"/>
    </symbol>
    <symbol id="i-tt" viewBox="0 0 24 24">
      <path d="M16 3h3a6 6 0 0 0 0 6 6 6 0 1 1-6 6V3h3z"/>
    </symbol>
    <symbol id="i-google" viewBox="0 0 24 24">
      <path d="M21.35 11.1H12v2.8h5.3c-.23 1.5-1.63 4.4-5.3 4.4A6.4 6.4 0 1 1 12 5.6c1.86 0 3.12.8 3.84 1.5l2.64-2.55C17.1 2.6 14.83 1.7 12 1.7 6.9 1.7 2.8 5.8 2.8 10.9s4.1 9.2 9.2 9.2c5.3 0 8.8-3.7 8.8-8.9 0-.6-.1-1-.25-1.9z"/>
    </symbol>
  </svg>

  <!-- ===== AUTH + SESSION SCRIPT ===== -->
  <script>
    (function AuthWiring(){
      const W = window, D = document;
      const byId = (id)=> D.getElementById(id);
      const toast = (msg)=>{
        const t = byId("toast"), m = byId("toastMsg");
        if (!t || !m) return console.log("[toast]", msg);
        m.textContent = msg; t.classList.remove("hidden");
        setTimeout(()=> t.classList.add("hidden"), 1800);
      };

      // Guard: Supabase client must already exist from Part 1.
      if (!W.supabase || !W.supabase.auth){
        console.warn("Supabase not initialized — check Part 1 import block.");
        return;
      }

      const authDlg = byId("auth");
      const googleBtn = byId("googleBtn");
      const emailInput = byId("authEmail");
      const sendMagicBtn = byId("sendMagic");

      // Expose helper for API calls to include session
      W.authHeaders = async () => {
        const { data: { session } } = await W.supabase.auth.getSession();
        const h = { "Content-Type":"application/json" };
        if (session?.access_token) h["Authorization"] = `Bearer ${session.access_token}`;
        if (session?.user?.id) h["X-User-Id"] = session.user.id;
        return h;
      };

      // Basic UI toggles (guest vs member)
      function setAuthedUI(user){
        const isAuthed = !!user;
        D.body.setAttribute("data-auth", isAuthed ? "member" : "guest");

        // Header buttons
        const idsShow   = isAuthed ? ["logoutBtn","logoutBtn_m"] : ["loginBtn","loginBtn_m"];
        const idsHide   = isAuthed ? ["loginBtn","loginBtn_m"]  : ["logoutBtn","logoutBtn_m"];
        idsShow.forEach(id=> byId(id)?.classList.remove("hidden"));
        idsHide.forEach(id=> byId(id)?.classList.add("hidden"));

        // Plan badges (header + mobile)
        if (!isAuthed){
          byId("planbadge")?.replaceChildren(document.createTextNode("Plan: Free"));
          byId("planbadge_m")?.replaceChildren(document.createTextNode("Plan: Free"));
        }

        // Route: land members on dashboard
        if (isAuthed) {
          const member = byId("memberView");
          if (member) member.scrollIntoView({ behavior:"smooth", block:"start" });
          // Also reflect in hash for bookmarking
          if (location.hash.toLowerCase() !== "#member") history.replaceState({}, "", "#member");
        }
      }

      // Login buttons open dialog
      ["loginBtn","loginBtn_m","heroSignIn","heroSignIn_pr"].forEach(id=>{
        const b = byId(id);
        b?.addEventListener("click", ()=> authDlg?.showModal());
      });

      // Logout buttons
      ["logoutBtn","logoutBtn_m"].forEach(id=>{
        byId(id)?.addEventListener("click", async ()=>{
          await W.supabase.auth.signOut();
          toast("Signed out");
          setAuthedUI(null);
          // Return to hero
          document.getElementById("hero")?.scrollIntoView({behavior:"smooth"});
        });
      });

      // Fix: sometimes button became unclickable if a dialog submit swallowed focus.
      // Ensure buttons are type="button" (they are), and forcibly enable pointer events.
      [googleBtn, sendMagicBtn].forEach(btn=>{
        if (btn){ btn.style.pointerEvents = "auto"; btn.disabled = false; }
      });

      // Google OAuth
      googleBtn?.addEventListener("click", async ()=>{
        try{
          // Optional: preserve hash so we can return to #member
          sessionStorage.setItem("post_auth_hash", "#member");
          const { data, error } = await W.supabase.auth.signInWithOAuth({
            provider: "google",
            options: {
              redirectTo: location.origin + "/#member", // returns to dashboard
              queryParams: { prompt: "select_account" }
            }
          });
          if (error) throw error;
          // supabase will redirect; no further action here.
        }catch(e){
          toast(e.message || "Google sign-in failed");
        }
      });

      // Magic link
      sendMagicBtn?.addEventListener("click", async ()=>{
        const email = (emailInput?.value || "").trim();
        if (!email){ toast("Enter your email first"); return; }
        try{
          sendMagicBtn.disabled = true; sendMagicBtn.textContent = "Sending…";
          const { error } = await W.supabase.auth.signInWithOtp({
            email,
            options: { emailRedirectTo: location.origin + "/#member" }
          });
          if (error) throw error;
          toast("Magic link sent ✉️ Check your inbox");
          // keep dialog open so the user can read the hint; enable re-send after 6s
          setTimeout(()=>{ sendMagicBtn.disabled=false; sendMagicBtn.textContent="Resend magic link"; }, 6000);
        }catch(e){
          toast(e.message || "Could not send magic link");
          sendMagicBtn.disabled=false; sendMagicBtn.textContent="Send magic link";
        }
      });

      // Handle OAuth/Magic-link return
      (async function hydrateSessionOnLoad(){
        // Supabase v2: check for URL hash params then update session (handled internally).
        const { data:{ session } } = await W.supabase.auth.getSession();
        setAuthedUI(session?.user || null);

        // After sign-in, refresh plan & badges
        if (session?.user){
          try{
            const r = await fetch(`${W.WORKER_BASE}/api/billing/status`, { headers: await W.authHeaders() });
            const j = await r.json();
            if (r.ok){
              const plan = (j.plan || "free").toLowerCase();
              const pretty = plan.charAt(0).toUpperCase() + plan.slice(1);
              byId("planbadge")?.replaceChildren(document.createTextNode(`Plan: ${pretty}`));
              byId("planbadge_m")?.replaceChildren(document.createTextNode(`Plan: ${pretty}`));
              // show manage billing for paid
              if (plan !== "free"){
                ["manageBilling","manageBilling_m","manageBilling2"].forEach(id=> byId(id)?.classList.remove("hidden"));
              }
            }
          }catch{}
        }

        // If we preserved a target hash pre-auth, go there
        const ph = sessionStorage.getItem("post_auth_hash");
        if (session?.user && ph){
          sessionStorage.removeItem("post_auth_hash");
          if (ph.startsWith("#")) location.hash = ph;
        }
      })();

      // React to session changes dynamically
      W.supabase.auth.onAuthStateChange(async (evt, sess)=>{
        setAuthedUI(sess?.user || null);
        if (evt === "SIGNED_IN"){
          toast("Signed in ✅");
          // Close dialog if open
          authDlg?.close?.();
          // Plan refresh
          try{
            const r = await fetch(`${W.WORKER_BASE}/api/billing/status`, { headers: await W.authHeaders() });
            const j = await r.json();
            if (r.ok){
              const plan = (j.plan || "free").toLowerCase();
              const pretty = plan.charAt(0).toUpperCase() + plan.slice(1);
              byId("planbadge")?.replaceChildren(document.createTextNode(`Plan: ${pretty}`));
              byId("planbadge_m")?.replaceChildren(document.createTextNode(`Plan: ${pretty}`));
            }
          }catch{}
        }
        if (evt === "SIGNED_OUT"){
          toast("Signed out");
        }
      });
    })();
  </script>

  <!-- ===== FOOTER ===== -->
  <footer class="mt-16 border-t border-white/20">
    <div class="max-w-7xl mx-auto px-4 md:px-5 py-10 text-sm text-slate-500">
      <div class="flex items-center justify-between flex-wrap gap-3">
        <div>© <span id="year"></span> ContentRepurpose.pro</div>
        <div class="flex items-center gap-4">
          <a href="/blog" class="hover:opacity-80">Blog</a>
          <a href="#pricing" class="hover:opacity-80">Pricing</a>
          <a href="mailto:support@contentrepurpose.pro" class="hover:opacity-80">Support</a>
        </div>
      </div>
    </div>
  </footer>

  <!-- Close body/html -->
</body>
</html>
