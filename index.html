<!doctype html>
<html lang="en" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>ContentRepurpose.pro — AI Content Repurposing Tool & Generator</title>
  <meta name="description" content="Content repurposing AI that turns one idea into LinkedIn, X, Email & Instagram drafts. Export to Notion & Trello. BYOK supported." />
  <link rel="canonical" href="https://contentrepurpose.pro/">
  <meta name="theme-color" content="#0a0d18">
  <meta name="color-scheme" content="dark light">
  <meta name="robots" content="index,follow,max-video-preview:-1,max-image-preview:large,max-snippet:-1">

  <!-- Open Graph -->
  <meta property="og:type" content="website">
  <meta property="og:title" content="ContentRepurpose.pro — AI Content Repurposing Tool">
  <meta property="og:description" content="Repurpose content with AI. Paste once → get LinkedIn, X, Email & Instagram drafts. Export to Notion & Trello. BYOK supported.">
  <meta property="og:url" content="https://contentrepurpose.pro/">
  <meta property="og:image" content="/og-cover.png">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="ContentRepurpose.pro — AI Content Generator">
  <meta name="twitter:description" content="Content repurposing AI for multi-channel drafts. Export to Notion & Trello. BYOK supported.">
  <meta name="twitter:image" content="/og-cover.png">

  <!-- Fonts + Tailwind -->
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Global CSS -->
  <style>
    :root{ --brandA:#7AA2FF; --brandB:#FF2D2D; --ink:#0a0d18 }
    html,body{font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .txt-grad{background:linear-gradient(135deg,var(--brandA),var(--brandB));-webkit-background-clip:text;background-clip:text;color:transparent}
    .bg-grad{background:linear-gradient(135deg,var(--brandA),var(--brandB))}
    .card{border-radius:1.25rem;border:1px solid rgba(15,23,42,.10);background:rgba(255,255,255,.80);box-shadow:0 12px 40px rgba(2,6,23,.08)}
    .badge{display:inline-flex;align-items:center;gap:.5rem;padding:.35rem .6rem;border-radius:9999px;border:1px solid rgba(255,255,255,.15);font-size:.75rem;background:rgba(255,255,255,.65)}
    .chip{font-size:.7rem;padding:.2rem .5rem;border-radius:9999px;border:1px solid rgba(148,163,184,.35)}
    .btn{padding:.6rem .9rem;border-radius:.9rem;border:1px solid rgba(148,163,184,.35)}
    .btn-primary{background:black;color:white}
    .glass{backdrop-filter: blur(12px); background:rgba(255,255,255,.62)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    .halo{position:absolute;filter:blur(60px);opacity:.55;pointer-events:none;transform:translateZ(0);
      background:radial-gradient(50% 50% at 50% 50%, rgba(122,162,255,.8), rgba(255,45,45,.65) 60%, transparent 70%);
      width:42rem;height:42rem;border-radius:50%;animation:float 16s ease-in-out infinite;}
    .halo.h2{width:34rem;height:34rem;right:-12rem;top:-6rem;animation-duration:18s;opacity:.5}
    .halo.h3{width:28rem;height:28rem;left:-10rem;top:26rem;animation-duration:22s;opacity:.45}
    @keyframes float{ 0%,100%{ transform: translate3d(0,0,0) } 50%{ transform: translate3d(0,-20px,0) } }
    .orbit{position:absolute;inset:-32px;border-radius:24px;pointer-events:none;
      background: conic-gradient(from 0deg, rgba(122,162,255,.25), rgba(255,45,45,.18), rgba(122,162,255,.25));
      -webkit-mask: radial-gradient(closest-side, transparent 88%, black 89%); mask: radial-gradient(closest-side, transparent 88%, black 89%);
      animation: spin 18s linear infinite;}
    @keyframes spin{ to{ transform: rotate(360deg) } }
    .mock{border-radius:1rem;border:1px solid rgba(255,255,255,.12); background:linear-gradient(180deg,rgba(255,255,255,.75),rgba(255,255,255,.6));}
    @media (prefers-color-scheme:dark){ body{background:var(--ink);color:#e9eef6} .card{background:rgba(14,16,22,.6);border-color:rgba(255,255,255,.08);box-shadow:0 24px 96px rgba(122,162,255,.08),0 14px 60px rgba(255,45,45,.06)} .badge{background:rgba(255,255,255,.06);border-color:rgba(255,255,255,.12)} .mock{ background:linear-gradient(180deg,rgba(17,20,31,.88),rgba(17,20,31,.72)); } }
    .marquee{ display:grid; grid-auto-flow:column; gap:2rem; align-items:center; animation: scrollx 26s linear infinite }
    .marquee:hover{ animation-play-state: paused } @keyframes scrollx{ from{ transform: translateX(0) } to{ transform: translateX(-50%) } }
    .nav-sheet{position:fixed; inset:0 0 auto 0; background:rgba(0,0,0,.6); backdrop-filter:blur(8px); display:none}
    .nav-panel{position:absolute; top:0; right:0; width:82vw; max-width:380px; height:100%; background:rgba(14,16,22,.96); border-left:1px solid rgba(255,255,255,.08); padding:1rem}
    .nav-open .nav-sheet{display:block}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
    .touch-target{min-height:40px;min-width:40px}

    /* Preview lock overlay (used for “Unlock preview”) */
    .preview-locked .preview-mask{display:flex}
    .preview-mask{display:none;position:absolute;inset:0;border-radius:1rem;align-items:end;justify-end;padding:.5rem}
    .preview-mask .cta{pointer-events:auto}

    /* Plan gates — safe defaults (no flashing Member text) */
    .only-guest{display:revert}
    .only-authed{display:none}
    .plan-starter-plus{display:none}
    .plan-creator-plus{display:none}
    .plan-business-only{display:none}
    body[data-auth="authed"] .only-guest{display:none}
    body[data-auth="authed"] .only-authed{display:revert}
    body[data-plan="starter"] .plan-starter-plus,
    body[data-plan="creator"] .plan-starter-plus,
    body[data-plan="business"] .plan-starter-plus{display:revert}
    body[data-plan="creator"] .plan-creator-plus,
    body[data-plan="business"] .plan-creator-plus{display:revert}
    body[data-plan="business"] .plan-business-only{display:revert}

    /* Toast */
    #toast{position:fixed;left:50%;bottom:24px;transform:translateX(-50%);z-index:60}
  </style>

  <!-- JSON-LD -->
  <script type="application/ld+json">{"@context":"https://schema.org","@type":"Organization","name":"ContentRepurpose.pro","url":"https://contentrepurpose.pro/","logo":"https://contentrepurpose.pro/logo.svg","sameAs":["https://x.com/contentrepurpose","https://www.linkedin.com/company/contentrepurpose"]}</script>
  <script type="application/ld+json">{"@context":"https://schema.org","@type":"WebSite","url":"https://contentrepurpose.pro/","name":"ContentRepurpose.pro","potentialAction":{"@type":"SearchAction","target":"https://contentrepurpose.pro/search?q={q}","query-input":"required name=q"}}</script>
  <script type="application/ld+json">{"@context":"https://schema.org","@type":"SoftwareApplication","name":"ContentRepurpose.pro","applicationCategory":"ContentCreationApplication","operatingSystem":"Web","offers":{"@type":"Offer","price":"0","priceCurrency":"USD"}}</script>

  <!-- Worker base (backend endpoints) -->
  <script>
    window.WORKER_BASE = "https://contentflow-worker.frank-couchman.workers.dev";
    window.SITE_ORIGIN = "https://contentrepurpose.pro";
  </script>

  <!-- Supabase v2 auth (OAuth + magic link) — reliable init & repaint -->
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";
    const SUPABASE_URL  = "https://ynkoavaeadlzlwylmfmu.supabase.co";
    const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlua29hdmFlYWRsemx3eWxtZm11Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5OTAxNDgsImV4cCI6MjA3MzU2NjE0OH0.1yM5yDo0MI9Upzt4GkLyf1mqvDXfb3DXvC0ouOLtRoU";

    // Single client; persistent sessions on; auto token refresh
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON, {
      auth: { persistSession:true, autoRefreshToken:true, detectSessionInUrl:true }
    });
    window.supabase = supabase;

    // Helpers used by the app
    window.getAuth = async () => {
      try {
        const { data } = await supabase.auth.getSession();
        const s = data?.session;
        return { token:s?.access_token||"", userId:s?.user?.id||null, email:s?.user?.email||null };
      } catch { return { token:"", userId:null, email:null }; }
    };
    window.getAuthHeaders = async () => {
      const { token, userId } = await window.getAuth();
      const h = { "Content-Type":"application/json" };
      if (token)  h["Authorization"] = `Bearer ${token}`;
      if (userId) h["X-User-Id"] = userId;
      return h;
    };

    function repaintAuth({authed, plan="free"}){
      document.body.setAttribute("data-auth", authed ? "authed" : "guest");
      document.body.setAttribute("data-plan", plan);
      const pretty = plan.charAt(0).toUpperCase()+plan.slice(1);
      const b1 = document.getElementById("planbadge");
      const b2 = document.getElementById("planbadge_m");
      if (b1) b1.textContent = `Plan: ${pretty}`;
      if (b2) b2.textContent = `Plan: ${pretty}`;
      const show = (id, on)=>{ const el=document.getElementById(id); if (el) el.classList.toggle("hidden", !on); };
      show("loginBtn", !authed); show("loginBtn_m", !authed);
      show("logoutBtn", authed);  show("logoutBtn_m", authed);
      show("manageBilling", authed); show("manageBilling_m", authed); show("manageBilling2", authed);
      const hp = document.getElementById("heroPlanName"); if (hp) hp.textContent = pretty;
    }

    async function completeRedirectsAndClean(){
      // Finish OAuth/magic link if needed and clean URL noise to avoid stray characters
      try{
        const u = new URL(location.href);
        const hasCode = u.searchParams.get("code");
        const err     = u.searchParams.get("error_description");
        if (err) console.warn("OAuth error:", err);
        if (hasCode) {
          await supabase.auth.exchangeCodeForSession({ code: hasCode });
          ["code","state","scope","provider_id","redirected_from"].forEach(p=>u.searchParams.delete(p));
          history.replaceState({}, "", u.toString());
        }
        // hash-based token callback (Google) → normalize URL
        if (location.hash.includes("access_token")) {
          await supabase.auth.getSession();
          history.replaceState({}, "", u.pathname + u.search);
        }
      }catch(e){ console.warn("Auth finalize error", e); }
    }

    document.addEventListener("DOMContentLoaded", async ()=>{
      // Initial safe paint: guest/free (prevents “?” / flicker)
      repaintAuth({authed:false, plan:"free"});

      await completeRedirectsAndClean();

      // Keep UI in sync with session changes
      supabase.auth.onAuthStateChange((_event, session)=>{
        repaintAuth({ authed: !!session, plan: "free" });
        try{ document.getElementById("auth")?.close(); }catch{}
        // Remaining plan/integration repaint happens in the main app boot (Part 4)
      });
    });
  </script>
</head>
<body class="min-h-full" data-auth="guest" data-plan="free">
  <!-- Decorative halos -->
  <div class="halo" style="left:-14rem; top:-10rem;"></div>
  <div class="halo h2"></div>
  <div class="halo h3"></div>

  <!-- Top nav -->
  <header class="sticky top-0 z-40 backdrop-blur bg-white/55 dark:bg-black/20 border-b border-white/30">
    <div class="max-w-7xl mx-auto px-4 md:px-5 py-4 flex items-center justify-between">
      <a href="/" class="flex items-center gap-3" aria-label="ContentRepurpose home">
        <svg width="36" height="36" viewBox="0 0 48 48" class="rounded-xl" aria-hidden="true">
          <defs><linearGradient id="g" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#7AA2FF"/><stop offset="100%" stop-color="#FF2D2D"/></linearGradient></defs>
          <rect x="0" y="0" width="48" height="48" rx="12" fill="url(#g)"/>
          <path d="M14 16h10a6 6 0 0 1 0 12H20v4h-6V16zm6 6v4h4a2 2 0 1 0 0-4h-4z" fill="white"/>
          <path d="M28 16h6v16h-6z" fill="white" opacity=".9"/>
        </svg>
        <span class="font-semibold tracking-tight">Content<span class="txt-grad">Repurpose</span></span>
      </a>

      <nav class="hidden md:flex items-center gap-6 text-sm">
        <a href="#demo" class="hover:opacity-80">Live Demo</a>
        <a href="https://contentrepurpose.pro/blog/linkedin-post-templates/" class="hover:opacity-80">Templates</a>
        <a href="#use-cases" class="hover:opacity-80">Use cases</a>
        <a href="#best-picks" class="hover:opacity-80">Best picks</a>
        <a href="#pricing" class="hover:opacity-80">Pricing</a>
        <a href="/blog" class="hover:opacity-80">Blog</a>
        <span id="planbadge" class="px-3 py-1 rounded-full text-xs bg-white/70 dark:bg-white/10 border border-white/50">Plan: Free</span>
        <button id="manageBilling" class="px-3 py-1 rounded-lg border hidden">Manage billing</button>
        <div class="flex items-center gap-2">
          <button id="loginBtn" class="px-3 py-1 rounded-lg border only-guest">Sign in</button>
          <button id="logoutBtn" class="px-3 py-1 rounded-lg border only-authed hidden">Sign out</button>
        </div>
      </nav>

      <button id="navToggle" class="md:hidden touch-target px-3 py-2 rounded-lg border" aria-expanded="false" aria-controls="mobileNav" aria-label="Open menu">☰</button>
    </div>

    <!-- Promo strip -->
    <div class="border-t border-white/40 bg-white/70 dark:bg-white/10">
      <div class="max-w-7xl mx-auto px-4 md:px-5 py-2 flex flex-wrap items-center justify-between gap-3 text-sm">
        <div class="flex items-center gap-2">
          <span class="px-2 py-0.5 rounded-full text-[11px] bg-black/80 text-white">LIMITED</span>
          <span>Use <strong class="mono">CONTENTOFF90</strong> for <strong>90% off</strong> the Creator plan.</span>
        </div>
        <div class="flex items-center gap-2">
          <button id="copyPromoBtn" class="px-3 py-1 rounded-lg border">Copy code</button>
          <a href="#pricing" class="px-3 py-1 rounded-lg bg-black text-white">See pricing</a>
        </div>
      </div>
    </div>

    <!-- Mobile sheet -->
    <div id="mobileNav" class="nav-sheet" aria-hidden="true">
      <div class="nav-panel text-sm text-white">
        <div class="flex items-center justify-between">
          <span class="font-semibold">Menu</span>
          <button id="navClose" class="touch-target px-3 py-2 rounded-lg border border-white/20" aria-label="Close menu">✕</button>
        </div>
        <nav class="mt-4 grid gap-2">
          <a href="#demo" class="px-3 py-2 rounded-lg hover:bg-white/10">Live Demo</a>
          <a href="https://contentrepurpose.pro/blog/linkedin-post-templates/" class="px-3 py-2 rounded-lg hover:bg-white/10">Templates</a>
          <a href="#use-cases" class="px-3 py-2 rounded-lg hover:bg-white/10">Use cases</a>
          <a href="#best-picks" class="px-3 py-2 rounded-lg hover:bg-white/10">Best picks</a>
          <a href="#pricing" class="px-3 py-2 rounded-lg hover:bg-white/10">Pricing</a>
          <a href="/blog" class="px-3 py-2 rounded-lg hover:bg-white/10">Blog</a>
        </nav>
        <div class="mt-6 grid gap-2">
          <span id="planbadge_m" class="px-3 py-1 rounded-full text-xs bg-white/10 border border-white/20 w-fit">Plan: Free</span>
          <button id="manageBilling_m" class="px-3 py-2 rounded-lg border border-white/20 hidden">Manage billing</button>
          <button id="loginBtn_m" class="px-3 py-2 rounded-lg border border-white/20 only-guest">Sign in</button>
          <button id="logoutBtn_m" class="px-3 py-2 rounded-lg border border-white/20 only-authed hidden">Sign out</button>
        </div>
      </div>
    </div>
  </header>

  <!-- Auth dialog -->
  <dialog id="auth" class="rounded-xl p-0 w-[92vw] max-w-md">
    <form method="dialog" class="p-5 grid gap-4">
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-semibold">Sign in</h3>
        <button class="btn" value="cancel">Close</button>
      </div>
      <p class="text-sm text-slate-500">Enter your email to receive a magic link or continue with Google.</p>
      <input id="authEmail" type="email" required placeholder="you@domain.com" class="border rounded-lg px-3 py-2">
      <div class="grid grid-cols-2 gap-2">
        <button id="authSend" class="btn btn-primary" type="button">Send magic link</button>
        <button id="authGoogle" class="btn" type="button">Continue with Google</button>
      </div>
      <p id="authNote" class="text-xs text-slate-500">We’ll never share your email.</p>
    </form>
  </dialog>

  <!-- Global toast (used by all parts; prevents UI “?” artifacts from alerts) -->
  <div id="toast" class="hidden">
    <div id="toastMsg" class="px-4 py-2 rounded-lg shadow card bg-white/90 dark:bg-white/10 border border-white/40 text-sm"></div>
  </div>
  <!-- ===== HERO ===== -->
  <section class="relative" id="hero">
    <div class="max-w-7xl mx-auto px-4 md:px-5 pt-10 md:pt-16 grid lg:grid-cols-2 gap-8 md:gap-10 items-center">
      <!-- Left: copy + CTAs -->
      <div>
        <div id="heroBadgeWrap" class="inline-flex items-center gap-2 px-3 py-1 rounded-full text-xs bg-white/70 dark:bg-white/10 border border-white/40">
          <span class="w-2 h-2 rounded-full bg-emerald-500"></span>
          <span class="only-guest">Demo — <strong class="mx-1">5 runs / month</strong> (no login)</span>
          <span class="only-authed hidden">Signed in — <strong id="heroPlanName">Free</strong> plan active</span>
        </div>

        <h1 class="mt-4 text-3xl md:text-5xl font-black leading-tight tracking-tight">
          AI <span class="txt-grad">Content Repurposing Tool</span> — turn one idea into everywhere content.
        </h1>

        <p class="mt-4 text-slate-600 dark:text-slate-300 max-w-xl">
          Paste content → get <strong>LinkedIn</strong>, <strong>X</strong>, <strong>Email</strong> &amp; <strong>Instagram</strong> drafts.
          Export to <strong>Notion</strong> or <strong>Trello</strong>. BYOK supported.
        </p>

        <!-- CTA rail -->
        <div class="mt-6 flex flex-wrap gap-3">
          <a href="#demo" class="px-4 py-3 rounded-xl font-semibold text-white bg-black hover:opacity-90 only-guest">Try the Live Demo</a>
          <a href="#demo" class="px-4 py-3 rounded-xl font-semibold text-white bg-black hover:opacity-90 only-authed hidden">Open Generator</a>
          <a href="#pricing" class="px-4 py-3 rounded-xl font-semibold border border-slate-300/60 hover:bg-white/50">See pricing</a>
          <button id="heroSignIn" class="px-4 py-3 rounded-xl font-semibold border border-slate-300/60 only-guest">Sign in</button>
        </div>

        <div class="mt-6 flex items-center gap-3 text-xs text-slate-500 dark:text-slate-400">
          <span class="badge">AI Content Generator</span>
          <span class="badge">Repurposing Tool</span>
          <span class="badge">SEO-ready</span>
          <span class="badge">BYOK</span>
        </div>

        <!-- Trust strip -->
        <div class="mt-8 overflow-hidden">
          <div class="flex items-center gap-4 text-[11px] uppercase tracking-widest text-slate-500">
            <span class="chip">Creators</span>
            <span class="chip">Marketers</span>
            <span class="chip">Newsletters</span>
            <span class="chip">Teams</span>
          </div>
          <div class="relative mt-4">
            <div class="marquee opacity-70">
              <div class="chip">LinkedIn-first</div>
              <div class="chip">Editorial-friendly</div>
              <div class="chip">Email copy</div>
              <div class="chip">Instagram captions</div>
              <div class="chip">Notion export</div>
              <div class="chip">Trello sync</div>
              <div class="chip">Keyword-aware</div>
              <div class="chip">Tone controls</div>
              <!-- duplicate for seamless scroll -->
              <div class="chip">LinkedIn-first</div>
              <div class="chip">Editorial-friendly</div>
              <div class="chip">Email copy</div>
              <div class="chip">Instagram captions</div>
              <div class="chip">Notion export</div>
              <div class="chip">Trello sync</div>
              <div class="chip">Keyword-aware</div>
              <div class="chip">Tone controls</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Right: visual mocks -->
      <div class="relative">
        <div class="orbit" aria-hidden="true"></div>
        <div class="grid gap-4">
          <div class="mock p-4 card">
            <div class="text-xs text-slate-400">Command</div>
            <pre class="mono text-xs bg-black/85 text-emerald-200 rounded-xl p-4 h-40 overflow-auto" aria-label="CLI Preview">repurpose generate --channels linkedin,x,email,instagram
outline created
3 social variants
email subject + body ready
instagram caption + hashtags</pre>
          </div>
          <div class="grid md:grid-cols-2 gap-4">
            <div class="mock p-4 card">
              <div class="text-xs text-slate-400">LinkedIn</div>
              <div class="mt-2 h-24 text-sm text-slate-200/90 leading-relaxed">
                • Hook that earns the scroll<br>
                • 6–10 crisp lines, one CTA<br>
                • On-brand tone &amp; keywords
              </div>
            </div>
            <div class="mock p-4 card">
              <div class="text-xs text-slate-400">X (Twitter)</div>
              <div class="mt-2 h-24 text-sm text-slate-200/90 leading-relaxed">
                Two fast variants<br>
                Always ≤ 280 chars<br>
                Ready to post ✓
              </div>
            </div>
          </div>
          <div class="grid md:grid-cols-2 gap-4">
            <div class="mock p-4 card">
              <div class="text-xs text-slate-400">Email</div>
              <div class="mt-2 h-20 text-sm text-slate-200/90 leading-relaxed">
                Subject &amp; body prepped<br>
                Preview &amp; send from your client
              </div>
            </div>
            <div class="mock p-4 card">
              <div class="text-xs text-slate-400">Instagram</div>
              <div class="mt-2 h-20 text-sm text-slate-200/90 leading-relaxed">
                Caption + 3–5 hashtags<br>
                Short, skimmable, on-brand
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Live activity strip (hero) -->
    <div class="mt-8 md:mt-10">
      <div class="max-w-7xl mx-auto px-4 md:px-5">
        <div class="card p-4 md:p-5">
          <div class="flex items-center justify-between flex-wrap gap-3">
            <div class="flex items-center gap-2">
              <span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span>
              <strong class="tracking-tight">Generations today</strong>
              <span class="chip" data-live-count>–</span>
            </div>
            <div class="text-xs text-slate-500">Real results update every 30s</div>
          </div>
          <div class="mt-3 overflow-hidden">
            <div class="flex gap-3 whitespace-nowrap text-[13px] will-change-transform" style="animation: scrollx 28s linear infinite" data-live-feed></div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- ===== LIVE DEMO / GENERATOR ===== -->
  <section id="demo" class="relative scroll-mt-24">
    <div class="max-w-7xl mx-auto px-4 md:px-5 py-14 md:py-20">
      <div class="flex items-end justify-between gap-4 mb-6">
        <div>
          <h2 class="text-2xl md:text-3xl font-black tracking-tight">Generator</h2>
          <!-- Copy changes by auth state -->
          <p class="mt-1 text-slate-500 dark:text-slate-300 text-sm only-guest">
            No login needed — <span class="font-semibold">5 runs/month</span> on the public pool.
          </p>
          <p class="mt-1 text-slate-500 dark:text-slate-300 text-sm only-authed hidden">
            Signed in — your plan limits apply per day/month by tier.
          </p>
        </div>
        <div class="flex items-center gap-3">
          <a href="#pricing" class="btn">See pricing</a>
          <button class="btn btn-primary js-open-auth only-guest" type="button">Sign in</button>
        </div>
      </div>

      <!-- Conversion rail -->
      <div class="card p-4 md:p-5 mb-6">
        <div class="flex flex-wrap items-center justify-between gap-3">
          <div class="flex items-center gap-2 text-sm">
            <span class="badge">LIMITED</span>
            <span>Use <strong class="mono">CONTENTOFF90</strong> for <strong>90% off</strong> the Creator plan.</span>
          </div>
          <div class="flex items-center gap-2">
            <button id="copyPromoBtn2" class="btn" type="button">Copy code</button>
            <a class="btn btn-primary" href="#pricing">Upgrade</a>
          </div>
        </div>
      </div>

      <!-- Generator Form -->
      <div class="card p-5 md:p-6">
        <form id="demoForm" class="grid gap-6" autocomplete="off">
          <!-- Source selector -->
          <fieldset>
            <legend class="text-sm font-semibold">Source</legend>
            <div class="mt-2 grid md:grid-cols-3 gap-3">
              <label class="tab flex items-center justify-between">
                <span class="flex items-center gap-2">
                  <input type="radio" name="sourceType" value="paragraph" checked>
                  Paragraph / Notes
                </span>
                <span class="chip">fastest</span>
              </label>
              <label class="tab flex items-center">
                <input type="radio" name="sourceType" value="blog" class="mr-2">
                Full Blog
              </label>
              <label class="tab flex items-center">
                <input type="radio" name="sourceType" value="url" class="mr-2">
                URL
              </label>
            </div>
            <div class="mt-3">
              <textarea id="sourceText" class="w-full rounded-xl border p-4 min-h-[140px]"
                placeholder="Paste your paragraph, full article, or a URL."></textarea>
            </div>
          </fieldset>

          <!-- Article Optimizer (signed-in feature; preview for Free) -->
          <fieldset class="relative">
            <legend class="text-sm font-semibold">Article Optimizer (optional)</legend>
            <div class="mt-2 grid sm:grid-cols-2 lg:grid-cols-3 gap-2">
              <label class="flex items-center gap-2"><input type="checkbox" name="opt_humanize" checked> Humanize content</label>
              <label class="flex items-center gap-2"><input type="checkbox" name="opt_lengthen" value="30"> Lengthen ~30%</label>
              <label class="flex items-center gap-2"><input type="checkbox" name="opt_faqs"> Add FAQs (+ JSON-LD)</label>
              <label class="flex items-center gap-2"><input type="checkbox" name="opt_headings" checked> Auto-headings (H2/H3)</label>
              <label class="flex items-center gap-2"><input type="checkbox" name="opt_meta" checked> Improve title & meta (CTR)</label>
              <label class="flex items-center gap-2"><input type="checkbox" name="opt_ab" checked> A/B test 5 titles</label>
              <label class="flex items-center gap-2"><input type="checkbox" name="opt_seo" checked> SEO check (alt/links/length)</label>
              <label class="flex items-center gap-2"><input type="checkbox" name="opt_svg"> Add platform-fit SVG ideas</label>
            </div>

            <div class="mt-3 grid md:grid-cols-3 gap-3">
              <label class="grid gap-1">
                <span class="text-xs text-slate-500">Focus keyword</span>
                <input name="seo_keyword" class="border rounded-lg px-3 py-2" placeholder="e.g. content repurposing for SEO" />
              </label>
              <label class="grid gap-1">
                <span class="text-xs text-slate-500">Secondary keywords (comma-sep)</span>
                <input name="seo_secondaries" class="border rounded-lg px-3 py-2" placeholder="content repurposing strategy, social media repurposing" />
              </label>
              <label class="grid gap-1">
                <span class="text-xs text-slate-500">Target SERP intent</span>
                <select name="seo_intent" class="border rounded-lg px-3 py-2">
                  <option value="informational" selected>Informational</option>
                  <option value="commercial">Commercial</option>
                  <option value="transactional">Transactional</option>
                  <option value="navigational">Navigational</option>
                </select>
              </label>
            </div>

            <p class="mt-2 text-[12px] text-slate-500">
              We’ll also provide: <em>estimated ranking likelihood</em> for your focus keyword, <em>alt keyword ideas</em> to try, and a
              <em>meta description</em> tuned for CTR.
            </p>

            <!-- Plan caps hint -->
            <div class="mt-2 text-[12px] text-slate-500">
              <span class="chip">Starter: up to 5/day</span>
              <span class="chip">Creator: up to 15/day</span>
              <span class="chip">Business: up to 30/day</span>
            </div>
          </fieldset>

          <!-- Channels -->
          <fieldset>
            <legend class="text-sm font-semibold">Channels to generate</legend>
            <div class="mt-2 grid sm:grid-cols-2 lg:grid-cols-4 gap-2">
              <label class="flex items-center gap-2"><input type="checkbox" name="ch_linkedin" checked> LinkedIn</label>
              <label class="flex items-center gap-2"><input type="checkbox" name="ch_x" checked> X (Twitter)</label>
              <label class="flex items-center gap-2"><input type="checkbox" name="ch_email" checked> Email</label>
              <label class="flex items-center gap-2"><input type="checkbox" name="ch_instagram"> Instagram</label>
              <label class="flex items-center gap-2"><input type="checkbox" name="ch_reddit" checked> Reddit</label>
              <label class="flex items-center gap-2"><input type="checkbox" name="ch_facebook"> Facebook</label>
              <label class="flex items-center gap-2"><input type="checkbox" name="ch_quora"> Quora</label>
              <label class="flex items-center gap-2"><input type="checkbox" name="ch_tiktok"> TikTok</label>
            </div>
          </fieldset>

          <!-- Channel-specific extras -->
          <div class="grid md:grid-cols-2 gap-6">
            <fieldset class="card p-4">
              <legend class="text-sm font-semibold">LinkedIn</legend>
              <label class="flex items-center gap-2 mt-2"><input type="checkbox" name="li_article"> Also generate a LinkedIn Article</label>
            </fieldset>

            <fieldset class="card p-4">
              <legend class="text-sm font-semibold">X (Twitter)</legend>
              <div class="mt-2 flex items-center gap-3">
                <label class="flex items-center gap-2"><input type="checkbox" name="x_sequence" checked> Output as sequence</label>
                <label class="flex items-center gap-2">
                  Max posts:
                  <select name="x_posts" class="border rounded-lg px-2 py-1">
                    <option>2</option><option selected>4</option><option>6</option>
                  </select>
                </label>
              </div>
            </fieldset>

            <fieldset class="card p-4">
              <legend class="text-sm font-semibold">Reddit</legend>
              <label class="flex items-center gap-2 mt-2"><input type="checkbox" name="rdt_communities" checked> Suggest best communities (with rules & flair tips)</label>
              <label class="flex items-center gap-2 mt-2"><input type="checkbox" name="rdt_comments" checked> Include 3 starter comment angles</label>
            </fieldset>

            <fieldset class="card p-4">
              <legend class="text-sm font-semibold">TikTok</legend>
              <label class="flex items-center gap-2 mt-2"><input type="checkbox" name="tt_hooks" checked> Provide 3 hook variants</label>
              <label class="flex items-center gap-2 mt-2"><input type="checkbox" name="tt_onscreen" checked> Include on-screen text plan</label>
            </fieldset>
          </div>

          <!-- Actions -->
          <div class="flex flex-wrap items-center gap-3">
            <button id="generateBtn" type="submit" class="px-4 py-3 rounded-xl font-semibold text-white bg-black hover:opacity-90 only-guest">
              Generate (demo)
            </button>
            <button id="generateBtn_member" type="submit" class="px-4 py-3 rounded-xl font-semibold text-white bg-black hover:opacity-90 only-authed hidden">
              Generate
            </button>
            <button type="button" id="clearBtn" class="px-4 py-3 rounded-xl font-semibold border">Clear</button>

            <!-- Quota copy varies -->
            <div class="text-sm text-slate-500 only-guest">
              You have <span id="demoQuota">—</span> demo runs left this month.
            </div>
            <div class="text-sm text-slate-500 only-authed hidden">
              You have <span id="memberQuota">—</span> runs left today.
            </div>

            <a href="#pricing" class="text-sm underline hover:opacity-80 ml-auto">Need more? See plans</a>
          </div>
        </form>
      </div>

      <!-- OUTPUT -->
      <div id="demoOutput" class="mt-8 grid gap-6" aria-live="polite" aria-busy="false">
        <!-- Channel cards injected here -->
      </div>

      <!-- QUICK PUBLISH (authed) -->
      <div class="mt-10 card p-5 only-authed hidden">
        <div class="flex items-center justify-between flex-wrap gap-3">
          <strong class="tracking-tight">Quick publish</strong>
          <div class="text-xs text-slate-500">Works with your last generation’s outputs.</div>
        </div>
        <div class="mt-4 grid sm:grid-cols-2 lg:grid-cols-4 gap-3">
          <button id="qp-x" class="btn" type="button">Post to X</button>
          <button id="qp-reddit" class="btn" type="button">Open Reddit submit</button>
          <button id="qp-linkedin" class="btn" type="button">Copy for LinkedIn &amp; open</button>
          <button id="qp-email" class="btn" type="button">Send email draft</button>
        </div>

        <!-- Creator+ integrations -->
        <div class="mt-4 grid sm:grid-cols-2 gap-3 plan-creator-plus">
          <button id="li-notion" class="btn" type="button">Export to Notion</button>
          <button id="li-trello" class="btn" type="button">Send to Trello</button>
        </div>
        <div class="mt-2 text-xs text-slate-500 plan-creator-plus">
          Notion/Trello require connecting once from this device. Find them in Settings → Integrations.
        </div>
      </div>

      <!-- Live strip (section-local, unique IDs) -->
      <div class="mt-10">
        <div class="card p-4 md:p-5">
          <div class="flex items-center justify-between flex-wrap gap-3">
            <div class="flex items-center gap-2">
              <span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span>
              <strong class="tracking-tight">Generations today</strong>
              <span id="liveCount" class="chip">–</span>
            </div>
            <div class="text-xs text-slate-500">Real results update every 30s</div>
          </div>
          <div class="mt-3 overflow-hidden">
            <div id="liveFeed" class="flex gap-3 whitespace-nowrap text-[13px] will-change-transform" style="animation: scrollx 28s linear infinite"></div>
          </div>
        </div>
      </div>
    </div>
  </section>
  <!-- ===== USE CASES (Topical authority + internal links) ===== -->
  <section id="use-cases" class="relative scroll-mt-24">
    <div class="max-w-7xl mx-auto px-4 md:px-5 py-14 md:py-20">
      <div class="text-center mb-10">
        <h2 class="text-3xl md:text-4xl font-black tracking-tight">Use cases</h2>
        <p class="mt-2 text-slate-600 dark:text-slate-300">See how ContentRepurpose outperforms point tools across your workflow.</p>
      </div>

      <div class="grid md:grid-cols-3 gap-6">
        <a class="card p-5 hover:opacity-95" href="https://contentrepurpose.pro/blog/ai-social-media-post-generator/" target="_blank" rel="noopener">
          <strong>AI Social Media Post Generator</strong>
          <p class="text-sm mt-2 text-slate-500">From one input to multi-channel drafts that fit each platform.</p>
        </a>
        <a class="card p-5 hover:opacity-95" href="https://contentrepurpose.pro/blog/paste-once-multi-channel/" target="_blank" rel="noopener">
          <strong>Paste once, multi-channel</strong>
          <p class="text-sm mt-2 text-slate-500">Single paste → LinkedIn, X, Email, Instagram, Reddit and more.</p>
        </a>
        <a class="card p-5 hover:opacity-95" href="https://contentrepurpose.pro/blog/ai-content-repurposing/" target="_blank" rel="noopener">
          <strong>AI content repurposing</strong>
          <p class="text-sm mt-2 text-slate-500">Modern workflows for speed without losing editorial control.</p>
        </a>

        <a class="card p-5 hover:opacity-95" href="https://contentrepurpose.pro/blog/content-repurposing-for-seo/" target="_blank" rel="noopener">
          <strong>Repurposing for SEO</strong>
          <p class="text-sm mt-2 text-slate-500">Turn articles into search-aligned social narratives.</p>
        </a>
        <a class="card p-5 hover:opacity-95" href="https://contentrepurpose.pro/blog/repurpose-blog-post-for-social-media/" target="_blank" rel="noopener">
          <strong>Repurpose blog → social</strong>
          <p class="text-sm mt-2 text-slate-500">Max reach with headline, hooks, captions and CTAs.</p>
        </a>
        <a class="card p-5 hover:opacity-95" href="https://contentrepurpose.pro/blog/ai-content-repurposing-examples-workflows/" target="_blank" rel="noopener">
          <strong>Examples and workflows</strong>
          <p class="text-sm mt-2 text-slate-500">Real examples you can copy and paste into your projects.</p>
        </a>
      </div>

      <!-- Authority cluster (useful for users; internal links for crawl) -->
      <div class="text-xs text-slate-500 mt-6 flex flex-wrap gap-3">
        <a href="https://contentrepurpose.pro/blog/content-repurposing-101/" target="_blank" rel="noopener">Content repurposing 101</a> ·
        <a href="https://contentrepurpose.pro/blog/content-repurposing-strategy/" target="_blank" rel="noopener">Strategy</a> ·
        <a href="https://contentrepurpose.pro/blog/how-to-repurpose-content/" target="_blank" rel="noopener">How-to guide</a> ·
        <a href="https://contentrepurpose.pro/blog/content-repurposing-ideas/" target="_blank" rel="noopener">Ideas</a> ·
        <a href="https://contentrepurpose.pro/blog/repurpose-one-piece-multiple-platforms/" target="_blank" rel="noopener">One piece → many</a> ·
        <a href="https://contentrepurpose.pro/blog/ai-vs-manual-content-repurposing/" target="_blank" rel="noopener">AI vs manual</a> ·
        <a href="https://contentrepurpose.pro/blog/ai-search-ranking-with-repurposed-content/" target="_blank" rel="noopener">Search ranking</a> ·
        <a href="https://contentrepurpose.pro/blog/ai-content-repurposing-benefits-risks-roi-2025/" target="_blank" rel="noopener">Benefits, risks and ROI</a> ·
        <a href="https://contentrepurpose.pro/blog/best-ai-content-repurposing-tools-2025/" target="_blank" rel="noopener">Best tools 2025</a> ·
        <a href="https://contentrepurpose.pro/blog/notion-trello-export/" target="_blank" rel="noopener">Notion and Trello export</a> ·
        <a href="https://contentrepurpose.pro/blog/free-ai-linkedin-post-generator/" target="_blank" rel="noopener">Free AI LinkedIn post generator</a> ·
        <a href="https://contentrepurpose.pro/blog/linkedin-post-templates/" target="_blank" rel="noopener">LinkedIn post templates</a> ·
        <a href="https://contentrepurpose.pro/blog/contentrepurpose-vs-missinglettr/" target="_blank" rel="noopener">vs Missinglettr</a> ·
        <a href="https://contentrepurpose.pro/blog/contentrepurpose-vs-writesonic/" target="_blank" rel="noopener">vs Writesonic</a>
      </div>
    </div>
  </section>

  <!-- ===== TEMPLATES QUICK LINK ===== -->
  <section id="templates" class="relative scroll-mt-24">
    <div class="max-w-7xl mx-auto px-4 md:px-5 py-8">
      <div class="card p-5 flex items-center justify-between gap-4">
        <div>
          <h3 class="font-semibold">Templates</h3>
          <p class="text-sm text-slate-500">Grab our LinkedIn post templates and kickstart your draft.</p>
        </div>
        <a class="btn btn-primary"
           href="https://contentrepurpose.pro/blog/linkedin-post-templates/"
           target="_blank" rel="noopener">Open templates</a>
      </div>
    </div>
  </section>

  <!-- ===== PRICING ===== -->
  <section id="pricing" class="relative scroll-mt-24">
    <div class="max-w-7xl mx-auto px-4 md:px-5 py-14 md:py-20">
      <div class="text-center mb-10">
        <h2 class="text-3xl md:text-4xl font-black tracking-tight">Simple, honest pricing</h2>
        <p class="mt-2 text-slate-600 dark:text-slate-300">Start free. Add power when you need it.</p>
      </div>

      <!-- Conversion rail -->
      <div class="card p-4 md:p-5 mb-6 flex flex-wrap items-center justify-between gap-3">
        <div class="flex items-center gap-2 text-sm">
          <span class="badge">LIMITED</span>
          <span>Use <strong class="mono">CONTENTOFF90</strong> for <strong>90% off</strong> your first month of <strong>Creator</strong>.</span>
        </div>
        <div class="flex items-center gap-2">
          <button id="copyPromoBtn_pr" class="btn" type="button">Copy code</button>
          <a href="#demo" class="btn only-guest">Try Demo</a>
          <button id="manageBilling2" class="btn hidden only-authed" type="button">Manage billing</button>
          <button class="btn btn-primary js-open-auth only-guest" type="button">Sign in</button>
        </div>
      </div>

      <div class="grid lg:grid-cols-4 gap-6">
        <!-- FREE -->
        <div class="card p-6 flex flex-col">
          <div class="text-sm px-3 py-1 rounded-full bg-white/70 dark:bg-white/10 border w-fit">Free</div>
          <h3 class="mt-3 text-xl font-bold">Demo + Account</h3>
          <div class="mt-2 text-3xl font-extrabold">$0<span class="text-sm text-slate-500">/forever</span></div>
          <ul class="mt-4 text-sm space-y-2">
            <li>• Demo (no login): <strong>5 runs/month</strong></li>
            <li>• Free account: <strong>5 runs/day</strong></li>
            <li>• 1× <strong>Article Optimizer</strong> (after verification)</li>
            <li>• BYOK: <strong>5/day</strong></li>
            <li>• CSV/Markdown export</li>
          </ul>
          <a href="#demo" class="mt-6 block text-center btn">Start free</a>
        </div>

        <!-- STARTER -->
        <div class="card p-6 flex flex-col">
          <div class="text-sm px-3 py-1 rounded-full bg-white/70 dark:bg-white/10 border w-fit">Starter</div>
          <h3 class="mt-3 text-xl font-bold">Solo Creator</h3>
          <div class="mt-2 text-3xl font-extrabold">$9<span class="text-sm text-slate-500">/mo</span></div>
          <ul class="mt-4 text-sm space-y-2">
            <li>• <strong>200 generations/month</strong></li>
            <li>• Batch inputs (up to 5 lines/run)</li>
            <li>• 10 saved presets</li>
            <li>• Priority models</li>
            <li>• BYOK: 50/month (+5 daily headroom)</li>
            <li>• <strong>Scheduler</strong> (queue and calendar)</li>
            <li>• <strong>Analytics</strong> (basics)</li>
            <li>• <strong>Article Optimizer</strong>: up to 5/day</li>
          </ul>
          <button
            data-price="price_1S7y58JYjIKHzKcjzL7cIKiB"
            class="mt-6 w-full btn btn-primary js-checkout subBtn"
            type="button">Get Starter</button>
        </div>

        <!-- CREATOR (featured) -->
        <div class="card p-6 flex flex-col ring-1 ring-black/5 relative">
          <span class="absolute -top-3 left-1/2 -translate-x-1/2 text-xs px-3 py-1 rounded-full bg-grad text-white shadow">Best value</span>
          <h3 class="mt-1 text-xl font-bold">Creator</h3>
          <div class="mt-2 text-3xl font-extrabold">$19<span class="text-sm text-slate-500">/mo</span></div>
          <ul class="mt-4 text-sm space-y-2">
            <li>• <strong>500 generations/month</strong></li>
            <li>• Unlimited presets</li>
            <li>• Project pack export</li>
            <li>• Notion export and Trello boards</li>
            <li>• Push drafts to Buffer</li>
            <li>• New workflows early</li>
            <li>• BYOK: 150/month (+10 daily)</li>
            <li>• <strong>Scheduler</strong> (multi-profile)</li>
            <li>• <strong>Analytics Pro</strong> (per-channel)</li>
            <li>• <strong>Article Optimizer</strong>: up to 15/day</li>
          </ul>
          <button
            data-price="price_1S7y77JYjIKHzKcjKQYjiqZH"
            class="mt-6 w-full btn btn-primary js-checkout subBtn"
            type="button">Get Creator</button>
        </div>

        <!-- BUSINESS -->
        <div class="card p-6 flex flex-col">
          <div class="text-sm px-3 py-1 rounded-full bg-white/70 dark:bg-white/10 border w-fit">Team</div>
          <h3 class="mt-3 text-xl font-bold">Business</h3>
          <div class="mt-2 text-3xl font-extrabold">$49<span class="text-sm text-slate-500">/mo</span></div>
          <ul class="mt-4 text-sm space-y-2">
            <li>• <strong>Unlimited</strong> (fair use)</li>
            <li>• 3 seats included</li>
            <li>• White-label export</li>
            <li>• Priority support</li>
            <li>• All Creator integrations</li>
            <li>• Team presets and shared calendar</li>
            <li>• BYOK: 300/month (+30 daily)</li>
            <li>• <strong>Team Analytics</strong> (org-wide)</li>
            <li>• <strong>Article Optimizer</strong>: up to 30/day</li>
          </ul>
          <button
            data-price="price_1S7y8OJYjIKHzKcjqA9uJdyh"
            class="mt-6 w-full btn js-checkout subBtn"
            type="button">Get Business</button>
        </div>
      </div>

      <!-- Why upgrade -->
      <div class="grid md:grid-cols-3 gap-6 mt-10">
        <div class="stat">
          <div class="k">Faster queues</div>
          <p class="text-sm text-slate-500 dark:text-slate-400">Paid lanes hit priority models with fewer rate limits.</p>
        </div>
        <div class="stat">
          <div class="k">Scheduler</div>
          <p class="text-sm text-slate-500 dark:text-slate-400">Queue multi-channel posts and see your week at a glance.</p>
        </div>
        <div class="stat">
          <div class="k">Integrations</div>
          <p class="text-sm text-slate-500 dark:text-slate-400">Push to Notion, Trello and Buffer in one click.</p>
        </div>
      </div>

      <!-- ===== FAQ (shell) ===== -->
      <div id="faq" class="mt-14">
        <h3 class="text-2xl md:text-3xl font-black tracking-tight">Frequently asked questions</h3>
        <div class="mt-6 grid md:grid-cols-2 gap-4">
          <details class="card p-4">
            <summary class="font-semibold cursor-pointer">What counts as a generation?</summary>
            <p class="mt-2 text-sm text-slate-500 dark:text-slate-300">
              Any click on Generate that returns content (demo or signed-in). Batch mode counts per line.
            </p>
          </details>
          <details class="card p-4">
            <summary class="font-semibold cursor-pointer">Is the Article Optimizer included?</summary>
            <p class="mt-2 text-sm text-slate-500 dark:text-slate-300">
              Yes for all paid plans (daily caps by tier). Free users get one verified run.
            </p>
          </details>
          <details class="card p-4">
            <summary class="font-semibold cursor-pointer">What is BYOK?</summary>
            <p class="mt-2 text-sm text-slate-500 dark:text-slate-300">
              Bring Your Own Key — use your own model API key for extra capacity. We never store your key in plaintext.
            </p>
          </details>
          <details class="card p-4">
            <summary class="font-semibold cursor-pointer">Can I cancel anytime?</summary>
            <p class="mt-2 text-sm text-slate-500 dark:text-slate-300">
              Absolutely. Manage billing from your dashboard; your plan remains active until the end of the cycle.
            </p>
          </details>
          <details class="card p-4">
            <summary class="font-semibold cursor-pointer">Do you support teams?</summary>
            <p class="mt-2 text-sm text-slate-500 dark:text-slate-300">
              Yes — the Business plan includes 3 seats, shared calendar, org analytics and white-label exports.
            </p>
          </details>
          <details class="card p-4">
            <summary class="font-semibold cursor-pointer">Which platforms can you export to?</summary>
            <p class="mt-2 text-sm text-slate-500 dark:text-slate-300">
              Notion and Trello on Creator+, plus Buffer queueing for LinkedIn, X, Facebook and Instagram.
            </p>
          </details>
        </div>
      </div>
    </div>
  </section>
  <!-- ===== AUTH DIALOG (markup only; wired in Part 6) ===== -->
  <dialog id="auth" class="rounded-xl p-0 w-[92vw] max-w-md">
    <form method="dialog" class="p-5 grid gap-4">
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-semibold">Sign in</h3>
        <button class="btn" value="cancel" aria-label="Close sign in">Close</button>
      </div>
      <p class="text-sm text-slate-500">Enter your email for a magic link or continue with Google.</p>
      <label class="grid gap-1">
        <span class="text-xs text-slate-500">Email</span>
        <input id="authEmail" type="email" required placeholder="you@domain.com" class="border rounded-lg px-3 py-2">
      </label>
      <div class="grid grid-cols-2 gap-2">
        <button id="authSend" class="btn btn-primary" type="button">Send magic link</button>
        <button id="authGoogle" class="btn" type="button">Continue with Google</button>
      </div>
      <p id="authNote" class="text-xs text-slate-500">We’ll never share your email.</p>
    </form>
  </dialog>

  <!-- ===== INTEGRATIONS (Creator+ & Business unlocked; Free sees preview) ===== -->
  <section id="integrations" class="relative scroll-mt-24">
    <div class="max-w-7xl mx-auto px-4 md:px-5 py-14 md:py-20">
      <div class="flex items-end justify-between gap-4 mb-6">
        <div>
          <h2 class="text-2xl md:text-3xl font-black tracking-tight">Integrations</h2>
          <p class="mt-1 text-slate-500 dark:text-slate-300 text-sm">
            Connect once — stays connected across refresh and sign-outs on this device.
          </p>
        </div>
        <!-- Upgrade teaser for Free -->
        <div class="only-guest">
          <button class="btn js-open-auth" type="button">Sign in</button>
        </div>
        <div class="only-authed hidden">
          <a class="btn plan-creator-plus hidden" href="#pricing">Included in Creator+</a>
          <a class="btn plan-business-only hidden" href="#pricing">Included in Business</a>
        </div>
      </div>

      <!-- Unlock preview for Free plan -->
      <div class="card p-4 md:p-5 mb-6 preview-locked only-authed hidden" id="integrationsLocked">
        <div class="flex items-center justify-between flex-wrap gap-3">
          <div>
            <strong class="tracking-tight">Unlock exports</strong>
            <div class="text-xs text-slate-500 mt-1">Creator+ adds Notion, Trello, and Buffer export.</div>
          </div>
          <a href="#pricing" class="btn btn-primary">Unlock preview</a>
        </div>
      </div>

      <!-- Connections -->
      <div class="grid md:grid-cols-3 gap-6">
        <!-- Notion -->
        <div class="card p-5">
          <div class="flex items-center justify-between">
            <strong>Notion</strong>
            <span id="notionStatus" class="chip">Not connected</span>
          </div>
          <p class="text-sm mt-2 text-slate-500">
            Creator+: export optimized articles and generator outputs to Notion.
          </p>
          <div class="mt-4 flex items-center gap-2">
            <button id="notionConnect" class="btn plan-creator-plus hidden" type="button">Connect</button>
            <button id="notionDisconnect" class="btn plan-creator-plus hidden" type="button">Disconnect</button>
            <button class="btn js-open-auth only-guest" type="button">Sign in</button>
          </div>
        </div>

        <!-- Trello -->
        <div class="card p-5">
          <div class="flex items-center justify-between">
            <strong>Trello</strong>
            <span id="trelloStatus" class="chip">Not connected</span>
          </div>
          <p class="text-sm mt-2 text-slate-500">
            Creator+: send drafts and project packs to Trello boards.
          </p>
          <div class="mt-4 flex items-center gap-2">
            <button id="trelloConnect" class="btn plan-creator-plus hidden" type="button">Connect</button>
            <button id="trelloDisconnect" class="btn plan-creator-plus hidden" type="button">Disconnect</button>
            <button class="btn js-open-auth only-guest" type="button">Sign in</button>
          </div>
        </div>

        <!-- Buffer (queue to LinkedIn/X/Facebook/IG) -->
        <div class="card p-5">
          <div class="flex items-center justify-between">
            <strong>Buffer</strong>
            <span id="bufferStatus" class="chip">Not connected</span>
          </div>
          <p class="text-sm mt-2 text-slate-500">
            Creator+: push drafts to Buffer queues for LinkedIn, X, Facebook, and Instagram.
          </p>
          <div class="mt-4 flex items-center gap-2">
            <button id="bufferConnect" class="btn plan-creator-plus hidden" type="button">Connect</button>
            <button id="bufferDisconnect" class="btn plan-creator-plus hidden" type="button">Disconnect</button>
            <button class="btn js-open-auth only-guest" type="button">Sign in</button>
          </div>
        </div>
      </div>

      <!-- Export shortcuts (visible when connected & Creator+) -->
      <div class="card p-4 md:p-5 mt-6 plan-creator-plus hidden" id="exportShortcuts">
        <div class="flex items-center justify-between flex-wrap gap-3">
          <strong class="tracking-tight">Quick export</strong>
          <div class="text-xs text-slate-500">Exports use your last Generator output or Optimizer result.</div>
        </div>
        <div class="mt-4 grid sm:grid-cols-2 lg:grid-cols-4 gap-3">
          <button id="expNotionLast" class="btn" type="button">Export last output → Notion</button>
          <button id="expTrelloLast" class="btn" type="button">Send last output → Trello</button>
          <button id="expProjectNotion" class="btn" type="button">Export Project Pack → Notion</button>
          <button id="expProjectTrello" class="btn" type="button">Send Project Pack → Trello</button>
        </div>
      </div>
    </div>
  </section>

  <!-- ===== PRESETS & BATCH (Starter+ feature; Free sees capped preview) ===== -->
  <section id="presets-batch" class="relative scroll-mt-24">
    <div class="max-w-7xl mx-auto px-4 md:px-5 py-14 md:py-20">
      <div class="flex items-end justify-between gap-4 mb-6">
        <div>
          <h2 class="text-2xl md:text-3xl font-black tracking-tight">Presets & Batch</h2>
          <p class="mt-1 text-slate-500 dark:text-slate-300 text-sm">
            Save your favorite settings and run batches. Starter: 5 lines/run · Creator/Business: 30 lines/run.
          </p>
        </div>
        <a href="#pricing" class="btn plan-starter-plus hidden">Included in Starter+</a>
      </div>

      <div class="grid lg:grid-cols-2 gap-6">
        <!-- Presets -->
        <div class="card p-5 md:p-6">
          <div class="flex items-center justify-between flex-wrap gap-3">
            <strong class="tracking-tight">Your presets</strong>
            <div class="text-xs text-slate-500">
              Starter: up to 10 · Creator/Business: unlimited
            </div>
          </div>

          <div class="mt-4 grid md:grid-cols-2 gap-3">
            <label class="grid gap-1">
              <span class="text-xs text-slate-500">Preset name</span>
              <input id="presetName" class="border rounded-lg px-3 py-2" placeholder="e.g. LinkedIn Thought Leadership">
            </label>
            <label class="grid gap-1">
              <span class="text-xs text-slate-500">Channels</span>
              <input id="presetChannels" class="border rounded-lg px-3 py-2" placeholder="linkedin,x,email">
            </label>
          </div>

          <div class="mt-3 grid md:grid-cols-3 gap-3">
            <label class="flex items-center gap-2"><input id="p_humanize" type="checkbox" checked> Humanize</label>
            <label class="flex items-center gap-2"><input id="p_lengthen" type="checkbox"> Lengthen ~30%</label>
            <label class="flex items-center gap-2"><input id="p_headings" type="checkbox" checked> Auto-headings</label>
          </div>

          <div class="mt-4 flex flex-wrap items-center gap-2">
            <button id="presetSave" class="btn plan-starter-plus hidden" type="button">Save preset</button>
            <button id="presetUpdate" class="btn plan-starter-plus hidden" type="button">Update</button>
            <button id="presetDelete" class="btn plan-starter-plus hidden" type="button">Delete</button>
            <button class="btn js-open-auth only-guest" type="button">Sign in</button>
          </div>

          <div class="mt-4">
            <div class="text-xs text-slate-500 mb-2">Saved presets</div>
            <div id="presetsList" class="grid gap-2"></div>
          </div>
        </div>

        <!-- Batch -->
        <div class="card p-5 md:p-6">
          <div class="flex items-center justify-between flex-wrap gap-3">
            <strong class="tracking-tight">Batch inputs</strong>
            <div class="text-xs text-slate-500">Each line becomes one job in this run.</div>
          </div>

          <label class="grid gap-1 mt-4">
            <span class="text-xs text-slate-500">Paste up to 5 (Starter) / 30 (Creator/Business) lines</span>
            <textarea id="batchInput" class="border rounded-lg px-3 py-2 min-h-[140px]" placeholder="Line 1&#10;Line 2&#10;Line 3"></textarea>
          </label>

          <div class="mt-3 grid md:grid-cols-2 gap-3">
            <label class="grid gap-1">
              <span class="text-xs text-slate-500">Use preset</span>
              <select id="batchPreset" class="border rounded-lg px-3 py-2">
                <option value="">None</option>
              </select>
            </label>
            <div class="grid grid-cols-2 gap-2 items-end">
              <button id="batchRun" class="btn plan-starter-plus hidden" type="button">Run batch</button>
              <button id="batchClear" class="btn" type="button">Clear</button>
            </div>
          </div>

          <div id="batchResults" class="mt-4 grid gap-3"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- ===== FOOTER ===== -->
  <footer class="mt-20 border-t border-white/30">
    <div class="max-w-7xl mx-auto px-4 md:px-5 py-10 text-sm flex flex-wrap items-center justify-between gap-3">
      <div class="opacity-80">© <span id="year">2025</span> ContentRepurpose.pro</div>
      <nav class="flex items-center gap-4 opacity-80">
        <a href="#pricing" class="hover:opacity-100">Pricing</a>
        <a href="/blog" class="hover:opacity-100">Blog</a>
        <a href="mailto:hello@contentrepurpose.pro" class="hover:opacity-100">Contact</a>
      </nav>
    </div>
  </footer>
  <!-- ===== STATUS TOAST (global, accessible) ===== -->
  <div id="toast" class="fixed bottom-4 left-1/2 -translate-x-1/2 z-[100] hidden">
    <div class="px-4 py-2 rounded-lg shadow card bg-white/90 dark:bg-black/70 text-sm">
      <span id="toastMsg">Done</span>
    </div>
  </div>

  <!-- ===== ARTICLE OPTIMIZER (signed-in gets full; Free sees unlock preview) ===== -->
  <section id="optimizer" class="relative scroll-mt-24">
    <div class="max-w-7xl mx-auto px-4 md:px-5 py-14 md:py-20">
      <div class="flex items-end justify-between gap-4 mb-6">
        <div>
          <h2 class="text-2xl md:text-3xl font-black tracking-tight">Article Optimizer</h2>
          <p class="mt-1 text-slate-500 dark:text-slate-300 text-sm">
            Paste your article. We’ll humanize, improve headings/meta, add FAQs (optional), and return clean HTML.
          </p>
        </div>
        <div class="flex items-center gap-2">
          <a href="#pricing" class="btn only-guest">Unlock all features</a>
          <button class="btn btn-primary js-open-auth only-guest" type="button">Sign in</button>
        </div>
      </div>

      <!-- INPUT CARD -->
      <div class="card p-5 md:p-6">
        <div class="grid lg:grid-cols-3 gap-6">
          <!-- Left: Input -->
          <div class="lg:col-span-2">
            <label class="grid gap-1">
              <span class="text-xs text-slate-500">Your article (HTML or Markdown)</span>
              <textarea id="optInput" class="border rounded-lg px-3 py-2 min-h-[260px]" placeholder="Paste your article content..."></textarea>
            </label>

            <!-- Controls -->
            <div class="mt-3 grid sm:grid-cols-2 lg:grid-cols-3 gap-3">
              <label class="flex items-center gap-2"><input id="optHumanize" type="checkbox" checked> Humanize content</label>
              <label class="flex items-center gap-2"><input id="optHeadings" type="checkbox" checked> Auto H2/H3</label>
              <label class="flex items-center gap-2"><input id="optMeta" type="checkbox" checked> Improve title/meta</label>
              <label class="flex items-center gap-2"><input id="optFaqs" type="checkbox"> Add FAQs + JSON-LD</label>
              <label class="flex items-center gap-2"><input id="optLengthen" type="checkbox"> Lengthen ~30%</label>
              <label class="flex items-center gap-2"><input id="optSeoCheck" type="checkbox" checked> SEO checks</label>
            </div>

            <!-- SEO fields -->
            <div class="mt-3 grid md:grid-cols-3 gap-3">
              <label class="grid gap-1">
                <span class="text-xs text-slate-500">Focus keyword</span>
                <input id="optKeyword" class="border rounded-lg px-3 py-2" placeholder="e.g. content repurposing for SEO">
              </label>
              <label class="grid gap-1">
                <span class="text-xs text-slate-500">Secondary keywords (comma-sep)</span>
                <input id="optSecondaries" class="border rounded-lg px-3 py-2" placeholder="content repurposing strategy, social media repurposing">
              </label>
              <label class="grid gap-1">
                <span class="text-xs text-slate-500">SERP intent</span>
                <select id="optIntent" class="border rounded-lg px-3 py-2">
                  <option value="informational" selected>Informational</option>
                  <option value="commercial">Commercial</option>
                  <option value="transactional">Transactional</option>
                  <option value="navigational">Navigational</option>
                </select>
              </label>
            </div>

            <!-- Actions -->
            <div class="mt-4 flex flex-wrap items-center gap-2">
              <button id="optRun" class="btn btn-primary only-authed hidden" type="button">Optimize Article</button>
              <button id="optRunPreview" class="btn only-guest" type="button">Preview optimization</button>
              <button id="optClear" class="btn" type="button">Clear</button>
              <a href="#pricing" class="btn only-guest">Unlock full optimizer</a>
            </div>
          </div>

          <!-- Right: Summary & Tips -->
          <div>
            <div class="border rounded-lg p-4">
              <strong class="tracking-tight">What you’ll get</strong>
              <ul class="mt-3 text-sm text-slate-500 space-y-2">
                <li>• Clean, humanized HTML (copy/download)</li>
                <li>• Improved title & meta description</li>
                <li>• Optional FAQs block + JSON-LD</li>
                <li>• Alt text & link hygiene checks</li>
                <li>• Ranking likelihood estimate</li>
              </ul>
              <div class="mt-4 text-xs text-slate-500">
                Tip: Paste raw text or existing HTML—both are fine.
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- RESULT CARD -->
      <div id="optResult" class="card p-5 md:p-6 mt-6 hidden">
        <div class="flex items-center justify-between flex-wrap gap-3">
          <strong class="tracking-tight">Optimized output</strong>
          <div class="text-xs text-slate-500" id="optSignals">SEO signals: —</div>
        </div>

        <!-- Meta -->
        <div class="mt-4 grid md:grid-cols-2 gap-4">
          <label class="grid gap-1">
            <span class="text-xs text-slate-500">Title</span>
            <input id="optTitle" class="border rounded-lg px-3 py-2" readonly>
          </label>
          <label class="grid gap-1">
            <span class="text-xs text-slate-500">Meta description</span>
            <input id="optMetaDesc" class="border rounded-lg px-3 py-2" readonly>
          </label>
        </div>

        <!-- HTML -->
        <div class="mt-4">
          <div class="flex items-center justify-between">
            <span class="text-xs text-slate-500">Optimized HTML</span>
            <div class="flex items-center gap-2">
              <button id="optCopyHtml" class="btn" type="button">Copy HTML</button>
              <button id="optCopyMd" class="btn" type="button">Copy Markdown</button>
              <button id="optDownloadHtml" class="btn" type="button">Download .html</button>
            </div>
          </div>
          <textarea id="optHtml" class="border rounded-lg px-3 py-2 min-h-[240px] mt-2" readonly></textarea>
        </div>

        <!-- FAQs JSON-LD (optional) -->
        <div class="mt-4 hidden" id="optFaqWrap">
          <div class="flex items-center justify-between">
            <span class="text-xs text-slate-500">FAQ JSON-LD</span>
            <button id="optCopyFaq" class="btn" type="button">Copy JSON-LD</button>
          </div>
          <textarea id="optFaqJson" class="border rounded-lg px-3 py-2 min-h-[140px] mt-2" readonly></textarea>
        </div>

        <!-- Preview -->
        <div class="mt-6 grid lg:grid-cols-2 gap-6">
          <div>
            <div class="text-xs text-slate-500 mb-2">Live preview</div>
            <div id="optPreview" class="border rounded-lg p-4 bg-white/70 dark:bg-white/5 overflow-auto min-h-[220px]"></div>
          </div>
          <div class="relative">
            <div class="text-xs text-slate-500 mb-2">Export</div>
            <div class="grid sm:grid-cols-2 gap-2">
              <button id="optExportNotion" class="btn plan-creator-plus hidden" type="button">Export to Notion</button>
              <button id="optExportTrello" class="btn plan-creator-plus hidden" type="button">Send to Trello</button>
              <a href="#pricing" class="btn only-guest">Unlock exports</a>
            </div>

            <!-- Unlock overlay for Free plans (visible when gated) -->
            <div id="optLockOverlay" class="preview-mask">
              <a href="#pricing" class="btn btn-primary cta">Unlock preview</a>
            </div>
          </div>
        </div>
      </div>

      <!-- PROJECT PACK (Creator+): bundle latest Generator outputs + Optimizer -->
      <div class="card p-5 md:p-6 mt-6">
        <div class="flex items-center justify-between flex-wrap gap-3">
          <strong class="tracking-tight">Project Pack</strong>
          <div class="text-xs text-slate-500">Creator+: export combined outputs to Notion/Trello.</div>
        </div>
        <div class="mt-4 grid sm:grid-cols-2 gap-2">
          <button id="projExportNotion" class="btn plan-creator-plus hidden" type="button">Export Project → Notion</button>
          <button id="projExportTrello" class="btn plan-creator-plus hidden" type="button">Send Project → Trello</button>
          <a href="#pricing" class="btn only-guest">Unlock Project Pack</a>
        </div>
      </div>
    </div>
  </section>
<script type="module">
/* =========================
   CRP — Part 6/6 Wiring
   ========================= */

const WORKER_BASE = window.WORKER_BASE || "https://contentflow-worker.frank-couchman.workers.dev";
const SITE_ORIGIN = window.SITE_ORIGIN || location.origin;

/* ---------- Shorthands ---------- */
const $  = (s, el=document)=> el.querySelector(s);
const $$ = (s, el=document)=> Array.from(el.querySelectorAll(s));
const byId = (id)=> document.getElementById(id);
const toast = (msg)=>{ const t=byId("toast"), m=byId("toastMsg"); if(!t||!m) return alert(msg); m.textContent=msg; t.classList.remove("hidden"); setTimeout(()=>t.classList.add("hidden"),1700); };
const cap = (s)=> (s||"").slice(0,1).toUpperCase()+(s||"").slice(1);

/* ---------- Supabase helpers (reuse existing client if loaded) ---------- */
const SUPABASE_URL  = "https://ynkoavaeadlzlwylmfmu.supabase.co";
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlua29hdmFlYWRsemx3eWxtZm11Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5OTAxNDgsImV4cCI6MjA3MzU2NjE0OH0.1yM5yDo0MI9Upzt4GkLyf1mqvDXfb3DXvC0ouOLtRoU";

let supabase = window.supabase; // created in Part 1

async function ensureSupabase(){
  if (window.supabase) { supabase = window.supabase; return; }
  const { createClient } = await import("https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm");
  window.supabase = createClient(SUPABASE_URL, SUPABASE_ANON, { auth:{ persistSession:true, autoRefreshToken:true, detectSessionInUrl:true } });
  supabase = window.supabase;
}

async function getAuthHeaders(){
  const h = { "Content-Type":"application/json" };
  try{
    const { data } = await supabase.auth.getSession();
    const tok = data?.session?.access_token;
    const uid = data?.session?.user?.id;
    if (tok) h["Authorization"] = `Bearer ${tok}`;
    if (uid) h["X-User-Id"]    = uid;
  }catch{}
  return h;
}

/* ---------- Global state ---------- */
const PLAN_RANK = { free:0, starter:1, creator:2, business:3 };
let CURRENT_PLAN = "free";
let USER_ID = null;
let AUTHTED = false;
let LAST_OUTPUT = {};                // from Generator
window.__CRP_LAST_OPTIMIZED__ = null; // from Optimizer

function setAuthFlag(authed){ AUTHTED = !!authed; document.body.setAttribute("data-auth", authed ? "authed" : "guest"); }
function setPlan(plan){
  CURRENT_PLAN = PLAN_RANK[plan]!=null ? plan : "free";
  document.body.setAttribute("data-plan", CURRENT_PLAN);
  const label = `Plan: ${cap(CURRENT_PLAN)}`;
  const pb = byId("planbadge"), pbm = byId("planbadge_m"), hp = byId("heroPlanName");
  if(pb) pb.textContent = label; if(pbm) pbm.textContent = label; if(hp) hp.textContent = cap(CURRENT_PLAN);
  const r = PLAN_RANK[CURRENT_PLAN] ?? 0;
  $$(".plan-starter-plus").forEach(el=> el.classList.toggle("hidden", r < 1));
  $$(".plan-creator-plus").forEach(el=> el.classList.toggle("hidden", r < 2));
  $$(".plan-business-only").forEach(el=> el.classList.toggle("hidden", r < 3));
}

/* ---------- Status + Integrations ---------- */
async function fetchStatus(){
  try{
    const r = await fetch(`${WORKER_BASE}/api/billing/status`, { headers: await getAuthHeaders() });
    const j = await r.json();
    if (!r.ok) throw new Error(j?.error?.message || "Status error");
    const authed = j.scope==="user";
    setAuthFlag(authed);
    USER_ID = authed ? (j.userId || null) : null;
    setPlan((j.plan||"free").toLowerCase());
    // Toggle generator buttons
    byId("generateBtn")?.classList.toggle("hidden", authed);
    byId("generateBtn_member")?.classList.toggle("hidden", !authed);
    // Quotas
    const demoEl = byId("demoQuota"), memEl = byId("memberQuota");
    if (!authed){
      const cap = j.platform?.monthly?.cap ?? 5;
      const used= j.platform?.monthly?.used ?? 0;
      if (demoEl) demoEl.textContent = Math.max(0, cap - used);
    } else {
      const cap = j.platform?.daily?.cap;
      const used= j.platform?.daily?.used ?? 0;
      if (memEl) memEl.textContent = (cap==null ? "∞" : Math.max(0, cap - used));
    }
  }catch{
    setAuthFlag(false); setPlan("free");
  }
}

async function fetchIntegrations(){
  try{
    const r = await fetch(`${WORKER_BASE}/api/integrations/status`, { headers: await getAuthHeaders() });
    const j = await r.json();
    if (!r.ok) throw new Error(j?.error?.message || "Integrations error");

    // Persist “connected” hint locally per user (for fast repaints), but server is source of truth
    const key = `crp:integrations:${USER_ID||"anon"}`;
    localStorage.setItem(key, JSON.stringify({ notion: !!j.notion?.connected, trello: !!j.trello?.connected, ts: Date.now() }));

    // If you have badges/nodes, update them (safe if absent)
    const nC = j.notion?.connected, tC = j.trello?.connected;
    const notionBtns = [byId("li-notion"), byId("optExportNotion"), byId("projExportNotion")];
    notionBtns.forEach(b=> b && b.classList.toggle("hidden", !nC || PLAN_RANK[CURRENT_PLAN] < 2));
    const trelloBtns = [byId("li-trello"), byId("optExportTrello"), byId("projExportTrello")];
    trelloBtns.forEach(b=> b && b.classList.toggle("hidden", !tC || PLAN_RANK[CURRENT_PLAN] < 2));
  }catch(e){
    // Don’t break UI if status fails
    console.warn(e);
  }
}

async function connectIntegration(kind){
  try{
    const r = await fetch(`${WORKER_BASE}/api/integrations/${kind}/connect`, { method:"POST", headers: await getAuthHeaders(), body: JSON.stringify({ return_url: SITE_ORIGIN }) });
    const j = await r.json();
    if (!r.ok || !j.url) throw new Error(j?.error?.message || "Connect failed");
    location.href = j.url;
  }catch(e){ toast(e.message || "Connect failed"); }
}

/* ---------- Generator: Presets & Batch ---------- */
function presetsKey(){ return `crp:presets:${USER_ID||"anon"}`; }
function loadPresets(){ try{ return JSON.parse(localStorage.getItem(presetsKey())||"[]"); }catch{return [];} }
function savePresets(list){ localStorage.setItem(presetsKey(), JSON.stringify(list||[])); }
function injectPresetsBatchUI(){
  if (byId("presetsPanel")) return;
  const anchor = byId("demoForm");
  if (!anchor) return;
  const panel = document.createElement("div");
  panel.id = "presetsPanel";
  panel.className = "card p-5 md:p-6 mt-6";
  panel.innerHTML = `
    <div class="flex items-center justify-between flex-wrap gap-3">
      <strong class="tracking-tight">Batch & Presets</strong>
      <div class="text-xs text-slate-500">Starter: up to 5 lines/run · Creator/Business: up to 30 lines/run</div>
    </div>
    <div class="mt-4 grid md:grid-cols-2 gap-4">
      <div class="border rounded-lg p-4">
        <div class="flex items-center justify-between">
          <span class="text-sm font-semibold">Batch input</span>
          <label class="flex items-center gap-2 text-sm">
            <input id="batchToggle" type="checkbox"> Use batch lines
          </label>
        </div>
        <p class="text-xs text-slate-500 mt-2">Paste multiple ideas in the main textbox — one per line. We’ll run them sequentially.</p>
      </div>
      <div class="border rounded-lg p-4">
        <div class="flex items-center justify-between">
          <span class="text-sm font-semibold">Saved presets</span>
          <div class="flex items-center gap-2">
            <input id="presetName" class="border rounded px-2 py-1 text-sm" placeholder="Name preset">
            <button id="presetSave" class="btn" type="button">Save</button>
          </div>
        </div>
        <div id="presetList" class="mt-3 grid gap-2"></div>
      </div>
    </div>
  `;
  anchor.parentNode.insertBefore(panel, anchor.nextSibling);
  wirePresets();
}

function readGeneratorForm(){
  const f = byId("demoForm"); if (!f) return null;
  const get = (n)=> f.elements[n];
  // Read toggles (mirror Part 1)
  const toggles = {
    opt: {
      humanize:  get("opt_humanize")?.checked,
      lengthen:  get("opt_lengthen")?.checked,
      faqs:      get("opt_faqs")?.checked,
      headings:  get("opt_headings")?.checked,
      svg:       get("opt_svg")?.checked,
      seo:       get("opt_seo")?.checked
    },
    ch: {
      linkedin:  get("ch_linkedin")?.checked,
      x:         get("ch_x")?.checked,
      email:     get("ch_email")?.checked,
      instagram: get("ch_instagram")?.checked,
      reddit:    get("ch_reddit")?.checked,
      facebook:  get("ch_facebook")?.checked,
      quora:     get("ch_quora")?.checked,
      tiktok:    get("ch_tiktok")?.checked,
    },
    extras: {
      li_article: get("li_article")?.checked,
      x_sequence: get("x_sequence")?.checked,
      x_posts:    get("x_posts")?.value || "4",
      rdt_communities: get("rdt_communities")?.checked,
      rdt_comments:    get("rdt_comments")?.checked,
      tt_hooks:   get("tt_hooks")?.checked,
      tt_onscreen:get("tt_onscreen")?.checked
    },
    seo: {
      keyword: get("seo_keyword")?.value?.trim() || "",
      secondaries: get("seo_secondaries")?.value?.trim() || "",
      intent: get("seo_intent")?.value || "informational"
    },
    sourceType: get("sourceType")?.value || "paragraph",
    content: byId("sourceText")?.value || ""
  };
  return toggles;
}

function wirePresets(){
  const listEl = byId("presetList");
  const saveBtn = byId("presetSave");
  const nameEl  = byId("presetName");
  if (!listEl || !saveBtn) return;

  function paint(){
    const items = loadPresets();
    listEl.innerHTML = "";
    if (!items.length){ listEl.innerHTML = `<div class="text-xs text-slate-500">No presets yet.</div>`; return; }
    items.forEach((p, idx)=>{
      const row = document.createElement("div");
      row.className = "flex items-center justify-between border rounded-lg p-2";
      row.innerHTML = `
        <div class="text-sm">${p.name}</div>
        <div class="flex items-center gap-2">
          <button data-i="${idx}" class="btn text-xs apply">Apply</button>
          <button data-i="${idx}" class="btn text-xs remove">Delete</button>
        </div>
      `;
      listEl.appendChild(row);
    });
    listEl.querySelectorAll(".apply").forEach(b=> b.addEventListener("click", ()=>{
      const i = +b.getAttribute("data-i");
      const items = loadPresets(); const p = items[i]; if (!p) return;
      // Apply to form
      try{
        const f = byId("demoForm");
        if (f && p.form) {
          Object.entries(p.form).forEach(([k,v])=>{
            const el = f.elements[k];
            if (!el) return;
            if (el.type==="checkbox") el.checked = !!v;
            else if (el.type==="radio") { /* noop */ }
            else el.value = v;
          });
          toast("Preset applied");
        }
      }catch{}
    }));
    listEl.querySelectorAll(".remove").forEach(b=> b.addEventListener("click", ()=>{
      const i = +b.getAttribute("data-i");
      const items = loadPresets(); items.splice(i,1); savePresets(items); paint();
    }));
  }

  saveBtn.addEventListener("click", ()=>{
    const name = (nameEl?.value||"").trim();
    if (!name) return toast("Name your preset");
    const f = byId("demoForm"); if (!f) return;
    // Snapshot only simple fields
    const fields = {};
    Array.from(f.elements).forEach(el=>{
      if (!el.name) return;
      if (el.type==="radio" && !el.checked) return;
      if (el.type==="checkbox") fields[el.name] = el.checked;
      else fields[el.name] = el.value;
    });
    const items = loadPresets();
    // Limit for Starter
    const limit = PLAN_RANK[CURRENT_PLAN] >= 2 ? 9999 : 10;
    if (items.length >= limit) return toast(`Preset limit reached (${limit})`);
    items.push({ name, form: fields, ts: Date.now() });
    savePresets(items);
    nameEl.value = "";
    paint();
    toast("Preset saved ✅");
  });

  paint();
}

function wireBatch(){
  const toggle = byId("batchToggle");
  const form = byId("demoForm");
  if (!form) return;
  form.addEventListener("submit", async (e)=>{
    if (!toggle?.checked) return; // normal flow continues (wired in Part 1)
    e.preventDefault();

    const src = (byId("sourceText")?.value || "").trim();
    if (!src) return toast("Paste content first");
    // Split into lines
    const lines = src.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    if (lines.length <= 1) return; // let Part 1 handler run if single line
    // Cap by plan
    const maxLines = PLAN_RANK[CURRENT_PLAN] >= 2 ? 30 : 5;
    const jobs = lines.slice(0, maxLines);

    const out = byId("demoOutput");
    out.innerHTML = `<div class="card p-5 text-sm text-slate-500">Running ${jobs.length} batch jobs…</div>`;

    // Run sequentially to keep quotas safe
    for (let i=0;i<jobs.length;i++){
      try{
        // Clone form state but override content per line
        byId("sourceText").value = jobs[i];
        const evt = new Event("submit",{bubbles:false,cancelable:true});
        toggle.checked = false; // temporarily disable to reuse normal handler
        form.dispatchEvent(evt);
        toggle.checked = true;
        // Wait a tiny bit between jobs
        // eslint-disable-next-line no-await-in-loop
        await new Promise(res=> setTimeout(res, 400));
      }catch(e){ console.warn(e); }
    }
  }, { capture:true });
}

/* ---------- Optimizer ---------- */
function showPreview(html){
  const prev = byId("optPreview"); if (!prev) return;
  prev.innerHTML = html || "";
}
function htmlToText(html){
  const tmp = document.createElement("div");
  tmp.innerHTML = html||"";
  return tmp.innerText;
}

function wireOptimizer(){
  const run      = byId("optRun");
  const runPrev  = byId("optRunPreview");
  const clearBtn = byId("optClear");
  const inputEl  = byId("optInput");
  const resWrap  = byId("optResult");
  const titleEl  = byId("optTitle");
  const metaEl   = byId("optMetaDesc");
  const htmlEl   = byId("optHtml");
  const copyHtml = byId("optCopyHtml");
  const copyMd   = byId("optCopyMd");
  const dlHtml   = byId("optDownloadHtml");
  const faqWrap  = byId("optFaqWrap");
  const faqJson  = byId("optFaqJson");
  const copyFaq  = byId("optCopyFaq");
  const sigEl    = byId("optSignals");

  function unlockPreview(){
    const overlay = byId("optLockOverlay");
    // show overlay for Free when trying Result preview without auth (keeps safe)
    if (overlay && PLAN_RANK[CURRENT_PLAN] === 0) overlay.classList.add("preview-mask");
  }

  function readOptions(){
    return {
      humanize:  byId("optHumanize")?.checked,
      headings:  byId("optHeadings")?.checked,
      meta:      byId("optMeta")?.checked,
      faqs:      byId("optFaqs")?.checked,
      lengthen:  byId("optLengthen")?.checked,
      seocheck:  byId("optSeoCheck")?.checked,
      keyword:   byId("optKeyword")?.value || "",
      secondaries: byId("optSecondaries")?.value || "",
      intent:    byId("optIntent")?.value || "informational"
    };
  }

  clearBtn?.addEventListener("click", ()=>{
    if (inputEl) inputEl.value = "";
    if (resWrap) resWrap.classList.add("hidden");
    window.__CRP_LAST_OPTIMIZED__ = null;
  });

  // Signed-in full optimize
  run?.addEventListener("click", async ()=>{
    const raw = (inputEl?.value||"").trim();
    if (!raw) return toast("Paste your article first");
    const opts = readOptions();
    const btn = run; const old = btn.textContent; btn.disabled = true; btn.textContent = "Optimizing…";
    try{
      const r = await fetch(`${WORKER_BASE}/api/optimize`,{
        method:"POST",
        headers: await getAuthHeaders(),
        body: JSON.stringify({ content: raw, options: opts })
      });
      const j = await r.json();
      if (!r.ok) throw new Error(j?.error?.message || "Optimization failed");

      titleEl.value = j.title || "";
      metaEl.value  = j.meta_description || "";
      htmlEl.value  = j.html || "";
      if (sigEl) sigEl.textContent = j.signals || "SEO signals ready";

      // FAQs block
      if (opts.faqs && j.faq_jsonld){
        faqWrap.classList.remove("hidden");
        faqJson.value = j.faq_jsonld;
      } else {
        faqWrap.classList.add("hidden");
        faqJson.value = "";
      }

      showPreview(j.html||"");
      resWrap.classList.remove("hidden");
      toast("Optimized ✅");
      window.__CRP_LAST_OPTIMIZED__ = { html: j.html||"", title: j.title||"", meta: j.meta_description||"", faq_jsonld: j.faq_jsonld||"" };
    }catch(e){ toast(e.message || "Optimization error"); }
    finally{ btn.disabled=false; btn.textContent=old; }
  });

  // Guest preview (teaser)
  runPrev?.addEventListener("click", ()=>{
    const raw = (inputEl?.value||"").trim();
    if (!raw) return toast("Paste your article first");
    // Lightweight client-side “preview” — shows overlay to nudge upgrade
    const teaser = `<article><h2>Preview (locked)</h2><p>${htmlToText(raw).slice(0,320)}…</p></article>`;
    titleEl.value = "Preview — upgrade to unlock";
    metaEl.value  = "Sign in and upgrade to generate full meta.";
    htmlEl.value  = teaser;
    showPreview(teaser);
    resWrap.classList.remove("hidden");
    unlockPreview();
  });

  // Copy / Download
  copyHtml?.addEventListener("click", async ()=>{ try{ await navigator.clipboard.writeText(htmlEl.value||""); toast("HTML copied ✅"); }catch{ toast("Copy failed"); } });
  copyMd?.addEventListener("click", async ()=>{ try{ await navigator.clipboard.writeText(htmlToText(htmlEl.value||"")); toast("Markdown copied ✅"); }catch{ toast("Copy failed"); } });
  dlHtml?.addEventListener("click", ()=>{
    const blob = new Blob([htmlEl.value||""], { type:"text/html;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a"); a.href=url; a.download="optimized-article.html"; a.click();
    setTimeout(()=> URL.revokeObjectURL(url), 1000);
  });

  copyFaq?.addEventListener("click", async ()=>{ try{ await navigator.clipboard.writeText(faqJson.value||""); toast("JSON-LD copied ✅"); }catch{ toast("Copy failed"); } });
}

/* ---------- Exports (Optimizer + Project Pack + Quick Publish) ---------- */
function gatherProjectChunks(){
  const cards = $$("#demoOutput .card");
  const chunks = [];
  cards.forEach(c=>{
    const title = $("strong", c)?.innerText || "Output";
    const text  = $("pre", c)?.innerText || "";
    if (text.trim()) chunks.push(`### ${title}\n\n${text.trim()}`);
  });
  return chunks;
}

async function exportToNotion(title, blocks){
  const r = await fetch(`${WORKER_BASE}/api/integrations/notion/export`,{
    method:"POST", headers: await getAuthHeaders(), body: JSON.stringify({ title, blocks })
  });
  const j = await r.json();
  if (!r.ok) throw new Error(j?.error?.message || "Notion export failed");
  window.open(j.url, "_blank");
}

async function exportToTrello(title, description){
  const r = await fetch(`${WORKER_BASE}/api/integrations/trello/export`,{
    method:"POST", headers: await getAuthHeaders(), body: JSON.stringify({ title, description })
  });
  const j = await r.json();
  if (!r.ok) throw new Error(j?.error?.message || "Trello export failed");
  window.open(j.url, "_blank");
}

function wireExports(){
  // Optimizer exports
  byId("optExportNotion")?.addEventListener("click", async ()=>{
    try{
      const last = window.__CRP_LAST_OPTIMIZED__;
      if (!last) return toast("Optimize an article first");
      const blocks = [
        { type:"heading",   text: last.title || "Optimized Article" },
        { type:"paragraph", text: `Meta: ${last.meta||""}` },
        { type:"paragraph", text: "HTML preview:" },
        { type:"paragraph", text: htmlToText(last.html||"").slice(0,1800) }
      ];
      await exportToNotion(last.title || "Optimized Article", blocks);
    }catch(e){ toast(e.message||"Export error"); }
  });

  byId("optExportTrello")?.addEventListener("click", async ()=>{
    try{
      const last = window.__CRP_LAST_OPTIMIZED__;
      if (!last) return toast("Optimize an article first");
      const desc = `Meta: ${last.meta||""}\n\n---\n\n${htmlToText(last.html||"")}`.slice(0,4000);
      await exportToTrello(last.title || "Optimized Article", desc);
    }catch(e){ toast(e.message||"Export error"); }
  });

  // Project pack (Creator+)
  byId("projExportNotion")?.addEventListener("click", async ()=>{
    try{
      const chunks = gatherProjectChunks();
      const opt = window.__CRP_LAST_OPTIMIZED__;
      if (!chunks.length && !opt) return toast("Generate or optimize something first");
      const blocks = [];
      if (opt){
        blocks.push({ type:"heading", text: opt.title || "Optimized Article" });
        blocks.push({ type:"paragraph", text: opt.meta || "" });
        blocks.push({ type:"paragraph", text: htmlToText(opt.html||"").slice(0,1800) });
        blocks.push({ type:"paragraph", text: "---" });
      }
      chunks.forEach(t=> blocks.push({ type:"paragraph", text: t.slice(0,1900) }));
      await exportToNotion("ContentRepurpose Project", blocks);
    }catch(e){ toast(e.message||"Export error"); }
  });

  byId("projExportTrello")?.addEventListener("click", async ()=>{
    try{
      const chunks = gatherProjectChunks();
      const opt = window.__CRP_LAST_OPTIMIZED__;
      if (!chunks.length && !opt) return toast("Generate or optimize something first");
      let description = "";
      if (opt){ description += `Optimized Article: ${opt.title||""}\n\n${htmlToText(opt.html||"").slice(0,2000)}\n\n---\n\n`; }
      description += chunks.join("\n\n---\n\n");
      await exportToTrello("ContentRepurpose Project", description.slice(0,4000));
    }catch(e){ toast(e.message||"Export error"); }
  });

  // Quick publish (existing IDs from Part 1)
  byId("li-notion")?.addEventListener("click", async ()=>{
    try{
      const chunks = gatherProjectChunks();
      if (!chunks.length) return toast("Generate first");
      await exportToNotion("Generator Export", chunks.map(t=>({type:"paragraph",text:t.slice(0,1900)})));
    }catch(e){ toast(e.message||"Export error"); }
  });
  byId("li-trello")?.addEventListener("click", async ()=>{
    try{
      const chunks = gatherProjectChunks();
      if (!chunks.length) return toast("Generate first");
      await exportToTrello("Generator Export", chunks.join("\n\n---\n\n").slice(0,4000));
    }catch(e){ toast(e.message||"Export error"); }
  });
}

/* ---------- Sign-in (ensure dialog + buttons work 100%) ---------- */
function wireAuthUI(){
  const dlg = byId("auth");
  const openAuth = ()=> dlg?.showModal?.();
  $$(".js-open-auth").forEach(b=> b.addEventListener("click", openAuth));
  byId("loginBtn")?.addEventListener("click", openAuth);
  byId("loginBtn_m")?.addEventListener("click", openAuth);
  byId("heroSignIn")?.addEventListener("click", openAuth);

  byId("authGoogle")?.addEventListener("click", async ()=>{
    try{
      await supabase.auth.signInWithOAuth({ provider:"google", options:{ redirectTo: SITE_ORIGIN }});
    }catch(e){ toast(e?.message || "Google sign-in failed"); }
  });

  byId("authSend")?.addEventListener("click", async ()=>{
    const email = byId("authEmail")?.value?.trim();
    if (!email) return toast("Enter your email");
    try{
      const { error } = await supabase.auth.signInWithOtp({ email, options:{ emailRedirectTo: SITE_ORIGIN } });
      if (error) throw error;
      toast("Check your email for the magic link.");
    }catch(e){ toast(e?.message || "Sign-in error"); }
  });

  // Sign out
  ["logoutBtn","logoutBtn_m"].forEach(id=>{
    byId(id)?.addEventListener("click", async ()=>{
      try{ await supabase.auth.signOut(); toast("Signed out"); }catch(e){ toast("Sign-out error"); }
    });
  });
}

/* ---------- Boot ---------- */
document.addEventListener("DOMContentLoaded", async ()=>{
  await ensureSupabase();

  // Complete OAuth (also handles magic link)
  try{
    const u = new URL(location.href);
    const code = u.searchParams.get("code");
    const err  = u.searchParams.get("error_description");
    if (err) toast(decodeURIComponent(err));
    if (code){
      const { error } = await supabase.auth.exchangeCodeForSession({ code });
      if (error) toast(error.message);
      ["code","state","scope","provider_id","redirected_from"].forEach(p=> u.searchParams.delete(p));
      history.replaceState({}, "", u.toString());
    }
    if (location.hash.includes("access_token")){
      await supabase.auth.getSession();
      history.replaceState({}, "", location.pathname + location.search);
    }
  }catch{}

  wireAuthUI();          // dialog + buttons
  injectPresetsBatchUI();// adds Batch & Presets panel
  wirePresets();         // list + save/apply/delete
  wireBatch();           // multi-line runs
  wireOptimizer();       // Article Optimizer logic
  wireExports();         // Notion/Trello + Project pack
  await fetchStatus();   // plan + quotas
  await fetchIntegrations(); // notion/trello state

  // Keep UI in sync with auth state, persist integrations across refresh/sign-outs
  supabase.auth.onAuthStateChange(async (_evt, session)=>{
    setAuthFlag(!!session);
    USER_ID = session?.user?.id || null;
    try{ $$('dialog[open]#auth').forEach(d=> d.close()); }catch{}
    await fetchStatus();
    await fetchIntegrations();
  });
});
</script>
</body>
<html>
