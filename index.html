<!doctype html>
<html lang="en" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>ContentRepurpose.pro — AI Content Repurposing Tool & Generator</title>
  <meta name="description" content="Content repurposing AI that turns one idea into LinkedIn, X, Email & Instagram drafts. Export to Notion & Trello. BYOK supported." />
  <link rel="canonical" href="https://contentrepurpose.pro/">
  <meta name="theme-color" content="#0a0d18">
  <meta name="color-scheme" content="dark light">
  <meta name="robots" content="index,follow,max-video-preview:-1,max-image-preview:large,max-snippet:-1">

  <!-- Open Graph -->
  <meta property="og:type" content="website">
  <meta property="og:title" content="ContentRepurpose.pro — AI Content Repurposing Tool">
  <meta property="og:description" content="Repurpose content with AI. Paste once → get LinkedIn, X, Email & Instagram drafts. Export to Notion & Trello. BYOK supported.">
  <meta property="og:url" content="https://contentrepurpose.pro/">
  <meta property="og:image" content="/og-cover.png">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="ContentRepurpose.pro — AI Content Generator">
  <meta name="twitter:description" content="Content repurposing AI for multi-channel drafts. Export to Notion & Trello. BYOK supported.">
  <meta name="twitter:image" content="/og-cover.png">

  <!-- Fonts + Tailwind -->
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Global CSS -->
  <style>
    :root{ --brandA:#7AA2FF; --brandB:#FF2D2D; --ink:#0a0d18 }
    html,body{font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .txt-grad{background:linear-gradient(135deg,var(--brandA),var(--brandB));-webkit-background-clip:text;background-clip:text;color:transparent}
    .bg-grad{background:linear-gradient(135deg,var(--brandA),var(--brandB))}
    .card{border-radius:1.25rem;border:1px solid rgba(15,23,42,.10);background:rgba(255,255,255,.80);box-shadow:0 12px 40px rgba(2,6,23,.08)}
    .badge{display:inline-flex;align-items:center;gap:.5rem;padding:.35rem .6rem;border-radius:9999px;border:1px solid rgba(255,255,255,.15);font-size:.75rem;background:rgba(255,255,255,.65)}
    .chip{font-size:.7rem;padding:.2rem .5rem;border-radius:9999px;border:1px solid rgba(148,163,184,.35)}
    .btn{padding:.6rem .9rem;border-radius:.9rem;border:1px solid rgba(148,163,184,.35)}
    .btn-primary{background:black;color:white}
    .glass{backdrop-filter: blur(12px); background:rgba(255,255,255,.62)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    .halo{position:absolute;filter:blur(60px);opacity:.55;pointer-events:none;transform:translateZ(0);
      background:radial-gradient(50% 50% at 50% 50%, rgba(122,162,255,.8), rgba(255,45,45,.65) 60%, transparent 70%);
      width:42rem;height:42rem;border-radius:50%;animation:float 16s ease-in-out infinite;}
    .halo.h2{width:34rem;height:34rem;right:-12rem;top:-6rem;animation-duration:18s;opacity:.5}
    .halo.h3{width:28rem;height:28rem;left:-10rem;top:26rem;animation-duration:22s;opacity:.45}
    @keyframes float{ 0%,100%{ transform: translate3d(0,0,0) } 50%{ transform: translate3d(0,-20px,0) } }
    .orbit{position:absolute;inset:-32px;border-radius:24px;pointer-events:none;
      background: conic-gradient(from 0deg, rgba(122,162,255,.25), rgba(255,45,45,.18), rgba(122,162,255,.25));
      -webkit-mask: radial-gradient(closest-side, transparent 88%, black 89%); mask: radial-gradient(closest-side, transparent 88%, black 89%);
      animation: spin 18s linear infinite;}
    @keyframes spin{ to{ transform: rotate(360deg) } }
    .mock{border-radius:1rem;border:1px solid rgba(255,255,255,.12); background:linear-gradient(180deg,rgba(255,255,255,.75),rgba(255,255,255,.6));}
    @media (prefers-color-scheme:dark){ body{background:var(--ink);color:#e9eef6} .card{background:rgba(14,16,22,.6);border-color:rgba(255,255,255,.08);box-shadow:0 24px 96px rgba(122,162,255,.08),0 14px 60px rgba(255,45,45,.06)} .badge{background:rgba(255,255,255,.06);border-color:rgba(255,255,255,.12)} .mock{ background:linear-gradient(180deg,rgba(17,20,31,.88),rgba(17,20,31,.72)); } }
    .marquee{ display:grid; grid-auto-flow:column; gap:2rem; align-items:center; animation: scrollx 26s linear infinite }
    .marquee:hover{ animation-play-state: paused } @keyframes scrollx{ from{ transform: translateX(0) } to{ transform: translateX(-50%) } }
    .nav-sheet{position:fixed; inset:0 0 auto 0; background:rgba(0,0,0,.6); backdrop-filter:blur(8px); display:none}
    .nav-panel{position:absolute; top:0; right:0; width:82vw; max-width:380px; height:100%; background:rgba(14,16,22,.96); border-left:1px solid rgba(255,255,255,.08); padding:1rem}
    .nav-open .nav-sheet{display:block}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
    .touch-target{min-height:40px;min-width:40px}

    /* Feature gating */
    .only-guest{display:revert}
    .only-authed{display:none}
    .plan-starter-plus{display:none}
    .plan-creator-plus{display:none}
    .plan-business-only{display:none}
    body[data-auth="authed"] .only-guest{display:none}
    body[data-auth="authed"] .only-authed{display:revert}
    body[data-plan="starter"] .plan-starter-plus,
    body[data-plan="creator"] .plan-starter-plus,
    body[data-plan="business"] .plan-starter-plus{display:revert}
    body[data-plan="creator"] .plan-creator-plus,
    body[data-plan="business"] .plan-creator-plus{display:revert}
    body[data-plan="business"] .plan-business-only{display:revert}

    /* “Unlock preview” mask for Free users */
    .locked-mask{position:absolute;inset:0;border-radius:1rem;background:linear-gradient(180deg,rgba(0,0,0,.5),rgba(0,0,0,.75));display:flex;align-items:center;justify-content:center;gap:10px;color:#fff}
    .lock-badge{font-size:.75rem;padding:.35rem .6rem;border:1px solid rgba(255,255,255,.35);border-radius:9999px;background:rgba(255,255,255,.12)}
    .hidden{display:none !important}
    :focus-visible{ outline:2px solid var(--brandA); outline-offset:2px }
  </style>

  <!-- JSON-LD minimal -->
  <script type="application/ld+json">{"@context":"https://schema.org","@type":"Organization","name":"ContentRepurpose.pro","url":"https://contentrepurpose.pro/","logo":"https://contentrepurpose.pro/logo.svg"}</script>

  <!-- Worker base -->
  <script>
    window.WORKER_BASE = "https://contentflow-worker.frank-couchman.workers.dev";
    window.SITE_ORIGIN = "https://contentrepurpose.pro";
  </script>

  <!-- Supabase v2 (resilient init) -->
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";
    const SUPABASE_URL  = "https://ynkoavaeadlzlwylmfmu.supabase.co";
    const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlua29hdmFlYWRsemx3eWxtZm11Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5OTAxNDgsImV4cCI6MjA3MzU2NjE0OH0.1yM5yDo0MI9Upzt4GkLyf1mqvDXfb3DXvC0ouOLtRoU";
    window.supabase = createClient(SUPABASE_URL, SUPABASE_ANON, { auth:{ persistSession:true, autoRefreshToken:true, detectSessionInUrl:true } });

    window.getAuth = async () => {
      try { const { data } = await window.supabase.auth.getSession();
        const s=data?.session; return { token:s?.access_token||"", userId:s?.user?.id||null, email:s?.user?.email||null };
      } catch { return { token:"", userId:null, email:null }; }
    };
    window.getAuthHeaders = async () => {
      const { token, userId } = await window.getAuth();
      const h = { "Content-Type":"application/json" };
      if (token)  h["Authorization"] = `Bearer ${token}`;
      if (userId) h["X-User-Id"] = userId;
      return h;
    };
  </script>
</head>
<body class="min-h-full" data-auth="guest" data-plan="free">
  <!-- Decorative halos -->
  <div class="halo" style="left:-14rem; top:-10rem;"></div>
  <div class="halo h2"></div>
  <div class="halo h3"></div>

  <!-- Top nav -->
  <header class="sticky top-0 z-40 backdrop-blur bg-white/55 dark:bg-black/20 border-b border-white/30">
    <div class="max-w-7xl mx-auto px-4 md:px-5 py-4 flex items-center justify-between">
      <a href="/" class="flex items-center gap-3" aria-label="ContentRepurpose home">
        <svg width="36" height="36" viewBox="0 0 48 48" class="rounded-xl" aria-hidden="true">
          <defs><linearGradient id="g" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#7AA2FF"/><stop offset="100%" stop-color="#FF2D2D"/></linearGradient></defs>
          <rect x="0" y="0" width="48" height="48" rx="12" fill="url(#g)"/>
          <path d="M14 16h10a6 6 0 0 1 0 12H20v4h-6V16zm6 6v4h4a2 2 0 1 0 0-4h-4z" fill="white"/>
          <path d="M28 16h6v16h-6z" fill="white" opacity=".9"/>
        </svg>
        <span class="font-semibold tracking-tight">Content<span class="txt-grad">Repurpose</span></span>
      </a>

      <nav class="hidden md:flex items-center gap-6 text-sm">
        <a href="#demo" class="hover:opacity-80">Live Demo</a>
        <a href="#optimizer" class="hover:opacity-80">Article Optimizer</a>
        <a href="#use-cases" class="hover:opacity-80">Use cases</a>
        <a href="#best-picks" class="hover:opacity-80">Best picks</a>
        <a href="#pricing" class="hover:opacity-80">Pricing</a>
        <a href="/blog" class="hover:opacity-80">Blog</a>
        <span id="planbadge" class="px-3 py-1 rounded-full text-xs bg-white/70 dark:bg-white/10 border border-white/50">Plan: Free</span>
        <button id="manageBilling" class="px-3 py-1 rounded-lg border hidden">Manage billing</button>
        <div class="flex items-center gap-2">
          <button id="loginBtn" class="px-3 py-1 rounded-lg border only-guest">Sign in</button>
          <button id="logoutBtn" class="px-3 py-1 rounded-lg border only-authed hidden">Sign out</button>
        </div>
      </nav>

      <button id="navToggle" class="md:hidden touch-target px-3 py-2 rounded-lg border" aria-expanded="false" aria-controls="mobileNav" aria-label="Open menu">☰</button>
    </div>

    <!-- Mobile sheet -->
    <div id="mobileNav" class="nav-sheet" aria-hidden="true">
      <div class="nav-panel text-sm text-white">
        <div class="flex items-center justify-between">
          <span class="font-semibold">Menu</span>
          <button id="navClose" class="touch-target px-3 py-2 rounded-lg border border-white/20" aria-label="Close menu">✕</button>
        </div>
        <nav class="mt-4 grid gap-2">
          <a href="#demo" class="px-3 py-2 rounded-lg hover:bg-white/10">Live Demo</a>
          <a href="#optimizer" class="px-3 py-2 rounded-lg hover:bg-white/10">Article Optimizer</a>
          <a href="#use-cases" class="px-3 py-2 rounded-lg hover:bg-white/10">Use cases</a>
          <a href="#best-picks" class="px-3 py-2 rounded-lg hover:bg-white/10">Best picks</a>
          <a href="#pricing" class="px-3 py-2 rounded-lg hover:bg-white/10">Pricing</a>
          <a href="/blog" class="px-3 py-2 rounded-lg hover:bg-white/10">Blog</a>
        </nav>
        <div class="mt-6 grid gap-2">
          <span id="planbadge_m" class="px-3 py-1 rounded-full text-xs bg-white/10 border border-white/20 w-fit">Plan: Free</span>
          <button id="manageBilling_m" class="px-3 py-2 rounded-lg border border-white/20 hidden">Manage billing</button>
          <button id="loginBtn_m" class="px-3 py-2 rounded-lg border border-white/20 only-guest">Sign in</button>
          <button id="logoutBtn_m" class="px-3 py-2 rounded-lg border border-white/20 only-authed hidden">Sign out</button>
        </div>
      </div>
    </div>
  </header>

  <!-- Auth dialog -->
  <dialog id="auth" class="rounded-xl p-0 w-[92vw] max-w-md">
    <form method="dialog" class="p-5 grid gap-4">
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-semibold">Sign in</h3>
        <button class="btn" value="cancel">Close</button>
      </div>
      <p class="text-sm text-slate-500">Use a magic link or Google.</p>
      <input id="authEmail" type="email" required placeholder="you@domain.com" class="border rounded-lg px-3 py-2">
      <div class="grid grid-cols-2 gap-2">
        <button id="authSend" class="btn btn-primary" type="button">Send magic link</button>
        <button id="authGoogle" class="btn" type="button">Continue with Google</button>
      </div>
      <p id="authNote" class="text-xs text-slate-500">We’ll never share your email.</p>
    </form>
  </dialog>
  <!-- ===== HERO ===== -->
  <section class="relative" id="hero">
    <div class="max-w-7xl mx-auto px-4 md:px-5 pt-10 md:pt-16 grid lg:grid-cols-2 gap-8 md:gap-10 items-center">
      <!-- Left -->
      <div>
        <div id="heroBadgeWrap" class="inline-flex items-center gap-2 px-3 py-1 rounded-full text-xs bg-white/70 dark:bg-white/10 border border-white/40">
          <span class="w-2 h-2 rounded-full bg-emerald-500"></span>
          <span class="only-guest">Demo — <strong class="mx-1">5 runs / month</strong> (no login)</span>
          <span class="only-authed hidden">Signed in — <strong id="heroPlanName">Free</strong> plan active</span>
        </div>

        <h1 class="mt-4 text-3xl md:text-5xl font-black leading-tight tracking-tight">
          AI <span class="txt-grad">Content Repurposing Tool</span> — turn one idea into everywhere content.
        </h1>

        <p class="mt-4 text-slate-600 dark:text-slate-300 max-w-xl">
          Paste once → get <strong>LinkedIn</strong>, <strong>X</strong>, <strong>Email</strong> &amp; <strong>Instagram</strong> drafts.
          Export to <strong>Notion</strong> & <strong>Trello</strong>. BYOK supported.
        </p>

        <div class="mt-6 flex flex-wrap gap-3">
          <a href="#demo" class="px-4 py-3 rounded-xl font-semibold text-white bg-black hover:opacity-90 only-guest">Try the Live Demo</a>
          <a href="#demo" class="px-4 py-3 rounded-xl font-semibold text-white bg-black hover:opacity-90 only-authed hidden">Open Generator</a>
          <a href="#pricing" class="px-4 py-3 rounded-xl font-semibold border border-slate-300/60 hover:bg-white/50">See pricing</a>
          <button id="heroSignIn" class="px-4 py-3 rounded-xl font-semibold border border-slate-300/60 only-guest">Sign in</button>
        </div>

        <div class="mt-6 flex items-center gap-3 text-xs text-slate-500 dark:text-slate-400">
          <span class="badge">Generator</span>
          <span class="badge">Optimizer</span>
          <span class="badge">Scheduler</span>
          <span class="badge">Presets</span>
        </div>
      </div>

      <!-- Right: visual mocks -->
      <div class="relative">
        <div class="orbit" aria-hidden="true"></div>
        <div class="grid gap-4">
          <div class="mock p-4 card">
            <div class="text-xs text-slate-400">Command</div>
            <pre class="mono text-xs bg-black/85 text-emerald-200 rounded-xl p-4 h-40 overflow-auto">repurpose generate --channels linkedin,x,email,instagram
? outline created
? 3 social variants
? email subject + body ready
? instagram caption + hashtags</pre>
          </div>
          <div class="grid md:grid-cols-2 gap-4">
            <div class="mock p-4 card">
              <div class="text-xs text-slate-400">LinkedIn</div>
              <div class="mt-2 h-24 text-sm text-slate-200/90 leading-relaxed">
                • Hook that earns the scroll<br>
                • 6–10 crisp lines, one CTA<br>
                • On-brand tone &amp; keywords
              </div>
            </div>
            <div class="mock p-4 card">
              <div class="text-xs text-slate-400">X (Twitter)</div>
              <div class="mt-2 h-24 text-sm text-slate-200/90 leading-relaxed">
                Two fast variants<br>
                Always ≤ 280 chars<br>
                Ready to post ✓
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Live activity strip (hero) -->
    <div class="mt-8 md:mt-10">
      <div class="max-w-7xl mx-auto px-4 md:px-5">
        <div class="card p-4 md:p-5">
          <div class="flex items-center justify-between flex-wrap gap-3">
            <div class="flex items-center gap-2">
              <span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span>
              <strong class="tracking-tight">Generations today</strong>
              <span class="chip" data-live-count>–</span>
            </div>
            <div class="text-xs text-slate-500">Real results update every 30s</div>
          </div>
          <div class="mt-3 overflow-hidden">
            <div class="flex gap-3 whitespace-nowrap text-[13px] will-change-transform" style="animation: scrollx 28s linear infinite" data-live-feed></div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- ===== LIVE DEMO / GENERATOR ===== -->
  <section id="demo" class="relative scroll-mt-24">
    <div class="max-w-7xl mx-auto px-4 md:px-5 py-14 md:py-20">
      <div class="flex items-end justify-between gap-4 mb-6">
        <div>
          <h2 class="text-2xl md:text-3xl font-black tracking-tight">Generator</h2>
          <p class="mt-1 text-slate-500 dark:text-slate-300 text-sm only-guest">
            No login needed — <span class="font-semibold">5 runs/month</span> on the public pool.
          </p>
          <p class="mt-1 text-slate-500 dark:text-slate-300 text-sm only-authed hidden">
            Signed in — your plan limits apply per day/month by tier.
          </p>
        </div>
        <div class="flex items-center gap-3">
          <a href="#pricing" class="btn">See pricing</a>
          <button class="btn btn-primary js-open-auth only-guest" type="button">Sign in</button>
        </div>
      </div>

      <!-- Presets + Batch rail -->
      <div class="card p-4 md:p-5 mb-6">
        <div class="flex flex-wrap items-center justify-between gap-3">
          <div class="flex items-center gap-2 text-sm">
            <span class="badge">Presets</span>
            <span>Save prompt settings for later. Starter: 10, Creator+: Unlimited.</span>
          </div>
          <div class="flex items-center gap-2">
            <button id="presetSave" class="btn only-authed hidden" type="button">Save as preset</button>
            <select id="presetSelect" class="border rounded-lg px-2 py-1 min-w-[200px]">
              <option value="">— Load preset —</option>
            </select>
            <button id="presetDelete" class="btn only-authed hidden" type="button">Delete</button>
          </div>
        </div>
        <div class="mt-3 flex flex-wrap items-center justify-between gap-3">
          <div class="flex items-center gap-2 text-sm">
            <span class="badge">Batch</span>
            <span>Up to <strong>5 lines/run</strong>. Each line becomes a separate generation.</span>
          </div>
          <div class="text-xs text-slate-500">Paste multiple lines in the source box below.</div>
        </div>
      </div>

      <!-- Generator Form -->
      <div class="card p-5 md:p-6 relative">
        <!-- Unlock mask (shown for Free when premium-only controls are used) -->
        <div id="genLock" class="locked-mask hidden">
          <span class="lock-badge">Creator+ feature</span>
          <a href="#pricing" class="btn btn-primary">Unlock preview</a>
        </div>

        <form id="demoForm" class="grid gap-6" autocomplete="off">
          <!-- Source selector -->
          <fieldset>
            <legend class="text-sm font-semibold">Source</legend>
            <div class="mt-2 grid md:grid-cols-3 gap-3">
              <label class="tab flex items-center justify-between">
                <span class="flex items-center gap-2">
                  <input type="radio" name="sourceType" value="paragraph" checked>
                  Paragraph / Notes
                </span>
                <span class="chip">fastest</span>
              </label>
              <label class="tab flex items-center">
                <input type="radio" name="sourceType" value="blog" class="mr-2">
                Full Blog (paste)
              </label>
              <label class="tab flex items-center">
                <input type="radio" name="sourceType" value="url" class="mr-2">
                URL
              </label>
            </div>
            <div class="mt-3">
              <textarea id="sourceText" class="w-full rounded-xl border p-4 min-h-[160px]"
                placeholder="Paste your paragraph, full article, or a URL.

For batch, paste up to 5 lines — each line is processed separately."></textarea>
              <div class="mt-2 text-xs text-slate-500"><span id="batchHint">Batch lines detected: 0</span></div>
            </div>
          </fieldset>

          <!-- Article Optimizer toggles (applied when present in input) -->
          <fieldset class="relative">
            <legend class="text-sm font-semibold">Article Optimizer (optional)</legend>
            <div class="mt-2 grid sm:grid-cols-2 lg:grid-cols-3 gap-2">
              <label class="flex items-center gap-2"><input type="checkbox" name="opt_humanize" checked> Humanize content</label>
              <label class="flex items-center gap-2"><input type="checkbox" name="opt_lengthen" value="30"> Lengthen ~30%</label>
              <label class="flex items-center gap-2"><input type="checkbox" name="opt_faqs"> Add FAQs (+ JSON-LD)</label>
              <label class="flex items-center gap-2"><input type="checkbox" name="opt_headings" checked> Auto-headings (H2/H3)</label>
              <label class="flex items-center gap-2"><input type="checkbox" name="opt_meta" checked> Better title & meta</label>
              <label class="flex items-center gap-2"><input type="checkbox" name="opt_ab" checked> A/B test 5 titles</label>
              <label class="flex items-center gap-2"><input type="checkbox" name="opt_seo" checked> SEO check (alt/links/length)</label>
              <label class="flex items-center gap-2"><input type="checkbox" name="opt_svg"> Add platform-fit SVG ideas</label>
            </div>

            <div class="mt-3 grid md:grid-cols-3 gap-3">
              <label class="grid gap-1">
                <span class="text-xs text-slate-500">Focus keyword</span>
                <input name="seo_keyword" class="border rounded-lg px-3 py-2" placeholder="e.g. content repurposing for SEO" />
              </label>
              <label class="grid gap-1">
                <span class="text-xs text-slate-500">Secondary keywords (comma-sep)</span>
                <input name="seo_secondaries" class="border rounded-lg px-3 py-2" placeholder="content repurposing strategy, social media repurposing" />
              </label>
              <label class="grid gap-1">
                <span class="text-xs text-slate-500">Target SERP intent</span>
                <select name="seo_intent" class="border rounded-lg px-3 py-2">
                  <option value="informational" selected>Informational</option>
                  <option value="commercial">Commercial</option>
                  <option value="transactional">Transactional</option>
                  <option value="navigational">Navigational</option>
                </select>
              </label>
            </div>
            <p class="mt-2 text-[12px] text-slate-500">
              We’ll also provide: <em>ranking likelihood</em>, <em>alt keyword ideas</em>, and a <em>CTR-tuned meta description</em>.
            </p>
          </fieldset>

          <!-- Channels -->
          <fieldset>
            <legend class="text-sm font-semibold">Channels to generate</legend>
            <div class="mt-2 grid sm:grid-cols-2 lg:grid-cols-4 gap-2">
              <label class="flex items-center gap-2"><input type="checkbox" name="ch_linkedin" checked> LinkedIn</label>
              <label class="flex items-center gap-2"><input type="checkbox" name="ch_x" checked> X (Twitter)</label>
              <label class="flex items-center gap-2"><input type="checkbox" name="ch_email" checked> Email</label>
              <label class="flex items-center gap-2"><input type="checkbox" name="ch_instagram"> Instagram</label>
              <label class="flex items-center gap-2"><input type="checkbox" name="ch_reddit" checked> Reddit</label>
              <label class="flex items-center gap-2"><input type="checkbox" name="ch_facebook"> Facebook</label>
              <label class="flex items-center gap-2"><input type="checkbox" name="ch_quora"> Quora</label>
              <label class="flex items-center gap-2"><input type="checkbox" name="ch_tiktok"> TikTok</label>
            </div>
          </fieldset>

          <!-- Channel extras -->
          <div class="grid md:grid-cols-2 gap-6">
            <fieldset class="card p-4">
              <legend class="text-sm font-semibold">LinkedIn</legend>
              <label class="flex items-center gap-2 mt-2"><input type="checkbox" name="li_article"> Also generate a LinkedIn Article</label>
            </fieldset>
            <fieldset class="card p-4">
              <legend class="text-sm font-semibold">X (Twitter)</legend>
              <div class="mt-2 flex items-center gap-3">
                <label class="flex items-center gap-2"><input type="checkbox" name="x_sequence" checked> Output as sequence</label>
                <label class="flex items-center gap-2">
                  Max posts:
                  <select name="x_posts" class="border rounded-lg px-2 py-1">
                    <option>2</option><option selected>4</option><option>6</option>
                  </select>
                </label>
              </div>
            </fieldset>
          </div>

          <!-- Actions -->
          <div class="flex flex-wrap items-center gap-3">
            <button id="generateBtn" type="submit" class="px-4 py-3 rounded-xl font-semibold text-white bg-black hover:opacity-90 only-guest">
              Generate (demo)
            </button>
            <button id="generateBtn_member" type="submit" class="px-4 py-3 rounded-xl font-semibold text-white bg-black hover:opacity-90 only-authed hidden">
              Generate
            </button>
            <button type="button" id="clearBtn" class="px-4 py-3 rounded-xl font-semibold border">Clear</button>

            <div class="text-sm text-slate-500 only-guest">
              You have <span id="demoQuota">—</span> demo runs left this month.
            </div>
            <div class="text-sm text-slate-500 only-authed hidden">
              You have <span id="memberQuota">—</span> runs left today.
            </div>

            <a href="#pricing" class="text-sm underline hover:opacity-80 ml-auto">Need more? See plans</a>
          </div>
        </form>
      </div>

      <!-- OUTPUT -->
      <div id="demoOutput" class="mt-8 grid gap-6" aria-live="polite" aria-busy="false">
        <!-- Channel cards injected here -->
      </div>

      <!-- Quick Publish (authed) -->
      <div class="mt-10 card p-5 only-authed hidden">
        <div class="flex items-center justify-between flex-wrap gap-3">
          <strong class="tracking-tight">Quick publish</strong>
          <div class="text-xs text-slate-500">Works with your last generation’s outputs.</div>
        </div>
        <div class="mt-4 grid sm:grid-cols-2 lg:grid-cols-4 gap-3">
          <button id="qp-x" class="btn">Post to X</button>
          <button id="qp-reddit" class="btn">Open Reddit submit</button>
          <button id="qp-linkedin" class="btn">Copy for LinkedIn & open</button>
          <button id="qp-email" class="btn">Send email draft</button>
        </div>

        <!-- Creator+ integrations -->
        <div class="mt-4 grid sm:grid-cols-2 gap-3 plan-creator-plus">
          <button id="li-notion" class="btn">Export to Notion</button>
          <button id="li-trello" class="btn">Send to Trello</button>
        </div>
        <div class="mt-2 text-xs text-slate-500 plan-creator-plus">
          Notion/Trello stay connected after refresh or logout; reconnect only if you revoke access.
        </div>
      </div>
    </div>
  </section>
  <!-- ===== ARTICLE OPTIMIZER (Authed-only; Free sees unlock mask) ===== -->
  <section id="optimizer" class="relative scroll-mt-24">
    <div class="max-w-7xl mx-auto px-4 md:px-5 py-14 md:py-20">
      <div class="flex items-end justify-between gap-4 mb-6">
        <div>
          <h2 class="text-2xl md:text-3xl font-black tracking-tight">Article Optimizer</h2>
          <p class="mt-1 text-slate-500 dark:text-slate-300 text-sm only-guest">
            Sign in to optimize full articles with SEO structure, FAQs (JSON-LD) and improved meta.
          </p>
          <p class="mt-1 text-slate-500 dark:text-slate-300 text-sm only-authed hidden">
            Paste your article — we’ll return clean HTML with headings, meta, FAQs & checks.
          </p>
        </div>
        <div class="flex items-center gap-3">
          <a href="#pricing" class="btn">See pricing</a>
          <button class="btn btn-primary js-open-auth only-guest" type="button">Sign in</button>
        </div>
      </div>

      <div class="card p-5 md:p-6 relative">
        <!-- Unlock mask for non-members -->
        <div id="optLock" class="locked-mask hidden">
          <span class="lock-badge">Members feature</span>
          <a href="#pricing" class="btn btn-primary">Unlock preview</a>
        </div>

        <form id="optForm" class="grid gap-6" autocomplete="off">
          <label class="grid gap-2">
            <span class="text-sm font-semibold">Your article</span>
            <textarea id="optSource" class="w-full rounded-xl border p-4 min-h-[220px]" placeholder="Paste your full article (plain text or HTML). We’ll restructure headings, humanize tone, add FAQs, and improve meta."></textarea>
          </label>

          <div class="grid md:grid-cols-3 gap-3">
            <label class="grid gap-1">
              <span class="text-xs text-slate-500">Focus keyword</span>
              <input id="optKw" class="border rounded-lg px-3 py-2" placeholder="e.g. content repurposing for SEO">
            </label>
            <label class="grid gap-1">
              <span class="text-xs text-slate-500">Secondary keywords (comma-sep)</span>
              <input id="optKws" class="border rounded-lg px-3 py-2" placeholder="repurpose blog to social, linkedin content plan">
            </label>
            <label class="grid gap-1">
              <span class="text-xs text-slate-500">Tone</span>
              <select id="optTone" class="border rounded-lg px-3 py-2">
                <option value="helpful" selected>Helpful</option>
                <option value="authoritative">Authoritative</option>
                <option value="conversational">Conversational</option>
                <option value="technical">Technical</option>
              </select>
            </label>
          </div>

          <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-2">
            <label class="flex items-center gap-2"><input type="checkbox" id="optHumanize" checked> Humanize & clarity pass</label>
            <label class="flex items-center gap-2"><input type="checkbox" id="optHeadings" checked> Auto H2/H3 sections</label>
            <label class="flex items-center gap-2"><input type="checkbox" id="optMeta" checked> Title & meta improvement</label>
            <label class="flex items-center gap-2"><input type="checkbox" id="optFaqs" checked> Add FAQs + JSON-LD</label>
            <label class="flex items-center gap-2"><input type="checkbox" id="optLinks" checked> Internal & external link suggestions</label>
            <label class="flex items-center gap-2"><input type="checkbox" id="optCheck" checked> SEO checks (alt, length)</label>
          </div>

          <div class="flex flex-wrap items-center gap-3">
            <button id="optGenerate" type="submit" class="px-4 py-3 rounded-xl font-semibold text-white bg-black hover:opacity-90 only-authed hidden">Optimize Article</button>
            <button type="button" id="optClear" class="px-4 py-3 rounded-xl font-semibold border only-authed hidden">Clear</button>
            <button class="btn btn-primary js-open-auth only-guest" type="button">Sign in to optimize</button>

            <div class="text-sm text-slate-500 ml-auto only-authed hidden">
              Creator+: export optimized HTML to Notion or Trello below.
            </div>
          </div>
        </form>
      </div>

      <!-- Optimized Output -->
      <div id="optResultWrap" class="mt-6 hidden">
        <div class="card p-4 md:p-5">
          <div class="flex items-center justify-between gap-3">
            <div class="flex items-center gap-2">
              <button id="optTabPreview" class="btn btn-primary" type="button">Preview</button>
              <button id="optTabHtml" class="btn" type="button">HTML</button>
            </div>
            <div class="flex items-center gap-2">
              <button id="optCopyHtml" class="btn" type="button">Copy HTML</button>
              <button id="optCopyMd" class="btn" type="button">Copy Markdown</button>
              <button id="optDownloadHtml" class="btn" type="button">Download .html</button>
            </div>
          </div>

          <!-- Tabs -->
          <div class="mt-4">
            <div id="optPreview" class="rounded-lg border p-4 bg-white/50 dark:bg-white/5 min-h-[200px]" aria-label="Optimized article preview"></div>
            <textarea id="optHtml" class="rounded-lg border p-4 mono text-sm w-full min-h-[240px] hidden" spellcheck="false"></textarea>
          </div>

          <!-- Creator+ exports -->
          <div class="mt-4 grid sm:grid-cols-2 gap-3 plan-creator-plus">
            <button id="optExportNotion" class="btn">Export to Notion</button>
            <button id="optExportTrello" class="btn">Send to Trello</button>
          </div>
          <p class="text-xs text-slate-500 mt-2 plan-creator-plus">
            Exports persist across refresh/logouts — reconnect only if you revoke access in Notion/Trello.
          </p>
        </div>
      </div>
    </div>
  </section>

  <!-- ===== INTEGRATIONS (Notion & Trello) ===== -->
  <section id="integrations" class="relative scroll-mt-24">
    <div class="max-w-7xl mx-auto px-4 md:px-5 py-14 md:py-20">
      <div class="text-center mb-8">
        <h2 class="text-2xl md:text-3xl font-black tracking-tight">Integrations</h2>
        <p class="mt-2 text-slate-600 dark:text-slate-300">Connect once — stays connected across refresh and sign-outs.</p>
      </div>

      <div class="grid md:grid-cols-2 gap-6">
        <!-- Notion -->
        <div class="card p-5">
          <div class="flex items-center justify-between">
            <div>
              <strong>Notion</strong>
              <div id="notionStatus" class="text-xs text-slate-500 mt-1">Not connected</div>
            </div>
            <div class="flex items-center gap-2">
              <button id="connectNotion" class="btn only-authed hidden" type="button">Connect</button>
              <button id="disconnectNotion" class="btn only-authed hidden" type="button">Disconnect</button>
              <button class="btn js-open-auth only-guest" type="button">Sign in</button>
            </div>
          </div>
          <p class="text-xs text-slate-500 mt-2">Creator+: export optimized articles and generator outputs to Notion.</p>
        </div>

        <!-- Trello -->
        <div class="card p-5">
          <div class="flex items-center justify-between">
            <div>
              <strong>Trello</strong>
              <div id="trelloStatus" class="text-xs text-slate-500 mt-1">Not connected</div>
            </div>
            <div class="flex items-center gap-2">
              <button id="connectTrello" class="btn only-authed hidden" type="button">Connect</button>
              <button id="disconnectTrello" class="btn only-authed hidden" type="button">Disconnect</button>
              <button class="btn js-open-auth only-guest" type="button">Sign in</button>
            </div>
          </div>
          <p class="text-xs text-slate-500 mt-2">Creator+: send drafts and project packs to Trello boards.</p>
        </div>
      </div>

      <!-- Export Project (Creator+) -->
      <div class="mt-6 card p-5 plan-creator-plus">
        <div class="flex items-center justify-between flex-wrap gap-3">
          <strong class="tracking-tight">Project export</strong>
          <div class="text-xs text-slate-500">Bundle your latest generator outputs and optimized article.</div>
        </div>
        <div class="mt-3 grid sm:grid-cols-2 gap-3">
          <button id="projExportNotion" class="btn">Export project to Notion</button>
          <button id="projExportTrello" class="btn">Send project to Trello</button>
        </div>
      </div>
    </div>
  </section>
<!-- ===== CRP ADD-ONS: Optimizer + Integrations + Presets + Batch (Part 4) ===== -->
<script type="module">
/* This script is additive. It does not modify your earlier boot code. */

const WORKER_BASE = window.WORKER_BASE || "https://contentflow-worker.frank-couchman.workers.dev";
const SITE_ORIGIN = window.SITE_ORIGIN || location.origin;
const PLAN_RANK = { free:0, starter:1, creator:2, business:3 };

const $  = (s, el=document)=> el.querySelector(s);
const $$ = (s, el=document)=> Array.from(el.querySelectorAll(s));
const byId = (id)=> document.getElementById(id);
const toast = (msg)=> {
  let t = byId("toast");
  if (!t){
    const div = document.createElement("div");
    div.id="toast";
    div.className="fixed bottom-4 left-1/2 -translate-x-1/2 px-4 py-2 rounded-lg border bg-white/90 dark:bg-black/70 text-sm shadow";
    div.innerHTML = `<span id="toastMsg"></span>`;
    document.body.appendChild(div);
    t = div;
  }
  byId("toastMsg").textContent = msg;
  t.classList.remove("hidden");
  setTimeout(()=> t.classList.add("hidden"), 1800);
};

// Supabase helpers (standalone so this file works even if loaded separately)
async function getAuthHeaders(){
  const h = { "Content-Type":"application/json" };
  try{
    if (!window.supabase){
      const { createClient } = await import("https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm");
      window.supabase = createClient(
        "https://ynkoavaeadlzlwylmfmu.supabase.co",
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlua29hdmFlYWRsemx3eWxtZm11Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5OTAxNDgsImV4cCI6MjA3MzU2NjE0OH0.1yM5yDo0MI9Upzt4GkLyf1mqvDXfb3DXvC0ouOLtRoU",
        { auth:{ persistSession:true, autoRefreshToken:true, detectSessionInUrl:true } }
      );
    }
    const { data } = await window.supabase.auth.getSession();
    const tok = data?.session?.access_token;
    const uid = data?.session?.user?.id;
    if (tok) h["Authorization"] = `Bearer ${tok}`;
    if (uid) h["X-User-Id"] = uid;
  }catch{}
  return h;
}

/* ---------- Plan + integrations status paint ---------- */
let CURRENT_PLAN = "free";
function rank(plan){ return PLAN_RANK[plan] ?? 0; }

async function refreshStatusAndIntegrations(){
  try{
    const r = await fetch(`${WORKER_BASE}/api/billing/status`, { headers: await getAuthHeaders() });
    const j = await r.json();
    if (!r.ok) throw new Error(j?.error?.message || "Status error");
    CURRENT_PLAN = (j.plan||"free").toLowerCase();

    // Lock/Unlock optimizer UI
    const lock = byId("optLock");
    const authed = j.scope === "user";
    const isFree = CURRENT_PLAN==="free";
    if (lock) lock.classList.toggle("hidden", authed && !isFree);
    $$(".only-authed").forEach(el=> el.classList.toggle("hidden", !authed));
    $$(".only-guest").forEach(el=> el.classList.toggle("hidden", authed));

    // Integrations paint
    const notion = j.integrations?.notion;
    byId("notionStatus") && (byId("notionStatus").textContent = notion?.connected ? `Connected${notion?.workspace_name?` — ${notion.workspace_name}`:""}` : "Not connected");
    byId("connectNotion")?.classList.toggle("hidden", !authed || notion?.connected);
    byId("disconnectNotion")?.classList.toggle("hidden", !authed || !notion?.connected);

    const trello = j.integrations?.trello;
    byId("trelloStatus") && (byId("trelloStatus").textContent = trello?.connected ? "Connected" : "Not connected");
    byId("connectTrello")?.classList.toggle("hidden", !authed || trello?.connected);
    // We don't have a server disconnect endpoint for Trello; hide button to avoid confusion.
    const tDisc = byId("disconnectTrello"); if (tDisc) tDisc.classList.add("hidden");
  }catch{}
}

/* ---------- Integrations: connect/disconnect handlers ---------- */
function wireIntegrations(){
  byId("connectNotion")?.addEventListener("click", async ()=>{
    try{
      const r = await fetch(`${WORKER_BASE}/api/integrations/notion/oauth/start`, { headers: await getAuthHeaders() });
      const j = await r.json(); if (!r.ok) throw new Error(j?.error?.message || "Connect failed");
      location.href = j.url;
    }catch(e){ toast(e.message || "Notion connect error"); }
  });
  byId("disconnectNotion")?.addEventListener("click", async ()=>{
    try{
      const r = await fetch(`${WORKER_BASE}/api/integrations/notion/disconnect`, { method:"POST", headers: await getAuthHeaders() });
      if (!r.ok) throw new Error("Disconnect failed");
      toast("Notion disconnected");
      refreshStatusAndIntegrations();
    }catch(e){ toast(e.message || "Notion disconnect error"); }
  });

  byId("connectTrello")?.addEventListener("click", async ()=>{
    try{
      const r = await fetch(`${WORKER_BASE}/api/integrations/trello/oauth/start`, { headers: await getAuthHeaders() });
      const j = await r.json(); if (!r.ok) throw new Error(j?.error?.message || "Connect failed");
      location.href = j.url; // Trello handles fragment token → /token bridge in Worker
    }catch(e){ toast(e.message || "Trello connect error"); }
  });
}

/* ---------- Presets (save/load/delete) ---------- */
function readGeneratorState(){
  const f = byId("demoForm"); if (!f) return {};
  const o = {};
  // source
  o.sourceType = f.elements["sourceType"]?.value || "paragraph";
  o.sourceText = byId("sourceText")?.value || "";
  // toggles
  const pick = (n)=> !!f.elements[n]?.checked;
  o.tog = {
    ch_linkedin: pick("ch_linkedin"),
    ch_x: pick("ch_x"),
    ch_email: pick("ch_email"),
    ch_instagram: pick("ch_instagram"),
    ch_reddit: pick("ch_reddit"),
    ch_facebook: pick("ch_facebook"),
    ch_quora: pick("ch_quora"),
    ch_tiktok: pick("ch_tiktok"),
    li_article: pick("li_article"),
    x_sequence: pick("x_sequence"),
    opt_humanize: pick("opt_humanize"),
    opt_lengthen: !!f.elements["opt_lengthen"]?.checked,
    opt_faqs: pick("opt_faqs"),
    opt_headings: pick("opt_headings"),
    opt_meta: pick("opt_meta"),
    opt_ab: pick("opt_ab"),
    opt_seo: pick("opt_seo"),
    opt_svg: pick("opt_svg")
  };
  // extras
  o.extras = {
    x_posts: f.elements["x_posts"]?.value || "4",
    seo_keyword: f.elements["seo_keyword"]?.value || "",
    seo_secondaries: f.elements["seo_secondaries"]?.value || "",
    seo_intent: f.elements["seo_intent"]?.value || "informational"
  };
  return o;
}
function applyGeneratorState(s){
  const f = byId("demoForm"); if (!f || !s) return;
  if (s.sourceType) { const el=[...f.elements["sourceType"]].find(r=>r.value===s.sourceType); el && (el.checked=true); }
  if (s.sourceText!=null) byId("sourceText").value = s.sourceText;
  const set = (n,v)=>{ const el=f.elements[n]; if (!el) return; if (el.type==="checkbox") el.checked=!!v; else el.value=v; };
  for (const [k,v] of Object.entries(s.tog||{})) set(k,v);
  for (const [k,v] of Object.entries(s.extras||{})) set(k,v);
}

async function presetsLoad(){
  try{
    const r = await fetch(`${WORKER_BASE}/api/presets/list`, { headers: await getAuthHeaders() });
    const j = await r.json(); if (!r.ok) throw new Error(j?.error?.message || "Load failed");
    const list = j.presets || [];
    const wrap = byId("presetList"); if (!wrap) return;
    wrap.innerHTML = "";
    if (!list.length){
      wrap.innerHTML = `<div class="text-sm text-slate-500">No presets yet.</div>`;
      return;
    }
    for (const p of list){
      const row = document.createElement("div");
      row.className = "flex items-center justify-between border rounded-lg px-3 py-2";
      row.innerHTML = `
        <div class="truncate">${p.title || "Untitled"}</div>
        <div class="flex items-center gap-2">
          <button class="btn btn-xs load">Load</button>
          <button class="btn btn-xs danger del">Delete</button>
        </div>`;
      $(".load",row).addEventListener("click", ()=> applyGeneratorState(p.data));
      $(".del",row).addEventListener("click", async ()=>{
        try{
          const r2 = await fetch(`${WORKER_BASE}/api/presets/delete`,{
            method:"POST", headers: await getAuthHeaders(),
            body: JSON.stringify({ id: p.id })
          });
          if (!r2.ok) throw new Error("Delete failed");
          presetsLoad();
        }catch(e){ toast(e.message || "Delete error"); }
      });
      wrap.appendChild(row);
    }
  }catch(e){ /* silent */ }
}
function wirePresets(){
  byId("presetSaveBtn")?.addEventListener("click", async ()=>{
    const title = (byId("presetTitle")?.value || "Preset").trim();
    const data = readGeneratorState();
    try{
      const r = await fetch(`${WORKER_BASE}/api/presets/save`,{
        method:"POST", headers: await getAuthHeaders(),
        body: JSON.stringify({ title, data })
      });
      const j = await r.json(); if (!r.ok) throw new Error(j?.error?.message || "Save failed");
      toast("Preset saved ✅");
      byId("presetTitle").value = "";
      presetsLoad();
    }catch(e){ toast(e.message || "Save error"); }
  });
}

/* ---------- Batch inputs (Starter: 5, Creator/Business: 30) ---------- */
function batchCap(){ return CURRENT_PLAN==="starter" ? 5 : (rank(CURRENT_PLAN)>=2 ? 30 : 5); }
function wireBatch(){
  const chk = byId("useBatch");
  const help= byId("batchHelp");
  const src = byId("sourceText");
  const form= byId("demoForm");
  if (!chk || !src || !form) return;

  const paint = ()=>{
    const cap = batchCap();
    help && (help.textContent = `Paste up to ${cap} lines. Each line becomes one job in this run.`);
  };
  paint();

  chk.addEventListener("change", paint);

  // Preprocess before the main generator handler runs
  form.addEventListener("submit", (e)=>{
    if (!chk.checked) return;
    // Transform the textarea into a single multi-item prompt the existing code can handle
    const lines = (src.value||"").split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    if (!lines.length) return;
    const cap = batchCap();
    const used = lines.slice(0, cap);
    const rest = lines.length - used.length;
    if (rest>0) toast(`Took first ${cap} lines (limit by plan). ${rest} skipped.`);
    src.value = `BATCH INPUTS (${used.length}):\n` + used.map((t,i)=>`${i+1}. ${t}`).join("\n");
  }, true); // capture: run before the other handler
}

/* ---------- Article Optimizer ---------- */
function optimizerSystemPrompt(opts){
  return {
    role:"system",
    content:
`You are an expert SEO editor. Return ONLY valid JSON with:
{
  "html": string,               // full cleaned article HTML (h2/h3, p, lists)
  "title": string,              // improved title
  "meta_description": string,   // CTR-friendly meta (~150 chars)
  "faq_jsonld": string,         // JSON-LD (FAQPage) or "" if none
  "checks": { "alt": number, "links": number, "read_time": string } // simple checks
}
Respect flags: humanize:${opts.humanize}, headings:${opts.headings}, meta:${opts.meta}, faqs:${opts.faqs}, links:${opts.links}, check:${opts.check}.
If input is HTML, preserve safe inline markup; never include <script> or external assets.`
  };
}
function optimizerUserPrompt(src, opts){
  return {
    role:"user",
    content:
`Article (may include HTML):
${src}

Focus keyword: ${opts.kw||"-"}
Secondary keywords: ${opts.kws||"-"}
Tone: ${opts.tone||"helpful"}

Tasks:
- Rewrite for clarity and ${opts.tone||"helpful"} tone ${opts.humanize?"(light humanize)":"(no change)"}.
- Structure with H2/H3 ${opts.headings?"(auto headings)":"(keep headings)"}.
- ${opts.meta?"Provide improved title and meta description.": "Keep title/meta as-is if present."}
- ${opts.faqs?"Add 3–6 FAQs with JSON-LD if relevant.": "No FAQs needed."}
- ${opts.links?"Suggest reasonable internal/external anchors (inline if natural).": "Skip link suggestions."}
- Run basic checks (alt, links, read time).
Return ONLY the JSON object.`
  };
}
function parseJsonLoose(txt){
  if (!txt) return null;
  let s = String(txt).trim();
  s = s.replace(/^```(?:json)?/i,"").replace(/```$/i,"").trim();
  const a=s.indexOf("{"), b=s.lastIndexOf("}");
  if (a>=0 && b>a) s=s.slice(a,b+1);
  try{ return JSON.parse(s);}catch{}
  s = s.replace(/,\s*([}\]])/g,"$1");
  try{ return JSON.parse(s);}catch{}
  return null;
}

function wireOptimizer(){
  const form = byId("optForm"); if (!form) return;
  const src  = byId("optSource");
  const resW = byId("optResultWrap");
  const prev = byId("optPreview");
  const html = byId("optHtml");
  const tabP = byId("optTabPreview");
  const tabH = byId("optTabHtml");
  const copyHtml = byId("optCopyHtml");
  const copyMd   = byId("optCopyMd");
  const dlHtml   = byId("optDownloadHtml");

  function showPreview(){ tabP.classList.add("btn-primary"); tabH.classList.remove("btn-primary"); prev.classList.remove("hidden"); html.classList.add("hidden"); }
  function showHtml(){ tabH.classList.add("btn-primary"); tabP.classList.remove("btn-primary"); prev.classList.add("hidden"); html.classList.remove("hidden"); }
  tabP?.addEventListener("click", showPreview);
  tabH?.addEventListener("click", showHtml);

  byId("optClear")?.addEventListener("click", ()=>{ src.value=""; resW.classList.add("hidden"); prev.innerHTML=""; html.value=""; });

  form.addEventListener("submit", async (e)=>{
    e.preventDefault();
    const raw = (src.value||"").trim(); if (!raw) return toast("Paste your article first");
    const opts = {
      kw: byId("optKw")?.value || "",
      kws: byId("optKws")?.value || "",
      tone: byId("optTone")?.value || "helpful",
      humanize: byId("optHumanize")?.checked,
      headings: byId("optHeadings")?.checked,
      meta: byId("optMeta")?.checked,
      faqs: byId("optFaqs")?.checked,
      links: byId("optLinks")?.checked,
      check: byId("optCheck")?.checked
    };
    const btn = byId("optGenerate"); const old = btn?.textContent; btn && (btn.disabled=true, btn.textContent="Optimizing…");

    try{
      const messages = [ optimizerSystemPrompt(opts), optimizerUserPrompt(raw, opts) ];
      const r = await fetch(`${WORKER_BASE}/api/generate`,{
        method:"POST",
        headers: await getAuthHeaders(),
        body: JSON.stringify({ plan: (CURRENT_PLAN==="free"?"free":"pro"), temperature: 0.4, messages })
      });
      const data = await r.json();
      if (!r.ok) throw new Error(data?.error?.message || "Optimization failed");
      const content = data?.choices?.[0]?.message?.content || "";
      const j = parseJsonLoose(content);
      if (!j?.html) throw new Error("Model didn't return HTML");

      // Paint preview + HTML
      prev.innerHTML = j.html;
      html.value = `<!-- title: ${j.title||""} -->\n<!-- meta: ${j.meta_description||""} -->\n${j.html}\n${j.faq_jsonld?`\n<!-- FAQ JSON-LD -->\n<script type="application/ld+json">\n${j.faq_jsonld}\n</script>\n`:""}`;
      resW.classList.remove("hidden");
      showPreview();
      toast("Optimized ✅");
      window.__CRP_LAST_OPTIMIZED__ = { html: j.html, title: j.title, meta: j.meta_description, faq_jsonld: j.faq_jsonld||"" };
    }catch(e){ toast(e.message || "Optimization error"); }
    finally{ btn && (btn.disabled=false, btn.textContent=old||"Optimize Article"); }
  });

  copyHtml?.addEventListener("click", async ()=>{ try{ await navigator.clipboard.writeText(byId("optHtml").value||""); toast("HTML copied ✅"); }catch{ toast("Copy failed"); }});
  copyMd?.addEventListener("click", async ()=>{
    // naive HTML→MD fallback (good enough for quick copy)
    const tmp = document.createElement("div"); tmp.innerHTML = byId("optHtml").value||"";
    const md = tmp.innerText; // quick text copy
    try{ await navigator.clipboard.writeText(md); toast("Markdown copied ✅"); }catch{ toast("Copy failed"); }
  });
  dlHtml?.addEventListener("click", ()=>{
    const blob = new Blob([byId("optHtml").value||""], { type:"text/html;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a"); a.href=url; a.download="optimized-article.html"; a.click();
    setTimeout(()=> URL.revokeObjectURL(url), 1500);
  });

  // Exports (Creator+)
  byId("optExportNotion")?.addEventListener("click", async ()=>{
    try{
      const last = window.__CRP_LAST_OPTIMIZED__; if (!last) return toast("Optimize an article first");
      const blocks = [
        { type:"heading", text: last.title || "Optimized Article" },
        { type:"paragraph", text: `Meta: ${last.meta||""}` },
        { type:"paragraph", text: "HTML below:" },
        { type:"paragraph", text: last.html.replace(/<[^>]+>/g,"").slice(0,1900) }
      ];
      const r = await fetch(`${WORKER_BASE}/api/integrations/notion/export`,{
        method:"POST", headers: await getAuthHeaders(),
        body: JSON.stringify({ title: last.title || "Optimized Article", blocks })
      });
      const j = await r.json(); if (!r.ok) throw new Error(j?.error?.message || "Notion export failed");
      window.open(j.url, "_blank");
    }catch(e){ toast(e.message || "Export error"); }
  });
  byId("optExportTrello")?.addEventListener("click", async ()=>{
    try{
      const last = window.__CRP_LAST_OPTIMIZED__; if (!last) return toast("Optimize an article first");
      const desc = `Meta: ${last.meta||""}\n\n---\n\n${(last.html||"").replace(/<[^>]+>/g,"")}`;
      // You may want to prompt user for board/list; here we assume user has a default Trello setup
      const r = await fetch(`${WORKER_BASE}/api/integrations/trello/export`,{
        method:"POST", headers: await getAuthHeaders(),
        body: JSON.stringify({ board_id:"", list_id:"", title: last.title||"Optimized Article", description: desc.slice(0,4000) })
      });
      const j = await r.json(); if (!r.ok) throw new Error(j?.error?.message || "Trello export failed");
      window.open(j.url, "_blank");
    }catch(e){ toast(e.message || "Export error"); }
  });
}

/* ---------- Project export (bundle latest generator outputs + optimized) ---------- */
function wireProjectExport(){
  const btnN = byId("projExportNotion");
  const btnT = byId("projExportTrello");
  if (!btnN && !btnT) return;

  function grabLastOutputs(){
    // We rely on cards rendered by generator (from earlier script). Gather their text.
    const cards = $$("#demoOutput .card");
    const chunks = [];
    cards.forEach(c=>{
      const title = $("strong", c)?.innerText || "Output";
      const text = $("pre", c)?.innerText || "";
      if (text.trim()) chunks.push(`### ${title}\n\n${text.trim()}`);
    });
    const opt = window.__CRP_LAST_OPTIMIZED__;
    return { chunks, opt };
  }

  btnN?.addEventListener("click", async ()=>{
    try{
      const { chunks, opt } = grabLastOutputs();
      if (!chunks.length && !opt) return toast("Generate or optimize something first");
      const blocks = [];
      if (opt){
        blocks.push({ type:"heading", text: opt.title || "Optimized Article" });
        blocks.push({ type:"paragraph", text: opt.meta || "" });
        blocks.push({ type:"paragraph", text: (opt.html||"").replace(/<[^>]+>/g,"").slice(0,1800) });
      }
      chunks.forEach(t=> blocks.push({ type:"paragraph", text: t.slice(0,1900) }));

      const r = await fetch(`${WORKER_BASE}/api/integrations/notion/export`,{
        method:"POST", headers: await getAuthHeaders(),
        body: JSON.stringify({ title:"ContentRepurpose Project", blocks })
      });
      const j = await r.json(); if (!r.ok) throw new Error(j?.error?.message || "Notion export failed");
      window.open(j.url, "_blank");
    }catch(e){ toast(e.message || "Export error"); }
  });

  btnT?.addEventListener("click", async ()=>{
    try{
      const { chunks, opt } = grabLastOutputs();
      if (!chunks.length && !opt) return toast("Generate or optimize something first");
      let description = "";
      if (opt){ description += `Optimized Article: ${opt.title||""}\n\n${(opt.html||"").replace(/<[^>]+>/g,"").slice(0,2000)}\n\n---\n\n`; }
      description += chunks.join("\n\n---\n\n");
      const r = await fetch(`${WORKER_BASE}/api/integrations/trello/export`,{
        method:"POST", headers: await getAuthHeaders(),
        body: JSON.stringify({ board_id:"", list_id:"", title:"ContentRepurpose Project", description: description.slice(0,4000) })
      });
      const j = await r.json(); if (!r.ok) throw new Error(j?.error?.message || "Trello export failed");
      window.open(j.url, "_blank");
    }catch(e){ toast(e.message || "Export error"); }
  });
}

/* ---------- Presets + Batch small UI injection (if not present) ---------- */
(function ensurePresetsBatchUI(){
  const anchor = byId("demoOutput")?.previousElementSibling; // the generator card container
  if (!anchor || byId("presetsPanel")) return;
  const panel = document.createElement("div");
  panel.id = "presetsPanel";
  panel.className = "card p-5 md:p-6 mt-6";
  panel.innerHTML = `
    <div class="flex items-end justify-between gap-3">
      <div>
        <strong class="tracking-tight">Batch & Presets</strong>
        <div class="text-xs text-slate-500">Starter: 5 lines/run · Creator/Business: 30 lines/run</div>
      </div>
      <label class="flex items-center gap-2">
        <input id="useBatch" type="checkbox"> Use batch inputs
      </label>
    </div>

    <div class="mt-3 text-xs text-slate-500" id="batchHelp">Paste up to 5 lines. Each line becomes one job in this run.</div>

    <div class="mt-4 grid md:grid-cols-3 gap-3 only-authed hidden">
      <label class="grid gap-1 md:col-span-2">
        <span class="text-xs text-slate-500">Preset title</span>
        <input id="presetTitle" class="border rounded-lg px-3 py-2" placeholder="e.g. LinkedIn thread + Email follow-up">
      </label>
      <button id="presetSaveBtn" class="btn btn-primary md:self-end" type="button">Save current as preset</button>
    </div>

    <div class="mt-3">
      <div class="text-sm mb-2">Your presets</div>
      <div id="presetList" class="grid gap-2"></div>
    </div>
  `;
  anchor.parentNode.insertBefore(panel, anchor.nextSibling);
})();

/* ---------- Boot ---------- */
document.addEventListener("DOMContentLoaded", async ()=>{
  wireIntegrations();
  wirePresets();
  wireBatch();
  wireOptimizer();
  wireProjectExport();
  await refreshStatusAndIntegrations();
  await presetsLoad();

  // Also refresh when auth changes (if your earlier script emits it)
  try{
    window.supabase?.auth?.onAuthStateChange?.((_e)=>{ refreshStatusAndIntegrations(); presetsLoad(); });
  }catch{}
});
</script>
<!-- ===== /CRP ADD-ONS (Part 4) ===== -->
<!-- ===== CRP ADD-ONS: Scheduler + Analytics + Unlock Overlays (Part 5) ===== -->
<script type="module">
/* This script augments the existing UI without breaking earlier logic. */

const WORKER_BASE = window.WORKER_BASE || "https://contentflow-worker.frank-couchman.workers.dev";
const PLAN_RANK = { free:0, starter:1, creator:2, business:3 };
const $  = (s, el=document)=> el.querySelector(s);
const $$ = (s, el=document)=> Array.from(el.querySelectorAll(s));
const byId = (id)=> document.getElementById(id);
const cap = (s)=> (s||"").slice(0,1).toUpperCase()+(s||"").slice(1);

function toast(msg){
  let t = byId("toast");
  if (!t){
    t = document.createElement("div");
    t.id = "toast";
    t.className = "fixed bottom-4 left-1/2 -translate-x-1/2 z-[100] px-4 py-2 rounded-lg border bg-white/90 dark:bg-black/70 text-sm shadow hidden";
    t.innerHTML = `<span id="toastMsg"></span>`;
    document.body.appendChild(t);
  }
  byId("toastMsg").textContent = msg;
  t.classList.remove("hidden");
  setTimeout(()=> t.classList.add("hidden"), 1800);
}

/* ---------------- Unlock previews (for Free users) ---------------- */
function addUnlockOverlay(el, {title, copy, cta="#pricing"}){
  if (!el || el.querySelector(".preview-mask")) return;
  el.style.position = "relative";
  const mask = document.createElement("div");
  mask.className = "preview-mask";
  mask.innerHTML = `
    <div class="cta card p-3 bg-white/90 dark:bg-black/70 border flex items-center gap-3">
      <div>
        <div class="font-semibold">${title||"Unlock this feature"}</div>
        <div class="text-xs text-slate-500">${copy||"Upgrade to Starter or Creator to use this."}</div>
      </div>
      <a href="${cta}" class="btn btn-primary">See plans</a>
    </div>`;
  el.appendChild(mask);
  el.classList.add("preview-locked");
}
function removeUnlockOverlay(el){
  if (!el) return;
  el.classList.remove("preview-locked");
  const m = el.querySelector(".preview-mask"); if (m) m.remove();
}

/* ---------------- Detect plan from body data-plan ---------------- */
function rankFromBody(){
  const p = document.body.getAttribute("data-plan") || "free";
  return PLAN_RANK[p] ?? 0;
}

/* ---------------- Scheduler (queue stored per user) ---------------- */
function schedStorageKey(){
  // per-user key; fallback to global
  const uid = (window.__CRP_USER_ID__) || document.body.getAttribute("data-user-id") || "anon";
  return `crp:schedule:${uid}`;
}
function readQueue(){
  try{ return JSON.parse(localStorage.getItem(schedStorageKey())||"[]"); }catch{ return []; }
}
function writeQueue(list){
  try{ localStorage.setItem(schedStorageKey(), JSON.stringify(list||[])); }catch{}
}
function uiQueueEmpty(vis){
  byId("schedEmpty")?.classList.toggle("hidden", vis);
  byId("schedList")?.classList.toggle("hidden", !vis);
}
function renderQueue(){
  const list = readQueue();
  const wrap = byId("schedList"); if (!wrap) return;
  wrap.innerHTML = "";
  if (!list.length){ uiQueueEmpty(false); return; }
  uiQueueEmpty(true);
  list.forEach((item, idx)=>{
    const row = document.createElement("div");
    row.className = "border rounded-lg p-3 grid gap-2";
    row.innerHTML = `
      <div class="flex items-center justify-between gap-2">
        <div class="text-xs chip">${new Date(item.when).toLocaleString()}</div>
        <div class="flex items-center gap-2">
          <label class="flex items-center gap-2 text-xs"><input type="checkbox" class="sel"> Select</label>
          <button class="btn btn-xs danger del">Delete</button>
        </div>
      </div>
      <div class="text-xs text-slate-500">${cap(item.channel)}</div>
      <pre class="whitespace-pre-wrap text-sm">${item.text}</pre>
    `;
    $(".del",row).addEventListener("click", ()=>{
      const cur = readQueue(); cur.splice(idx,1); writeQueue(cur); renderQueue(); updateAnalytics();
    });
    $(".sel",row).addEventListener("change", (e)=>{ item.__selected = e.target.checked; });
    wrap.appendChild(row);
  });
}

function wireScheduler(){
  const addBtn  = byId("schedAdd");
  const useLast = byId("schedUseLast");
  const clear   = byId("schedClear");
  const pubBtn  = byId("schedPublish");
  if (!addBtn || !pubBtn) return;

  // Lock display for free plan (view-only with overlay)
  const container = addBtn.closest(".card");
  const rnk = rankFromBody();
  if (rnk < 1){ addUnlockOverlay(container, { title:"Scheduler (Starter+)", copy:"Queue posts and plan your week. Upgrade to use the scheduler." }); }
  else removeUnlockOverlay(container);

  addBtn.addEventListener("click", ()=>{
    if (rankFromBody() < 1) return toast("Upgrade to Starter to use the Scheduler.");
    const ch = byId("schedChannel")?.value || "linkedin";
    const when = byId("schedWhen")?.value;
    const text = byId("schedText")?.value?.trim();
    if (!when) return toast("Pick a date & time");
    if (!text) return toast("Paste some text");
    const list = readQueue();
    list.push({ channel: ch, when: new Date(when).toISOString(), text });
    writeQueue(list);
    renderQueue(); updateAnalytics();
    toast("Added to queue ✅");
  });

  useLast?.addEventListener("click", ()=>{
    // Try to pull last output from generator cards
    const pre = $("#demoOutput pre"); 
    if (!pre) return toast("Generate something first");
    byId("schedText").value = pre.innerText.trim().slice(0, 2000);
    toast("Filled from last output");
  });

  clear?.addEventListener("click", ()=>{
    writeQueue([]); renderQueue(); updateAnalytics();
  });

  pubBtn.addEventListener("click", ()=>{
    if (rankFromBody() < 1) return toast("Upgrade to Starter to publish from Scheduler.");
    const list = readQueue();
    const sel  = list.filter(x=>x.__selected);
    const post = sel.length ? sel : list;
    if (!post.length) return toast("Nothing selected.");
    // Light “publish”: open intents (safer than APIs)
    post.forEach(item=>{
      const txt = item.text.slice(0, 10000);
      if (item.channel==="x"){
        window.open(`https://x.com/intent/tweet?text=${encodeURIComponent(txt.slice(0,270))}`,"_blank");
      } else if (item.channel==="linkedin"){
        navigator.clipboard.writeText(txt).catch(()=>{});
        window.open("https://www.linkedin.com/feed/","_blank");
      } else if (item.channel==="reddit"){
        const title = txt.split("\n")[0].slice(0,280);
        window.open(`https://www.reddit.com/submit?title=${encodeURIComponent(title)}&text=${encodeURIComponent(txt)}`,"_blank");
      } else if (item.channel==="email"){
        const subj = (txt.split("\n")[0] || "Draft").slice(0,120);
        location.href = `mailto:?subject=${encodeURIComponent(subj)}&body=${encodeURIComponent(txt)}`;
      } else {
        navigator.clipboard.writeText(txt).catch(()=>{});
        toast(`Copied ${cap(item.channel)} text to clipboard`);
      }
    });
    toast("Opened publishing intents");
  });

  renderQueue();
}

/* ---------------- Analytics (basic + pro placeholders) ---------------- */
function estimateReach(channel, len){
  // Tiny heuristic for display only
  const base = { linkedin: 150, x: 120, instagram: 100, facebook: 90, reddit: 80, email: 60, quora: 40, tiktok: 140 };
  const k = base[channel] || 50;
  const mult = Math.min(3, 1 + (len/280)); // more text → (slightly) higher
  return Math.round(k * mult);
}
function updateAnalytics(){
  const basic = byId("anaBasic");
  const pro   = byId("anaPro");
  const team  = byId("anaTeam");

  // Basics: per-day posts & est. reach from queue
  const q = readQueue();
  const byDay = {};
  let reach = 0;
  q.forEach(i=>{
    const d = new Date(i.when); const key = d.toISOString().slice(0,10);
    byDay[key] = (byDay[key]||0)+1;
    reach += estimateReach(i.channel, i.text.length);
  });
  const days = Object.entries(byDay).map(([d,c])=>`${d}: ${c}`).join(" · ");
  basic && (basic.textContent = q.length ? `Queued posts: ${q.length}. ${days}. Est. reach: ~${reach.toLocaleString()}.` : "Connect accounts to see data.");

  // Pro: per-channel breakdown (visible for Creator+)
  const r = rankFromBody();
  if (pro){
    if (r < 2){
      pro.textContent = "Unlock channel-level analytics with Creator plan.";
    } else {
      const perCh = {};
      q.forEach(i=> perCh[i.channel] = (perCh[i.channel]||0)+1);
      const parts = Object.entries(perCh).map(([ch,c])=> `${cap(ch)}: ${c}`).join(" · ");
      pro.textContent = parts ? parts : "No queued posts yet.";
    }
  }

  // Team: simple message (Business only)
  if (team){
    team.textContent = (r<3) ? "Invite teammates to unlock org-wide analytics." : "Org analytics coming online as you post.";
  }
}

/* ---------------- Lock specific premium areas with preview ---------------- */
function paintLocks(){
  const r = rankFromBody();

  // Quick publish integrations: Creator+
  const qpCard = byId("demo")?.querySelector(".only-authed + .plan-creator-plus, .plan-creator-plus");
  if (qpCard){
    if (r < 2) addUnlockOverlay(qpCard.closest(".card") || qpCard, { title:"Integrations (Creator+)", copy:"Export to Notion & Trello with Creator plan." });
    else removeUnlockOverlay(qpCard.closest(".card") || qpCard);
  }

  // Analytics Pro: Creator+
  const proCard = byId("anaPro")?.closest(".card");
  if (proCard){
    if (r < 2) addUnlockOverlay(proCard, { title:"Analytics Pro (Creator+)", copy:"Breakdown by channel with Creator plan." });
    else removeUnlockOverlay(proCard);
  }

  // Team Analytics: Business
  const teamCard = byId("anaTeam")?.closest(".card");
  if (teamCard){
    if (r < 3) addUnlockOverlay(teamCard, { title:"Team Analytics (Business)", copy:"Org-wide view, shared calendar & seats." });
    else removeUnlockOverlay(teamCard);
  }
}

/* ---------------- A11y tweaks ---------------- */
function a11y(){
  // Ensure all interactive elements have discernible text
  $$("button, a").forEach(el=>{
    if (!el.getAttribute("aria-label") && !el.textContent.trim()){
      el.setAttribute("aria-label","Action");
    }
  });
}

/* ---------------- Boot ---------------- */
document.addEventListener("DOMContentLoaded", ()=>{
  try{
    // expose user id from supabase (optional, helps per-user queue key)
    window.supabase?.auth?.getUser().then(({ data })=>{
      const uid = data?.user?.id; if (uid){ window.__CRP_USER_ID__ = uid; document.body.setAttribute("data-user-id", uid); }
      renderQueue(); updateAnalytics();
    }).catch(()=>{ renderQueue(); updateAnalytics(); });
  }catch{ renderQueue(); updateAnalytics(); }

  wireScheduler();
  paintLocks();
  a11y();

  // Repaint locks & analytics if plan changes (earlier script fires onAuthStateChange)
  try{
    window.supabase?.auth?.onAuthStateChange?.((_e, _s)=>{ setTimeout(()=>{ renderQueue(); updateAnalytics(); paintLocks(); }, 200); });
  }catch{}
});
</script>
<!-- ===== /CRP ADD-ONS (Part 5) ===== -->

<!-- Small CSS additions for buttons used above -->
<style>
  .btn.btn-xs{ padding:.25rem .5rem; font-size:.75rem; border-radius:.5rem }
  .btn.danger{ border-color:rgba(244,63,94,.5) }
</style>
<!-- ===== CRP INTEGRATIONS + DEEP LINKS + AUTH GUARDS (Part 6) ===== -->
<style>
  .intg-badge{display:inline-flex;align-items:center;gap:.4rem;font-size:.75rem;padding:.3rem .6rem;border:1px solid rgba(148,163,184,.35);border-radius:9999px}
  .intg-badge[data-state="connected"]{border-color:rgba(16,185,129,.5)}
  .intg-dot{width:.45rem;height:.45rem;border-radius:9999px;background:#f59e0b}
  .intg-badge[data-state="connected"] .intg-dot{background:#10b981}
  .is-disabled{opacity:.55;pointer-events:none}
</style>

<script type="module">
const WORKER_BASE = window.WORKER_BASE || "https://contentflow-worker.frank-couchman.workers.dev";
const PLAN_RANK   = { free:0, starter:1, creator:2, business:3 };
const $  = (s, el=document)=> el.querySelector(s);
const $$ = (s, el=document)=> Array.from(el.querySelectorAll(s));
const byId = (id)=> document.getElementById(id);
const cap = (s)=> (s||"").slice(0,1).toUpperCase()+(s||"").slice(1);
function toast(msg){
  let t=byId("toast"); if(!t){ t=document.createElement("div"); t.id="toast"; t.className="fixed bottom-4 left-1/2 -translate-x-1/2 z-[100] px-4 py-2 rounded-lg border bg-white/90 dark:bg-black/70 text-sm shadow"; t.innerHTML=`<span id="toastMsg"></span>`; document.body.appendChild(t); }
  byId("toastMsg").textContent = msg;
  t.classList.remove("hidden"); setTimeout(()=> t.classList.add("hidden"), 1800);
}

/* ---------------- Persist lightweight integration state (no secrets) ---------------- */
function userScopedKey(suffix){
  const uid = document.body.getAttribute("data-user-id") || window.__CRP_USER_ID__ || "anon";
  return `crp:${suffix}:${uid}`;
}
function saveIntegrationsState(state){
  try{ localStorage.setItem(userScopedKey("integrations"), JSON.stringify(state||{})); }catch{}
}
function readIntegrationsState(){
  try{ return JSON.parse(localStorage.getItem(userScopedKey("integrations"))||"{}"); }catch{ return {}; }
}

/* Add small badges near Quick Publish (Creator+) if present */
function ensureIntegrationBadges(){
  const qp = byId("demo")?.querySelector(".plan-creator-plus");
  if (!qp) return;
  if (byId("badgeRow")) return;

  const row = document.createElement("div");
  row.id = "badgeRow";
  row.className = "mt-3 flex items-center gap-2 text-xs";
  row.innerHTML = `
    <span class="intg-badge" id="badgeNotion" data-state="disconnected" title="Notion">
      <span class="intg-dot" aria-hidden="true"></span> Notion <span class="st">• Connect</span>
    </span>
    <span class="intg-badge" id="badgeTrello" data-state="disconnected" title="Trello">
      <span class="intg-dot" aria-hidden="true"></span> Trello <span class="st">• Connect</span>
    </span>
  `;
  qp.parentElement?.insertBefore(row, qp);
}

/* Paint buttons + badges */
function paintIntegrations(integrations, planRank){
  ensureIntegrationBadges();
  const n = integrations?.notion?.connected ? "connected" : "disconnected";
  const t = integrations?.trello?.connected ? "connected" : "disconnected";

  const bN = byId("badgeNotion"); const bT = byId("badgeTrello");
  if (bN){ bN.dataset.state = n; bN.querySelector(".st").textContent = n==="connected" ? "• Connected" : "• Connect"; }
  if (bT){ bT.dataset.state = t; bT.querySelector(".st").textContent = t==="connected" ? "• Connected" : "• Connect"; }

  const btnNotion = byId("li-notion");
  const btnTrello = byId("li-trello");
  const needPlan = planRank < 2;

  // Plan gate first
  [btnNotion, btnTrello].forEach(b=>{
    if (!b) return;
    b.classList.toggle("is-disabled", needPlan);
    b.title = needPlan ? "Creator+ required" : "";
  });

  // If plan ok but not connected, clicking badge or button starts OAuth
  function wireConnect(el, which){
    if (!el) return;
    el.onclick = async (e)=>{
      if (planRank < 2){ e.preventDefault(); location.hash="#pricing"; toast("Upgrade to Creator to use integrations."); return; }
      const url = which==="notion"
        ? `${WORKER_BASE}/api/integrations/notion/oauth/start`
        : `${WORKER_BASE}/api/integrations/trello/oauth/start`;
      try{
        const r = await fetch(url, { headers: await getAuthHeaders() });
        const j = await r.json();
        if (!r.ok || !j.url) throw new Error(j?.error?.message || "Connect failed");
        location.href = j.url;
      }catch(err){ toast(err.message||"Connect error"); }
    };
  }

  if (planRank >= 2){
    if (n!=="connected") wireConnect(byId("li-notion"), "notion"), wireConnect(bN, "notion");
    if (t!=="connected") wireConnect(byId("li-trello"), "trello"), wireConnect(bT, "trello");
  }

  // When connected, “Export” buttons will gather latest content (wired below)
}

/* Export handlers (No-op if not Creator+) */
function wireExports(){
  const btnNotion = byId("li-notion");
  const btnTrello = byId("li-trello");
  const getLast = ()=> {
    const pre = $("#demoOutput .card pre.content") || $("#demoOutput .card pre");
    const title = (pre?.innerText?.split("\n")[0] || "ContentRepurpose Export").slice(0,120);
    const body  = pre?.innerText || "";
    return { title, body };
  };

  btnNotion?.addEventListener("click", async ()=>{
    if (rankFromBody()<2) return toast("Creator plan required");
    const { title, body } = getLast();
    if (!body) return toast("Generate something first");
    try{
      const r = await fetch(`${WORKER_BASE}/api/integrations/notion/export`,{
        method:"POST",
        headers: await getAuthHeaders(),
        body: JSON.stringify({ title, blocks: body.split(/\n\n+/).map(p=>({ type:"paragraph", text:p })) })
      });
      const j = await r.json();
      if (!r.ok) throw new Error(j?.error?.message||"Notion export failed");
      toast("Sent to Notion ✅");
      window.open(j.url, "_blank");
    }catch(e){ toast(e.message||"Export error"); }
  });

  btnTrello?.addEventListener("click", async ()=>{
    if (rankFromBody()<2) return toast("Creator plan required");
    const { title, body } = getLast();
    if (!body) return toast("Generate something first");
    // Minimal: user chooses a list once elsewhere (for demo, create to default board/list via Trello UI)
    try{
      // If you have UI to pick list_id, plug it here; using placeholder requires your front-end addition:
      const listId = localStorage.getItem(userScopedKey("trello:list")) || "";
      if (!listId) { toast("Choose a Trello list in Integrations first"); return; }
      const r = await fetch(`${WORKER_BASE}/api/integrations/trello/export`,{
        method:"POST",
        headers: await getAuthHeaders(),
        body: JSON.stringify({ list_id: listId, title, description: body })
      });
      const j = await r.json();
      if (!r.ok) throw new Error(j?.error?.message||"Trello export failed");
      toast("Card created on Trello ✅");
      window.open(j.url, "_blank");
    }catch(e){ toast(e.message||"Export error"); }
  });
}

/* Helper: headers with Supabase token */
async function getAuthHeaders(){
  const h = { "Content-Type":"application/json" };
  try{
    const { data } = await window.supabase.auth.getSession();
    const tok = data?.session?.access_token; const uid = data?.session?.user?.id;
    if (tok) h["Authorization"] = `Bearer ${tok}`; if (uid){ h["X-User-Id"] = uid; document.body.setAttribute("data-user-id", uid); }
  }catch{}
  return h;
}
function rankFromBody(){ const p = document.body.getAttribute("data-plan") || "free"; return PLAN_RANK[p] ?? 0; }

/* Fetch status → paint plan + integrations; persist lightweight “connected:true/false” only */
async function refreshPlanAndIntegrations(){
  try{
    const r = await fetch(`${WORKER_BASE}/api/billing/status`, { headers: await getAuthHeaders() });
    const j = await r.json();
    if (!r.ok) throw new Error(j?.error?.message || "Status error");

    // Plan was already painted by earlier boot; but resync if changed
    const plan = (j.plan||"free").toLowerCase();
    document.body.setAttribute("data-plan", plan);

    // Persist integrations meta (no secrets)
    const isN = !!j.integrations?.notion?.connected;
    const isT = !!j.integrations?.trello?.connected;
    const saved = readIntegrationsState();
    const next  = { notion: isN, trello: isT };
    if (saved.notion !== isN || saved.trello !== isT) saveIntegrationsState(next);

    paintIntegrations({ notion:{connected:isN}, trello:{connected:isT} }, rankFromBody());
  }catch{
    // fallback to local cached state for badge paint
    const saved = readIntegrationsState();
    paintIntegrations({ notion:{connected:!!saved.notion}, trello:{connected:!!saved.trello} }, rankFromBody());
  }
}

/* ---------------- “Deep-link” routing for #demo / #optimizer / #pricing ---------------- */
function smoothScrollTo(id){
  const el = document.querySelector(id);
  if (!el) return;
  try{ el.scrollIntoView({ behavior:"smooth", block:"start" }); }catch{ el.scrollIntoView(); }
}
function handleDeepLink(){
  const h = (location.hash||"").toLowerCase();
  if (!h) return;
  if (h==="#demo" || h.startsWith("#demo")) smoothScrollTo("#demo");
  if (h==="#pricing" || h.startsWith("#pricing")) smoothScrollTo("#pricing");
  if (h==="#optimizer" || h.startsWith("#optimizer")){
    // Focus the optimizer textarea if present
    smoothScrollTo("#optimizer");
    const t = byId("optArticleInput") || $('#optimizer textarea');
    t && t.focus();
  }
}

/* ---------------- Auth guardrails ---------------- */
function wireAuthGuards(){
  // Any element with data-requires-auth will open sign-in if guest
  const requires = $$("[data-requires-auth]");
  requires.forEach(el=>{
    el.addEventListener("click", (e)=>{
      if (document.body.getAttribute("data-auth")!=="authed"){
        e.preventDefault();
        const dlg = byId("auth");
        dlg?.showModal?.();
      }
    });
  });

  // Ensure all “Sign in” triggers are wired
  ["loginBtn","loginBtn_m","heroSignIn"].forEach(id=>{
    const el = byId(id);
    if (!el) return;
    el.addEventListener("click", (e)=>{
      e.preventDefault();
      byId("auth")?.showModal?.();
    });
  });
}

/* ---------------- Listen to auth changes to re-paint integrations ---------------- */
function bootIntegrationListeners(){
  try{
    window.supabase?.auth?.onAuthStateChange?.((_evt, session)=>{
      if (session?.user?.id){
        document.body.setAttribute("data-user-id", session.user.id);
      } else {
        document.body.removeAttribute("data-user-id");
      }
      // Refresh badges after sign-in/out
      setTimeout(refreshPlanAndIntegrations, 300);
    });
  }catch{}
}

/* ---------------- Boot ---------------- */
document.addEventListener("visibilitychange", ()=>{ if (document.visibilityState==="visible") refreshPlanAndIntegrations(); });

document.addEventListener("DOMContentLoaded", async ()=>{
  wireAuthGuards();
  handleDeepLink();
  await refreshPlanAndIntegrations();
  wireExports();

  // Also handle hash changes after load
  window.addEventListener("hashchange", handleDeepLink);

  // If you want a periodic gentle refresh of integration badges:
  setInterval(()=>{ if (document.visibilityState==="visible") refreshPlanAndIntegrations(); }, 60000);

  bootIntegrationListeners();
});
</script>
<!-- ===== /CRP INTEGRATIONS + DEEP LINKS + AUTH GUARDS (Part 6) ===== -->
</body>
<html>
