<!doctype html>
<html lang="en" class="h-full">
<head>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=AW-17511593434"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'AW-17511593434');
  </script>

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>ContentRepurpose.pro — AI Content Repurposing Tool & Generator</title>
  <meta name="description" content="Content repurposing AI that turns one idea into LinkedIn, X, Email & Instagram drafts. Export to Notion & Trello. BYOK supported.">
  <meta name="keywords" content="content repurposing, content repurposing ai, content repurposing tool, repurpose content, content repurpose, content repurposing ideas, repurpose project, repurpose content ai">
  <link rel="canonical" href="https://contentrepurpose.pro/">
  <meta name="theme-color" content="#0a0d18">
  <meta name="color-scheme" content="dark light">
  <meta name="robots" content="index,follow,max-video-preview:-1,max-image-preview:large,max-snippet:-1">

  <!-- Open Graph / Twitter -->
  <meta property="og:type" content="website">
  <meta property="og:title" content="ContentRepurpose.pro — AI Content Repurposing Tool">
  <meta property="og:description" content="Repurpose content with AI. Paste once → get LinkedIn, X, Email & Instagram drafts. Export to Notion & Trello. BYOK supported.">
  <meta property="og:url" content="https://contentrepurpose.pro/">
  <meta property="og:image" content="/og-cover.png">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="ContentRepurpose.pro — AI Content Generator">
  <meta name="twitter:description" content="Content repurposing AI for multi-channel drafts. Export to Notion & Trello. BYOK supported.">
  <meta name="twitter:image" content="/og-cover.png">

  <!-- Favicons -->
  <link rel="icon" type="image/svg+xml" href="/logo.svg">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">

  <!-- Preconnects for perf -->
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            brandA: '#7AA2FF',
            brandB: '#FF2D2D',
            ink: '#0a0d18',
            ink2: '#101425',
          },
          boxShadow: {
            glowA: '0 24px 96px rgba(122,162,255,.18), 0 14px 60px rgba(255,45,45,.10)',
            glass: '0 12px 40px rgba(2,6,23,.08)',
          },
          borderRadius: {
            xl2: '1.25rem',
          },
          keyframes: {
            float: { '0%,100%': { transform: 'translate3d(0,0,0)' }, '50%': { transform: 'translate3d(0,-20px,0)' } },
            spin360: { to: { transform: 'rotate(360deg)' } },
            marquee: { from: { transform: 'translateX(0)' }, to: { transform: 'translateX(-50%)' } },
          },
          animation: {
            float: 'float 16s ease-in-out infinite',
            floatSlow: 'float 22s ease-in-out infinite',
            spin360: 'spin360 18s linear infinite',
            marquee: 'marquee 26s linear infinite',
          }
        }
      }
    }
  </script>

  <!-- Base styles (component tokens) -->
  <style>
    :root{ --brandA:#7AA2FF; --brandB:#FF2D2D; --ink:#0a0d18; --ink-2:#101425 }
    html,body{font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .txt-grad{background:linear-gradient(135deg,var(--brandA),var(--brandB));-webkit-background-clip:text;background-clip:text;color:transparent}
    .bg-grad{background:linear-gradient(135deg,var(--brandA),var(--brandB))}
    .card{border-radius:1.25rem;border:1px solid rgba(15,23,42,.10);background:rgba(255,255,255,.80);box-shadow:0 12px 40px rgba(2,6,23,.08)}
    .glass{backdrop-filter: blur(12px); background:rgba(255,255,255,.62)}
    .badge{display:inline-flex;align-items:center;gap:.5rem;padding:.35rem .6rem;border-radius:9999px;border:1px solid rgba(255,255,255,.15);font-size:.75rem;background:rgba(255,255,255,.65)}
    .chip{font-size:.7rem;padding:.2rem .5rem;border-radius:9999px;border:1px solid rgba(148,163,184,.35)}
    .btn{padding:.65rem .95rem;border-radius:.9rem;border:1px solid rgba(148,163,184,.35)}
    .btn-primary{background:black;color:white}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    .orbit{
      position:absolute; inset:-32px; border-radius:24px; pointer-events:none;
      background: conic-gradient(from 0deg, rgba(122,162,255,.25), rgba(255,45,45,.18), rgba(122,162,255,.25));
      -webkit-mask: radial-gradient(closest-side, transparent 88%, black 89%);
              mask: radial-gradient(closest-side, transparent 88%, black 89%);
      animation: spin360 18s linear infinite;
    }
    .halo{
      position:absolute; filter: blur(60px); opacity:.55; pointer-events:none; transform:translateZ(0);
      background:radial-gradient(50% 50% at 50% 50%, rgba(122,162,255,.8), rgba(255,45,45,.65) 60%, transparent 70%);
      width:42rem; height:42rem; border-radius:50%; animation: float 16s ease-in-out infinite;
    }
    @media (prefers-color-scheme:dark){
      body{background:var(--ink);color:#e9eef6}
      .card{background:rgba(14,16,22,.6);border-color:rgba(255,255,255,.08);box-shadow:0 24px 96px rgba(122,162,255,.08),0 14px 60px rgba(255,45,45,.06)}
      .badge{background:rgba(255,255,255,.06);border-color:rgba(255,255,255,.12)}
    }
    .nav-sheet{position:fixed; inset:0 0 auto 0; background:rgba(0,0,0,.6); backdrop-filter:blur(8px); display:none}
    .nav-panel{position:absolute; top:0; right:0; width:82vw; max-width:380px; height:100%; background:rgba(14,16,22,.96); border-left:1px solid rgba(255,255,255,.08); padding:1rem}
    .nav-open .nav-sheet{display:block}
    .touch-target{min-height:44px; min-width:44px}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
    /* Guest/Member helpers (we’ll toggle data-auth on <body>) */
    .guest-only{}
    .member-only{ display:none !important; }
    [data-auth="member"] .guest-only{ display:none !important; }
    [data-auth="member"] .member-only{ display:initial !important; }
  </style>

  <!-- JSON-LD: Organization -->
  <script type="application/ld+json">{
    "@context":"https://schema.org",
    "@type":"Organization",
    "name":"ContentRepurpose.pro",
    "url":"https://contentrepurpose.pro/",
    "logo":"https://contentrepurpose.pro/logo.svg",
    "sameAs":[
      "https://x.com/contentrepurpose",
      "https://www.linkedin.com/company/contentrepurpose"
    ]
  }</script>
  <!-- JSON-LD: WebSite + Sitelinks search -->
  <script type="application/ld+json">{
    "@context":"https://schema.org",
    "@type":"WebSite",
    "url":"https://contentrepurpose.pro/",
    "name":"ContentRepurpose.pro",
    "potentialAction":{
      "@type":"SearchAction",
      "target":"https://contentrepurpose.pro/search?q={q}",
      "query-input":"required name=q"
    }
  }</script>
  <!-- JSON-LD: SoftwareApplication -->
  <script type="application/ld+json">{
    "@context":"https://schema.org",
    "@type":"SoftwareApplication",
    "name":"ContentRepurpose.pro",
    "applicationCategory":"ContentCreationApplication",
    "operatingSystem":"Web",
    "offers":{"@type":"Offer","price":"0","priceCurrency":"USD"}
  }</script>

  <!-- Safe, idempotent bootstrap (avoids “buttons don’t work” by deferring handlers) -->
  <script>
    window.__CRP__ = (function(){
      const Q = (sel, root=document) => root.querySelector(sel);
      const QA = (sel, root=document) => Array.from(root.querySelectorAll(sel));
      const byId = (id) => document.getElementById(id);

      // Event registry ensures multiple inits don’t duplicate listeners
      const on = (el, type, handler, opts) => {
        if (!el) return;
        const key = '__once_'+type;
        if (el[key]) el.removeEventListener(type, el[key]);
        el[key] = handler;
        el.addEventListener(type, handler, opts || false);
      };

      // Local storage helpers
      const store = {
        get(k, d=null){ try{ return JSON.parse(localStorage.getItem(k)) ?? d }catch{ return d } },
        set(k, v){ try{ localStorage.setItem(k, JSON.stringify(v)); }catch{} },
        del(k){ try{ localStorage.removeItem(k); }catch{} }
      };

      // Auth state (will be updated by real auth flows in Part 6)
      const auth = {
        get(){ return store.get('crp_auth', { status:'guest', plan:'free', email:'' }); },
        set(v){ store.set('crp_auth', v); document.body.setAttribute('data-auth', v.status === 'member' ? 'member' : 'guest'); }
      };

      // Toast
      let toastTimer;
      const toast = (msg) => {
        const t = byId('toast'), m = byId('toastMsg');
        if (!t || !m) return alert(msg);
        m.textContent = msg; t.classList.remove('hidden');
        clearTimeout(toastTimer);
        toastTimer = setTimeout(()=> t.classList.add('hidden'), 2200);
      };

      // Nav sheet
      const initNav = () => {
        const toggle = byId('navToggle'), sheet = byId('mobileNav'), closeBtn = byId('navClose');
        on(toggle, 'click', () => { document.documentElement.classList.add('nav-open'); toggle.setAttribute('aria-expanded','true'); });
        on(closeBtn, 'click', () => { document.documentElement.classList.remove('nav-open'); toggle.setAttribute('aria-expanded','false'); });
        on(sheet, 'click', (e) => { if (e.target === sheet) { document.documentElement.classList.remove('nav-open'); toggle.setAttribute('aria-expanded','false'); } });
      };

      const initTheme = () => {
        // Respect prefers-color-scheme, allow future toggle
        document.documentElement.classList.toggle('dark',
          window.matchMedia('(prefers-color-scheme: dark)').matches
        );
      };

      // Public API used by later parts
      return { Q, QA, byId, on, store, auth, toast, initNav, initTheme };
    })();
  </script>
</head>
<body class="min-h-full" data-auth="guest">
  <!-- Decorative halos -->
  <div class="halo" style="left:-14rem; top:-10rem;"></div>
  <div class="halo" style="right:-12rem; top:-6rem; width:34rem; height:34rem; opacity:.5; animation-duration:18s"></div>
  <div class="halo" style="left:-10rem; top:26rem; width:28rem; height:28rem; opacity:.45; animation-duration:22s"></div>

  <!-- NAV -->
  <header class="sticky top-0 z-40 backdrop-blur bg-white/55 dark:bg-black/20 border-b border-white/30">
    <div class="max-w-7xl mx-auto px-4 md:px-5 py-4 flex items-center justify-between">
      <a href="/" class="flex items-center gap-3" aria-label="ContentRepurpose home">
        <!-- Inline SVG logo -->
        <svg width="36" height="36" viewBox="0 0 48 48" class="rounded-xl" aria-hidden="true">
          <defs><linearGradient id="g2" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#7AA2FF"/><stop offset="100%" stop-color="#FF2D2D"/></linearGradient></defs>
        <rect x="0" y="0" width="48" height="48" rx="12" fill="url(#g2)"/>
          <path d="M14 16h10a6 6 0 0 1 0 12H20v4h-6V16zm6 6v4h4a2 2 0 1 0 0-4h-4z" fill="white"/>
          <path d="M28 16h6v16h-6z" fill="white" opacity=".9"/>
        </svg>
        <span class="font-semibold tracking-tight">Content<span class="txt-grad">Repurpose</span></span>
      </a>

      <!-- Desktop nav -->
      <nav class="hidden md:flex items-center gap-6 text-sm">
        <a href="#demo" class="hover:opacity-80 guest-only">Live Demo</a>
        <a href="#templates" class="hover:opacity-80 guest-only">Templates</a>
        <a href="#use-cases" class="hover:opacity-80 guest-only">Use cases</a>
        <a href="#best-picks" class="hover:opacity-80 guest-only">Best picks</a>
        <a href="#pricing" class="hover:opacity-80">Pricing</a>
        <a href="/blog" class="hover:opacity-80 guest-only">Blog</a>

        <span id="planbadge" class="px-3 py-1 rounded-full text-xs bg-white/70 dark:bg-white/10 border border-white/50">Plan: Free</span>
        <button id="manageBilling" class="px-3 py-1 rounded-lg border hidden">Manage billing</button>

        <div class="flex items-center gap-2">
          <button id="loginBtn" class="px-3 py-1 rounded-lg border">Sign in</button>
          <button id="logoutBtn" class="px-3 py-1 rounded-lg border hidden">Sign out</button>
        </div>
      </nav>

      <!-- Mobile burger -->
      <button id="navToggle" class="md:hidden touch-target px-3 py-2 rounded-lg border" aria-expanded="false" aria-controls="mobileNav" aria-label="Open menu">☰</button>
    </div>

    <!-- Guest promo bar (funnel strip) -->
    <div id="promoGuest" class="guest-only border-t border-white/40 bg-white/70 dark:bg-white/10">
      <div class="max-w-7xl mx-auto px-4 md:px-5 py-2 flex flex-wrap items-center justify-between gap-3 text-sm">
        <div class="flex items-center gap-2">
          <span class="px-2 py-0.5 rounded-full text-[11px] bg-black/80 text-white">LIMITED</span>
          <span>Use <strong class="mono">CONTENTOFF90</strong> for <strong>90% off</strong> the Creator plan.</span>
        </div>
        <div class="flex items-center gap-2">
          <button id="copyPromoBtn" class="px-3 py-1 rounded-lg border">Copy code</button>
          <a href="#pricing" class="px-3 py-1 rounded-lg bg-black text-white">See pricing</a>
        </div>
      </div>
    </div>

    <!-- Mobile sheet -->
    <div id="mobileNav" class="nav-sheet" aria-hidden="true">
      <div class="nav-panel text-sm text-white">
        <div class="flex items-center justify-between">
          <span class="font-semibold">Menu</span>
          <button id="navClose" class="touch-target px-3 py-2 rounded-lg border border-white/20" aria-label="Close menu">✕</button>
        </div>
        <nav class="mt-4 grid gap-2">
          <a href="#demo" class="px-3 py-2 rounded-lg hover:bg-white/10 guest-only">Live Demo</a>
          <a href="#templates" class="px-3 py-2 rounded-lg hover:bg-white/10 guest-only">Templates</a>
          <a href="#use-cases" class="px-3 py-2 rounded-lg hover:bg-white/10 guest-only">Use cases</a>
          <a href="#best-picks" class="px-3 py-2 rounded-lg hover:bg-white/10 guest-only">Best picks</a>
          <a href="#pricing" class="px-3 py-2 rounded-lg hover:bg-white/10">Pricing</a>
          <a href="/blog" class="px-3 py-2 rounded-lg hover:bg-white/10 guest-only">Blog</a>
        </nav>
        <div class="mt-6 grid gap-2">
          <span id="planbadge_m" class="px-3 py-1 rounded-full text-xs bg-white/10 border border-white/20 w-fit">Plan: Free</span>
          <button id="manageBilling_m" class="px-3 py-2 rounded-lg border border-white/20 hidden">Manage billing</button>
          <button id="loginBtn_m" class="px-3 py-2 rounded-lg border border-white/20">Sign in</button>
          <button id="logoutBtn_m" class="px-3 py-2 rounded-lg border border-white/20 hidden">Sign out</button>
        </div>
      </div>
    </div>
  </header>

  <!-- HERO -->
  <section class="relative">
    <div class="max-w-7xl mx-auto px-4 md:px-5 pt-10 md:pt-16 grid lg:grid-cols-2 gap-8 md:gap-10 items-center">
      <div>
        <!-- Funnel CTA bar -->
        <div class="flex flex-wrap items-center gap-3">
          <button id="ctaTryDemoTop" class="px-4 py-2 rounded-xl font-semibold text-white bg-black hover:opacity-90">Try Demo</button>
          <button id="ctaSignInTop" class="px-4 py-2 rounded-xl font-semibold border border-slate-300/60">Sign in</button>
          <a id="ctaContinueTop" href="/blog" class="px-4 py-2 rounded-xl font-semibold border border-slate-300/60">Continue to Website</a>
        </div>

        <h1 class="mt-6 text-3xl md:text-5xl font-black leading-tight tracking-tight">
          AI <span class="txt-grad">Content Repurposing Tool</span> — turn one idea into everywhere content.
        </h1>
        <p class="mt-4 text-slate-600 dark:text-slate-300 max-w-xl">
          Paste content → get <strong>LinkedIn</strong>, <strong>X</strong>, <strong>Email</strong> &amp; <strong>Instagram</strong> drafts.
          Export to <strong>Notion</strong> or <strong>Trello</strong>. BYOK supported.
        </p>

        <!-- Secondary CTA row -->
        <div class="mt-6 flex flex-wrap gap-3">
          <a href="#demo" class="px-4 py-3 rounded-xl font-semibold text-white bg-black hover:opacity-90">Try the Live Demo</a>
          <a href="#pricing" class="px-4 py-3 rounded-xl font-semibold border border-slate-300/60 hover:bg-white/50">See pricing</a>
          <button id="heroSignIn" class="px-4 py-3 rounded-xl font-semibold border border-slate-300/60">Sign in</button>
        </div>

        <!-- Social proof chips -->
        <div class="mt-6 flex items-center gap-3 text-xs text-slate-500 dark:text-slate-400">
          <span class="badge">AI Content Generator</span>
          <span class="badge">Repurposing Tool</span>
          <span class="badge">SEO-ready</span>
          <span class="badge">BYOK</span>
        </div>

        <!-- Trust strip -->
        <div class="mt-8 overflow-hidden">
          <div class="flex items-center gap-4 text-[11px] uppercase tracking-widest text-slate-500">
            <span class="chip">Creators</span>
            <span class="chip">Marketers</span>
            <span class="chip">Newsletters</span>
            <span class="chip">Teams</span>
          </div>
          <div class="relative mt-4">
            <div class="flex items-center gap-4 whitespace-nowrap opacity-70 animate-marquee will-change-transform">
              <div class="chip">LinkedIn-first</div>
              <div class="chip">Editorial-friendly</div>
              <div class="chip">Email copy</div>
              <div class="chip">Instagram captions</div>
              <div class="chip">Notion export</div>
              <div class="chip">Trello sync</div>
              <div class="chip">Keyword-aware</div>
              <div class="chip">Tone controls</div>
              <!-- duplicate for seamless scroll -->
              <div class="chip">LinkedIn-first</div>
              <div class="chip">Editorial-friendly</div>
              <div class="chip">Email copy</div>
              <div class="chip">Instagram captions</div>
              <div class="chip">Notion export</div>
              <div class="chip">Trello sync</div>
              <div class="chip">Keyword-aware</div>
              <div class="chip">Tone controls</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Visual mockups -->
      <div class="relative">
        <div class="orbit" aria-hidden="true"></div>
        <div class="grid gap-4">
          <div class="mock p-4 card">
            <div class="text-xs text-slate-400">Command</div>
            <pre class="mono text-xs bg-black/85 text-emerald-200 rounded-xl p-4 h-40 overflow-auto" aria-label="CLI Preview">repurpose generate --channels linkedin,x,email,instagram
? outline created
? 3 social variants
? email subject + body ready
? instagram caption + hashtags</pre>
          </div>
          <div class="grid md:grid-cols-2 gap-4">
            <div class="mock p-4 card">
              <div class="text-xs text-slate-400">LinkedIn</div>
              <div class="mt-2 h-24 text-sm text-slate-200/90 leading-relaxed">
                • Hook that earns the scroll<br>
                • 6–10 crisp lines, one CTA<br>
                • On-brand tone &amp; keywords
              </div>
            </div>
            <div class="mock p-4 card">
              <div class="text-xs text-slate-400">X (Twitter)</div>
              <div class="mt-2 h-24 text-sm text-slate-200/90 leading-relaxed">
                Two fast variants<br>
                Always ≤ 280 chars<br>
                Ready to post ✓
              </div>
            </div>
          </div>
          <div class="grid md:grid-cols-2 gap-4">
            <div class="mock p-4 card">
              <div class="text-xs text-slate-400">Email</div>
              <div class="mt-2 h-20 text-sm text-slate-200/90 leading-relaxed">
                Subject &amp; body prepped<br>
                Preview &amp; send from your client
              </div>
            </div>
            <div class="mock p-4 card">
              <div class="text-xs text-slate-400">Instagram</div>
              <div class="mt-2 h-20 text-sm text-slate-200/90 leading-relaxed">
                Caption + 3–5 hashtags<br>
                Short, skimmable, on-brand
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Live activity strip -->
    <div class="mt-8 md:mt-10">
      <div class="max-w-7xl mx-auto px-4 md:px-5">
        <div class="card p-4 md:p-5">
          <div class="flex items-center justify-between flex-wrap gap-3">
            <div class="flex items-center gap-2">
              <span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span>
              <strong class="tracking-tight">Generations today</strong>
              <span id="liveCount" class="chip">–</span>
            </div>
            <div class="text-xs text-slate-500">Real results update every 30s</div>
          </div>
          <div class="mt-3 overflow-hidden">
            <div id="liveFeed" class="flex gap-3 whitespace-nowrap text-[13px] will-change-transform" style="animation: marquee 28s linear infinite"></div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Tiny wiring so hero/nav CTAs always work (de-duped via bootstrap) -->
  <script>
    document.addEventListener('DOMContentLoaded', function(){
      const { byId, on, toast, auth, initNav, initTheme } = window.__CRP__;

      initTheme();
      initNav();

      // Plan badge paint
      const state = auth.get();
      const planText = (state.plan || 'free').toString().charAt(0).toUpperCase() + (state.plan || 'free').toString().slice(1);
      const pb = byId('planbadge'); if (pb) pb.textContent = `Plan: ${planText}`;
      const pbm = byId('planbadge_m'); if (pbm) pbm.textContent = `Plan: ${planText}`;

      // Header auth buttons
      on(byId('loginBtn'), 'click', () => { const dlg = byId('auth'); dlg?.showModal(); });
      on(byId('loginBtn_m'), 'click', () => { const dlg = byId('auth'); dlg?.showModal(); });
      on(byId('logoutBtn'), 'click', () => { auth.set({ status:'guest', plan:'free', email:'' }); toast('Signed out'); location.reload(); });
      on(byId('logoutBtn_m'), 'click', () => { auth.set({ status:'guest', plan:'free', email:'' }); toast('Signed out'); location.reload(); });

      // Manage billing (will be enabled after real plan detection)
      on(byId('manageBilling'), 'click', () => toast('Opening billing…'));
      on(byId('manageBilling_m'), 'click', () => toast('Opening billing…'));

      // Promo copy
      on(byId('copyPromoBtn'), 'click', async () => {
        try { await navigator.clipboard.writeText('CONTENTOFF90'); toast('Code copied ✅'); } catch { alert('Copy failed'); }
      });

      // Funnel CTAs
      const gotoDemo = () => { const sec = document.getElementById('demo'); if (sec) sec.scrollIntoView({ behavior: 'smooth' }); else location.hash = '#demo'; };
      on(byId('ctaTryDemoTop'), 'click', gotoDemo);
      on(byId('ctaSignInTop'), 'click', () => { const dlg = byId('auth'); dlg?.showModal(); });
      // Continue takes to your public area (blog/home hub). Can be updated later.
      // Already an <a> to /blog

      // Secondary hero CTAs
      on(byId('heroSignIn'), 'click', () => { const dlg = byId('auth'); dlg?.showModal(); });
    });
  </script>
<!-- === PART 3/8 — Icons + Toast bootstrap (idempotent) === -->
<style>
  /* Icon sizing helpers */
  .icon { width: 1rem; height: 1rem; display: inline-block; vertical-align: -0.15em; }
  .icon-lg { width: 1.25rem; height: 1.25rem; }

  /* Simple toast */
  #toast { position: fixed; left: 50%; bottom: 1.5rem; transform: translateX(-50%); z-index: 9999; display: none; }
  #toastMsg { padding: .6rem .9rem; border-radius: .75rem; background: black; color: white; font-size: .9rem; box-shadow: 0 8px 30px rgba(0,0,0,.25); }
  @media (prefers-color-scheme:light){ #toastMsg{ background: #111; color:#fff } }

  /* Marquee utility used in Part 2 */
  .animate-marquee{ animation: marquee 26s linear infinite }
  @keyframes marquee { from{ transform: translateX(0) } to{ transform: translateX(-50%) } }
</style>

<!-- Toast shell (created if missing to avoid duplicates) -->
<div id="toast" class="toast"><div id="toastMsg"></div></div>

<!-- SVG SPRITE (inject only if not already present) -->
<template id="crp-sprite-template">
  <svg id="crp-sprite" xmlns="http://www.w3.org/2000/svg" style="position:absolute;width:0;height:0;overflow:hidden" aria-hidden="true">
    <defs>
      <!-- LinkedIn -->
      <symbol id="i-li" viewBox="0 0 24 24"><path fill="currentColor" d="M4.98 3.5C4.98 4.88 3.86 6 2.5 6S0 4.88 0 3.5 1.12 1 2.5 1s2.48 1.12 2.48 2.5zM0 8h5v16H0zM8 8h4.8v2.2h.1c.67-1.2 2.33-2.46 4.8-2.46C22.6 7.74 24 10 24 13.8V24h-5v-9.1c0-2.18-.04-4.98-3.04-4.98-3.04 0-3.5 2.37-3.5 4.82V24H8z"/></symbol>
      <!-- X / Twitter -->
      <symbol id="i-x" viewBox="0 0 24 24"><path fill="currentColor" d="M18.244 2H21.5l-7.5 8.61L23 22h-6.9l-5.4-6.83L4.6 22H1.34l8.04-9.23L1 2h7.03l4.87 6.17L18.24 2Zm-1.2 18h1.9L7.03 4h-1.9L17.04 20Z"/></symbol>
      <!-- Instagram -->
      <symbol id="i-ig" viewBox="0 0 24 24"><path fill="currentColor" d="M12 7a5 5 0 1 0 0 10 5 5 0 0 0 0-10Zm6.5-.5a1 1 0 1 0 0-2 1 1 0 0 0 0 2ZM12 2c3.2 0 3.584.012 4.85.07 1.17.055 1.97.24 2.67.51.72.28 1.33.66 1.92 1.25.59.59.97 1.2 1.25 1.92.27.7.45 1.5.51 2.67.06 1.27.07 1.65.07 4.86s-.01 3.59-.07 4.86c-.06 1.17-.24 1.97-.51 2.67a5.1 5.1 0 0 1-1.25 1.92 5.1 5.1 0 0 1-1.92 1.25c-.7.27-1.5.45-2.67.51-1.27.06-1.65.07-4.86.07s-3.59-.01-4.86-.07c-1.17-.06-1.97-.24-2.67-.51a5.1 5.1 0 0 1-1.92-1.25 5.1 5.1 0 0 1-1.25-1.92c-.27-.7-.45-1.5-.51-2.67C2.01 15.6 2 15.2 2 12s.01-3.59.07-4.86c.06-1.17.24-1.97.51-2.67A5.1 5.1 0 0 1 3.83 2.55 5.1 5.1 0 0 1 5.75 1.3c.7-.27 1.5-.45 2.67-.51C9.7.73 10.1.72 13.3.72z"/></symbol>
      <!-- Mail -->
      <symbol id="i-mail" viewBox="0 0 24 24"><path fill="currentColor" d="M20 4H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2Zm0 4-8 5L4 8V6l8 5 8-5v2Z"/></symbol>
      <!-- Reddit -->
      <symbol id="i-reddit" viewBox="0 0 24 24"><path fill="currentColor" d="M14.5 3.5a1 1 0 1 0 0 2l2.3.5a4.5 4.5 0 1 1-1 7.9c-.8.5-1.9.8-3.1.8s-2.3-.3-3.1-.8a4.5 4.5 0 1 1-1-7.9l2.3-.5a1 1 0 1 0 0-2l-2.1.5A6.5 6.5 0 1 0 12 20.5a6.5 6.5 0 1 0 6.5-11.8z"/></symbol>
      <!-- Facebook -->
      <symbol id="i-fb" viewBox="0 0 24 24"><path fill="currentColor" d="M22 12a10 10 0 1 0-11.6 9.9v-7H7.8v-3h2.6V9.3c0-2.6 1.5-4 3.8-4 1.1 0 2.2.2 2.2.2v2.5h-1.2c-1.2 0-1.6.8-1.6 1.6V12h2.7l-.4 3h-2.3v7A10 10 0 0 0 22 12Z"/></symbol>
      <!-- Quora -->
      <symbol id="i-quora" viewBox="0 0 24 24"><path fill="currentColor" d="M12 2C6.5 2 2 6.6 2 12s4.5 10 10 10c1.7 0 3.3-.4 4.7-1.2l2.2 2.2 1.4-1.4-2-2A9.9 9.9 0 0 0 22 12C22 6.6 17.5 2 12 2Zm0 18a8 8 0 1 1 0-16 8 8 0 0 1 0 16Z"/></symbol>
      <!-- TikTok -->
      <symbol id="i-tt" viewBox="0 0 24 24"><path fill="currentColor" d="M16 2h3a6 6 0 0 1-6 6v6a6 6 0 1 1-6-6h2a3.5 3.5 0 1 0 3.5 3.5V2h3.5Z"/></symbol>
      <!-- Calendar -->
      <symbol id="i-calendar" viewBox="0 0 24 24"><path fill="currentColor" d="M7 2h2v2h6V2h2v2h3a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h3V2Zm13 8H4v10h16V10Z"/></symbol>
      <!-- Chart -->
      <symbol id="i-chart" viewBox="0 0 24 24"><path fill="currentColor" d="M3 3h2v18H3zM8 13h2v8H8zM13 9h2v12h-2zM18 5h2v16h-2z"/></symbol>
      <!-- Wand -->
      <symbol id="i-wand" viewBox="0 0 24 24"><path fill="currentColor" d="m6 14 8-8 2 2-8 8H6zm10-10 1-3 1 3 3 1-3 1-1 3-1-3-3-1 3-1zM2 18l1-2 1 2 2 1-2 1-1 2-1-2-2-1 2-1z"/></symbol>
      <!-- Time -->
      <symbol id="i-time" viewBox="0 0 24 24"><path fill="currentColor" d="M12 1a11 11 0 1 0 0 22A11 11 0 0 0 12 1Zm1 6h-2v6l5 3 1-1.7-4-2.3V7z"/></symbol>
      <!-- Check -->
      <symbol id="i-check" viewBox="0 0 24 24"><path fill="currentColor" d="M9 16.2 4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4z"/></symbol>
    </defs>
  </svg>
</template>

<script>
  (function bootstrapIconsAndToast(){
    // Minimal helper namespace (plays nice with Part 1 bootstrap if present)
    window.__CRP__ = window.__CRP__ || {};
    const $ = (id)=> document.getElementById(id);
    const on = (el, evt, cb)=> el && el.addEventListener(evt, cb);
    window.__CRP__.byId = window.__CRP__.byId || $;
    window.__CRP__.on = window.__CRP__.on || on;

    // Inject sprite once (avoid duplicate symbol id collisions)
    if (!document.getElementById('i-li')){
      const tpl = document.getElementById('crp-sprite-template');
      if (tpl) document.body.appendChild(tpl.content.cloneNode(true));
    }

    // Ensure single toast node
    if (!$('toast')){
      const wrap = document.createElement('div');
      wrap.id = 'toast';
      wrap.innerHTML = '<div id="toastMsg"></div>';
      document.body.appendChild(wrap);
    }

    // Toast API
    function toast(msg = 'Done', ms = 2200){
      const box = $('toast'); const label = $('toastMsg');
      if (!box || !label) return alert(msg);
      label.textContent = msg;
      box.style.display = 'block';
      clearTimeout(box.__t);
      box.__t = setTimeout(()=> { box.style.display = 'none'; }, ms);
    }
    window.__CRP__.toast = window.__CRP__.toast || toast;

    // Small keyboard affordance (close toast)
    on(document, 'keydown', (e)=>{ if(e.key === 'Escape'){ const t = $('toast'); if(t) t.style.display='none'; }});
  })();
</script>
<!-- === /PART 3/8 === -->
<!-- === PART 4/8 — Templates + Use-cases + Best Picks === -->
<section id="templates" class="relative">
  <div class="max-w-7xl mx-auto px-4 md:px-5 py-14 md:py-20">
    <div class="flex items-end justify-between gap-4 mb-6">
      <h2 class="text-2xl md:text-3xl font-black tracking-tight">Templates</h2>
      <button class="icon-btn" data-scroll-to="#demo" aria-label="Try the live demo">
        <svg class="icon"><use href="#i-wand"/></svg>Try in demo
      </button>
    </div>

    <div class="grid sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 md:gap-6">
      <!-- LinkedIn Post -->
      <article class="card p-5 hover:shadow-xl transition" tabindex="0" role="button"
               data-apply-template="linkedin-post" aria-label="Apply LinkedIn Post template">
        <div class="flex items-center gap-2 text-sm text-slate-500">
          <svg class="icon"><use href="#i-li"/></svg>LinkedIn Post
        </div>
        <p class="mt-2 text-sm">Hook + 6–10 crisp lines + CTA. Hashtags optional.</p>
        <div class="mt-3 text-xs text-slate-500">Click to prefill demo</div>
      </article>

      <!-- X (Twitter) -->
      <article class="card p-5 hover:shadow-xl transition" tabindex="0" role="button"
               data-apply-template="x-sequence" aria-label="Apply X sequence template">
        <div class="flex items-center gap-2 text-sm text-slate-500">
          <svg class="icon"><use href="#i-x"/></svg>X (Twitter)
        </div>
        <p class="mt-2 text-sm">1–4 post sequence with alt variants under 280 chars.</p>
        <div class="mt-3 text-xs text-slate-500">Click to prefill demo</div>
      </article>

      <!-- Email -->
      <article class="card p-5 hover:shadow-xl transition" tabindex="0" role="button"
               data-apply-template="email" aria-label="Apply Email template">
        <div class="flex items-center gap-2 text-sm text-slate-500">
          <svg class="icon"><use href="#i-mail"/></svg>Email
        </div>
        <p class="mt-2 text-sm">Subject lines + body with preview text suggestions.</p>
        <div class="mt-3 text-xs text-slate-500">Click to prefill demo</div>
      </article>

      <!-- Instagram -->
      <article class="card p-5 hover:shadow-xl transition" tabindex="0" role="button"
               data-apply-template="instagram" aria-label="Apply Instagram template">
        <div class="flex items-center gap-2 text-sm text-slate-500">
          <svg class="icon"><use href="#i-ig"/></svg>Instagram Caption
        </div>
        <p class="mt-2 text-sm">Caption + 3–5 relevant hashtags and line breaks.</p>
        <div class="mt-3 text-xs text-slate-500">Click to prefill demo</div>
      </article>

      <!-- Reddit -->
      <article class="card p-5 hover:shadow-xl transition" tabindex="0" role="button"
               data-apply-template="reddit" aria-label="Apply Reddit Discussion template">
        <div class="flex items-center gap-2 text-sm text-slate-500">
          <svg class="icon"><use href="#i-reddit"/></svg>Reddit Discussion
        </div>
        <p class="mt-2 text-sm">Conversational post + comment prompts + best sub suggestions.</p>
        <div class="mt-3 text-xs text-slate-500">Click to prefill demo</div>
      </article>

      <!-- Facebook -->
      <article class="card p-5 hover:shadow-xl transition" tabindex="0" role="button"
               data-apply-template="facebook" aria-label="Apply Facebook Post template">
        <div class="flex items-center gap-2 text-sm text-slate-500">
          <svg class="icon"><use href="#i-fb"/></svg>Facebook Post
        </div>
        <p class="mt-2 text-sm">Primary text + headline/description variants for shares.</p>
        <div class="mt-3 text-xs text-slate-500">Click to prefill demo</div>
      </article>

      <!-- Quora -->
      <article class="card p-5 hover:shadow-xl transition" tabindex="0" role="button"
               data-apply-template="quora" aria-label="Apply Quora Answer template">
        <div class="flex items-center gap-2 text-sm text-slate-500">
          <svg class="icon"><use href="#i-quora"/></svg>Quora Answer
        </div>
        <p class="mt-2 text-sm">Direct answer + evidence framing + follow-up angles.</p>
        <div class="mt-3 text-xs text-slate-500">Click to prefill demo</div>
      </article>

      <!-- TikTok -->
      <article class="card p-5 hover:shadow-xl transition" tabindex="0" role="button"
               data-apply-template="tiktok" aria-label="Apply TikTok Script template">
        <div class="flex items-center gap-2 text-sm text-slate-500">
          <svg class="icon"><use href="#i-tt"/></svg>TikTok Script
        </div>
        <p class="mt-2 text-sm">3-hook openers, beat-by-beat script, and on-screen text.</p>
        <div class="mt-3 text-xs text-slate-500">Click to prefill demo</div>
      </article>

      <!-- LinkedIn Article -->
      <article class="card p-5 hover:shadow-xl transition" tabindex="0" role="button"
               data-apply-template="linkedin-article" aria-label="Apply LinkedIn Article template">
        <div class="flex items-center gap-2 text-sm text-slate-500">
          <svg class="icon"><use href="#i-li"/></svg>LinkedIn Article
        </div>
        <p class="mt-2 text-sm">Long-form with hero image SVG, subheads, pull-quotes.</p>
        <div class="mt-3 text-xs text-slate-500">Click to prefill demo</div>
      </article>
    </div>
  </div>
</section>

<section id="use-cases" class="relative">
  <div class="max-w-7xl mx-auto px-4 md:px-5 py-14 md:py-20">
    <h2 class="text-2xl md:text-3xl font-black tracking-tight">Use cases</h2>
    <div class="grid md:grid-cols-3 gap-6 mt-6">
      <div class="card p-5">
        <h3 class="font-semibold">Founders & Creators</h3>
        <p class="mt-2 text-sm text-slate-500">Turn podcasts, blogs, or notes into a weekly multi-channel plan.</p>
      </div>
      <div class="card p-5">
        <h3 class="font-semibold">Marketing Teams</h3>
        <p class="mt-2 text-sm text-slate-500">Keep brand voice consistent across LinkedIn, X, FB, and email.</p>
      </div>
      <div class="card p-5">
        <h3 class="font-semibold">SEO & Editorial</h3>
        <p class="mt-2 text-sm text-slate-500">Upgrade outlines to rankable articles with FAQs and internal anchors.</p>
      </div>
    </div>
  </div>
</section>

<section id="best-picks" class="relative">
  <div class="max-w-7xl mx-auto px-4 md:px-5 py-14 md:py-20">
    <div class="flex items-end justify-between gap-4 mb-6">
      <h2 class="text-2xl md:text-3xl font-black tracking-tight">Best picks</h2>
      <button class="icon-btn" data-scroll-to="#demo">
        <svg class="icon"><use href="#i-chart"/></svg>Generate yours
      </button>
    </div>

    <div class="grid md:grid-cols-2 xl:grid-cols-3 gap-6">
      <article class="card p-5">
        <h3 class="font-semibold">Long-form Article</h3>
        <ul class="mt-3 text-sm list-disc pl-5 space-y-1 text-slate-600 dark:text-slate-300">
          <li>Auto-headings (H2/H3), internal ToC</li>
          <li>Optional FAQs with JSON-LD</li>
          <li>Optimized HTML output ready to paste</li>
        </ul>
      </article>
      <article class="card p-5">
        <h3 class="font-semibold">Reddit Pack</h3>
        <ul class="mt-3 text-sm list-disc pl-5 space-y-1 text-slate-600 dark:text-slate-300">
          <li>Main post + 3 comment angles</li>
          <li>Suggested communities with flairs</li>
          <li>Tonal guidance to avoid removal</li>
        </ul>
      </article>
      <article class="card p-5">
        <h3 class="font-semibold">X Multi-Post</h3>
        <ul class="mt-3 text-sm list-disc pl-5 space-y-1 text-slate-600 dark:text-slate-300">
          <li>“Post 1 … Post 4” sequence</li>
          <li>Hook/Body/CTA structure per post</li>
          <li>≤ 280 chars each by default</li>
        </ul>
      </article>
      <article class="card p-5">
        <h3 class="font-semibold">Quora Answer</h3>
        <ul class="mt-3 text-sm list-disc pl-5 space-y-1 text-slate-600 dark:text-slate-300">
          <li>Direct answer + context + sources block</li>
          <li>Follow-up prompts to drive comments</li>
          <li>Ending CTA that feels native</li>
        </ul>
      </article>
      <article class="card p-5">
        <h3 class="font-semibold">Facebook Post</h3>
        <ul class="mt-3 text-sm list-disc pl-5 space-y-1 text-slate-600 dark:text-slate-300">
          <li>Primary text + link preview copy</li>
          <li>“Save-worthy” angle suggestions</li>
          <li>Image SVG ideas included</li>
        </ul>
      </article>
      <article class="card p-5">
        <h3 class="font-semibold">TikTok Script</h3>
        <ul class="mt-3 text-sm list-disc pl-5 space-y-1 text-slate-600 dark:text-slate-300">
          <li>3 opening hooks to test</li>
          <li>Beat sheet + on-screen text</li>
          <li>Natural close + CTA</li>
        </ul>
      </article>
    </div>
  </div>
</section>

<script>
  // Wiring that safely integrates with the existing Demo form (if present)
  (function templatesWiring(){
    const { byId: $, toast } = window.__CRP__ || {};
    const d = document;

    // Smooth scroll for any [data-scroll-to]
    d.querySelectorAll('[data-scroll-to]').forEach(btn=>{
      btn.addEventListener('click', (e)=>{
        const sel = btn.getAttribute('data-scroll-to');
        const target = sel && d.querySelector(sel);
        if (target) target.scrollIntoView({ behavior:'smooth', block:'start' });
      });
    });

    // Utility to set a checkbox by name safely
    function setCheck(name, value=true){
      const el = d.querySelector(`[name="${name}"]`);
      if (el && el.type === 'checkbox'){ el.checked = !!value; }
      if (el && el.tagName === 'SELECT'){ /* no-op here */ }
    }
    function setSelect(name, value){
      const el = d.querySelector(`[name="${name}"]`);
      if (el && el.tagName === 'SELECT'){ el.value = String(value); }
    }

    // Prefill demo content depending on the chosen template
    function applyTemplate(kind){
      const form = d.getElementById('demoForm');
      const src  = d.getElementById('sourceText');
      if (!form || !src){ if (toast) toast('Open the demo to use templates'); return; }

      // Reset all channels to a known state
      ['ch_linkedin','ch_x','ch_email','ch_instagram','ch_reddit','ch_facebook','ch_quora','ch_tiktok']
        .forEach(n=> setCheck(n, false));

      // Reset options
      ['opt_humanize','opt_lengthen','opt_faqs','opt_headings','opt_svg','opt_seo']
        .forEach(n=> setCheck(n, false));
      setCheck('opt_headings', true); // good default

      // Helpful snippets (short + generic)
      const sample = `We just launched ContentRepurpose.pro — paste any idea and get LinkedIn, X, Email, and Instagram drafts. Export to Notion & Trello. BYOK supported.`;

      switch(kind){
        case 'linkedin-post':
          src.value = sample;
          setCheck('ch_linkedin', true);
          setCheck('opt_humanize', true);
          break;
        case 'x-sequence':
          src.value = sample + ' Looking for fast multi-post tests.';
          setCheck('ch_x', true);
          setSelect('x_posts', 4);
          setCheck('x_sequence', true);
          break;
        case 'email':
          src.value = sample + ' Draft a short announcement email.';
          setCheck('ch_email', true);
          setCheck('opt_seo', true);
          break;
        case 'instagram':
          src.value = sample + ' Need a caption + 3–5 hashtags.';
          setCheck('ch_instagram', true);
          setCheck('opt_svg', true);
          break;
        case 'reddit':
          src.value = sample + ' Ask for feedback and workflow tips.';
          setCheck('ch_reddit', true);
          setCheck('rdt_communities', true);
          setCheck('rdt_comments', true);
          break;
        case 'facebook':
          src.value = sample + ' Write primary text and link preview copy.';
          setCheck('ch_facebook', true);
          break;
        case 'quora':
          src.value = 'How do you repurpose one idea across LinkedIn, X, Email, and Instagram?';
          setCheck('ch_quora', true);
          break;
        case 'tiktok':
          src.value = sample + ' Create 3 hooks and a simple beat sheet.';
          setCheck('ch_tiktok', true);
          setCheck('tt_hooks', true);
          setCheck('tt_onscreen', true);
          break;
        case 'linkedin-article':
          src.value = 'Repurposing content: a practical playbook for founders and lean teams.';
          setCheck('ch_linkedin', true);
          setCheck('li_article', true);
          setCheck('opt_faqs', true);
          setCheck('opt_seo', true);
          break;
        default:
          src.value = sample;
      }

      if (toast) toast('Template applied. Scroll to Demo.');
      const demo = d.querySelector('#demo');
      if (demo) demo.scrollIntoView({ behavior:'smooth' });
      // Focus the textarea for instant typing
      setTimeout(()=> d.getElementById('sourceText')?.focus(), 350);
    }

    // Card click + keyboard support
    d.querySelectorAll('[data-apply-template]').forEach(card=>{
      const kind = card.getAttribute('data-apply-template');
      const run = ()=> applyTemplate(kind);
      card.addEventListener('click', run);
      card.addEventListener('keypress', (e)=>{ if(e.key === 'Enter' || e.key === ' ') { e.preventDefault(); run(); }});
    });
  })();
</script>
<!-- === /PART 4/8 === -->
<!-- === PART 5/8 — Live Demo wiring + quota + output renderer === -->
<script>
(function DEMO_WIRE_UP(){
  // ==== Safe guards / tiny utils (use existing if present) ====
  const G = (window.__CRP__ ||= {});
  const d = document;
  const byId = G.byId || (G.byId = (id)=> d.getElementById(id));
  const showToast = G.toast || (G.toast = (msg)=> {
    const t = byId('toast'), m = byId('toastMsg');
    if(!t||!m) return alert(msg);
    m.textContent = msg; t.classList.remove('hidden');
    setTimeout(()=> t.classList.add('hidden'), 1800);
  });
  const getAuthHeaders = G.getAuthHeaders || (G.getAuthHeaders = async ()=> {
    // Fallback public headers — your Part 1–3 should override with real auth headers
    return { 'content-type':'application/json' };
  });
  const WORKER_BASE = G.WORKER_BASE || (G.WORKER_BASE = '');

  function escapeHTML(s=''){ return String(s)
    .replaceAll('&','&amp;').replaceAll('<','&lt;')
    .replaceAll('>','&gt;').replaceAll('"','&quot;'); }
  function extractJSON(txt=''){
    try{ return JSON.parse(txt); }catch(_){}
    const m = txt.match(/\{[\s\S]*\}$/); // last JSON object in stream
    if(m){ try{ return JSON.parse(m[0]); }catch(_){ } }
    return null;
  }
  function setBusy(btn, busy=true){
    if(!btn) return;
    btn.disabled = busy;
    btn.dataset.busy = busy ? '1' : '';
    btn.style.opacity = busy ? .7 : '';
  }

  // ==== DEMO QUOTA (5 runs / month, no login) ====
  const QUOTA_EL = byId('demoQuota');
  const GEN_BTN  = byId('generateBtn');
  const FORM     = byId('demoForm');
  const OUTPUT   = byId('demoOutput');
  const SOURCE   = byId('sourceText');

  function monthKey(){ const d=new Date(); return `${d.getUTCFullYear()}-${d.getUTCMonth()+1}`; }
  function readQuota(){
    const raw = JSON.parse(localStorage.getItem('crp_demo_quota') || '{}');
    const key = monthKey();
    if(!raw[key]) raw[key] = { used:0, cap:5 };
    // Clean old months to keep tidy
    Object.keys(raw).forEach(k=>{ if(k!==key) delete raw[k]; });
    localStorage.setItem('crp_demo_quota', JSON.stringify(raw));
    return raw[key];
  }
  function writeQuota(q){
    const raw = JSON.parse(localStorage.getItem('crp_demo_quota') || '{}');
    raw[monthKey()] = q;
    localStorage.setItem('crp_demo_quota', JSON.stringify(raw));
  }
  function paintQuota(){
    const q = readQuota();
    if(QUOTA_EL) QUOTA_EL.textContent = Math.max(0, (q.cap - q.used));
    if(GEN_BTN) GEN_BTN.disabled = q.used >= q.cap;
  }
  paintQuota();

  // ==== Live strip (generations today) — soft-fail ====
  const LIVE_COUNT = byId('liveCount');
  const LIVE_FEED  = byId('liveFeed');
  async function paintLive(){
    try{
      const r = await fetch(`${WORKER_BASE}/api/public/stats`, { cache:'no-store' });
      const j = await r.json().catch(()=> ({}));
      if(LIVE_COUNT && typeof j.generations_today === 'number'){
        LIVE_COUNT.textContent = j.generations_today.toLocaleString();
      }
      if(LIVE_FEED && Array.isArray(j.recent)){
        LIVE_FEED.innerHTML = '';
        j.recent.slice(0,24).forEach((it)=>{
          const pill = d.createElement('span');
          pill.className = 'chip';
          pill.textContent = it?.label || it?.channel || 'New draft';
          LIVE_FEED.appendChild(pill);
        });
      }
    }catch(_){ /* silent */ }
  }
  paintLive(); setInterval(paintLive, 30000);

  // ==== Helper: read form into a structured task ====
  function readForm(){
    const val = (name)=> d.querySelector(`[name="${name}"]`);
    const checked = (name)=> !!val(name)?.checked;
    const sel = (name)=> val(name)?.value;

    const sourceType = ['paragraph','blog','url'].find(v=> val('sourceType')?.value === v) || 'paragraph';

    const opts = {
      humanize:   checked('opt_humanize'),
      lengthen:   checked('opt_lengthen'),
      faqs:       checked('opt_faqs'),
      headings:   checked('opt_headings'),
      svg:        checked('opt_svg'),
      seo:        checked('opt_seo'),
    };

    const channels = {
      linkedin:   checked('ch_linkedin'),
      x:          checked('ch_x'),
      email:      checked('ch_email'),
      instagram:  checked('ch_instagram'),
      reddit:     checked('ch_reddit'),
      facebook:   checked('ch_facebook'),
      quora:      checked('ch_quora'),
      tiktok:     checked('ch_tiktok'),
    };

    const xPrefs = {
      sequence: checked('x_sequence'),
      postsMax: Number(sel('x_posts') || 4)
    };
    const linkedinPrefs = { article: checked('li_article') };
    const redditPrefs   = { suggestSubs: checked('rdt_communities'), comments: checked('rdt_comments') };
    const ttPrefs       = { hooks: checked('tt_hooks'), onscreen: checked('tt_onscreen') };

    return {
      source: (SOURCE?.value || '').trim(),
      sourceType,
      opts, channels, xPrefs, linkedinPrefs, redditPrefs, ttPrefs
    };
  }

  // ==== System Prompt (strict JSON so UI can render robustly) ====
  function buildSystemPrompt(task){
    const on = (b, yes, no='')=> b ? yes : no;
    return {
      role:'system',
      content: `
You are an expert content repurposer. Return ONLY one JSON object with selected keys (omit unselected channels). Do not include markdown fences.

Schema:
{
  "ok": true,
  "meta": { "notes": string },
  "linkedin": { "post": string, "article_html": string|null },
  "x": { "sequence": boolean, "posts": string[] },
  "email": { "subject": string, "body": string },
  "instagram": { "caption": string, "hashtags": string[] },
  "reddit": { "title": string, "body": string, "subreddits": string[], "starter_comments": string[] },
  "facebook": { "primary": string, "headline": string, "description": string },
  "quora": { "answer": string, "followups": string[] },
  "tiktok": { "script": string, "hooks": string[], "onscreen": string[] }
}

Editing rules:
- Keep facts; be concrete, non-fluffy.
- ${on(task.opts.humanize,'Human, conversational, crisp.','Neutral professional tone.')}
- ${on(task.opts.lengthen,'Expand thin ideas with examples.','Stay concise; only clarify if needed.')}
- ${on(task.opts.headings,'Prefer scannable bullets and short lines for socials.','')}
- ${on(task.opts.seo,'Make email subject and LI post keyword-aware, not spammy.','')}
- If Instagram, provide 3–5 relevant hashtags (no banned ones).
- If Reddit, sound native, avoid salesy tone; add communities only when highly relevant.
- If X, prefer ≤ 280 chars per post; number them "Post 1 …".
- If LinkedIn Article requested, include "article_html" with semantic HTML (<article>, <h2>, <p>, lists). No scripts.
- No external links unless clearly useful; no made-up data.

Hard constraints:
- Output valid JSON; no trailing commas; strings escaped properly.
`.trim()
    };
  }

  // ==== User Prompt ====
  function buildUserPrompt(task){
    const src = task.source;
    const isUrl = /^https?:\/\//i.test(src);
    const selected = Object.entries(task.channels).filter(([k,v])=> v).map(([k])=> k).join(', ');
    return {
      role:'user',
      content: `
Source ${task.sourceType}${isUrl ? ' (URL)' : ''}:
${src || '(no text provided)'}

Selected channels: ${selected || 'none'}

Channel preferences:
- LinkedIn Article: ${task.linkedinPrefs.article ? 'yes' : 'no'}
- X: sequence=${task.xPrefs.sequence} maxPosts=${task.xPrefs.postsMax}
- Reddit: subs=${task.redditPrefs.suggestSubs} comments=${task.redditPrefs.comments}
- TikTok: hooks=${task.ttPrefs.hooks} onscreen=${task.ttPrefs.onscreen}

General options: ${Object.entries(task.opts).filter(([_,v])=>v).map(([k])=>k).join(', ') || 'defaults'}

Task: Repurpose the source into drafts for the selected channels following the rules. Return only the JSON schema described by system.
`.trim()
    };
  }

  // ==== Renderers per channel ====
  function wipeOutput(){ if(OUTPUT) OUTPUT.innerHTML=''; }
  function card(title, iconId){
    const el = d.createElement('div');
    el.className = 'card p-5';
    el.innerHTML = `
      <div class="flex justify-between items-center gap-2 flex-wrap">
        <strong class="tracking-tight inline-flex items-center gap-2">
          <svg class="icon"><use href="#${iconId}"></use></svg>${escapeHTML(title)}
        </strong>
        <div class="flex items-center gap-2">
          <button class="px-3 py-1 rounded-full text-xs border js-copy">Copy</button>
        </div>
      </div>
      <div class="js-body mt-3 text-sm whitespace-pre-wrap"></div>
    `;
    el.querySelector('.js-copy')?.addEventListener('click', async ()=>{
      try{
        const txt = el.querySelector('.js-body')?.innerText || '';
        await navigator.clipboard.writeText(txt);
        showToast('Copied ✅');
      }catch{ showToast('Copy failed'); }
    });
    return el;
  }

  function renderLinkedIn(data){
    const el = card('LinkedIn', 'i-li');
    const body = el.querySelector('.js-body');
    body.innerText = data.post || '';
    if(data.article_html){
      const details = d.createElement('details');
      details.className = 'mt-3';
      details.innerHTML = `
        <summary class="text-sm text-slate-500">LinkedIn Article (optional)</summary>
        <div class="mt-2 text-sm prose prose-invert max-w-none js-article"></div>
      `;
      body.after(details);
      details.querySelector('.js-article').innerHTML = data.article_html;
    }
    OUTPUT.appendChild(el);
  }

  function renderX(data){
    const el = card('X (Twitter)', 'i-x');
    const body = el.querySelector('.js-body');
    const posts = (data.posts || []).map((p,i)=>`Post ${i+1}: ${p}`).join('\n\n');
    body.innerText = posts;
    const hint = d.createElement('div');
    hint.className = 'text-xs text-slate-500 mt-2';
    hint.textContent = data.sequence ? 'Sequence format enabled.' : 'Single posts.';
    body.after(hint);
    OUTPUT.appendChild(el);
  }

  function renderEmail(data){
    const el = card('Email', 'i-mail');
    const body = el.querySelector('.js-body');
    body.innerText = `Subject:\n${data.subject || ''}\n\nBody:\n${data.body || ''}`;
    OUTPUT.appendChild(el);
  }

  function renderInstagram(data){
    const el = card('Instagram', 'i-ig');
    const body = el.querySelector('.js-body');
    const tags = (data.hashtags||[]).map(h=> h.startsWith('#')? h : '#'+h).join(' ');
    body.innerText = `${data.caption || ''}\n\n${tags}`;
    OUTPUT.appendChild(el);
  }

  function renderReddit(data){
    const el = card('Reddit', 'i-reddit');
    const body = el.querySelector('.js-body');
    const subs = (data.subreddits||[]).slice(0,8).map(s=> s.startsWith('r/')? s : 'r/'+s).join(', ');
    const comments = (data.starter_comments||[]).map((c,i)=>`• ${c}`).join('\n');
    body.innerText = `Title:\n${data.title||''}\n\n${data.body||''}\n\nSuggested communities: ${subs || '—'}\n\nStarter comments:\n${comments || '—'}`;
    OUTPUT.appendChild(el);
  }

  function renderFacebook(data){
    const el = card('Facebook', 'i-fb');
    const body = el.querySelector('.js-body');
    body.innerText = `Primary:\n${data.primary||''}\n\nLink preview:\nHeadline: ${data.headline||''}\nDescription: ${data.description||''}`;
    OUTPUT.appendChild(el);
  }

  function renderQuora(data){
    const el = card('Quora', 'i-quora');
    const body = el.querySelector('.js-body');
    const fu = (data.followups||[]).map(f=>`• ${f}`).join('\n');
    body.innerText = `${data.answer||''}\n\nFollow-ups:\n${fu || '—'}`;
    OUTPUT.appendChild(el);
  }

  function renderTikTok(data){
    const el = card('TikTok', 'i-tt');
    const body = el.querySelector('.js-body');
    const hooks = (data.hooks||[]).map(h=>`• ${h}`).join('\n');
    const onsc  = (data.onscreen||[]).map(t=>`• ${t}`).join('\n');
    body.innerText = `Script:\n${data.script||''}\n\nHooks:\n${hooks || '—'}\n\nOn-screen:\n${onsc || '—'}`;
    OUTPUT.appendChild(el);
  }

  // ==== Form submit ====
  async function onSubmit(e){
    e?.preventDefault?.();
    if(!FORM || !GEN_BTN || !SOURCE) return;

    // Basic validation
    const task = readForm();
    if(!task.source){
      SOURCE.focus();
      showToast('Paste something to repurpose ✍️');
      return;
    }
    if(!Object.values(task.channels).some(Boolean)){
      showToast('Pick at least one channel');
      return;
    }

    // Quota gate (client-side; server should enforce real limits)
    const q = readQuota();
    if(q.used >= q.cap){
      showToast('You’ve used your 5 free demo runs. Create a free account for more!');
      return;
    }

    setBusy(GEN_BTN, true);
    OUTPUT.innerHTML = '';
    const loading = d.createElement('div');
    loading.className = 'text-sm text-slate-500';
    loading.textContent = 'Generating…';
    OUTPUT.appendChild(loading);

    try{
      const headers = await getAuthHeaders();
      const messages = [ buildSystemPrompt(task), buildUserPrompt(task) ];
      const r = await fetch(`${WORKER_BASE}/api/generate`, {
        method:'POST',
        headers,
        body: JSON.stringify({
          plan: 'free-demo',
          temperature: 0.5,
          messages
        })
      });
      const data = await r.json().catch(()=> ({}));
      if(!r.ok){
        loading.textContent = data?.error?.message || 'Generation failed.';
        return;
      }

      let content = data?.choices?.[0]?.message?.content || '';
      let json = extractJSON(content) || {};
      OUTPUT.removeChild(loading);

      // Render selected channels only if present
      if(json.linkedin)   renderLinkedIn(json.linkedin);
      if(json.x)          renderX(json.x);
      if(json.email)      renderEmail(json.email);
      if(json.instagram)  renderInstagram(json.instagram);
      if(json.reddit)     renderReddit(json.reddit);
      if(json.facebook)   renderFacebook(json.facebook);
      if(json.quora)      renderQuora(json.quora);
      if(json.tiktok)     renderTikTok(json.tiktok);

      if(!OUTPUT.children.length){
        const note = d.createElement('div');
        note.className = 'text-sm text-slate-500';
        note.textContent = 'No drafts returned for the selected channels.';
        OUTPUT.appendChild(note);
      }

      // Increment quota
      q.used += 1; writeQuota(q); paintQuota();
    }catch(err){
      loading.textContent = err?.message || 'Network error.';
    }finally{
      setBusy(GEN_BTN, false);
    }
  }

  // Bind submit + clear
  FORM?.addEventListener('submit', onSubmit);
  byId('clearBtn')?.addEventListener('click', ()=>{
    SOURCE && (SOURCE.value = '');
    wipeOutput();
  });

  // Promo code copy + nav toggles (soft wire if present)
  byId('copyPromoBtn')?.addEventListener('click', async ()=>{
    try{ await navigator.clipboard.writeText('CONTENTOFF90'); showToast('Code copied ✅'); }
    catch{ showToast('Copy failed'); }
  });
  (function navSheetWire(){
    const toggle = byId('navToggle');
    const close  = byId('navClose');
    const sheet  = byId('mobileNav');
    if(!toggle || !sheet) return;
    toggle.addEventListener('click', ()=>{
      const open = d.documentElement.classList.toggle('nav-open');
      toggle.setAttribute('aria-expanded', String(open));
      sheet.setAttribute('aria-hidden', String(!open));
    });
    close?.addEventListener('click', ()=>{
      d.documentElement.classList.remove('nav-open');
      toggle.setAttribute('aria-expanded','false');
      sheet.setAttribute('aria-hidden','true');
    });
  })();

})();
</script>
<!-- === /PART 5/8 === -->
<!-- === PART 6/8 — Auth, Membership, Plan Badges, Billing === -->
<script>
(function AUTH_AND_MEMBERSHIP(){
  // ---------- Config ----------
  // 1) Set these once. You can also set them earlier in Part 1 and they’ll be reused here.
  const G = (window.__CRP__ ||= {});
  G.WORKER_BASE = G.WORKER_BASE || ""; // e.g. "https://your-worker.example.workers.dev"
  G.SUPABASE_URL = G.SUPABASE_URL || ""; // e.g. "https://xxxxxxx.supabase.co"
  G.SUPABASE_ANON = G.SUPABASE_ANON || ""; // e.g. "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."

  // ---------- Tiny utils ----------
  const d = document;
  const byId = (id)=> d.getElementById(id);
  function showToast(msg){
    const t = byId('toast'), m = byId('toastMsg');
    if(!t||!m) return alert(msg);
    m.textContent = msg; t.classList.remove('hidden');
    setTimeout(()=> t.classList.add('hidden'), 1600);
  }
  function soft(a, fn){ try{ fn(); }catch(_){} return a; }
  function setDataAuth(mode){ d.body?.setAttribute('data-auth', mode ? 'member' : 'guest'); }

  // ---------- Load Supabase v2 (only once) ----------
  async function ensureSupabase(){
    if (window.supabase) return;
    await new Promise((res, rej)=>{
      const s = d.createElement('script');
      s.src = "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2";
      s.async = true;
      s.onload = res; s.onerror = ()=> rej(new Error('Failed to load Supabase SDK'));
      d.head.appendChild(s);
    });
  }

  // ---------- Create client & session cache ----------
  let supa = null;
  let currentSession = null;

  async function initSupabase(){
    await ensureSupabase();
    if(!G.SUPABASE_URL || !G.SUPABASE_ANON){
      console.warn('[CRP] Supabase keys not set; auth will be disabled.');
      return null;
    }
    supa = window.supabase.createClient(G.SUPABASE_URL, G.SUPABASE_ANON, {
      auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true }
    });
    const { data: { session } } = await supa.auth.getSession();
    currentSession = session || null;

    // Listen for changes
    supa.auth.onAuthStateChange((_event, session)=>{
      currentSession = session || null;
      paintAuthUI(); // toggle guest/member view
    });

    return supa;
  }

  // ---------- Public helpers (used by other parts) ----------
  G.getAuth = async function getAuth(){
    if(!supa) await initSupabase();
    const token = currentSession?.access_token || null;
    const userId = currentSession?.user?.id || null;
    const email = currentSession?.user?.email || null;
    return { token, userId, email };
  };

  G.getAuthHeaders = async function getAuthHeaders(){
    const h = { 'content-type':'application/json' };
    if(!supa){ await initSupabase(); }
    const token = currentSession?.access_token;
    if(token){ h['authorization'] = `Bearer ${token}`; }
    return h;
  };

  // ---------- Billing status + plan painting ----------
  async function fetchPlan(){
    try{
      const headers = await G.getAuthHeaders();
      const r = await fetch(`${G.WORKER_BASE}/api/billing/status`, { headers, cache:'no-store' });
      if(!r.ok) throw new Error('status not ok');
      return await r.json();
    }catch(_){ return { plan: 'free', quota_today: 0, quota_cap: 5 }; }
  }

  function setText(id, txt){
    const el = byId(id); if(el) el.textContent = txt;
  }

  function toggle(el, show){
    if(!el) return;
    el.classList[show ? 'remove' : 'add']('hidden');
  }

  async function paintAuthUI(){
    const isMember = !!currentSession?.user;
    setDataAuth(isMember);

    // Header buttons
    toggle(byId('loginBtn'), !isMember);
    toggle(byId('logoutBtn'), isMember);
    toggle(byId('loginBtn_m'), !isMember);
    toggle(byId('logoutBtn_m'), isMember);
    toggle(byId('logoutBtn2'), isMember);
    toggle(byId('heroSignIn'), !isMember);

    // Plan badges + member dashboard shell
    const userEmail = currentSession?.user?.email || '';
    setText('userEmail', userEmail);

    const planData = await fetchPlan();
    const plan = (planData?.plan || 'free').toLowerCase();
    const pretty = { free:'Free', starter:'Starter', creator:'Creator', business:'Business' }[plan] || 'Free';

    setText('planbadge', `Plan: ${pretty}`);
    setText('planbadge_m', `Plan: ${pretty}`);
    setText('memberPlanBadge', `Plan: ${pretty}`);

    // Billing button visibility (usually show for paid or trial)
    const canManage = plan !== 'free';
    toggle(byId('manageBilling'), canManage);
    toggle(byId('manageBilling_m'), canManage);
    toggle(byId('manageBilling2'), canManage);

    // Member view section
    toggle(byId('memberView'), isMember);

    // Quotas (member card header)
    const used = Number(planData?.quota_today || 0);
    const cap  = Number(planData?.quota_cap ?? (plan==='free' ? 5 : 200));
    setText('quotaMember', `Today: ${used}/${cap}`);

    // Feature gates: integrations & extras by plan
    const integrations = ['li-notion','li-trello','li-buffer','x-notion','x-trello','x-buffer','em-notion','em-trello','em-buffer','ig-notion','ig-trello','ig-buffer'];
    integrations.forEach(id=> toggle(byId(id), plan==='creator' || plan==='business'));

    // Team features (Business)
    toggle(byId('teamCard'), plan==='business');

    // Scheduler & Analytics badges
    setText('schedPlanNote', plan==='free' ? 'Starter+' : 'Enabled');
    setText('anPlanNote', plan==='free' ? 'Starter+' : 'Enabled');

    // Article Optimizer quota label (member view badge is updated by Part 7 too)
    const aoBadge = byId('ao_quota_m');
    if(aoBadge){
      if(plan==='free'){
        aoBadge.textContent = 'Verified Free: 1 article optimization run • Upgrade for more';
      }else if(plan==='starter'){
        aoBadge.textContent = 'Starter: Article Optimizer included • Fair use';
      }else if(plan==='creator'){
        aoBadge.textContent = 'Creator: Optimizer + integrations';
      }else if(plan==='business'){
        aoBadge.textContent = 'Business: Team Optimizer + calendar';
      }
    }
  }

  // ---------- Auth modal controls ----------
  function openAuth(){ byId('auth')?.showModal?.(); }
  function closeAuth(){ soft(null, ()=> byId('auth')?.close?.()); }

  // Wire “Sign in” entry points
  byId('heroSignIn')?.addEventListener('click', openAuth);
  byId('loginBtn')?.addEventListener('click', openAuth);
  byId('loginBtn_m')?.addEventListener('click', openAuth);

  // Logout everywhere
  async function doLogout(){
    try{
      if(!supa) await initSupabase();
      await supa?.auth.signOut();
      currentSession = null;
      showToast('Signed out');
      paintAuthUI();
    }catch(e){ showToast(e?.message || 'Sign-out failed'); }
  }
  byId('logoutBtn')?.addEventListener('click', doLogout);
  byId('logoutBtn_m')?.addEventListener('click', doLogout);
  byId('logoutBtn2')?.addEventListener('click', doLogout);

  // Magic link
  byId('magicBtn')?.addEventListener('click', async ()=>{
    try{
      if(!supa) await initSupabase();
      const email = byId('emailInput')?.value?.trim();
      if(!email){ byId('emailInput')?.focus(); return showToast('Enter your email'); }
      const { error } = await supa.auth.signInWithOtp({
        email,
        options: {
          emailRedirectTo: location.origin + '/auth/callback'
        }
      });
      if(error) throw error;
      showToast('Magic link sent ✉️');
      closeAuth();
    }catch(e){ showToast(e?.message || 'Could not send link'); }
  });

  // Google OAuth
  byId('googleBtn')?.addEventListener('click', async ()=>{
    try{
      if(!supa) await initSupabase();
      const { error } = await supa.auth.signInWithOAuth({
        provider: 'google',
        options: {
          redirectTo: location.origin + '/auth/callback',
          queryParams: { access_type: 'offline', prompt: 'consent' }
        }
      });
      if(error) throw error;
      // supabase will redirect; no need to close modal
    }catch(e){ showToast(e?.message || 'Google sign-in failed'); }
  });

  // ---------- Billing portal ----------
  async function openBillingPortal(){
    try{
      const headers = await G.getAuthHeaders();
      const r = await fetch(`${G.WORKER_BASE}/api/billing/portal`, { method:'POST', headers });
      const j = await r.json().catch(()=> ({}));
      if(!r.ok || !j?.url) throw new Error(j?.error?.message || 'Could not open billing');
      location.href = j.url;
    }catch(e){ showToast(e?.message || 'Billing not available'); }
  }
  byId('manageBilling')?.addEventListener('click', openBillingPortal);
  byId('manageBilling_m')?.addEventListener('click', openBillingPortal);
  byId('manageBilling2')?.addEventListener('click', openBillingPortal);

  // ---------- “Continue to website” CTA (optional) ----------
  // If you add a button with id="continueBtn" in your hero, this navigates to /blog (or change as needed)
  byId('continueBtn')?.addEventListener('click', ()=> { location.href = '/blog'; });

  // ---------- Initial boot ----------
  (async function boot(){
    await initSupabase();
    await paintAuthUI();

    // Auto-open modal if redirected back from /auth/callback without session (edge case)
    setTimeout(async ()=>{
      const { token } = await G.getAuth();
      if(!token){
        // no-op by default; uncomment to nudge the user
        // openAuth();
      }
    }, 300);
  })();

})();
</script>
<!-- === /PART 6/8 === -->
<!-- === PART 7/8 — Article Optimizer + Platforms Pack Wiring === -->
<script>
(function ARTICLE_OPTIMIZER_WIRING(){
  // ---------- Shared config & helpers ----------
  const G = (window.__CRP__ ||= {});
  const d = document;
  const byId = (id)=> d.getElementById(id);

  function showToast(msg){
    const t = byId('toast'), m = byId('toastMsg');
    if(!t||!m){ console.log(msg); return; }
    m.textContent = msg; t.classList.remove('hidden');
    setTimeout(()=> t.classList.add('hidden'), 1500);
  }

  // Basic sanitization (strip <script> and inline handlers). Production back-end should also sanitize.
  function sanitizeHtml(html){
    const s = String(html || "");
    return s
      .replace(/<script[\s\S]*?>[\s\S]*?<\/script>/gi, "")
      .replace(/\son\w+="[^"]*"/gi, "")
      .replace(/\son\w+='[^']*'/gi, "");
  }

  // Extract JSON if model adds prose. Returns object or null.
  function extractJSON(text){
    try{ return JSON.parse(text); }catch(_){}
    const s = String(text || "");
    const start = s.indexOf("{");
    const end = s.lastIndexOf("}");
    if(start !== -1 && end !== -1 && end > start){
      try{ return JSON.parse(s.slice(start, end+1)); }catch(_){}
    }
    return null;
  }

  // Clipboard helpers
  async function copy(text){ try{ await navigator.clipboard.writeText(text); showToast("Copied ✅"); }catch(_){ showToast("Copy failed"); } }
  function downloadText(filename, mime, content){
    const blob = new Blob([content], {type: mime});
    const url = URL.createObjectURL(blob);
    const a = d.createElement('a'); a.href = url; a.download = filename;
    d.body.appendChild(a); a.click(); a.remove(); setTimeout(()=> URL.revokeObjectURL(url), 0);
  }

  // ---------- Local state ----------
  let AO_LAST_HTML = "";
  let AO_BUNDLE = null; // { reddit, facebook, quora, tiktok, x_long, linkedin_article, faq_schema }

  // ---------- Prompt builders ----------
  function buildSystemPrompt(opts){
    const wants = {
      humanize: !!opts.humanize,
      lengthen: !!opts.lengthen,
      faqs: !!opts.faqs,
      headings: opts.headings !== false,
      schema: !!opts.schema,
      cta: !!opts.cta
    };

    return {
      role: "system",
      content:
`You are a senior editor + distribution strategist.
Return ONLY a single JSON object with keys:
- article_html (string): fully formatted semantic HTML (<article> with one <h1>, logical <h2>/<h3>, <p>, lists, blockquote). No external CSS/JS. If CTA requested, include <div class="cta"> at the end with concise copy.
- faq_schema (string|null): If FAQs produced, include minified JSON-LD FAQPage string that matches the same Q/A. Otherwise null.
- platforms (object):
  - reddit: { "title": string, "body": string, "subreddits": string[] }
  - facebook: { "post": string }
  - quora: { "answer": string }
  - tiktok: { "hooks": string[], "captions": string[] }
  - x_long: { "posts": string[] }  // 3–5 numbered long-form tweets, <=280 chars if possible; if >280 truly needed, keep <=380 and add "(thread)"
  - linkedin_article: { "html": string } // LinkedIn Article-ready HTML (<article> only)

Editing rules:
- Preserve facts; be conservative with inference.
- ${wants.humanize ? "Use a conversational, concise tone." : "Use a neutral, professional tone."}
- ${wants.lengthen ? "Expand thin sections with concrete details (no fluff)." : "Do not lengthen unless needed for clarity."}
- ${wants.headings ? "Fix headings: exactly one <h1>, logical <h2>/<h3>, scannable lists, short paragraphs." : "Leave headings unchanged."}
- ${wants.faqs ? "Append a grounded FAQ section (<section class='faq'>) with 3–6 Q/A pairs derived from the article." : "Do not add FAQs unless essential."}
- ${wants.schema ? "If FAQs exist, produce faq_schema that exactly matches Q/A." : "Set faq_schema to null."}
- ${wants.cta ? "Add a clear, generic CTA in a <div class='cta'> without making up pricing or promises." : "No CTA block."}

Hard constraints:
- Output must be valid JSON (no trailing commas, no Markdown fences).
- article_html and platforms.linkedin_article.html must not contain <script> tags or inline event handlers.
- Do not output any text outside the JSON object.`
    };
  }

  function buildUserPrompt(src){
    const isUrl = /^https?:\/\//i.test(src.trim());
    if(isUrl){
      return { role: "user", content: `Source URL:\n${src.trim()}\n\nTask: Fetch or assume the readable body and optimize as instructed.` };
    } else {
      return { role: "user", content: `Raw Article Text:\n${src.trim()}\n\nTask: Optimize as instructed.` };
    }
  }

  // ---------- Core runner ----------
  async function runOptimizer({ isMember=false }){
    const srcEl   = byId(isMember ? "ao_source_m" : "ao_source_g");
    const status  = byId(isMember ? "ao_status_m" : "ao_status_g");
    const preview = byId(isMember ? "ao_preview_m" : "ao_preview_g");
    const copyBtn = byId(isMember ? "ao_copy_html_m" : "ao_copy_html_g");
    const dlBtn   = byId("ao_download_html_m");

    if(!srcEl || !status || !preview){ return; }
    const src = (srcEl.value || "").trim();
    if(!src){ srcEl.focus(); return showToast("Paste an article or URL first"); }

    // Read options
    const opts = {
      humanize: byId(isMember ? "ao_humanize_m" : "ao_humanize_g")?.checked,
      lengthen: byId(isMember ? "ao_lengthen_m" : "ao_lengthen_g")?.checked,
      faqs:     byId(isMember ? "ao_faqs_m"     : "ao_faqs_g")?.checked,
      headings: byId(isMember ? "ao_headings_m" : "ao_headings_g")?.checked,
      schema:   byId(isMember ? "ao_schema_m"   : "ao_schema_g")?.checked,
      cta:      byId(isMember ? "ao_cta_m"      : "ao_cta_g")?.checked,
    };

    // UI state
    status.textContent = "Optimizing…";
    preview.innerHTML = `<p class="text-slate-500">Working…</p>`;
    copyBtn && copyBtn.classList.add("hidden");
    dlBtn && dlBtn.classList.add("hidden");
    AO_LAST_HTML = ""; AO_BUNDLE = null;

    // Auth headers from Part 6
    if(!G.getAuthHeaders){
      status.textContent = "Auth not initialized (Part 6 missing).";
      return;
    }
    const headers = await G.getAuthHeaders();

    // Worker endpoint
    const base = G.WORKER_BASE || "";
    if(!base){
      status.textContent = "Backend not configured. Set WORKER_BASE in Part 1/6.";
      return;
    }

    const messages = [ buildSystemPrompt(opts), buildUserPrompt(src) ];

    try{
      const r = await fetch(`${base}/api/generate`, {
        method: "POST",
        headers,
        body: JSON.stringify({
          plan: isMember ? "member" : "free",
          messages,
          temperature: 0.4
        })
      });
      const data = await r.json().catch(()=> ({}));
      if(!r.ok){
        const msg = data?.error?.message || "Generation failed";
        status.textContent = msg; showToast(msg);
        return;
      }

      let content = data?.choices?.[0]?.message?.content || "";
      let j = extractJSON(content);
      if(!j){ status.textContent = "Could not parse response."; return; }

      const clean = sanitizeHtml(j.article_html);
      if(!clean){ status.textContent = "No article returned."; return; }

      AO_LAST_HTML = clean;
      AO_BUNDLE = {
        reddit: j?.platforms?.reddit || null,
        facebook: j?.platforms?.facebook || null,
        quora: j?.platforms?.quora || null,
        tiktok: j?.platforms?.tiktok || null,
        x_long: j?.platforms?.x_long || null,
        linkedin_article: j?.platforms?.linkedin_article || null,
        faq_schema: j?.faq_schema || null
      };

      preview.innerHTML = clean;
      status.textContent = `Done • HTML ready${AO_BUNDLE?.faq_schema ? " • FAQ schema" : ""}`;
      copyBtn && copyBtn.classList.remove("hidden");
      if(isMember) dlBtn && dlBtn.classList.remove("hidden");
    }catch(e){
      status.textContent = e?.message || "Network error";
      showToast(status.textContent);
    }
  }

  // ---------- Preview modal ----------
  function openArticlePreview(html){
    const dlg = byId("articlePreview");
    const body = byId("ap_body");
    if(!dlg || !body){ return; }
    body.innerHTML = sanitizeHtml(html || "<p>No content.</p>");
    dlg.showModal();
  }

  // ---------- Event wiring (Guest) ----------
  byId("ao_run_g")?.addEventListener("click", ()=> runOptimizer({ isMember:false }));
  byId("ao_clear_g")?.addEventListener("click", ()=>{
    const p = byId("ao_preview_g");
    const s = byId("ao_status_g");
    const c = byId("ao_copy_html_g");
    byId("ao_source_g") && (byId("ao_source_g").value = "");
    p && (p.innerHTML = `<p class="text-slate-500">Your optimized article will render here.</p>`);
    s && (s.textContent = "");
    c && c.classList.add("hidden");
    AO_LAST_HTML = ""; AO_BUNDLE = null;
  });
  byId("ao_copy_html_g")?.addEventListener("click", ()=> AO_LAST_HTML && copy(AO_LAST_HTML));

  // ---------- Event wiring (Member) ----------
  byId("ao_run_m")?.addEventListener("click", ()=> runOptimizer({ isMember:true }));
  byId("ao_clear_m")?.addEventListener("click", ()=>{
    const p = byId("ao_preview_m");
    const s = byId("ao_status_m");
    const c = byId("ao_copy_html_m");
    const dl= byId("ao_download_html_m");
    byId("ao_source_m") && (byId("ao_source_m").value = "");
    p && (p.innerHTML = `<p class="text-slate-500">Your optimized article will render here.</p>`);
    s && (s.textContent = "");
    c && c.classList.add("hidden");
    dl && dl.classList.add("hidden");
    AO_LAST_HTML = ""; AO_BUNDLE = null;
  });
  byId("ao_copy_html_m")?.addEventListener("click", ()=> AO_LAST_HTML && copy(AO_LAST_HTML));
  byId("ao_download_html_m")?.addEventListener("click", ()=> AO_LAST_HTML && downloadText("optimized-article.html","text/html;charset=utf-8", AO_LAST_HTML));

  // ---------- Shared modal copy ----------
  byId("ap_copy")?.addEventListener("click", ()=> AO_LAST_HTML && copy(AO_LAST_HTML));

  // ---------- Quick actions powered by AO_BUNDLE ----------
  byId("ao_to_linkedin_article")?.addEventListener("click", ()=>{
    if(AO_BUNDLE?.linkedin_article?.html){
      openArticlePreview(sanitizeHtml(AO_BUNDLE.linkedin_article.html));
    }else if(AO_LAST_HTML){
      openArticlePreview(AO_LAST_HTML);
    }else{
      showToast("Generate the article first");
    }
  });

  byId("ao_to_reddit")?.addEventListener("click", ()=>{
    const r = AO_BUNDLE?.reddit;
    if(!r){ return showToast("Generate the article first"); }
    const subs = (Array.isArray(r.subreddits) ? r.subreddits : []).slice(0,8).map(s=>`r/${s}`).join(", ");
    const md = `**Title:** ${r.title || ""}\n\n${r.body || ""}\n\n**Suggested communities:** ${subs || "—"}`;
    copy(md);
  });

  byId("ao_to_quora")?.addEventListener("click", ()=>{
    const q = AO_BUNDLE?.quora?.answer;
    if(!q) return showToast("Generate the article first");
    copy(q);
  });

  // Easter-egg: copy long X posts (Ctrl/Cmd + Shift + X)
  d.addEventListener("keydown", (e)=>{
    if((e.ctrlKey || e.metaKey) && e.shiftKey && e.key.toLowerCase() === "x"){
      const posts = AO_BUNDLE?.x_long?.posts;
      if(!posts?.length) return showToast("Generate first to get X suggestions");
      copy(posts.map((p,i)=>`Post ${i+1}: ${p}`).join("\n\n"));
    }
  });

  // Open preview by double-clicking the inline preview
  ["ao_preview_g","ao_preview_m"].forEach(id=>{
    byId(id)?.addEventListener("dblclick", ()=> AO_LAST_HTML && openArticlePreview(AO_LAST_HTML));
  });
})();
</script>
<!-- === /PART 7/8 === -->
<!-- === PART 8/8 — Final wiring: Scheduler, Analytics, Integrations, Live Demo, Billing, Nav, Toasts === -->
<script>
(function FINAL_WIRING(){
  // ---------- Shared config & helpers ----------
  const G = (window.__CRP__ ||= {});
  const d = document;
  const byId = (id)=> d.getElementById(id);
  const qs = (sel,root=d)=> root.querySelector(sel);
  const qsa = (sel,root=d)=> Array.from(root.querySelectorAll(sel));

  function showToast(msg){
    const t = byId('toast'), m = byId('toastMsg');
    if(!t||!m){ console.log(msg); return; }
    m.textContent = msg; t.classList.remove('hidden');
    setTimeout(()=> t.classList.add('hidden'), 1600);
  }
  async function tryFetch(url, opts){
    try{
      const res = await fetch(url, opts);
      const data = await res.json().catch(()=> ({}));
      return { ok: res.ok, status: res.status, data };
    }catch(e){ return { ok:false, status:0, data:{ error:{ message: e?.message || "Network error" } } }; }
  }

  // ---------- Nav (mobile) ----------
  const navToggle = byId('navToggle'), mobileNav = byId('mobileNav'), navClose = byId('navClose');
  function setNav(open){ d.body.classList.toggle('nav-open', !!open); navToggle?.setAttribute('aria-expanded', open?'true':'false'); }
  navToggle?.addEventListener('click', ()=> setNav(!d.body.classList.contains('nav-open')));
  navClose?.addEventListener('click', ()=> setNav(false));
  mobileNav?.addEventListener('click', (e)=>{ if(e.target === mobileNav) setNav(false); });

  // ---------- Hero promo code copy ----------
  byId('copyPromoBtn')?.addEventListener('click', async ()=>{
    try{ await navigator.clipboard.writeText('CONTENTOFF90'); showToast('Code copied: CONTENTOFF90'); }catch(_){ showToast('Copy failed'); }
  });

  // ---------- Year footer ----------
  byId('year') && (byId('year').textContent = new Date().getFullYear());

  // ---------- Auth entry points ----------
  // Part 6 defined G.getAuth, G.logout, G.openAuthModal, etc.
  byId('loginBtn')?.addEventListener('click', ()=> G.openAuthModal?.());
  byId('loginBtn_m')?.addEventListener('click', ()=> G.openAuthModal?.());
  byId('heroSignIn')?.addEventListener('click', ()=> G.openAuthModal?.());

  byId('logoutBtn')?.addEventListener('click', ()=> G.logout?.());
  byId('logoutBtn_m')?.addEventListener('click', ()=> G.logout?.());
  byId('logoutBtn2')?.addEventListener('click', ()=> G.logout?.());

  // ---------- Billing buttons ----------
  // Sub buttons carry data-price (Stripe price id); your Worker should return {url} to redirect
  function wireSubs(){
    qsa('.subBtn').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        const price = btn.getAttribute('data-price') || '';
        if(!G.WORKER_BASE) return showToast('Backend not configured');
        const { ok, data } = await tryFetch(`${G.WORKER_BASE}/api/billing/checkout`, {
          method:'POST',
          headers: await G.getAuthHeaders(),
          body: JSON.stringify({ price })
        });
        if(!ok || !data?.url){ return showToast(data?.error?.message || 'Checkout failed'); }
        location.href = data.url;
      });
    });

    async function openPortal(){
      if(!G.WORKER_BASE) return showToast('Backend not configured');
      const { ok, data } = await tryFetch(`${G.WORKER_BASE}/api/billing/portal`, {
        method:'POST',
        headers: await G.getAuthHeaders()
      });
      if(!ok || !data?.url){ return showToast(data?.error?.message || 'Portal unavailable'); }
      location.href = data.url;
    }
    byId('manageBilling')?.addEventListener('click', openPortal);
    byId('manageBilling_m')?.addEventListener('click', openPortal);
    byId('manageBilling2')?.addEventListener('click', openPortal);
  }
  wireSubs();

  // ---------- Live activity strip ----------
  async function paintLive(){
    if(!G.WORKER_BASE) return; // silent
    const feed = byId('liveFeed');
    const count = byId('liveCount');
    if(!feed || !count) return;
    const { ok, data } = await tryFetch(`${G.WORKER_BASE}/api/live`, { headers: await G.getAuthHeaders() });
    if(!ok) return; // keep silent
    const items = Array.isArray(data?.items) ? data.items : [];
    count.textContent = String(data?.today || items.length || '0');
    feed.innerHTML = items.slice(0, 40).map(it=> `<span class="chip">${(it?.msg || '').replace(/</g,'&lt;').slice(0,80)}</span>`).join('');
  }
  paintLive(); setInterval(paintLive, 30000);

  // ---------- DEMO generator (guest) ----------
  const demoForm = byId('demoForm');
  if(demoForm){
    demoForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const srcType = qs('input[name="sourceType"]:checked', demoForm)?.value || 'paragraph';
      const sourceText = byId('sourceText')?.value?.trim() || '';
      if(!sourceText) return showToast('Paste some text or a URL');

      // Options
      const opts = {
        opt_humanize: demoForm.opt_humanize?.checked ?? false,
        opt_lengthen: demoForm.opt_lengthen?.checked ?? false,
        opt_faqs: demoForm.opt_faqs?.checked ?? false,
        opt_headings: demoForm.opt_headings?.checked ?? true,
        opt_svg: demoForm.opt_svg?.checked ?? false,
        opt_seo: demoForm.opt_seo?.checked ?? false,
        ch_linkedin: demoForm.ch_linkedin?.checked ?? false,
        ch_x: demoForm.ch_x?.checked ?? false,
        ch_email: demoForm.ch_email?.checked ?? false,
        ch_instagram: demoForm.ch_instagram?.checked ?? false,
        ch_reddit: demoForm.ch_reddit?.checked ?? false,
        ch_facebook: demoForm.ch_facebook?.checked ?? false,
        ch_quora: demoForm.ch_quora?.checked ?? false,
        ch_tiktok: demoForm.ch_tiktok?.checked ?? false,
        x_sequence: demoForm.x_sequence?.checked ?? false,
        x_posts: Number(demoForm.x_posts?.value || 4),
        li_article: demoForm.li_article?.checked ?? false,
        rdt_communities: demoForm.rdt_communities?.checked ?? false,
        rdt_comments: demoForm.rdt_comments?.checked ?? false,
        tt_hooks: demoForm.tt_hooks?.checked ?? false,
        tt_onscreen: demoForm.tt_onscreen?.checked ?? false,
      };

      const out = byId('demoOutput'); out.innerHTML = '';
      const genBtn = byId('generateBtn'); genBtn.disabled = true; genBtn.textContent = 'Generating…';

      if(!G.WORKER_BASE) { genBtn.disabled = false; genBtn.textContent = 'Generate'; return showToast('Backend not configured'); }

      const body = {
        plan: 'free',
        sourceType: srcType,
        sourceText,
        options: opts
      };

      const { ok, data } = await tryFetch(`${G.WORKER_BASE}/api/repurpose`, {
        method:'POST',
        headers: await G.getAuthHeaders(),
        body: JSON.stringify(body)
      });

      genBtn.disabled = false; genBtn.textContent = 'Generate';

      if(!ok){ return showToast(data?.error?.message || 'Generation failed'); }

      // Render simple cards based on channels returned
      const blocks = data?.blocks || {};
      function card(title, inner){
        const el = d.createElement('div');
        el.className = 'card p-5';
        el.innerHTML = `<div class="flex justify-between items-center gap-2 flex-wrap">
          <strong class="tracking-tight">${title}</strong>
          <button class="px-3 py-1 rounded-full text-xs border copyBtn" type="button">Copy</button>
        </div>
        <pre class="whitespace-pre-wrap text-sm mt-3">${inner}</pre>`;
        el.querySelector('.copyBtn').addEventListener('click', async ()=> {
          try{ await navigator.clipboard.writeText(inner); showToast('Copied ✅'); }catch(_){ showToast('Copy failed'); }
        });
        out.appendChild(el);
      }

      blocks.linkedin && card('LinkedIn', blocks.linkedin);
      blocks.x && card('X (Twitter)', blocks.x);
      blocks.email && card('Email', `Subject: ${blocks.email.subject}\n\n${blocks.email.body}`);
      blocks.instagram && card('Instagram', blocks.instagram);
      blocks.reddit && card('Reddit', `Title: ${blocks.reddit.title}\n\n${blocks.reddit.body}`);
      blocks.facebook && card('Facebook', `${blocks.facebook.post}`);
      blocks.quora && card('Quora', blocks.quora.answer);
      blocks.tiktok && card('TikTok', `Hooks:\n- ${blocks.tiktok.hooks?.join('\n- ') || ''}\n\nCaptions:\n- ${blocks.tiktok.captions?.join('\n- ') || ''}`);

      // Quota paint (if provided)
      if(typeof data?.demoQuotaLeft === 'number'){ byId('demoQuota') && (byId('demoQuota').textContent = String(data.demoQuotaLeft)); }
    });

    byId('clearBtn')?.addEventListener('click', ()=>{
      byId('sourceText') && (byId('sourceText').value = '');
      byId('demoOutput') && (byId('demoOutput').innerHTML = '');
    });
  }

  // ---------- Member dashboard: quotas + feature list ----------
  async function paintMemberShell(){
    const planBadge = byId('memberPlanBadge') || byId('planbadge');
    const planBadgeM = byId('planbadge_m');
    const quotaWrap = byId('quotaCards');
    const featureList = byId('featureList');

    if(!G.WORKER_BASE) return;

    const { ok, data } = await tryFetch(`${G.WORKER_BASE}/api/billing/status`, { headers: await G.getAuthHeaders() });
    if(!ok) return;

    const plan = (data?.plan || 'free').toLowerCase();
    const today = data?.today || { used:0, cap:5 };
    const labels = {
      free: 'Free',
      starter: 'Starter',
      creator: 'Creator',
      business: 'Business'
    };
    const planLabel = labels[plan] || data?.plan || 'Free';
    planBadge && (planBadge.textContent = `Plan: ${planLabel}`);
    planBadgeM && (planBadgeM.textContent = `Plan: ${planLabel}`);
    byId('quotaMember') && (byId('quotaMember').textContent = `Today: ${today.used}/${today.cap}`);

    // Manage billing visibility
    const mg = [byId('manageBilling'), byId('manageBilling_m'), byId('manageBilling2')];
    mg.forEach(el=> el && el.classList.toggle('hidden', plan === 'free'));

    // Quota cards (pretty)
    if(quotaWrap){
      const cards = [
        { k:'Generations', v:`${today.used}/${today.cap}` },
        { k:'BYOK today', v: data?.byokToday ? `${data.byokToday.used}/${data.byokToday.cap}` : '—' },
        { k:'Presets', v: data?.presets ?? '—' },
        { k:'Scheduler', v: plan==='free'?'Locked':'Enabled' },
      ];
      quotaWrap.innerHTML = cards.map(c=>`
        <div class="stat">
          <div class="text-xs text-slate-500">${c.k}</div>
          <div class="k kpi">${c.v}</div>
        </div>`).join('');
    }

    // Features (friendly, static per plan)
    if(featureList){
      const feats = {
        free:[
          'Demo runs (guest & account)',
          '1× Article Optimizer (verified)',
          'CSV/Markdown export',
        ],
        starter:[
          '200 generations / month',
          'Batch inputs (5 lines/run)',
          'Scheduler (queue & calendar)',
          'Analytics (basics)',
          'Article Optimizer: up to 5/day'
        ],
        creator:[
          '500 generations / month',
          'Unlimited presets',
          'Project pack export',
          'Notion export & Trello boards',
          'Buffer queue',
          'Analytics Pro',
          'Article Optimizer: up to 15/day'
        ],
        business:[
          'Unlimited (fair use)',
          '3 seats & team calendar',
          'White-label export',
          'Priority support',
          'Team Analytics',
          'Article Optimizer: up to 30/day'
        ]
      };
      featureList.innerHTML = (feats[plan] || feats.free).map(f=>`<li>• ${f}</li>`).join('');
    }
  }
  paintMemberShell();

  // ---------- Email preview modal (open mail client) ----------
  const emailDialog = byId('emailPreview');
  byId('emailSendBtn')?.addEventListener('click', ()=>{
    const subj = byId('emailSubjEdit')?.value || '';
    const body = byId('emailBodyEdit')?.value || '';
    const href = `mailto:?subject=${encodeURIComponent(subj)}&body=${encodeURIComponent(body)}`;
    window.location.href = href;
  });

  // ---------- Publish/Export buttons (Member) ----------
  async function publishTo(channel, payload){
    if(!G.WORKER_BASE) return showToast('Backend not configured');
    const { ok, data } = await tryFetch(`${G.WORKER_BASE}/api/publish/${channel}`, {
      method:'POST',
      headers: await G.getAuthHeaders(),
      body: JSON.stringify(payload)
    });
    if(!ok) return showToast(data?.error?.message || 'Publish failed');
    showToast('Queued ✅');
  }

  // LinkedIn
  byId('publish-li_m')?.addEventListener('click', ()=>{
    const text = byId('out-li_m')?.textContent || '';
    if(!text) return showToast('Generate content first');
    publishTo('linkedin', { text });
  });
  // X
  byId('publish-x_m')?.addEventListener('click', ()=>{
    const text = byId('out-x_m')?.textContent || '';
    if(!text) return showToast('Generate content first');
    publishTo('x', { text });
  });
  // Email
  byId('publish-em_m')?.addEventListener('click', ()=>{
    // Load current subject/body into modal for edit
    const subj = byId('out-em-subj_m')?.textContent || '';
    const body = byId('out-em-body_m')?.textContent || '';
    byId('emailSubjEdit') && (byId('emailSubjEdit').value = subj.trim());
    byId('emailBodyEdit') && (byId('emailBodyEdit').value = body.trim());
    emailDialog?.showModal();
  });
  // Instagram
  byId('publish-ig_m')?.addEventListener('click', ()=>{
    window.open('https://business.facebook.com/creatorstudio/home', '_blank');
  });

  // Copy helpers
  function wireCopy(btnId, srcId){
    byId(btnId)?.addEventListener('click', async ()=>{
      const txt = byId(srcId)?.textContent || '';
      if(!txt) return showToast('Nothing to copy');
      try{ await navigator.clipboard.writeText(txt); showToast('Copied ✅'); }catch(_){ showToast('Copy failed'); }
    });
  }
  wireCopy('copy-li_m','out-li_m');
  wireCopy('copy-x_m','out-x_m');
  wireCopy('copy-em_m','out-em-body_m');
  wireCopy('copy-ig_m','out-ig_m');
  wireCopy('copy-reddit_m','out-reddit_m');
  wireCopy('copy-fb_m','out-fb_m');
  wireCopy('copy-quora_m','out-quora_m');
  wireCopy('copy-tt_m','out-tt_m');

  // ---------- Notion / Trello / Buffer (Member) ----------
  // Notion export
  async function exportTo(dest, content){
    if(!G.WORKER_BASE) return showToast('Backend not configured');
    const { ok, data } = await tryFetch(`${G.WORKER_BASE}/api/export/${dest}`,{
      method:'POST',
      headers: await G.getAuthHeaders(),
      body: JSON.stringify({ content })
    });
    if(!ok) return showToast(data?.error?.message || 'Export failed');
    showToast('Exported ✅');
  }
  byId('li-notion')?.addEventListener('click', ()=> exportTo('notion', byId('out-li_m')?.textContent || ''));
  byId('x-notion')?.addEventListener('click', ()=> exportTo('notion', byId('out-x_m')?.textContent || ''));
  byId('em-notion')?.addEventListener('click', ()=> exportTo('notion', (byId('out-em-subj_m')?.textContent||'') + '\n\n' + (byId('out-em-body_m')?.textContent||'')));
  byId('ig-notion')?.addEventListener('click', ()=> exportTo('notion', byId('out-ig_m')?.textContent || ''));

  // Trello modal (simple)
  const trelloDlg = byId('trelloModal');
  function openTrelloFor(content){
    trelloDlg?.showModal();
    byId('trelloConfirm')?.onclick = async ()=>{
      const board = byId('trelloBoardId')?.value?.trim();
      const list  = byId('trelloListId')?.value?.trim();
      if(!board || !list) return showToast('Board & List required');
      const { ok, data } = await tryFetch(`${G.WORKER_BASE}/api/export/trello`, {
        method:'POST',
        headers: await G.getAuthHeaders(),
        body: JSON.stringify({ board, list, content })
      });
      if(!ok) return showToast(data?.error?.message || 'Trello failed');
      trelloDlg.close(); showToast('Sent to Trello ✅');
    };
  }
  byId('li-trello')?.addEventListener('click', ()=> openTrelloFor(byId('out-li_m')?.textContent || ''));
  byId('x-trello')?.addEventListener('click', ()=> openTrelloFor(byId('out-x_m')?.textContent || ''));
  byId('em-trello')?.addEventListener('click', ()=> openTrelloFor((byId('out-em-subj_m')?.textContent||'') + '\n\n' + (byId('out-em-body_m')?.textContent||'')));
  byId('ig-trello')?.addEventListener('click', ()=> openTrelloFor(byId('out-ig_m')?.textContent || ''));

  // Buffer modal (profiles from backend)
  const bufferDlg = byId('bufferModal'), bufferSelect = byId('bufferProfile');
  async function openBufferFor(content){
    bufferDlg?.showModal();
    // Load profiles
    const { ok, data } = await tryFetch(`${G.WORKER_BASE}/api/buffer/profiles`, { headers: await G.getAuthHeaders() });
    if(ok && Array.isArray(data?.profiles)){
      bufferSelect.innerHTML = data.profiles.map(p=> `<option value="${p.id}">${(p.name || p.id)}</option>`).join('');
    }else{
      bufferSelect.innerHTML = `<option>Default</option>`;
    }
    byId('bufferConfirm').onclick = async ()=>{
      const profile = bufferSelect?.value || '';
      const res = await tryFetch(`${G.WORKER_BASE}/api/publish/buffer`, {
        method:'POST',
        headers: await G.getAuthHeaders(),
        body: JSON.stringify({ profile, content })
      });
      if(!res.ok) return showToast(res.data?.error?.message || 'Buffer failed');
      bufferDlg.close(); showToast('Queued in Buffer ✅');
    };
  }
  byId('li-buffer')?.addEventListener('click', ()=> openBufferFor(byId('out-li_m')?.textContent || ''));
  byId('x-buffer')?.addEventListener('click', ()=> openBufferFor(byId('out-x_m')?.textContent || ''));
  byId('em-buffer')?.addEventListener('click', ()=> openBufferFor((byId('out-em-subj_m')?.textContent||'') + '\n\n' + (byId('out-em-body_m')?.textContent||'')));
  byId('ig-buffer')?.addEventListener('click', ()=> openBufferFor(byId('out-ig_m')?.textContent || ''));

  // ---------- Scheduler (local queue + server sync if available) ----------
  const sched = {
    el: {
      channel: byId('schedChannel'),
      when: byId('schedWhen'),
      content: byId('schedContent'),
      list: byId('schedList'),
      calendar: byId('schedCalendar'),
      save: byId('schedSave'),
      clear: byId('schedClear'),
    },
    key: 'crp.scheduler.queue'
  };

  function loadQueue(){
    try{ return JSON.parse(localStorage.getItem(sched.key) || '[]'); }catch(_){ return []; }
  }
  function saveQueue(items){
    localStorage.setItem(sched.key, JSON.stringify(items));
  }
  function renderQueue(){
    const items = loadQueue().sort((a,b)=> new Date(a.when) - new Date(b.when));
    sched.el.list.innerHTML = items.map((it,i)=> `
      <li class="p-2 rounded-lg border flex items-center justify-between gap-3">
        <div class="text-sm">
          <div class="font-medium">${it.channel.toUpperCase()} • ${new Date(it.when).toLocaleString()}</div>
          <div class="text-slate-500 line-clamp-2">${(it.content||'').replace(/</g,'&lt;')}</div>
        </div>
        <div class="flex items-center gap-2">
          <button class="px-2 py-1 rounded border text-xs" data-idx="${i}" data-act="send">Queue</button>
          <button class="px-2 py-1 rounded border text-xs" data-idx="${i}" data-act="del">Delete</button>
        </div>
      </li>`).join('') || '<li class="text-sm text-slate-500">No scheduled items yet.</li>';

    // light calendar paint
    sched.el.calendar.innerHTML = 'Weekly calendar (visual)';
  }
  function nowRounded(){
    const dt = new Date();
    dt.setMinutes(dt.getMinutes() + 10);
    dt.setSeconds(0); dt.setMilliseconds(0);
    return dt.toISOString().slice(0,16);
  }
  sched.el.when && (sched.el.when.value = nowRounded());
  renderQueue();

  sched.el.save?.addEventListener('click', async ()=>{
    const channel = sched.el.channel?.value || 'linkedin';
    const when = sched.el.when?.value;
    const content = sched.el.content?.value?.trim() || '';
    if(!when || !content) return showToast('Time and content required');
    const items = loadQueue();
    items.push({ channel, when, content, id: crypto.randomUUID() });
    saveQueue(items); renderQueue(); sched.el.content.value = '';
    showToast('Added to queue ✅');

    // Optional server sync
    if(G.WORKER_BASE){
      await tryFetch(`${G.WORKER_BASE}/api/scheduler/save`, {
        method:'POST',
        headers: await G.getAuthHeaders(),
        body: JSON.stringify(items)
      });
    }
  });

  sched.el.clear?.addEventListener('click', ()=>{
    sched.el.content.value = '';
  });

  sched.el.list?.addEventListener('click', async (e)=>{
    const btn = e.target.closest('button[data-act]');
    if(!btn) return;
    const idx = Number(btn.getAttribute('data-idx'));
    const act = btn.getAttribute('data-act');
    const items = loadQueue();
    const item = items[idx];
    if(!item) return;

    if(act === 'del'){
      items.splice(idx,1); saveQueue(items); renderQueue(); showToast('Deleted');
      if(G.WORKER_BASE){ await tryFetch(`${G.WORKER_BASE}/api/scheduler/save`, { method:'POST', headers: await G.getAuthHeaders(), body: JSON.stringify(items) }); }
    }
    if(act === 'send'){
      // immediate queue to backend publisher; real CRON would publish at time
      await publishTo(item.channel, { text: item.content, when: item.when });
    }
  });

  // ---------- Analytics (client-side paint + backend enrichment) ----------
  const an = {
    range: byId('anRange'),
    channel: byId('anChannel'),
    count: byId('anCount'),
    top: byId('anTop'),
    recent: byId('anRecent'),
    chart: byId('anChart'),
  };

  function fakeSeries(days=7){
    const arr = []; let top = 0, topIdx = 0;
    for(let i=days-1;i>=0;i--){
      const v = Math.max(0, Math.round((Math.sin(i/2)+1)*4 + Math.random()*3));
      if(v>top){ top = v; topIdx = i; }
      arr.push({ d: i, v });
    }
    return { arr, top };
  }

  async function paintAnalytics(){
    const range = Number(an.range?.value || 7);
    const { arr } = fakeSeries(range);
    const sum = arr.reduce((a,b)=> a + b.v, 0);
    an.count && (an.count.textContent = String(sum));

    // top channel (mock or from backend)
    let top = 'LinkedIn';
    if(G.WORKER_BASE){
      const { ok, data } = await tryFetch(`${G.WORKER_BASE}/api/analytics/summary?days=${range}&channel=${encodeURIComponent(an.channel?.value||'')}`, { headers: await G.getAuthHeaders() });
      if(ok){
        an.count.textContent = String(data?.total ?? sum);
        top = data?.top || top;
        if(Array.isArray(data?.recent)){
          an.recent.innerHTML = data.recent.slice(0,10).map(r=> `<li class="p-2 rounded-lg border text-sm"><strong>${(r.channel||'').toUpperCase()}</strong> • ${new Date(r.time).toLocaleString()}<br>${(r.preview||'').replace(/</g,'&lt;')}</li>`).join('');
        }
      } else {
        an.recent.innerHTML = '<li class="text-sm text-slate-500">No recent items.</li>';
      }
    } else {
      // local placeholder
      an.recent.innerHTML = '<li class="text-sm text-slate-500">Connect backend to see recent items.</li>';
    }
    an.top && (an.top.textContent = top);

    // simple chart (bar blocks)
    if(an.chart){
      const max = Math.max(...arr.map(x=> x.v), 1);
      an.chart.innerHTML = `
        <div class="grid grid-cols-${range} gap-1 w-full h-full p-2">
          ${arr.map(x=>{
            const h = Math.round((x.v / max) * 100);
            return `<div class="bg-white/30 dark:bg-white/10 rounded" style="align-self:end;height:${h}%;" title="${x.v}"></div>`;
          }).join('')}
        </div>`;
    }
  }
  an.range?.addEventListener('change', paintAnalytics);
  an.channel?.addEventListener('change', paintAnalytics);
  paintAnalytics();

  // ---------- Integrations connect/disconnect toggles ----------
  async function toggleIntegration(which, connect=true){
    if(!G.WORKER_BASE) return showToast('Backend not configured');
    const endpoint = connect ? 'connect' : 'disconnect';
    const { ok, data } = await tryFetch(`${G.WORKER_BASE}/api/integrations/${which}/${endpoint}`, {
      method:'POST',
      headers: await G.getAuthHeaders()
    });
    if(!ok){ return showToast(data?.error?.message || 'Integration failed'); }
    showToast(connect ? 'Connected ✅' : 'Disconnected');
    paintIntegrationStates();
  }

  function paintIntegrationStates(){
    const map = [
      { key:'notion',  stateEl:'notionState',  c:'connectNotion', d:'disconnectNotion' },
      { key:'trello',  stateEl:'trelloState',  c:'connectTrello', d:'disconnectTrello' },
      { key:'buffer',  stateEl:'bufferState',  c:'connectBuffer', d:'disconnectBuffer' },
    ];
    map.forEach(async m=>{
      if(!G.WORKER_BASE) return;
      const { ok, data } = await tryFetch(`${G.WORKER_BASE}/api/integrations/state?key=${m.key}`, { headers: await G.getAuthHeaders() });
      const connected = ok && !!data?.connected;
      const stateEl = byId(m.stateEl);
      const cBtn = byId(m.c), dBtn = byId(m.d);
      stateEl && (stateEl.textContent = connected ? 'Connected' : 'Disconnected');
      cBtn && cBtn.classList.toggle('hidden', connected);
      dBtn && dBtn.classList.toggle('hidden', !connected);
    });
  }
  byId('connectNotion')?.addEventListener('click', ()=> toggleIntegration('notion', true));
  byId('disconnectNotion')?.addEventListener('click', ()=> toggleIntegration('notion', false));
  byId('connectTrello')?.addEventListener('click', ()=> toggleIntegration('trello', true));
  byId('disconnectTrello')?.addEventListener('click', ()=> toggleIntegration('trello', false));
  byId('connectBuffer')?.addEventListener('click', ()=> toggleIntegration('buffer', true));
  byId('disconnectBuffer')?.addEventListener('click', ()=> toggleIntegration('buffer', false));
  paintIntegrationStates();

  // ---------- Team invite (Business) ----------
  byId('inviteBtn')?.addEventListener('click', async ()=>{
    const email = byId('inviteEmail')?.value?.trim();
    if(!email) return showToast('Enter an email');
    if(!G.WORKER_BASE) return showToast('Backend not configured');
    const { ok, data } = await tryFetch(`${G.WORKER_BASE}/api/team/invite`, {
      method:'POST',
      headers: await G.getAuthHeaders(),
      body: JSON.stringify({ email })
    });
    if(!ok) return showToast(data?.error?.message || 'Invite failed');
    showToast('Invite sent ✅');
    // paint seats
    const seatList = byId('seatList');
    if(seatList){
      const { ok:ok2, data:members } = await tryFetch(`${G.WORKER_BASE}/api/team/members`, { headers: await G.getAuthHeaders() });
      if(ok2 && Array.isArray(members?.items)){
        seatList.innerHTML = members.items.map(m=> `<li class="text-sm p-2 border rounded-lg">${(m.email||'user')} — ${(m.role||'member')}</li>`).join('');
      }
    }
  });

  // ---------- WOW micro-interactions ----------
  // smooth anchor scroll
  qsa('a[href^="#"]').forEach(a=>{
    a.addEventListener('click', (e)=>{
      const id = a.getAttribute('href')?.slice(1);
      const el = byId(id);
      if(el){ e.preventDefault(); el.scrollIntoView({ behavior:'smooth', block:'start' }); setNav(false); }
    });
  });

  // subtle parallax halos
  const halos = qsa('.halo');
  window.addEventListener('mousemove', (e)=>{
    const cx = window.innerWidth/2, cy = window.innerHeight/2;
    const dx = (e.clientX - cx)/cx, dy = (e.clientY - cy)/cy;
    halos.forEach((h,i)=>{
      const x = dx * (8 + i*4), y = dy * (6 + i*3);
      h.style.transform = `translate3d(${x}px, ${y}px, 0)`;
    });
  }, { passive:true });

  // ---------- “Continue to website” funnel wiring ----------
  // Buttons in hero already link to demo/pricing; add a universal “Continue” if you place it in hero/footer
  qsa('[data-continue]').forEach(btn=>{
    btn.addEventListener('click', ()=> { location.href = '/blog'; });
  });

})(); 
</script>
<!-- === /PART 8/8 === -->
