<!doctype html>
<html lang="en" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ContentFlow AI — Repurpose & Schedule in Minutes</title>
  <meta name="description" content="Turn one idea into channel-ready drafts. Free AI via OpenRouter.">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@3.4.10/dist/tailwind.min.css" rel="stylesheet">
  <style>
    :root { --brandA:#7AA2FF; --brandB:#FF2D2D; }
    html,body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
    .txt-grad{ background:linear-gradient(135deg,var(--brandA),var(--brandB)); -webkit-background-clip:text; background-clip:text; color:transparent; }
    .bg-grad{ background:linear-gradient(135deg,var(--brandA),var(--brandB)); }
    .glass{ backdrop-filter: blur(12px); background:rgba(255,255,255,.62); }
    .card{ border-radius: 1.25rem; border:1px solid rgba(15,23,42,.10); background:rgba(255,255,255,.78); box-shadow: 0 15px 60px rgba(2,6,23,.08); }
    .neon{ position:relative; }
    .neon:before{ content:""; position:absolute; inset:-1px; border-radius:inherit; padding:1px; background:linear-gradient(90deg,rgba(122,162,255,.9),rgba(255,45,45,.9));
      -webkit-mask:linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      -webkit-mask-composite: xor; mask-composite: exclude; filter: blur(10px); opacity:.35; pointer-events:none;}
    .orb{ position:absolute; border-radius:9999px; filter: blur(40px); opacity:.55; }
    .orb.a{ width:520px; height:520px; background:radial-gradient(closest-side,rgba(122,162,255,.6),rgba(122,162,255,0)); animation: floatA 14s ease-in-out infinite; }
    .orb.b{ width:620px; height:620px; background:radial-gradient(closest-side,rgba(255,45,45,.5),rgba(255,45,45,0)); animation: floatB 16s ease-in-out infinite; }
    @keyframes floatA{ 0%,100%{ transform:translate(-5%, -8%);} 50%{ transform:translate(6%,3%);} }
    @keyframes floatB{ 0%,100%{ transform:translate(4%, 6%);} 50%{ transform:translate(-6%,-4%);} }
    .tilt{ transform-style:preserve-3d; transition: transform .25s ease, box-shadow .25s ease;}
    .tilt:hover{ transform: translateY(-2px) rotate3d(.5,1,0,4deg); box-shadow: 0 20px 80px rgba(122,162,255,.18);}
    @media (prefers-color-scheme:dark){
      body{ background:#07090f; color:#e9eef6;}
      .glass{ background:rgba(10,12,18,.5);}
      .card{ background:rgba(14,16,22,.65); border-color:rgba(255,255,255,.08); box-shadow: 0 20px 70px rgba(122,162,255,.08), 0 10px 60px rgba(255,45,45,.06);}
    }
  </style>

  <!-- Optional: GA4 (replace G-XXXX) -->
  <!-- <script async src="https://www.googletagmanager.com/gtag/js?id=G-XXXX"></script>
  <script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js',new Date());gtag('config','G-XXXX');</script> -->

  <!-- Optional: Supabase (for magic-link login). If you skip keys, login hides. -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="min-h-full">
  <!-- background orbs -->
  <div class="fixed inset-0 -z-10 pointer-events-none">
    <div class="orb a -top-40 -left-28"></div>
    <div class="orb b -bottom-40 -right-28"></div>
  </div>

  <!-- NAV -->
  <header class="sticky top-0 z-40 backdrop-blur bg-white/55 dark:bg-black/20 border-b border-white/30">
    <div class="max-w-7xl mx-auto px-5 py-4 flex items-center justify-between">
      <a href="#" class="flex items-center gap-3">
        <span class="w-9 h-9 rounded-xl bg-grad"></span>
        <span class="font-semibold tracking-tight">ContentFlow <span class="txt-grad">AI</span></span>
      </a>
      <nav class="hidden md:flex items-center gap-6 text-sm">
        <a href="#demo" class="hover:opacity-80">Demo</a>
        <a href="#pricing" class="hover:opacity-80">Pricing</a>
        <a href="#faq" class="hover:opacity-80">FAQ</a>
        <span id="planbadge" class="px-3 py-1 rounded-full text-xs bg-white/70 dark:bg-white/10 border border-white/50">Plan: Free</span>
        <button id="loginBtn" class="px-3 py-1 rounded-lg border">Sign in</button>
      </nav>
    </div>
  </header>

  <!-- HERO -->
  <section class="max-w-7xl mx-auto px-5 pt-8 md:pt-14 grid lg:grid-cols-2 gap-10 items-center">
    <div>
      <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full text-xs bg-white/70 dark:bg-white/10 border border-white/40">
        <span class="w-2 h-2 rounded-full bg-emerald-500"></span> Free demo — 1 run/day, sign in for 9 more
      </div>
      <h1 class="mt-4 text-4xl md:text-5xl font-black leading-tight tracking-tight">
        From one idea to <span class="txt-grad">everywhere</span> — repurpose & schedule in minutes.
      </h1>
      <p class="mt-4 text-slate-600 dark:text-slate-300 max-w-xl">
        Paste content → get <strong>LinkedIn</strong>, <strong>X</strong>, <strong>Email</strong> & <strong>Instagram</strong> drafts. Export with one click.
      </p>
      <div class="mt-6 flex flex-wrap gap-3">
        <a href="#demo" class="px-4 py-3 rounded-xl font-semibold text-white bg-black hover:opacity-90">Try the Live Demo</a>
        <a href="#pricing" class="px-4 py-3 rounded-xl font-semibold border border-slate-300/60 hover:bg-white/50">See pricing</a>
      </div>
    </div>

    <div class="glass card p-5">
      <div class="text-xs text-slate-500 mb-2">Preview</div>
      <pre class="text-xs bg-black/85 text-green-200 rounded-xl p-4 h-56 overflow-auto">
contentflow generate --channels linkedin,x,email
✓ outline created
✓ 3 social variants
✓ email snippet ready</pre>
    </div>
  </section>

  <!-- DEMO -->
  <main id="demo" class="max-w-7xl mx-auto px-5 py-10 grid lg:grid-cols-2 gap-8">
    <section class="card p-6">
      <div class="flex items-center justify-between">
        <h2 class="text-xl font-bold tracking-tight">Live Demo — Repurpose</h2>
        <span id="quota" class="px-3 py-1 rounded-full text-xs bg-white/70 dark:bg-white/10 border border-white/50">Checking quota…</span>
      </div>

      <textarea id="source" class="mt-4 w-full h-48 p-3 rounded-xl border border-slate-200/70 focus:outline-none focus:ring-2 focus:ring-slate-300 dark:bg-black/30" placeholder="Paste a paragraph or blog snippet…"></textarea>

      <details id="settings" class="mt-4 open:scroll-mt-20">
        <summary class="cursor-pointer text-sm text-slate-500">Advanced settings</summary>
        <div class="grid md:grid-cols-3 gap-3 mt-3">
          <input id="model" class="p-2 rounded-xl border border-slate-200/70 dark:bg-black/30" placeholder="Preferred model (optional)" />
          <input id="byok" class="p-2 rounded-xl border border-slate-200/70 dark:bg-black/30" placeholder="Your OpenRouter key (optional BYOK)" />
          <button id="save" class="px-4 py-2 rounded-xl font-semibold border border-slate-300/60 hover:bg-white/50">Save</button>
        </div>
        <p class="text-xs text-slate-500 mt-2">BYOK lives only in this tab. We don’t store keys.</p>
      </details>

      <div class="mt-4 flex flex-wrap items-center gap-3">
        <button id="run" class="px-4 py-2 rounded-xl font-semibold text-white bg-black hover:opacity-90">Generate</button>
        <button id="clear" class="px-4 py-2 rounded-xl font-semibold border border-slate-300/60 hover:bg-white/50">Clear</button>
        <button id="dl-md" class="px-4 py-2 rounded-xl font-semibold border border-slate-300/60 hover:bg-white/50" disabled>Download Markdown</button>
        <button id="dl-csv" class="px-4 py-2 rounded-xl font-semibold border border-slate-300/60 hover:bg-white/50" disabled>Export CSV</button>
        <span id="status" class="text-sm text-slate-500"></span>
      </div>

      <!-- Batch UI appears for non-free plans (client-side), still enforces caps in Worker -->
      <div id="batch-ui" class="mt-5 hidden">
        <label class="text-sm font-medium">Batch inputs (one per line)</label>
        <textarea id="batch-inputs" class="mt-2 w-full h-32 p-3 rounded-xl border border-slate-200/70 dark:bg-black/30" placeholder="Line 1&#10;Line 2&#10;Line 3"></textarea>
        <div class="mt-2 text-xs text-slate-500">Starter: 200/mo • Creator: 500/mo • Business: Unlimited (BYOK always unlimited)</div>
        <button id="run-batch" class="mt-3 px-4 py-2 rounded-xl font-semibold bg-black text-white hover:opacity-90">Run Batch</button>
        <span id="batch-status" class="text-sm text-slate-500 ml-3"></span>
      </div>
    </section>

    <section class="grid gap-5">
      <div class="card p-5">
        <div class="flex justify-between items-center">
          <strong class="tracking-tight">LinkedIn</strong>
          <button id="copy-li" class="px-3 py-1 rounded-full text-xs border border-slate-300/60 hover:bg-white/50">Copy</button>
        </div>
        <pre id="out-li" class="whitespace-pre-wrap text-sm mt-3"></pre>
      </div>

      <div class="card p-5">
        <div class="flex justify-between items-center">
          <strong class="tracking-tight">X (Twitter)</strong>
          <button id="copy-x" class="px-3 py-1 rounded-full text-xs border border-slate-300/60 hover:bg-white/50">Copy</button>
        </div>
        <pre id="out-x" class="whitespace-pre-wrap text-sm mt-3"></pre>
      </div>

      <div class="card p-5">
        <div class="flex justify-between items-center">
          <strong class="tracking-tight">Email snippet</strong>
          <button id="copy-em" class="px-3 py-1 rounded-full text-xs border border-slate-300/60 hover:bg-white/50">Copy</button>
        </div>
        <pre id="out-em" class="whitespace-pre-wrap text-sm mt-3"></pre>
      </div>

      <div class="card p-5">
        <div class="flex justify-between items-center">
          <strong class="tracking-tight">Instagram</strong>
          <button id="copy-ig" class="px-3 py-1 rounded-full text-xs border border-slate-300/60 hover:bg-white/50">Copy</button>
        </div>
        <pre id="out-ig" class="whitespace-pre-wrap text-sm mt-3"></pre>
      </div>
    </section>
  </main>

  <!-- PRICING -->
  <section id="pricing" class="max-w-7xl mx-auto px-5 pb-16">
    <div class="text-center mb-8">
      <h2 class="text-3xl md:text-4xl font-extrabold tracking-tight">Simple, honest pricing</h2>
      <p class="text-slate-600 dark:text-slate-300 mt-2">Start free. Add power when you need it.</p>
    </div>
    <div class="grid lg:grid-cols-4 gap-6">
      <div class="card p-6">
        <div class="text-sm px-3 py-1 rounded-full bg-white/70 dark:bg-white/10 border w-fit">Free</div>
        <h3 class="mt-3 text-xl font-bold">Demo</h3>
        <div class="mt-2 text-3xl font-extrabold">$0<span class="text-sm text-slate-500">/forever</span></div>
        <ul class="mt-4 text-sm space-y-2">
          <li>• 1 run/day (no login)</li>
          <li>• 10/day when signed in</li>
          <li>• BYOK unlimited</li>
          <li>• CSV/Markdown export</li>
        </ul>
        <a href="#demo" class="mt-6 block text-center px-4 py-2 rounded-xl font-semibold border hover:bg-white/50">Try free</a>
      </div>
      <div class="card p-6 neon">
        <div class="text-sm px-3 py-1 rounded-full bg-white/70 dark:bg-white/10 border w-fit">Starter</div>
        <h3 class="mt-3 text-xl font-bold">Solo Creator</h3>
        <div class="mt-2 text-3xl font-extrabold">$9<span class="text-sm text-slate-500">/mo</span></div>
        <ul class="mt-4 text-sm space-y-2">
          <li>• 200 generations / month</li>
          <li>• Batch inputs</li>
          <li>• 10 saved presets</li>
          <li>• Priority models</li>
        </ul>
        <a href="?plan=starter" class="mt-6 block text-center px-4 py-2 rounded-xl font-semibold bg-black text-white hover:opacity-90">Get Starter</a>
      </div>
      <div class="card p-6 neon">
        <div class="text-sm px-3 py-1 rounded-full bg-white/70 dark:bg-white/10 border w-fit">Best value</div>
        <h3 class="mt-3 text-xl font-bold">Creator</h3>
        <div class="mt-2 text-3xl font-extrabold">$19<span class="text-sm text-slate-500">/mo</span></div>
        <ul class="mt-4 text-sm space-y-2">
          <li>• 500 generations / month</li>
          <li>• Unlimited presets</li>
          <li>• Project pack export</li>
          <li>• New workflows early</li>
        </ul>
        <a href="?plan=creator" class="mt-6 block text-center px-4 py-2 rounded-xl font-semibold bg-black text-white hover:opacity-90">Get Creator</a>
      </div>
      <div class="card p-6">
        <div class="text-sm px-3 py-1 rounded-full bg-white/70 dark:bg-white/10 border w-fit">Team</div>
        <h3 class="mt-3 text-xl font-bold">Business</h3>
        <div class="mt-2 text-3xl font-extrabold">$49<span class="text-sm text-slate-500">/mo</span></div>
        <ul class="mt-4 text-sm space-y-2">
          <li>• Unlimited (fair use)</li>
          <li>• 3 seats (soft-gated)</li>
          <li>• White-label export</li>
          <li>• Priority support</li>
        </ul>
        <a href="?plan=business" class="mt-6 block text-center px-4 py-2 rounded-xl font-semibold border hover:bg-white/50">Get Business</a>
      </div>
    </div>
  </section>

  <section id="faq" class="max-w-7xl mx-auto px-5 pb-16">
    <div class="card p-6">
      <h3 class="text-2xl font-bold tracking-tight">FAQ</h3>
      <ul class="mt-3 text-sm text-slate-700 dark:text-slate-300 space-y-2">
        <li><strong>Is it free?</strong> Yes. 1/day anonymous, 10/day signed-in, BYOK unlimited.</li>
        <li><strong>Does it store my key?</strong> No. BYOK stays in your browser tab (sessionStorage).</li>
        <li><strong>What if a model is busy?</strong> We auto-rotate free lanes and try again.</li>
      </ul>
    </div>
  </section>

  <footer class="py-10 text-center text-xs text-slate-500">
    © <span id="year"></span> ContentFlow AI
  </footer>

  <script>
    // ===== CONFIG =====
    const WORKER_BASE = "https://contentflow-worker.frank-couchman.workers.dev";

    // Optional Supabase login — add your keys to enable magic link sign-in
    const SUPABASE_URL = "";     // e.g., https://xxxx.supabase.co
    const SUPABASE_ANON = "";    // e.g., public anon key
    let supabase = null;
    if (SUPABASE_URL && SUPABASE_ANON) supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

    const $ = (s)=>document.querySelector(s);
    $("#year").textContent = new Date().getFullYear();

    // Hide login if Supabase not configured
    if (!supabase) $("#loginBtn").style.display = "none";

    // Plan activation from URL (?plan=starter|creator|business)
    (function(){
      const params = new URLSearchParams(location.search);
      const incoming = params.get("plan");
      if (incoming && ["starter","creator","business"].includes(incoming)) {
        localStorage.setItem("plan", incoming);
        history.replaceState({}, "", location.pathname); // clean URL
      }
      const plan = localStorage.getItem("plan") || "free";
      const badge = document.getElementById("planbadge");
      badge.textContent = `Plan: ${plan.charAt(0).toUpperCase()+plan.slice(1)}`;
      if (plan !== "free") document.getElementById("batch-ui").classList.remove("hidden");
    })();

    // Supabase magic link login (optional)
    document.getElementById("loginBtn").onclick = async ()=>{
      if (!supabase) return;
      const email = prompt("Enter your email for a magic link:");
      if (!email) return;
      const { data, error } = await supabase.auth.signInWithOtp({ email });
      if (error) { alert(error.message); return; }
      alert("Magic link sent. Check your inbox.");
    };

    async function getAuth(){
      if (!supabase) return { token:null, userId:null };
      const { data: { session } } = await supabase.auth.getSession();
      return { token: session?.access_token || null, userId: session?.user?.id || null };
    }

    // Save simple settings in this tab
    $("#save").onclick = ()=>{
      sessionStorage.setItem("MODEL", $("#model").value.trim());
      sessionStorage.setItem("BYOK",  $("#byok").value.trim());
      alert("Saved for this tab.");
    };

    // Copy helpers
    const copy = (btnSel, get)=>{ $(btnSel).onclick = async()=>{ await navigator.clipboard.writeText(get()); } };
    copy("#copy-li", ()=> $("#out-li").textContent || "");
    copy("#copy-x",  ()=> $("#out-x").textContent  || "");
    copy("#copy-em", ()=> $("#out-em").textContent || "");
    copy("#copy-ig", ()=> $("#out-ig").textContent || "");

    async function refreshQuota(){
      try{
        const { token, userId } = await getAuth();
        const headers = {};
        if (token) headers["Authorization"] = `Bearer ${token}`;
        if (userId) headers["X-User-Id"] = userId;
        const plan = localStorage.getItem("plan") || "";
        if (plan) headers["X-Plan"] = plan;

        const r = await fetch(`${WORKER_BASE}/api/quota?plan=free`, { headers });
        const q = await r.json();
        const d = q.cap===Infinity ? "Unlimited" : `${q.used}/${q.cap} today`;
        $("#quota").textContent = `Quota: ${d}` + (q.monthly ? ` • ${q.monthly.used}/${q.monthly.cap===null? "∞":q.monthly.cap} this month` : "");
      }catch{ $("#quota").textContent = "Quota: n/a"; }
    }
    refreshQuota();

    function buildMarkdown(o){
      const lines = [
        "# Content Pack","","## LinkedIn",(o.linkedin||"").trim(),
        "","## X (Twitter)",(Array.isArray(o.x)?o.x.join("\\n\\n—\\n\\n"):o.x||"").trim(),
        "","## Email",(o.email||"").trim(),
        "","## Instagram",(o.instagram||"").trim(),""
      ];
      return lines.join("\\n");
    }
    const csvEsc = s => '"' + String(s).replace(/"/g,'""') + '"';
    function buildCSV(o){
      const rows = [["channel","content"]];
      if (o.linkedin) rows.push(["linkedin", o.linkedin]);
      if (o.x) rows.push(["x", Array.isArray(o.x)?o.x.join("\\n\\n—\\n\\n"):o.x]);
      if (o.email) rows.push(["email", o.email]);
      if (o.instagram) rows.push(["instagram", o.instagram]);
      return rows.map(r=>r.map(csvEsc).join(",")).join("\\n");
    }
    function download(filename, mime, text){
      const blob = new Blob([text], { type: mime });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = filename; document.body.appendChild(a); a.click();
      setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0);
    }

    // Fallback parser: if the model returns plain text, we still show it
    function parseOutput(content){
      if (!content) return {};
      try {
        const j = JSON.parse(content);
        if (j && (j.linkedin || j.x || j.email || j.instagram)) return j;
      } catch {}
      // Heuristic fallback: split the text into sections
      const text = String(content);
      const out = {};
      // Try simple splits
      const parts = text.split(/\n{2,}/);
      out.linkedin  = parts[0] || text;
      out.x         = parts[1] || "";
      out.email     = parts[2] || "";
      out.instagram = parts.slice(3).join("\n\n") || "";
      return out;
    }

    // Generate one
    $("#run").onclick = async ()=>{
      const source = $("#source").value.trim();
      if (!source) { alert("Paste some content first."); return; }
      $("#status").textContent = "Generating…";
      $("#out-li").textContent = $("#out-x").textContent = $("#out-em").textContent = $("#out-ig").textContent = "";
      $("#dl-md").disabled = true; $("#dl-csv").disabled = true;

      const model = sessionStorage.getItem("MODEL") || "";
      const byok  = sessionStorage.getItem("BYOK")  || "";
      const headers = { "Content-Type":"application/json" };
      if (byok) headers["X-User-OpenRouter-Key"] = byok;

      const { token, userId } = await getAuth();
      if (token) headers["Authorization"] = `Bearer ${token}`;
      if (userId) headers["X-User-Id"] = userId;
      const planHdr = localStorage.getItem("plan") || "";
      if (planHdr) headers["X-Plan"] = planHdr;

      const SYSTEM = {
        role: "system",
        content: `You are a senior content strategist. Repurpose the user's source into JSON with keys: linkedin, x, email, instagram.
- LinkedIn: 6–10 lines, 1 CTA.
- X: <= 280 chars, 2 variants.
- Email: 3–5 sentences + subject.
- Instagram: 1–2 short paragraphs + 3–5 hashtags.
No extra commentary.`
      };
      const messages = [ SYSTEM, { role:"user", content: `Source:\n${source}\nChannels: LinkedIn,X,Email,Instagram` } ];

      try{
        const r = await fetch(`${WORKER_BASE}/api/generate`, {
          method:"POST",
          headers,
          body: JSON.stringify({ plan: byok ? "pro":"free", messages, temperature:0.7, model: model || undefined })
        });
        const data = await r.json().catch(()=> ({}));
        if (!r.ok) { $("#status").textContent = data?.error?.message || "Error"; return; }

        const content = data?.choices?.[0]?.message?.content || "";
        const out = parseOutput(content);

        $("#out-li").textContent = out.linkedin || "";
        $("#out-x").textContent  = Array.isArray(out.x) ? out.x.join("\n\n—\n\n") : (out.x || "");
        $("#out-em").textContent = out.email || "";
        $("#out-ig").textContent = out.instagram || "";

        $("#status").textContent = `Done • Model: ${data?._meta?.model_used || "n/a"}`;
        refreshQuota();

        $("#dl-md").disabled = false; $("#dl-csv").disabled = false;
        $("#dl-md").onclick = ()=> download("content-pack.md","text/markdown", buildMarkdown(out));
        $("#dl-csv").onclick = ()=> download("content-pack.csv","text/csv",      buildCSV(out));
      }catch(e){ $("#status").textContent = e.message || "Network error"; }
    };

    // Batch (client unlock; worker still enforces monthly caps)
    document.getElementById("run-batch").addEventListener("click", async ()=>{
      const plan = localStorage.getItem("plan") || "free";
      const caps = { starter:200, creator:500, business:Infinity };
      if (!caps[plan]) { alert("Upgrade to use batch."); return; }

      const { token, userId } = await getAuth();
      const byok = sessionStorage.getItem("BYOK") || "";
      const headers = { "Content-Type":"application/json" };
      if (byok) headers["X-User-OpenRouter-Key"] = byok;
      if (token) headers["Authorization"] = `Bearer ${token}`;
      if (userId) headers["X-User-Id"] = userId;
      headers["X-Plan"] = plan;

      const model = sessionStorage.getItem("MODEL") || "";
      const SYSTEM = {
        role: "system",
        content: `You are a senior content strategist. Repurpose the user's source into JSON with keys: linkedin, x, email, instagram.
- LinkedIn: 6–10 lines, 1 CTA.
- X: <= 280 chars, 2 variants.
- Email: 3–5 sentences + subject.
- Instagram: 1–2 short paragraphs + 3–5 hashtags.
No extra commentary.`
      };

      const lines = ($("#batch-inputs").value || "").split("\n").map(s=>s.trim()).filter(Boolean);
      const toRun = lines.slice(0, Math.min(lines.length, 50)); // safety; worker monthly cap will still guard
      const status = $("#batch-status"); status.textContent = `Running ${toRun.length}…`;

      let done=0; const packs=[];
      for (const src of toRun) {
        try{
          const r = await fetch(`${WORKER_BASE}/api/generate`, {
            method:"POST", headers,
            body: JSON.stringify({ plan: byok ? "pro":"free", messages:[SYSTEM,{role:"user",content:`Source:\n${src}\nChannels: LinkedIn,X,Email,Instagram`}], temperature:0.7, model: model || undefined })
          });
          const data = await r.json().catch(()=> ({}));
          const content = data?.choices?.[0]?.message?.content || "";
          packs.push({ source: src, ...parseOutput(content) });
        }catch(e){}
        done++; status.textContent = `Completed ${done}/${toRun.length}`;
      }

      const csvRows = [["source","channel","content"]];
      const md = [];
      const csvEsc = s => '"' + String(s).replace(/"/g,'""') + '"';
      for (const p of packs) {
        md.push(`# ${p.source}\n\n## LinkedIn\n${p.linkedin||""}\n\n## X\n${Array.isArray(p.x)?p.x.join("\n\n—\n\n"):(p.x||"")}\n\n## Email\n${p.email||""}\n\n## Instagram\n${p.instagram||""}\n`);
        if (p.linkedin)  csvRows.push([p.source,"linkedin",p.linkedin]);
        if (p.x)         csvRows.push([p.source,"x",Array.isArray(p.x)?p.x.join("\\n\\n—\\n\\n"):p.x]);
        if (p.email)     csvRows.push([p.source,"email",p.email]);
        if (p.instagram) csvRows.push([p.source,"instagram",p.instagram]);
      }
      const csv = csvRows.map(r=>r.map(csvEsc).join(",")).join("\n");
      const mdAll = md.join("\n---\n\n");

      const blobMD = new Blob([mdAll], {type:"text/markdown"});
      const blobCSV = new Blob([csv], {type:"text/csv"});
      const urlMD = URL.createObjectURL(blobMD);
      const urlCSV = URL.createObjectURL(blobCSV);
      const a1 = Object.assign(document.createElement("a"), { href:urlMD, download:"batch-pack.md" });
      const a2 = Object.assign(document.createElement("a"), { href:urlCSV, download:"batch-pack.csv" });
      a1.click(); a2.click();
      setTimeout(()=>{ URL.revokeObjectURL(urlMD); URL.revokeObjectURL(urlCSV); }, 1000);
      status.textContent = "Batch exports downloaded.";
      refreshQuota();
    });

    // Enter to run
    document.getElementById("source").addEventListener("keydown",(e)=>{
      if (e.key==="Enter" && !e.shiftKey) { e.preventDefault(); document.getElementById("run").click(); }
    });

    $("#clear").onclick = ()=>{
      $("#source").value = "";
      $("#status").textContent = "";
      $("#out-li").textContent = $("#out-x").textContent = $("#out-em").textContent = $("#out-ig").textContent = "";
      $("#dl-md").disabled = true; $("#dl-csv").disabled = true;
    };
  </script>
</body>
</html>
