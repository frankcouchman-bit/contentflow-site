<!doctype html>
<html lang="en" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>ContentRepurpose.pro — AI Content Repurposing Tool & Generator</title>
  <meta name="description" content="Content repurposing AI that turns one idea into LinkedIn, X, Email & Instagram drafts. Export to Notion & Trello. BYOK supported." />
  <link rel="canonical" href="https://contentrepurpose.pro/">
  <meta name="theme-color" content="#0a0d18">
  <meta name="color-scheme" content="dark light">
  <meta name="robots" content="index,follow,max-video-preview:-1,max-image-preview:large,max-snippet:-1">

  <!-- Open Graph -->
  <meta property="og:type" content="website">
  <meta property="og:title" content="ContentRepurpose.pro — AI Content Repurposing Tool">
  <meta property="og:description" content="Repurpose content with AI. Paste once → get LinkedIn, X, Email & Instagram drafts. Export to Notion & Trello. BYOK supported.">
  <meta property="og:url" content="https://contentrepurpose.pro/">
  <meta property="og:image" content="/og-cover.png">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="ContentRepurpose.pro — AI Content Generator">
  <meta name="twitter:description" content="Content repurposing AI for multi-channel drafts. Export to Notion & Trello. BYOK supported.">
  <meta name="twitter:image" content="/og-cover.png">

  <!-- Fonts + Tailwind -->
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Chart.js for Analytics Pro (creator+) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>

  <!-- JSZip for Project Pack export (creator+) -->
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

  <!-- Global CSS -->
  <style>
    :root{ --brandA:#7AA2FF; --brandB:#FF2D2D; --ink:#0a0d18 }
    html,body{font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .txt-grad{background:linear-gradient(135deg,var(--brandA),var(--brandB));-webkit-background-clip:text;background-clip:text;color:transparent}
    .bg-grad{background:linear-gradient(135deg,var(--brandA),var(--brandB))}
    .card{border-radius:1.25rem;border:1px solid rgba(15,23,42,.10);background:rgba(255,255,255,.80);box-shadow:0 12px 40px rgba(2,6,23,.08)}
    .badge{display:inline-flex;align-items:center;gap:.5rem;padding:.35rem .6rem;border-radius:9999px;border:1px solid rgba(255,255,255,.15);font-size:.75rem;background:rgba(255,255,255,.65)}
    .chip{font-size:.7rem;padding:.2rem .5rem;border-radius:9999px;border:1px solid rgba(148,163,184,.35)}
    .btn{padding:.6rem .9rem;border-radius:.9rem;border:1px solid rgba(148,163,184,.35)}
    .btn-primary{background:black;color:white}
    .glass{backdrop-filter: blur(12px); background:rgba(255,255,255,.62)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    .halo{position:absolute;filter:blur(60px);opacity:.55;pointer-events:none;transform:translateZ(0);
      background:radial-gradient(50% 50% at 50% 50%, rgba(122,162,255,.8), rgba(255,45,45,.65) 60%, transparent 70%);
      width:42rem;height:42rem;border-radius:50%;animation:float 16s ease-in-out infinite;}
    .halo.h2{width:34rem;height:34rem;right:-12rem;top:-6rem;animation-duration:18s;opacity:.5}
    .halo.h3{width:28rem;height:28rem;left:-10rem;top:26rem;animation-duration:22s;opacity:.45}
    @keyframes float{ 0%,100%{ transform: translate3d(0,0,0) } 50%{ transform: translate3d(0,-20px,0) } }
    .orbit{position:absolute;inset:-32px;border-radius:24px;pointer-events:none;
      background: conic-gradient(from 0deg, rgba(122,162,255,.25), rgba(255,45,45,.18), rgba(122,162,255,.25));
      -webkit-mask: radial-gradient(closest-side, transparent 88%, black 89%); mask: radial-gradient(closest-side, transparent 88%, black 89%);
      animation: spin 18s linear infinite;}
    @keyframes spin{ to{ transform: rotate(360deg) } }
    .mock{border-radius:1rem;border:1px solid rgba(255,255,255,.12); background:linear-gradient(180deg,rgba(255,255,255,.75),rgba(255,255,255,.6));}
    @media (prefers-color-scheme:dark){ body{background:var(--ink);color:#e9eef6} .card{background:rgba(14,16,22,.6);border-color:rgba(255,255,255,.08);box-shadow:0 24px 96px rgba(122,162,255,.08),0 14px 60px rgba(255,45,45,.06)} .badge{background:rgba(255,255,255,.06);border-color:rgba(255,255,255,.12)} .mock{ background:linear-gradient(180deg,rgba(17,20,31,.88),rgba(17,20,31,.72)); } }
    .marquee{ display:grid; grid-auto-flow:column; gap:2rem; align-items:center; animation: scrollx 26s linear infinite }
    .marquee:hover{ animation-play-state: paused } @keyframes scrollx{ from{ transform: translateX(0) } to{ transform: translateX(-50%) } }
    .nav-sheet{position:fixed; inset:0 0 auto 0; background:rgba(0,0,0,.6); backdrop-filter:blur(8px); display:none}
    .nav-panel{position:absolute; top:0; right:0; width:82vw; max-width:380px; height:100%; background:rgba(14,16,22,.96); border-left:1px solid rgba(255,255,255,.08); padding:1rem}
    .nav-open .nav-sheet{display:block}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
    .icon { width: 1rem; height: 1rem; display: inline-block; vertical-align: -0.15em; }
    .touch-target{min-height:40px;min-width:40px}

    /* Plan gates (default: safe) — revealed after plan detection */
    .only-authed{ display:none }
    .plan-starter-plus, .plan-creator-plus, .plan-business-only { display:none }

    /* Toast + live regions */
    #toast[aria-live]{ position:fixed; bottom:1rem; left:50%; transform:translateX(-50%); z-index:9999 }
  </style>

  <!-- JSON-LD -->
  <script type="application/ld+json">{"@context":"https://schema.org","@type":"Organization","name":"ContentRepurpose.pro","url":"https://contentrepurpose.pro/","logo":"https://contentrepurpose.pro/logo.svg","sameAs":["https://x.com/contentrepurpose","https://www.linkedin.com/company/contentrepurpose"]}</script>

  <!-- Worker base -->
  <script>
    window.WORKER_BASE = "https://contentflow-worker.frank-couchman.workers.dev";
    window.SITE_ORIGIN = "https://contentrepurpose.pro";
  </script>

  <!-- Supabase v2 auth -->
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

    const SUPABASE_URL  = "https://ynkoavaeadlzlwylmfmu.supabase.co";
    const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlua29hdmFlYWRsemx3eWxtZm11Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5OTAxNDgsImV4cCI6MjA3MzU2NjE0OH0.1yM5yDo0MI9Upzt4GkLyf1mqvDXfb3DXvC0ouOLtRoU";

    window.supabase = createClient(SUPABASE_URL, SUPABASE_ANON);

    window.getAuth = async () => {
      try {
        const { data } = await window.supabase.auth.getSession();
        const s = data?.session;
        return { token: s?.access_token || "", userId: s?.user?.id || null, email: s?.user?.email || null };
      } catch { return { token:"", userId:null, email:null }; }
    };
    window.getAuthHeaders = async () => {
      const { token, userId } = await window.getAuth();
      const h = { "Content-Type": "application/json" };
      if (token)  h["Authorization"] = `Bearer ${token}`;
      if (userId) h["X-User-Id"] = userId;
      return h;
    };

    // Sign-in helpers (fixed)
    window.openAuthDialog = () => {
      const dlg = document.getElementById("auth");
      if (dlg?.showModal) dlg.showModal();
    };
    window.attachAuthButtons = () => {
      document.querySelectorAll(".js-open-auth").forEach(btn=>{
        if (!btn.__wired){ btn.__wired = true; btn.addEventListener("click", window.openAuthDialog); }
      });
    };

    // Paint minimal auth UI (shows correct plan label later)
    function paintAuthUI(authed) {
      const show = (id) => document.getElementById(id)?.classList.remove("hidden");
      const hide = (id) => document.getElementById(id)?.classList.add("hidden");
      const has  = (id) => !!document.getElementById(id);

      if (has("loginBtn"))     (authed ? hide("loginBtn")     : show("loginBtn"));
      if (has("loginBtn_m"))   (authed ? hide("loginBtn_m")   : show("loginBtn_m"));
      if (has("logoutBtn"))    (authed ? show("logoutBtn")    : hide("logoutBtn"));
      if (has("logoutBtn_m"))  (authed ? show("logoutBtn_m")  : hide("logoutBtn_m"));
      if (has("manageBilling"))   authed ? show("manageBilling")   : hide("manageBilling");
      if (has("manageBilling_m")) authed ? show("manageBilling_m") : hide("manageBilling_m");

      // Temporary label until status fetch replaces it with actual plan
      const badge = document.getElementById("planbadge");
      const badgeM= document.getElementById("planbadge_m");
      if (badge)  badge.textContent  = authed ? "Plan: Signed in" : "Plan: Free";
      if (badgeM) badgeM.textContent = authed ? "Plan: Signed in" : "Plan: Free";
    }

    document.addEventListener("DOMContentLoaded", async () => {
      // Dialog wires
      const email = document.getElementById("authEmail");
      const note  = document.getElementById("authNote");
      const send  = document.getElementById("authSend");
      const googleBtn = document.getElementById("authGoogle");

      if (send && !send.__wired){
        send.__wired = true;
        send.addEventListener("click", async ()=>{
          const e = email?.value?.trim();
          if (!e){ note.textContent = "Enter your email."; return; }
          try{
            const { error } = await window.supabase.auth.signInWithOtp({ email: e, options:{ emailRedirectTo: window.location.origin } });
            if (error) throw error;
            note.textContent = "Check your email for the magic link.";
          }catch(err){ note.textContent = err?.message || "Sign-in error"; }
        });
      }
      if (googleBtn && !googleBtn.__wired){
        googleBtn.__wired = true;
        googleBtn.addEventListener("click", async ()=>{
          try{
            await window.supabase.auth.signInWithOAuth({ provider:"google", options:{ redirectTo: window.location.origin }});
          }catch(err){ note.textContent = err?.message || "Google sign-in failed."; }
        });
      }

      // Header buttons
      window.attachAuthButtons();
      document.getElementById("logoutBtn")?.addEventListener("click", ()=>window.supabase.auth.signOut());
      document.getElementById("logoutBtn_m")?.addEventListener("click", ()=>window.supabase.auth.signOut());

      // Paint initial auth state
      const { data } = await window.supabase.auth.getSession();
      paintAuthUI(!!data?.session);

      // React to changes
      window.supabase.auth.onAuthStateChange((_evt, session)=> {
        paintAuthUI(!!session);
        // downstream script will re-fetch status and apply plan gates
        try{ window.CRP && window.CRP.refreshStatus && window.CRP.refreshStatus(); }catch{}
        // close any open auth dialog
        try{ document.querySelectorAll('dialog#auth[open]').forEach(d=>d.close()); }catch{}
      });
    });
  </script>
</head>

<body class="min-h-full" data-auth="guest">
  <!-- Decorative halos -->
  <div class="halo" style="left:-14rem; top:-10rem;"></div>
  <div class="halo h2"></div>
  <div class="halo h3"></div>

  <!-- Top nav (desktop + mobile trigger) -->
  <header class="sticky top-0 z-40 backdrop-blur bg-white/55 dark:bg-black/20 border-b border-white/30">
    <div class="max-w-7xl mx-auto px-4 md:px-5 py-4 flex items-center justify-between">
      <a href="/" class="flex items-center gap-3" aria-label="ContentRepurpose home">
        <svg width="36" height="36" viewBox="0 0 48 48" class="rounded-xl" aria-hidden="true">
          <defs><linearGradient id="g" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#7AA2FF"/><stop offset="100%" stop-color="#FF2D2D"/></linearGradient></defs>
          <rect x="0" y="0" width="48" height="48" rx="12" fill="url(#g)"/>
          <path d="M14 16h10a6 6 0 0 1 0 12H20v4h-6V16zm6 6v4h4a2 2 0 1 0 0-4h-4z" fill="white"/>
          <path d="M28 16h6v16h-6z" fill="white" opacity=".9"/>
        </svg>
        <span class="font-semibold tracking-tight">Content<span class="txt-grad">Repurpose</span></span>
      </a>

      <nav class="hidden md:flex items-center gap-6 text-sm">
        <a href="#demo" class="hover:opacity-80">Live Demo</a>
        <a href="#templates" class="hover:opacity-80">Templates</a>
        <a href="#use-cases" class="hover:opacity-80">Use cases</a>
        <a href="#best-picks" class="hover:opacity-80">Best picks</a>
        <a href="#pricing" class="hover:opacity-80">Pricing</a>
        <a href="/blog" class="hover:opacity-80">Blog</a>
        <span id="planbadge" class="px-3 py-1 rounded-full text-xs bg-white/70 dark:bg-white/10 border border-white/50">Plan: Free</span>
        <button id="manageBilling" class="px-3 py-1 rounded-lg border hidden">Manage billing</button>
        <div class="flex items-center gap-2">
          <button id="loginBtn" class="px-3 py-1 rounded-lg border js-open-auth">Sign in</button>
          <button id="logoutBtn" class="px-3 py-1 rounded-lg border hidden">Sign out</button>
        </div>
      </nav>

      <button id="navToggle" class="md:hidden touch-target px-3 py-2 rounded-lg border" aria-expanded="false" aria-controls="mobileNav" aria-label="Open menu">☰</button>
    </div>

    <!-- Promo strip -->
    <div class="border-t border-white/40 bg-white/70 dark:bg-white/10">
      <div class="max-w-7xl mx-auto px-4 md:px-5 py-2 flex flex-wrap items-center justify-between gap-3 text-sm">
        <div class="flex items-center gap-2">
          <span class="px-2 py-0.5 rounded-full text-[11px] bg-black/80 text-white">LIMITED</span>
          <span>Use <strong class="mono">CONTENTOFF90</strong> for <strong>90% off</strong> the Creator plan.</span>
        </div>
        <div class="flex items-center gap-2">
          <button id="copyPromoBtn" class="px-3 py-1 rounded-lg border">Copy code</button>
          <a href="#pricing" class="px-3 py-1 rounded-lg bg-black text-white">See pricing</a>
        </div>
      </div>
    </div>

    <!-- Mobile sheet -->
    <div id="mobileNav" class="nav-sheet" aria-hidden="true">
      <div class="nav-panel text-sm text-white">
        <div class="flex items-center justify-between">
          <span class="font-semibold">Menu</span>
          <button id="navClose" class="touch-target px-3 py-2 rounded-lg border border-white/20" aria-label="Close menu">✕</button>
        </div>
        <nav class="mt-4 grid gap-2">
          <a href="#demo" class="px-3 py-2 rounded-lg hover:bg-white/10">Live Demo</a>
          <a href="#templates" class="px-3 py-2 rounded-lg hover:bg-white/10">Templates</a>
          <a href="#use-cases" class="px-3 py-2 rounded-lg hover:bg-white/10">Use cases</a>
          <a href="#best-picks" class="px-3 py-2 rounded-lg hover:bg-white/10">Best picks</a>
          <a href="#pricing" class="px-3 py-2 rounded-lg hover:bg-white/10">Pricing</a>
          <a href="/blog" class="px-3 py-2 rounded-lg hover:bg-white/10">Blog</a>
        </nav>
        <div class="mt-6 grid gap-2">
          <span id="planbadge_m" class="px-3 py-1 rounded-full text-xs bg-white/10 border border-white/20 w-fit">Plan: Free</span>
          <button id="manageBilling_m" class="px-3 py-2 rounded-lg border border-white/20 hidden">Manage billing</button>
          <button id="loginBtn_m" class="px-3 py-2 rounded-lg border border-white/20 js-open-auth">Sign in</button>
          <button id="logoutBtn_m" class="px-3 py-2 rounded-lg border border-white/20 hidden">Sign out</button>
        </div>
      </div>
    </div>
  </header>
  <!-- Hero -->
  <section class="relative overflow-hidden">
    <div class="max-w-7xl mx-auto px-4 md:px-5 py-14 md:py-20">
      <div class="grid md:grid-cols-2 gap-10 items-center">
        <div>
          <h1 class="text-3xl md:text-5xl font-extrabold leading-tight">
            Turn one idea into <span class="txt-grad">multi-channel</span> content.
          </h1>
          <p class="mt-4 text-slate-600 dark:text-slate-300 max-w-xl">
            Paste once → get LinkedIn posts & articles, X threads, Email drafts, Reddit/Quora answers, Instagram captions. Export to Notion/Trello. Schedule with multi-profile (Creator+).
          </p>
          <div class="mt-6 flex flex-wrap gap-3">
            <a href="#demo" class="btn btn-primary">Start generating</a>
            <button class="btn js-open-auth">Sign in</button>
            <a href="#pricing" class="btn">See plans</a>
          </div>
          <div class="mt-4 flex items-center gap-3 text-sm">
            <span class="chip">BYOK supported</span>
            <span class="chip">Per-channel analytics (Creator+)</span>
            <span class="chip">Scheduler (Creator+)</span>
          </div>
        </div>

        <!-- Hero preview mock -->
        <div class="relative">
          <div class="orbit"></div>
          <div class="mock p-4">
            <div class="grid gap-3">
              <div class="flex items-center justify-between">
                <span class="badge">Generator</span>
                <span class="chip">LinkedIn • X • Email</span>
              </div>
              <div class="rounded-lg border border-white/10 bg-white/60 dark:bg-white/5 p-4">
                <div class="h-28 rounded bg-white/70 dark:bg-white/10"></div>
              </div>
              <div class="flex gap-2">
                <div class="h-10 flex-1 rounded bg-white/70 dark:bg-white/10"></div>
                <div class="h-10 w-24 rounded bg-black/80 text-white grid place-items-center text-xs">Generate</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Quota / Plan banner (dynamic) -->
      <div id="quotaBanner" class="mt-8 hidden">
        <div class="card p-4 md:p-5 flex flex-wrap items-center justify-between gap-3">
          <div class="text-sm md:text-base" id="quotaText">
            <!-- Filled by JS with: demo runs left, daily cap, or monthly cap -->
          </div>
          <div class="flex items-center gap-2">
            <a href="#pricing" class="btn">See plans</a>
            <button id="manageBilling2" class="btn only-authed hidden">Manage billing</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Live Demo header -->
  <section id="demo" class="pt-4 md:pt-8">
    <div class="max-w-7xl mx-auto px-4 md:px-5">
      <div class="flex flex-wrap items-center justify-between gap-3">
        <div class="flex items-center gap-3">
          <h2 class="text-xl md:text-2xl font-semibold">Live Demo</h2>
          <span id="planPill" class="badge">Plan: Free</span>
          <span id="orgPill" class="badge hidden">Team</span>
        </div>
        <div class="flex flex-wrap items-center gap-2 text-sm">
          <span class="chip">No data leaves without you clicking “Generate”</span>
          <span class="chip">OpenRouter pool + BYOK</span>
        </div>
      </div>
    </div>
  </section>

  <!-- Auth dialog -->
  <dialog id="auth" class="w-[92vw] max-w-md rounded-2xl p-0 border border-white/20 backdrop:bg-black/40">
    <form method="dialog" class="p-0 m-0">
      <div class="p-5 border-b border-white/10">
        <div class="flex items-center justify-between">
          <h3 class="text-lg font-semibold">Sign in</h3>
          <button class="px-3 py-1 rounded-lg border">Close</button>
        </div>
      </div>
      <div class="p-5 grid gap-3">
        <label class="text-sm">Email</label>
        <input id="authEmail" type="email" placeholder="you@company.com"
               class="w-full px-3 py-2 rounded-lg border bg-transparent" required />
        <button id="authSend" type="button" class="btn btn-primary w-full">Send magic link</button>
        <div class="relative my-2 text-center text-xs text-slate-500">
          <span>or</span>
        </div>
        <button id="authGoogle" type="button" class="btn w-full">Continue with Google</button>
        <p id="authNote" class="text-xs text-slate-500"></p>
        <p class="text-[11px] text-slate-500">
          By continuing you agree to our <a href="/terms" class="underline">Terms</a> and <a href="/privacy" class="underline">Privacy</a>.
        </p>
      </div>
    </form>
  </dialog>

  <!-- Toast container -->
  <div id="toast" aria-live="polite" class="hidden"></div>

  <!-- Section tabs header (the views appear in later parts) -->
  <section class="mt-6">
    <div class="max-w-7xl mx-auto px-4 md:px-5">
      <div class="card p-2 md:p-3">
        <div class="flex flex-wrap gap-2">
          <button data-tab="generator" class="tabBtn btn btn-primary">Generator</button>
          <button data-tab="scheduler" class="tabBtn btn plan-starter-plus">Scheduler</button>
          <button data-tab="analytics" class="tabBtn btn plan-creator-plus">Analytics Pro</button>
          <button data-tab="presets"   class="tabBtn btn only-authed">Saved Presets</button>
          <button data-tab="integrations" class="tabBtn btn only-authed">Integrations</button>
        </div>
      </div>
    </div>
  </section>
  <!-- ===================== VIEW: GENERATOR ===================== -->
  <section id="view-generator" class="mt-4">
    <div class="max-w-7xl mx-auto px-4 md:px-5 grid lg:grid-cols-12 gap-6">

      <!-- ========== LEFT: INPUTS ========== -->
      <div class="lg:col-span-7 grid gap-4">

        <!-- Source / Idea -->
        <div class="card p-4 md:p-5">
          <div class="flex items-center justify-between gap-3">
            <h3 class="text-lg font-semibold">Source / Idea</h3>
            <div class="flex items-center gap-2">
              <button id="btnClear" class="btn">Clear</button>
            </div>
          </div>
          <textarea id="genInput" rows="8" class="mt-3 w-full rounded-lg border bg-transparent p-3"
            placeholder="Paste a draft, transcript, link summary, or raw idea."></textarea>

          <!-- Channels -->
          <div class="mt-4 grid sm:grid-cols-2 lg:grid-cols-3 gap-2">
            <label class="flex items-center gap-2"><input id="ch_linkedin" type="checkbox" checked> LinkedIn post</label>
            <label class="flex items-center gap-2"><input id="ch_x" type="checkbox" checked> X (Twitter) thread</label>
            <label class="flex items-center gap-2"><input id="ch_email" type="checkbox"> Email draft</label>
            <label class="flex items-center gap-2"><input id="ch_reddit" type="checkbox"> Reddit answer</label>
            <label class="flex items-center gap-2"><input id="ch_quora" type="checkbox"> Quora answer</label>
            <label class="flex items-center gap-2"><input id="ch_ig" type="checkbox"> Instagram caption</label>
          </div>

          <!-- LinkedIn Article toggle -->
          <div class="mt-3">
            <label class="flex items-center gap-2">
              <input id="toggleArticle" type="checkbox">
              Also generate a <span class="font-medium">LinkedIn Article</span>
            </label>
          </div>

          <!-- Style row -->
          <div class="mt-4 grid md:grid-cols-3 gap-3">
            <div>
              <label class="text-sm">Tone</label>
              <select id="tone" class="w-full rounded-lg border bg-transparent p-2 mt-1">
                <option value="professional" selected>Professional</option>
                <option value="friendly">Friendly</option>
                <option value="bold">Bold</option>
                <option value="technical">Technical</option>
                <option value="story">Story-driven</option>
              </select>
            </div>
            <div>
              <label class="text-sm">Audience</label>
              <input id="audience" class="w-full rounded-lg border bg-transparent p-2 mt-1"
                     placeholder="e.g., SaaS founders, HR leaders">
            </div>
            <div>
              <label class="text-sm">Lane</label>
              <select id="lane" class="w-full rounded-lg border bg-transparent p-2 mt-1">
                <option value="free" selected>Auto (Platform pool)</option>
                <option value="pro" class="only-authed">Pro (paid quota)</option>
                <option value="byok" class="only-authed">BYOK (your OpenRouter key)</option>
              </select>
            </div>
          </div>

          <!-- Article Optimizer -->
          <details id="optPanel" class="mt-4">
            <summary class="cursor-pointer font-semibold">Article Optimizer (up to 15/day on Creator+)</summary>
            <div class="mt-3 grid sm:grid-cols-2 gap-3">
              <label class="flex items-center gap-2"><input id="optHumanize" type="checkbox" checked> Humanize content</label>
              <label class="flex items-center gap-2"><input id="optLengthen" type="checkbox"> Lengthen content</label>
              <label class="flex items-center gap-2"><input id="optFaq" type="checkbox"> Add FAQs (+ JSON-LD)</label>
              <label class="flex items-center gap-2"><input id="optHeadings" type="checkbox" checked> Auto-headings (H2/H3)</label>
              <label class="flex items-center gap-2"><input id="optSvg" type="checkbox"> Platform-fit SVG image ideas</label>
              <label class="flex items-center gap-2"><input id="optSeo" type="checkbox" checked> Check SEO basics (title/meta/alt-text)</label>
            </div>
            <div class="mt-3 grid md:grid-cols-2 gap-3">
              <textarea id="optInput" rows="5" class="w-full rounded-lg border bg-transparent p-3"
                placeholder="(Optional) Paste an article here to optimize…"></textarea>
              <div class="flex flex-col gap-2">
                <button id="btnOptimize" class="btn plan-creator-plus">Run Optimizer</button>
                <small class="text-slate-500">Counts toward Article Optimizer quota (Creator+). Outputs appear in Results.</small>
              </div>
            </div>
          </details>

          <!-- Batch input (Creator+ & Business) -->
          <details id="batchWrap" class="mt-4 plan-creator-plus">
            <summary class="cursor-pointer font-semibold">Batch input (CSV / one topic per line)</summary>
            <div class="mt-3 grid md:grid-cols-2 gap-3">
              <textarea id="batchInput" rows="6" class="w-full rounded-lg border bg-transparent p-3"
                placeholder="Line 1: …&#10;Line 2: …&#10;Line 3: …"></textarea>
              <div class="flex flex-col gap-2">
                <label class="text-sm">Batch mode</label>
                <select id="batchMode" class="rounded-lg border bg-transparent p-2">
                  <option value="multi-channel" selected>Multi-channel (per line)</option>
                  <option value="article-only">LinkedIn Article only</option>
                  <option value="optimizer-only">Optimizer only</option>
                </select>
                <button id="btnRunBatch" class="btn plan-creator-plus">Run batch</button>
                <small class="text-slate-500">We’ll queue and stream results into the grid on the right.</small>
              </div>
            </div>
          </details>

          <!-- Generate bar -->
          <div class="mt-4 flex flex-wrap items-center gap-2">
            <button id="btnGenerate" class="btn btn-primary">Generate</button>
            <button id="btnAddFromLast" class="btn" title="Insert last output back into the input">Add from last output</button>
            <span id="genStatus" class="text-sm text-slate-500"></span>
          </div>
        </div>

        <!-- Quick Publish (inline) -->
        <div class="card p-4 md:p-5">
          <div class="flex items-center justify-between">
            <h3 class="text-lg font-semibold">Quick publish</h3>
            <div class="text-sm text-slate-500">Use last output or paste below</div>
          </div>
          <div class="grid md:grid-cols-4 gap-3 mt-3">
            <div class="md:col-span-1">
              <label class="text-sm">Channel</label>
              <select id="qpChannel" class="w-full rounded-lg border bg-transparent p-2 mt-1">
                <option value="linkedin">LinkedIn</option>
                <option value="x">X</option>
                <option value="reddit">Reddit</option>
                <option value="quora">Quora</option>
                <option value="email">Email</option>
              </select>
            </div>
            <div class="md:col-span-1 plan-creator-plus">
              <label class="text-sm">Profile</label>
              <select id="qpProfile" class="w-full rounded-lg border bg-transparent p-2 mt-1">
                <option value="default">Default</option>
                <!-- Multi-profile injected by JS for Creator+ -->
              </select>
            </div>
            <div class="md:col-span-2">
              <label class="text-sm">When</label>
              <input id="qpWhen" type="datetime-local" class="w-full rounded-lg border bg-transparent p-2 mt-1">
            </div>
          </div>
          <div class="mt-3">
            <label class="text-sm">Text</label>
            <textarea id="qpText" rows="4" class="w-full rounded-lg border bg-transparent p-3"
                      placeholder="Paste content (or generate first and use ‘Add from last output’)"></textarea>
          </div>
          <div class="mt-3 flex flex-wrap gap-2">
            <button id="qpAddFromLast" class="btn">Add from last output</button>
            <button id="qpQueue" class="btn plan-starter-plus">Add to queue</button>
            <button id="qpPublish" class="btn btn-primary plan-starter-plus">Publish selected</button>
            <button id="qpLocalPreview" class="btn">Local preview</button>
          </div>
        </div>
      </div>

      <!-- ========== RIGHT: RESULTS ========== -->
      <div class="lg:col-span-5 grid gap-4">
        <!-- Results / Templates grid -->
        <div class="card p-4 md:p-5">
          <div class="flex items-center justify-between gap-3">
            <h3 class="text-lg font-semibold">Results</h3>
            <div class="flex items-center gap-2">
              <button id="btnCopyAll" class="btn">Copy all</button>
              <button id="btnSavePreset" class="btn only-authed">Save as preset</button>
            </div>
          </div>

          <!-- Results grid (filled by JS) -->
          <div id="outGrid" class="mt-3 grid gap-3">
            <!-- Template for a result card; JS will clone and fill -->
            <template id="tplResultCard">
              <article class="result card p-3 md:p-4" data-channel="">
                <div class="flex items-start justify-between gap-3">
                  <div class="flex items-center gap-2">
                    <span class="badge ch"></span>
                    <span class="badge variant hidden"></span>
                  </div>
                  <div class="flex flex-wrap gap-2">
                    <button class="btn btn-xs act-copy" title="Copy">Copy</button>
                    <button class="btn btn-xs act-submit" title="Open submit">Submit</button>
                    <button class="btn btn-xs act-schedule plan-starter-plus" title="Schedule">Scheduler</button>
                    <button class="btn btn-xs act-notion only-authed" title="Export to Notion">Export Notion</button>
                    <button class="btn btn-xs act-trello only-authed" title="Export to Trello">Export Trello</button>
                    <button class="btn btn-xs act-preview" title="Local preview">Preview</button>
                  </div>
                </div>
                <h4 class="mt-2 font-semibold title"></h4>
                <div class="mt-2 prose-sm whitespace-pre-wrap body"></div>
              </article>
            </template>

            <!-- Placeholder empty state -->
            <div id="outEmpty" class="text-sm text-slate-500">
              Generate to see templates here. Each card includes <em>Submit</em> and <em>Export</em> actions
              (Reddit/Quora/LinkedIn Article/X/Email + Notion/Trello).
            </div>
          </div>
        </div>

        <!-- Queue (read-only preview here; full controls in Scheduler tab) -->
        <div class="card p-4 md:p-5 plan-starter-plus">
          <div class="flex items-center justify-between">
            <h3 class="text-lg font-semibold">Queue</h3>
            <a href="#scheduler" class="btn">Open Scheduler</a>
          </div>
          <div id="queueList" class="mt-3 text-sm text-slate-500">
            Nothing scheduled yet.
          </div>
        </div>

        <!-- Per-channel notes -->
        <div class="text-xs text-slate-500">
          Submitting opens the official composer for each platform with your text prefilled when possible.<br>
          Export uses your connected Notion/Trello workspaces (see Integrations tab).
        </div>
      </div>
    </div>
  </section>
  <!-- =================== /VIEW: GENERATOR =================== -->
  <!-- ===================== VIEW: SCHEDULER ===================== -->
  <section id="view-scheduler" class="mt-4 hidden">
    <div class="max-w-7xl mx-auto px-4 md:px-5 grid lg:grid-cols-12 gap-6">

      <!-- ========== LEFT: PROFILES & CRON HELPERS ========== -->
      <div class="lg:col-span-5 grid gap-4">

        <!-- Multi-profile (Creator+) -->
        <div class="card p-4 md:p-5">
          <div class="flex items-center justify-between gap-2">
            <h3 class="text-lg font-semibold">Profiles <span class="badge ml-2 plan-creator-plus">Multi-profile</span></h3>
            <div class="flex items-center gap-2">
              <select id="profileTZ" class="rounded-lg border bg-transparent p-2 text-sm plan-creator-plus">
                <option value="local" selected>Local timezone</option>
                <option value="UTC">UTC</option>
              </select>
              <button id="btnAddProfile" class="btn plan-creator-plus">Add profile</button>
            </div>
          </div>
          <p class="text-sm text-slate-500 mt-1">Default profile is available to all plans. Multi-profile requires Creator+.</p>

          <!-- Profiles list -->
          <div id="profilesList" class="mt-3 grid gap-2">
            <!-- Filled by JS. Example item template below -->
            <template id="tplProfileItem">
              <div class="flex items-start justify-between gap-3 rounded-lg border p-3">
                <div class="min-w-0">
                  <div class="flex items-center gap-2">
                    <span class="font-medium name truncate"></span>
                    <span class="badge ch"></span>
                  </div>
                  <div class="text-xs text-slate-500 mt-1">
                    <span class="handle"></span>
                    <span class="sep hidden">•</span>
                    <span class="slots"></span>
                  </div>
                </div>
                <div class="flex flex-wrap gap-2">
                  <button class="btn btn-xs act-edit">Edit</button>
                  <button class="btn btn-xs act-dup">Duplicate</button>
                  <button class="btn btn-xs act-del">Delete</button>
                </div>
              </div>
            </template>
          </div>
        </div>

        <!-- Cron Helpers (Starter+) -->
        <div class="card p-4 md:p-5 plan-starter-plus">
          <h3 class="text-lg font-semibold">Auto-distribute</h3>
          <p class="text-sm text-slate-500">Create a posting cadence; we’ll schedule selected items to the next open slots.</p>

          <div class="grid gap-3 mt-3">
            <!-- Days -->
            <div>
              <label class="text-sm">Days</label>
              <div id="cronDays" class="mt-1 flex flex-wrap gap-2">
                <label class="flex items-center gap-2"><input type="checkbox" value="1" checked> Mon</label>
                <label class="flex items-center gap-2"><input type="checkbox" value="2" checked> Tue</label>
                <label class="flex items-center gap-2"><input type="checkbox" value="3" checked> Wed</label>
                <label class="flex items-center gap-2"><input type="checkbox" value="4" checked> Thu</label>
                <label class="flex items-center gap-2"><input type="checkbox" value="5" checked> Fri</label>
                <label class="flex items-center gap-2"><input type="checkbox" value="6"> Sat</label>
                <label class="flex items-center gap-2"><input type="checkbox" value="0"> Sun</label>
              </div>
            </div>

            <!-- Times -->
            <div>
              <label class="text-sm">Times (local)</label>
              <div class="flex flex-wrap items-center gap-2 mt-1" id="cronTimes">
                <input type="time" value="09:00" class="rounded-lg border bg-transparent p-2 time">
                <input type="time" value="13:00" class="rounded-lg border bg-transparent p-2 time">
                <input type="time" value="17:00" class="rounded-lg border bg-transparent p-2 time">
                <button id="btnAddCronTime" class="btn btn-xs">+ time</button>
              </div>
            </div>

            <!-- Channels -->
            <div>
              <label class="text-sm">Channels</label>
              <div id="cronChannels" class="mt-1 flex flex-wrap gap-2">
                <label class="flex items-center gap-2"><input type="checkbox" value="linkedin" checked> LinkedIn</label>
                <label class="flex items-center gap-2"><input type="checkbox" value="x" checked> X</label>
                <label class="flex items-center gap-2"><input type="checkbox" value="reddit"> Reddit</label>
                <label class="flex items-center gap-2"><input type="checkbox" value="quora"> Quora</label>
                <label class="flex items-center gap-2"><input type="checkbox" value="email"> Email</label>
              </div>
            </div>

            <!-- Apply -->
            <div class="flex flex-wrap gap-2">
              <button id="btnAutoDistribute" class="btn btn-primary">Auto-schedule selected queue</button>
              <button id="btnClearSchedule" class="btn">Clear times</button>
            </div>
          </div>
        </div>

        <!-- Note -->
        <div class="text-xs text-slate-500">
          Scheduling places items in your queue. Publishing opens each platform’s composer with your content pre-filled when possible.
        </div>
      </div>

      <!-- ========== RIGHT: QUEUE TABLE ========== -->
      <div class="lg:col-span-7 grid gap-4">
        <div class="card p-4 md:p-5">
          <div class="flex items-center justify-between gap-3">
            <h3 class="text-lg font-semibold">Queue</h3>
            <div class="flex items-center gap-2">
              <button id="btnBulkExportPack" class="btn plan-starter-plus" title="Export all selected to a Project Pack (Part 6)">Export pack</button>
              <button id="btnBulkPublish" class="btn btn-primary plan-starter-plus">Publish selected</button>
              <button id="btnBulkDelete" class="btn">Delete selected</button>
            </div>
          </div>

          <!-- Filters -->
          <div class="mt-3 grid md:grid-cols-4 gap-2">
            <input id="queueSearch" class="rounded-lg border bg-transparent p-2" placeholder="Search…">
            <select id="queueFilterChannel" class="rounded-lg border bg-transparent p-2">
              <option value="">All channels</option>
              <option value="linkedin">LinkedIn</option>
              <option value="x">X</option>
              <option value="reddit">Reddit</option>
              <option value="quora">Quora</option>
              <option value="email">Email</option>
            </select>
            <select id="queueFilterProfile" class="rounded-lg border bg-transparent p-2">
              <option value="">All profiles</option>
            </select>
            <select id="queueFilterState" class="rounded-lg border bg-transparent p-2">
              <option value="">Any state</option>
              <option value="scheduled">Scheduled</option>
              <option value="due">Due now</option>
              <option value="sent">Sent</option>
              <option value="draft">Draft</option>
            </select>
          </div>

          <!-- Table -->
          <div class="mt-3 overflow-x-auto">
            <table class="w-full text-sm" id="queueTable">
              <thead class="text-left text-slate-400">
                <tr>
                  <th class="py-2"><input id="bulkSelectAll" type="checkbox"></th>
                  <th class="py-2">When</th>
                  <th class="py-2">Channel</th>
                  <th class="py-2">Profile</th>
                  <th class="py-2">Preview</th>
                  <th class="py-2">Status</th>
                  <th class="py-2 text-right">Actions</th>
                </tr>
              </thead>
              <tbody id="queueBody">
                <!-- rows injected -->
              </tbody>
            </table>
            <div id="queueEmpty" class="text-sm text-slate-500 mt-3">Nothing scheduled yet.</div>

            <!-- Row template -->
            <template id="tplQueueRow">
              <tr class="border-t border-white/5">
                <td class="py-2 align-top">
                  <input class="sel" type="checkbox">
                </td>
                <td class="py-2 align-top min-w-[160px]">
                  <input type="datetime-local" class="rounded-lg border bg-transparent p-1 when w-[180px]">
                </td>
                <td class="py-2 align-top">
                  <span class="badge ch"></span>
                </td>
                <td class="py-2 align-top">
                  <div class="text-xs text-slate-300 profile">Default</div>
                </td>
                <td class="py-2 align-top max-w-[360px]">
                  <div class="line-clamp-3 text-slate-200 preview"></div>
                </td>
                <td class="py-2 align-top">
                  <span class="badge state">draft</span>
                </td>
                <td class="py-2 align-top">
                  <div class="flex justify-end gap-2">
                    <button class="btn btn-xs act-preview">Preview</button>
                    <button class="btn btn-xs act-edit">Edit</button>
                    <button class="btn btn-xs act-submit">Submit</button>
                    <button class="btn btn-xs act-publish plan-starter-plus">Publish</button>
                    <button class="btn btn-xs act-del">Delete</button>
                  </div>
                </td>
              </tr>
            </template>
          </div>
        </div>

        <!-- Inline composer to add to queue -->
        <div class="card p-4 md:p-5">
          <h3 class="text-lg font-semibold">Add to queue</h3>
          <div class="grid md:grid-cols-4 gap-3 mt-3">
            <div>
              <label class="text-sm">Channel</label>
              <select id="schChannel" class="w-full rounded-lg border bg-transparent p-2 mt-1">
                <option value="linkedin">LinkedIn</option>
                <option value="x">X</option>
                <option value="reddit">Reddit</option>
                <option value="quora">Quora</option>
                <option value="email">Email</option>
              </select>
            </div>
            <div class="plan-creator-plus">
              <label class="text-sm">Profile</label>
              <select id="schProfile" class="w-full rounded-lg border bg-transparent p-2 mt-1">
                <option value="default" selected>Default</option>
              </select>
            </div>
            <div class="md:col-span-2">
              <label class="text-sm">When</label>
              <input id="schWhen" type="datetime-local" class="w-full rounded-lg border bg-transparent p-2 mt-1">
            </div>
          </div>
          <div class="mt-3">
            <label class="text-sm">Text</label>
            <textarea id="schText" rows="4" class="w-full rounded-lg border bg-transparent p-3"
              placeholder="Paste content or use ‘Add from last output’ in Generator."></textarea>
          </div>
          <div class="mt-3 flex flex-wrap gap-2">
            <button id="schAdd" class="btn btn-primary">Add</button>
            <button id="schFromLast" class="btn">Add from last output</button>
          </div>
        </div>
      </div>
    </div>
  </section>
  <!-- =================== /VIEW: SCHEDULER =================== -->

  <!-- =================== MODALS (profiles / queue edit) =================== -->
  <dialog id="modalProfile" class="modal">
    <form method="dialog" class="modal-box w-full max-w-2xl">
      <h3 class="font-semibold text-lg">Profile</h3>
      <div class="grid md:grid-cols-2 gap-3 mt-3">
        <div>
          <label class="text-sm">Name</label>
          <input id="pfName" class="w-full rounded-lg border bg-transparent p-2 mt-1" placeholder="e.g., Jane / Brand">
        </div>
        <div>
          <label class="text-sm">Primary channel</label>
          <select id="pfChannel" class="w-full rounded-lg border bg-transparent p-2 mt-1">
            <option value="linkedin">LinkedIn</option>
            <option value="x">X</option>
            <option value="reddit">Reddit</option>
            <option value="quora">Quora</option>
            <option value="email">Email</option>
          </select>
        </div>
        <div class="md:col-span-2">
          <label class="text-sm">Handle / URL</label>
          <input id="pfHandle" class="w-full rounded-lg border bg-transparent p-2 mt-1" placeholder="@yourhandle or profile URL">
        </div>
        <div class="md:col-span-2">
          <label class="text-sm">Default hashtags / footer</label>
          <input id="pfFooter" class="w-full rounded-lg border bg-transparent p-2 mt-1" placeholder="#saas #buildinpublic">
        </div>
      </div>

      <!-- Default slots -->
      <div class="mt-4">
        <label class="text-sm font-medium">Default posting slots</label>
        <div id="pfSlots" class="mt-2 flex flex-wrap items-center gap-2">
          <input type="time" value="09:00" class="rounded-lg border bg-transparent p-2 slot">
          <input type="time" value="13:00" class="rounded-lg border bg-transparent p-2 slot">
          <button id="pfAddSlot" type="button" class="btn btn-xs">+ slot</button>
        </div>
      </div>

      <div class="mt-5 flex justify-end gap-2">
        <button class="btn" value="cancel">Cancel</button>
        <button id="pfSave" class="btn btn-primary" value="default">Save</button>
      </div>
    </form>
  </dialog>

  <dialog id="modalQueueEdit" class="modal">
    <form method="dialog" class="modal-box w-full max-w-3xl">
      <h3 class="font-semibold text-lg">Edit queued post</h3>
      <div class="grid md:grid-cols-3 gap-3 mt-3">
        <div>
          <label class="text-sm">Channel</label>
          <select id="qeChannel" class="w-full rounded-lg border bg-transparent p-2 mt-1">
            <option value="linkedin">LinkedIn</option>
            <option value="x">X</option>
            <option value="reddit">Reddit</option>
            <option value="quora">Quora</option>
            <option value="email">Email</option>
          </select>
        </div>
        <div>
          <label class="text-sm">Profile</label>
          <select id="qeProfile" class="w-full rounded-lg border bg-transparent p-2 mt-1">
            <option value="default">Default</option>
          </select>
        </div>
        <div>
          <label class="text-sm">When</label>
          <input id="qeWhen" type="datetime-local" class="w-full rounded-lg border bg-transparent p-2 mt-1">
        </div>
      </div>
      <div class="mt-3">
        <label class="text-sm">Text</label>
        <textarea id="qeText" rows="8" class="w-full rounded-lg border bg-transparent p-3"></textarea>
      </div>
      <div class="mt-5 flex justify-between items-center">
        <div class="text-xs text-slate-500" id="qeHint">Use “Submit” to open the platform composer.</div>
        <div class="flex gap-2">
          <button class="btn" value="cancel">Cancel</button>
          <button id="qeSubmit" class="btn">Submit</button>
          <button id="qePublish" class="btn btn-primary plan-starter-plus">Publish</button>
        </div>
      </div>
    </form>
  </dialog>
  <!-- =================== /MODALS =================== -->
  <!-- ===================== VIEW: INTEGRATIONS & PRESETS ===================== -->
  <section id="view-integrations" class="mt-4 hidden">
    <div class="max-w-7xl mx-auto px-4 md:px-5 grid lg:grid-cols-12 gap-6">

      <!-- ================= LEFT: INTEGRATIONS ================= -->
      <div class="lg:col-span-7 grid gap-4">

        <!-- Notion -->
        <div class="card p-4 md:p-5">
          <div class="flex items-center justify-between gap-2">
            <h3 class="text-lg font-semibold">Notion</h3>
            <div class="flex items-center gap-2">
              <span id="notionStatus" class="badge">Disconnected</span>
              <button id="btnNotionConnect" class="btn">Connect</button>
              <button id="btnNotionDisconnect" class="btn hidden">Disconnect</button>
            </div>
          </div>
          <p class="text-sm text-slate-500 mt-1">
            Export outlines, drafts, and project packs into your Notion workspace.
          </p>

          <div class="grid md:grid-cols-2 gap-3 mt-4">
            <div>
              <label class="text-sm">Parent Page ID (optional)</label>
              <input id="notionParent" class="w-full rounded-lg border bg-transparent p-2 mt-1" placeholder="Notion Page ID (leave empty for workspace)">
            </div>
            <div>
              <label class="text-sm">Title</label>
              <input id="notionTitle" class="w-full rounded-lg border bg-transparent p-2 mt-1" placeholder="ContentRepurpose Export">
            </div>
          </div>

          <div class="mt-3">
            <label class="text-sm">Blocks to export</label>
            <div class="grid gap-2 mt-2">
              <label class="flex items-center gap-2">
                <input id="notionFromLast" type="checkbox" checked>
                Use last generated output (recommended)
              </label>
              <textarea id="notionBlocks" rows="6" class="w-full rounded-lg border bg-transparent p-3"
                placeholder="Each line becomes a Notion paragraph block. Use the 'H2: ' prefix on a line to turn it into a heading."></textarea>
              <div class="text-xs text-slate-500">
                Tip: If “Use last generated output” is checked, we’ll export your most recent content (Generator/Optimizer). You can still add custom lines here.
              </div>
            </div>
          </div>

          <div class="mt-3 flex flex-wrap gap-2">
            <button id="btnNotionExport" class="btn btn-primary">Export to Notion</button>
            <a id="linkNotionOpen" class="hidden underline text-sm" target="_blank" rel="noopener">Open created page</a>
          </div>
        </div>

        <!-- Trello -->
        <div class="card p-4 md:p-5">
          <div class="flex items-center justify-between gap-2">
            <h3 class="text-lg font-semibold">Trello</h3>
            <div class="flex items-center gap-2">
              <span id="trelloStatus" class="badge">Disconnected</span>
              <button id="btnTrelloConnect" class="btn">Connect</button>
            </div>
          </div>
          <p class="text-sm text-slate-500 mt-1">
            Export posts as Trello cards (e.g., to your Editorial board). We’ll store your Trello token in your account.
          </p>

          <div class="grid md:grid-cols-3 gap-3 mt-4">
            <div>
              <label class="text-sm">Board ID</label>
              <input id="trelloBoard" class="w-full rounded-lg border bg-transparent p-2 mt-1" placeholder="ex: 5f...">
            </div>
            <div>
              <label class="text-sm">List ID</label>
              <input id="trelloList" class="w-full rounded-lg border bg-transparent p-2 mt-1" placeholder="ex: 6a...">
            </div>
            <div>
              <label class="text-sm">Card title</label>
              <input id="trelloTitle" class="w-full rounded-lg border bg-transparent p-2 mt-1" placeholder="ContentRepurpose Draft">
            </div>
          </div>

          <div class="mt-3">
            <label class="text-sm">Card description</label>
            <textarea id="trelloDesc" rows="6" class="w-full rounded-lg border bg-transparent p-3"
              placeholder="We’ll prefill from your last output if left empty."></textarea>
          </div>

          <div class="mt-3 flex flex-wrap gap-2">
            <button id="btnTrelloExport" class="btn btn-primary">Create Trello card</button>
            <a id="linkTrelloCard" class="hidden underline text-sm" target="_blank" rel="noopener">Open card</a>
          </div>
        </div>

      </div>
      <!-- =============== /LEFT ================= -->

      <!-- =============== RIGHT: PRESETS & BYOK =============== -->
      <div class="lg:col-span-5 grid gap-4">

        <!-- Saved Presets -->
        <div class="card p-4 md:p-5">
          <div class="flex items-center justify-between gap-2">
            <h3 class="text-lg font-semibold">Saved Presets</h3>
            <div class="flex items-center gap-2">
              <button id="btnPresetSaveCurrent" class="btn">Save current settings</button>
            </div>
          </div>
          <p class="text-sm text-slate-500 mt-1">One-click recall of your Generator/Optimizer controls.</p>

          <div class="mt-3">
            <input id="presetTitle" class="w-full rounded-lg border bg-transparent p-2" placeholder="Preset title (e.g., LinkedIn Thought Leadership)">
          </div>

          <div id="presetsList" class="mt-4 grid gap-2">
            <!-- Rendered via JS -->
          </div>

          <!-- Preset Item Template -->
          <template id="tplPresetItem">
            <div class="flex items-center justify-between gap-3 rounded-lg border p-3">
              <div class="min-w-0">
                <div class="font-medium name truncate"></div>
                <div class="text-xs text-slate-500 mt-1 created"></div>
              </div>
              <div class="flex flex-wrap gap-2">
                <button class="btn btn-xs act-apply">Apply</button>
                <button class="btn btn-xs act-delete">Delete</button>
              </div>
            </div>
          </template>
        </div>

        <!-- BYOK (Bring Your Own OpenRouter key) -->
        <div class="card p-4 md:p-5">
          <div class="flex items-center justify-between gap-2">
            <h3 class="text-lg font-semibold">BYOK (OpenRouter)</h3>
            <span id="byokStatus" class="badge">Not saved</span>
          </div>
          <p class="text-sm text-slate-500 mt-1">
            Use your own OpenRouter API key for Pro models and higher limits. We never send your key to our servers except to store it in your account record for server-side calls.
          </p>

          <div class="grid gap-3 mt-3">
            <div class="grid md:grid-cols-2 gap-3">
              <div>
                <label class="text-sm">API Key</label>
                <input id="byokKey" class="w-full rounded-lg border bg-transparent p-2 mt-1" placeholder="sk-or-v1-...">
              </div>
              <div>
                <label class="text-sm">Preferred Model</label>
                <input id="byokModel" class="w-full rounded-lg border bg-transparent p-2 mt-1" placeholder="e.g., openai/gpt-4o, meta-llama/llama-3.3-70b-instruct">
              </div>
            </div>
            <div class="grid md:grid-cols-2 gap-3">
              <div>
                <label class="text-sm">Provider (optional)</label>
                <input id="byokProvider" class="w-full rounded-lg border bg-transparent p-2 mt-1" placeholder="openrouter">
              </div>
              <div>
                <label class="text-sm">API Base (optional)</label>
                <input id="byokBase" class="w-full rounded-lg border bg-transparent p-2 mt-1" placeholder="https://openrouter.ai/api/v1">
              </div>
            </div>

            <div class="flex flex-wrap gap-2">
              <button id="btnByokSave" class="btn btn-primary">Save</button>
              <button id="btnByokTest" class="btn">Test</button>
              <button id="btnByokDelete" class="btn">Remove</button>
            </div>

            <div id="byokHint" class="text-xs text-slate-500">
              Starter: 50 BYOK/mo (+daily bonus). Creator: 150 BYOK/mo. Business: 300 BYOK/mo.
            </div>
          </div>
        </div>

        <!-- Quick help -->
        <div class="text-xs text-slate-500">
          After connecting Notion/Trello, you’ll also see <em>Submit</em> / <em>Export</em> actions next to generated templates and in the Queue.
        </div>

      </div>
      <!-- =============== /RIGHT ================= -->
    </div>
  </section>
  <!-- =================== /VIEW: INTEGRATIONS & PRESETS =================== -->

  <!-- =================== MODALS: INTEGRATIONS (optional future use) =================== -->
  <dialog id="modalPresetConfirm" class="modal">
    <form method="dialog" class="modal-box w-full max-w-md">
      <h3 class="font-semibold text-lg">Save current settings?</h3>
      <p class="text-sm text-slate-400 mt-2">This will snapshot your current Generator and Optimizer controls.</p>
      <div class="mt-4 flex justify-end gap-2">
        <button class="btn" value="cancel">Cancel</button>
        <button id="presetConfirmSave" class="btn btn-primary" value="default">Save</button>
      </div>
    </form>
  </dialog>
  <!-- =================== /MODALS =================== -->
  <!-- ===================== VIEW: PROJECT PACK & ANALYTICS ===================== -->
  <section id="view-projectpack" class="mt-4 hidden">
    <div class="max-w-7xl mx-auto px-4 md:px-5 grid lg:grid-cols-12 gap-6">

      <!-- =============== LEFT: PROJECT PACK EXPORT =============== -->
      <div class="lg:col-span-7 grid gap-4">

        <div class="card p-4 md:p-5">
          <div class="flex items-center justify-between gap-2">
            <h3 class="text-lg font-semibold">Project Pack Export</h3>
            <span class="badge">Creator+</span>
          </div>
          <p class="text-sm text-slate-500 mt-1">
            Bundle your strategy outline, multi-channel posts, FAQs, and SEO meta into one export. Works with your last generated output or custom input.
          </p>

          <div class="mt-3 grid md:grid-cols-2 gap-3">
            <label class="flex items-center gap-2">
              <input id="packUseLast" type="checkbox" checked>
              Use last generated output
            </label>
            <label class="flex items-center gap-2">
              <input id="packSplitCards" type="checkbox" checked>
              For Trello: split into multiple cards
            </label>
          </div>

          <div class="mt-3">
            <label class="text-sm">Custom content (optional)</label>
            <textarea id="packInput" rows="10" class="w-full rounded-lg border bg-transparent p-3"
              placeholder="Paste any additional items. Use '---' to separate sections. Lines starting with 'H2:' become headings in Notion."></textarea>
          </div>

          <div class="mt-3 grid md:grid-cols-2 gap-3">
            <div>
              <label class="text-sm">Pack title</label>
              <input id="packTitle" class="w-full rounded-lg border bg-transparent p-2 mt-1" placeholder="Launch Project Pack">
            </div>
            <div>
              <label class="text-sm">For Notion: Parent Page ID (optional)</label>
              <input id="packNotionParent" class="w-full rounded-lg border bg-transparent p-2 mt-1" placeholder="Notion Page ID">
            </div>
          </div>

          <div class="mt-3 flex flex-wrap gap-2">
            <button id="btnPackExportNotion" class="btn btn-primary">Export Pack → Notion</button>
            <button id="btnPackExportTrello" class="btn">Export Pack → Trello</button>
            <a id="linkPackResult" class="hidden underline text-sm" target="_blank" rel="noopener">Open export</a>
          </div>

          <div id="packStatus" class="text-xs text-slate-500 mt-2"></div>
        </div>

        <!-- LinkedIn Article generator -->
        <div class="card p-4 md:p-5">
          <div class="flex items-center justify-between gap-2">
            <h3 class="text-lg font-semibold">LinkedIn Article</h3>
            <span class="badge">All plans</span>
          </div>
          <p class="text-sm text-slate-500 mt-1">
            Create a polished LinkedIn Article from your draft—optimized with headings, pull-quotes, and CTA.
          </p>

          <div class="mt-3 grid md:grid-cols-2 gap-3">
            <label class="flex items-center gap-2">
              <input id="liUseLast" type="checkbox" checked>
              Use last generated output
            </label>
            <label class="flex items-center gap-2">
              <input id="liSEO" type="checkbox" checked>
              Include SEO title & excerpt
            </label>
          </div>

          <div class="mt-3">
            <label class="text-sm">Article source (optional)</label>
            <textarea id="liInput" rows="8" class="w-full rounded-lg border bg-transparent p-3"
              placeholder="Paste the longform draft or key bullets if not using last output."></textarea>
          </div>

          <div class="mt-3 flex flex-wrap gap-2">
            <button id="btnGenLinkedInArticle" class="btn btn-primary">Generate LinkedIn Article</button>
            <button id="btnOpenLinkedInArticle" class="btn">Copy & open LinkedIn Article editor</button>
          </div>

          <div class="mt-3">
            <label class="text-sm">Generated Article</label>
            <textarea id="liArticleOut" rows="14" class="w-full rounded-lg border bg-transparent p-3" placeholder="Your LinkedIn Article will appear here…" readonly></textarea>
          </div>
        </div>

        <!-- Article Optimizer (15/day) -->
        <div class="card p-4 md:p-5">
          <div class="flex items-center justify-between gap-2">
            <h3 class="text-lg font-semibold">Article Optimizer</h3>
            <span class="badge">Creator+ · 15/day</span>
          </div>
          <p class="text-sm text-slate-500 mt-1">
            Drop in any draft and choose tweaks. We’ll return a clean, platform-ready version.
          </p>

          <div class="grid md:grid-cols-3 gap-3 mt-3">
            <label class="flex items-center gap-2"><input id="optHumanize" type="checkbox" checked> Humanize</label>
            <label class="flex items-center gap-2"><input id="optLengthen" type="checkbox"> Lengthen</label>
            <label class="flex items-center gap-2"><input id="optFaqs" type="checkbox"> Add FAQs (+ JSON-LD)</label>
            <label class="flex items-center gap-2"><input id="optHeadings" type="checkbox" checked> Auto-headings (H2/H3)</label>
            <label class="flex items-center gap-2"><input id="optSVG" type="checkbox"> SVG image ideas</label>
            <label class="flex items-center gap-2"><input id="optSEO" type="checkbox" checked> SEO basics (title/meta/alt)</label>
          </div>

          <div class="mt-3">
            <label class="text-sm">Article to optimize</label>
            <textarea id="optInput" rows="12" class="w-full rounded-lg border bg-transparent p-3"
              placeholder="Paste the article you want optimized…"></textarea>
          </div>

          <div class="mt-3 flex items-center gap-3">
            <button id="btnRunOptimizer" class="btn btn-primary">Optimize</button>
            <div class="text-xs text-slate-500">Remaining today: <span id="optRemain">15</span></div>
          </div>

          <div class="mt-3">
            <label class="text-sm">Optimized result</label>
            <textarea id="optOut" rows="14" class="w-full rounded-lg border bg-transparent p-3" readonly></textarea>
          </div>
        </div>

      </div>
      <!-- =============== /LEFT =============== -->

      <!-- =============== RIGHT: ANALYTICS PRO (PER-CHANNEL) =============== -->
      <div class="lg:col-span-5 grid gap-4">
        <div class="card p-4 md:p-5">
          <div class="flex items-center justify-between gap-2">
            <h3 class="text-lg font-semibold">Analytics Pro</h3>
            <div class="flex items-center gap-2">
              <select id="anaRange" class="rounded-lg border bg-transparent p-2">
                <option value="7">Last 7 days</option>
                <option value="30" selected>Last 30 days</option>
                <option value="90">Last 90 days</option>
              </select>
              <span class="badge">Creator+</span>
            </div>
          </div>
          <p class="text-sm text-slate-500 mt-1">
            Counts are based on actions done via ContentRepurpose (generated, queued, and published). Per-channel breakdown.
          </p>

          <div id="anaGrid" class="grid sm:grid-cols-2 gap-3 mt-3">
            <!-- Cards populated via JS -->
          </div>

          <div class="mt-4">
            <canvas id="anaChart" height="180"></canvas>
          </div>

          <div class="text-xs text-slate-500 mt-2">
            Tip: Publishing from the Generator/Queue automatically logs analytics locally so you can compare channels.
          </div>
        </div>

        <div class="card p-4 md:p-5">
          <h3 class="text-lg font-semibold">Quick Submitters</h3>
          <p class="text-sm text-slate-500 mt-1">
            These also appear beside each generated template.
          </p>
          <div class="mt-3 grid sm:grid-cols-2 gap-2">
            <button data-submit="x" class="btn">Submit to X (copy & open)</button>
            <button data-submit="reddit" class="btn">Submit to Reddit (open)</button>
            <button data-submit="linkedin" class="btn">Submit to LinkedIn (copy & open)</button>
            <button data-submit="linkedin-article" class="btn">Submit LinkedIn Article</button>
            <button data-submit="quora" class="btn">Submit to Quora (copy & open)</button>
            <button data-submit="email" class="btn">Draft email (copy)</button>
          </div>
        </div>
      </div>
      <!-- =============== /RIGHT =============== -->
    </div>
  </section>
  <!-- ===================== /VIEW: PROJECT PACK & ANALYTICS ===================== -->

  <!-- ===================== TEMPLATE ACTIONS INJECTION (Submit / Export) ===================== -->
  <template id="tplTemplateActions">
    <div class="mt-3 flex flex-wrap gap-2">
      <button class="btn btn-xs act-submit" data-kind="platform">Submit</button>
      <button class="btn btn-xs act-export-notion">Export → Notion</button>
      <button class="btn btn-xs act-export-trello">Export → Trello</button>
    </div>
  </template>

  <script>
  (function(){
    // ---------------------- Small helpers ----------------------
    const $ = (sel, el=document) => el.querySelector(sel);
    const $$ = (sel, el=document) => Array.from(el.querySelectorAll(sel));
    const App = window.App = window.App || {};
    App.plan = App.plan || "free";
    App.userId = App.userId || null;
    App.lastOutput = App.lastOutput || "";         // set by Generator
    App.activity = App.activity || [];             // local analytics log

    const fetchJSON = (url, opts={}) => fetch(url, { headers:{ "Content-Type":"application/json", ...(opts.headers||{}) }, ...opts })
      .then(r => r.json());

    function toast(msg){ try{ window.Toast?.show?.(msg); }catch{} console.log(msg); }
    function copy(text){ navigator.clipboard?.writeText(text).catch(()=>{}); }
    function todayKey(){ return new Date().toISOString().slice(0,10); }
    function k(name){ return `crp:${name}:${App.userId||"anon"}`; }
    function getRemain(){
      const plan = (App.plan||"free").toLowerCase();
      const cap = (plan==="creator"||plan==="business") ? 15 : 5; // Starter/free get 5/day for optimizer
      const used = Number(localStorage.getItem(k("optUsed:"+todayKey()))||"0");
      return Math.max(0, cap - used);
    }
    function bumpOptimizerCount(){
      const key = k("optUsed:"+todayKey());
      const n = Number(localStorage.getItem(key)||"0")+1;
      localStorage.setItem(key, String(n));
      $("#optRemain").textContent = getRemain();
    }
    function planGate(selector, minPlan){ // hides card if below plan
      const order = { free:0, starter:1, creator:2, business:3 };
      const me = order[(App.plan||"free")] ?? 0;
      const need = order[minPlan] ?? 0;
      const el = $(selector);
      if (!el) return;
      if (me < need) el.classList.add("pointer-events-none","opacity-50");
    }

    // hydrate plan/user
    (async function initIdentity(){
      try{
        const who = await fetchJSON("/api/whoami");
        if (who?.plan) App.plan = who.plan;
        if (who?.userId) App.userId = who.userId;
      }catch{}
      $("#optRemain").textContent = getRemain();
      planGate("#view-projectpack .badge:contains('Creator+')","creator"); // visual; also disable buttons below
    })();

    // ---------------------- Project Pack Export ----------------------
    function parsePackBlocks(){
      const parts = [];
      const useLast = $("#packUseLast").checked;
      const add = txt => { if (txt && txt.trim()) parts.push(txt.trim()); };
      if (useLast && App.lastOutput) add(App.lastOutput);

      const custom = $("#packInput").value;
      if (custom) add(custom);

      // split by '---'
      return parts.join("\n\n").split(/\n-{3,}\n/).map(s => s.trim()).filter(Boolean);
    }

    async function exportPackToNotion(){
      const blocksRaw = parsePackBlocks();
      const parent = $("#packNotionParent").value.trim();
      const title = $("#packTitle").value.trim() || "Project Pack";
      const blocks = [];
      blocksRaw.forEach(seg => {
        const lines = seg.split(/\n/);
        if (/^H2:\s*/i.test(lines[0])) {
          blocks.push({ type:"heading", text: lines.shift().replace(/^H2:\s*/i,"").trim() });
        }
        blocks.push({ type:"paragraph", text: lines.join("\n").trim() });
      });
      $("#packStatus").textContent = "Exporting to Notion…";
      try{
        const res = await fetchJSON("/api/integrations/notion/export", {
          method:"POST",
          body: JSON.stringify({ title, parent_page_id: parent || undefined, blocks })
        });
        if (res?.url){
          $("#linkPackResult").classList.remove("hidden");
          $("#linkPackResult").href = res.url;
          $("#packStatus").textContent = "Exported to Notion.";
          logActivity("notion","published");
        } else {
          $("#packStatus").textContent = res?.error?.message || "Export failed.";
        }
      }catch(e){
        $("#packStatus").textContent = "Export failed.";
      }
    }

    async function exportPackToTrello(){
      const splitCards = $("#packSplitCards").checked;
      const boardId = $("#trelloBoard")?.value?.trim();
      const listId  = $("#trelloList")?.value?.trim();
      const title   = $("#packTitle").value.trim() || "Project Pack";
      const blocks  = parsePackBlocks();
      if (!listId){ toast("Set Trello List ID in Integrations."); return; }

      $("#packStatus").textContent = "Exporting to Trello…";
      try{
        if (splitCards){
          let lastUrl = "";
          for (let i=0;i<blocks.length;i++){
            const name = `${title} #${i+1}`;
            const desc = blocks[i];
            const r = await fetchJSON("/api/integrations/trello/export", {
              method:"POST", body: JSON.stringify({ board_id: boardId||"", list_id: listId, title:name, description:desc })
            });
            if (!r?.url){ $("#packStatus").textContent = "Some cards failed."; break; }
            lastUrl = r.url;
          }
          if (lastUrl){
            $("#linkPackResult").classList.remove("hidden");
            $("#linkPackResult").href = lastUrl;
            $("#packStatus").textContent = "Exported multiple Trello cards.";
            logActivity("trello","published");
          }
        } else {
          const combined = blocks.map((b,i)=>`#${i+1}\n${b}`).join("\n\n---\n\n");
          const r = await fetchJSON("/api/integrations/trello/export", {
            method:"POST", body: JSON.stringify({ board_id: boardId||"", list_id: listId, title, description: combined })
          });
          if (r?.url){
            $("#linkPackResult").classList.remove("hidden");
            $("#linkPackResult").href = r.url;
            $("#packStatus").textContent = "Exported Trello card.";
            logActivity("trello","published");
          } else {
            $("#packStatus").textContent = r?.error?.message || "Export failed.";
          }
        }
      }catch(e){
        $("#packStatus").textContent = "Export failed.";
      }
    }

    $("#btnPackExportNotion")?.addEventListener("click", exportPackToNotion);
    $("#btnPackExportTrello")?.addEventListener("click", exportPackToTrello);

    // ---------------------- LinkedIn Article ----------------------
    function liPrompt(text, wantSEO){
      return [
        { role:"system", content:
`You are a senior B2B content editor. Transform the user's draft into a polished LinkedIn Article (not a short post).
- Start with a compelling H1 title.
- Use H2/H3 headings, short paragraphs, and 1–2 pull quotes.
- Include a practical CTA at the end.
${wantSEO? "- Provide SEO title (<=60 chars) and meta description (<=155 chars) at the end under 'SEO:'." : ""}` },
        { role:"user", content: text }
      ];
    }

    async function genLinkedInArticle(){
      const useLast = $("#liUseLast").checked;
      const includeSEO = $("#liSEO").checked;
      const src = (useLast && App.lastOutput) ? App.lastOutput : $("#liInput").value.trim();
      if (!src){ toast("No source text."); return; }
      $("#liArticleOut").value = "Generating…";
      try{
        const res = await fetch("/api/generate", {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ messages: liPrompt(src, includeSEO), temperature: 0.6 })
        }).then(r=>r.json());
        const text = res?.choices?.[0]?.message?.content || res?.error?.message || "Failed to generate.";
        $("#liArticleOut").value = text;
        App.lastOutput = text;
        logActivity("linkedin-article","generated");
      }catch(e){
        $("#liArticleOut").value = "Failed to generate.";
      }
    }
    $("#btnGenLinkedInArticle")?.addEventListener("click", genLinkedInArticle);

    $("#btnOpenLinkedInArticle")?.addEventListener("click", ()=>{
      const txt = $("#liArticleOut").value.trim() || App.lastOutput || "";
      if (!txt){ toast("No article to submit."); return; }
      copy(txt);
      // Open LinkedIn "Write article" surface; URL can change, pulse is a safe landing.
      window.open("https://www.linkedin.com/pulse/", "_blank","noopener");
      logActivity("linkedin-article","published");
    });

    // ---------------------- Article Optimizer (15/day) ----------------------
    function optPrompt(text, flags){
      const parts = [];
      if (flags.humanize) parts.push("Humanize tone (plain, direct, confident).");
      if (flags.lengthen) parts.push("Lengthen by ~20–35% with examples.");
      if (flags.faqs)     parts.push("Add 4–7 FAQs at the end and include JSON-LD FAQPage schema.");
      if (flags.headings) parts.push("Auto-add H2/H3 headings for scannability.");
      if (flags.svg)      parts.push("List 2–4 platform-fit SVG image ideas with titles and one-line descriptions.");
      if (flags.seo)      parts.push("Check SEO basics: include title tag, meta description, and alt-text suggestions.");
      return [
        { role:"system", content: `You are an expert content optimizer. Apply the requested transformations while preserving the original meaning and facts. Output only the revised article and any requested appendices.` },
        { role:"user", content: `Original article:\n\n${text}\n\nPlease apply:\n- ${parts.join("\n- ")}` }
      ];
    }

    async function runOptimizer(){
      const remain = getRemain();
      if (remain <= 0){ toast("Daily optimizer limit reached."); return; }
      const src = $("#optInput").value.trim() || App.lastOutput || "";
      if (!src){ toast("No article text."); return; }
      $("#optOut").value = "Optimizing…";
      const flags = {
        humanize: $("#optHumanize").checked,
        lengthen: $("#optLengthen").checked,
        faqs:     $("#optFaqs").checked,
        headings: $("#optHeadings").checked,
        svg:      $("#optSVG").checked,
        seo:      $("#optSEO").checked,
      };
      try{
        const res = await fetch("/api/generate", {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ messages: optPrompt(src, flags), temperature: 0.5, max_tokens: 1800 })
        }).then(r=>r.json());
        const text = res?.choices?.[0]?.message?.content || res?.error?.message || "Failed to optimize.";
        $("#optOut").value = text;
        App.lastOutput = text;
        bumpOptimizerCount();
        logActivity("optimizer","generated");
      }catch(e){
        $("#optOut").value = "Failed to optimize.";
      }
    }
    $("#btnRunOptimizer")?.addEventListener("click", runOptimizer);

    // ---------------------- Template Actions Injection ----------------------
    // Add Submit / Export buttons to each generated template card (expects .template-card)
    const actionsTpl = $("#tplTemplateActions");
    const container = document.body; // observe whole doc to be safe
    const mo = new MutationObserver(() => {
      $$(".template-card").forEach(card => {
        if (card.__actionsInjected) return;
        card.__actionsInjected = true;
        const frag = actionsTpl.content.cloneNode(true);
        card.appendChild(frag);
        const text = (card.querySelector("textarea, pre, .content")?.value || card.querySelector("textarea, pre, .content")?.textContent || "").trim();
        card.dataset.text = text;

        card.querySelector(".act-submit")?.addEventListener("click", ()=> submitTemplate(text));
        card.querySelector(".act-export-notion")?.addEventListener("click", ()=> exportTemplateNotion(text));
        card.querySelector(".act-export-trello")?.addEventListener("click", ()=> exportTemplateTrello(text));
      });
    });
    mo.observe(container, { childList:true, subtree:true });

    async function exportTemplateNotion(text){
      const blocks = text.split(/\n\n+/).map((t,i)=> i===0 ? {type:"heading", text:t.slice(0,200)} : {type:"paragraph", text:t});
      try{
        const res = await fetchJSON("/api/integrations/notion/export", {
          method:"POST",
          body: JSON.stringify({ title: blocks[0]?.text || "Template", blocks })
        });
        if (res?.url){ window.open(res.url,"_blank","noopener"); logActivity("notion","published"); }
        else toast(res?.error?.message || "Notion export failed.");
      }catch(e){ toast("Notion export failed."); }
    }

    async function exportTemplateTrello(text){
      const listId = $("#trelloList")?.value?.trim();
      if (!listId){ toast("Set Trello List ID in Integrations."); return; }
      try{
        const res = await fetchJSON("/api/integrations/trello/export", {
          method:"POST",
          body: JSON.stringify({ list_id: listId, title: (text.split("\n")[0]||"Content"), description: text })
        });
        if (res?.url){ window.open(res.url,"_blank","noopener"); logActivity("trello","published"); }
        else toast(res?.error?.message || "Trello export failed.");
      }catch(e){ toast("Trello export failed."); }
    }

    function submitTemplate(text){
      // Open quick submitter modal equivalents:
      copy(text);
      toast("Copied to clipboard.");
    }

    // ---------------------- Quick Submitters (right panel) ----------------------
    $$("#view-projectpack [data-submit]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const kind = btn.getAttribute("data-submit");
        const txt = App.lastOutput?.trim() || "";
        if (!txt){ toast("No content to submit."); return; }
        copy(txt);
        if (kind==="x") window.open("https://x.com/intent/tweet","_blank","noopener");
        if (kind==="reddit") window.open("https://www.reddit.com/submit","_blank","noopener");
        if (kind==="linkedin") window.open("https://www.linkedin.com/feed/","_blank","noopener");
        if (kind==="linkedin-article") window.open("https://www.linkedin.com/pulse/","_blank","noopener");
        if (kind==="quora") window.open("https://www.quora.com/","_blank","noopener");
        if (kind==="email") toast("Paste into your email client.");
        logActivity(kind, "published");
      });
    });

    // ---------------------- Analytics Pro ----------------------
    function loadLog(){
      try{
        const raw = localStorage.getItem(k("activityLog")) || "[]";
        App.activity = JSON.parse(raw);
      }catch{ App.activity = []; }
    }
    function saveLog(){
      try{ localStorage.setItem(k("activityLog"), JSON.stringify(App.activity.slice(-2000))); }catch{}
    }
    function logActivity(channel, action){
      loadLog();
      App.activity.push({ t: Date.now(), channel, action });
      saveLog();
      renderAnalytics();
    }

    function summarize(rangeDays){
      const ms = rangeDays*86400*1000;
      const cutoff = Date.now() - ms;
      const groups = {};
      const CH = ["x","linkedin","linkedin-article","reddit","quora","email","notion","trello","optimizer","scheduler"];
      CH.forEach(c => groups[c] = { generated:0, queued:0, published:0 });

      (App.activity||[]).forEach(e=>{
        if (e.t < cutoff) return;
        const g = groups[e.channel] || (groups[e.channel] = { generated:0, queued:0, published:0 });
        if (e.action==="generated") g.generated++;
        else if (e.action==="queued") g.queued++;
        else if (e.action==="published") g.published++;
      });

      return groups;
    }

    function renderAnalytics(){
      const days = Number($("#anaRange").value||30);
      const data = summarize(days);
      const grid = $("#anaGrid");
      grid.innerHTML = "";
      Object.entries(data).forEach(([ch, stats])=>{
        const total = stats.generated + stats.queued + stats.published;
        if (total===0) return; // hide empty channels
        const el = document.createElement("div");
        el.className = "rounded-lg border p-3";
        el.innerHTML = `
          <div class="flex items-center justify-between">
            <div class="font-medium">${labelFor(ch)}</div>
            <div class="text-xs text-slate-500">${days}d</div>
          </div>
          <div class="mt-2 text-sm">Generated: <b>${stats.generated}</b></div>
          <div class="text-sm">Queued: <b>${stats.queued}</b></div>
          <div class="text-sm">Published: <b>${stats.published}</b></div>
        `;
        grid.appendChild(el);
      });
      drawChart(data);
    }

    function labelFor(ch){
      const map = {
        "x":"X / Twitter","linkedin":"LinkedIn","linkedin-article":"LinkedIn Article",
        "reddit":"Reddit","quora":"Quora","email":"Email","notion":"Notion","trello":"Trello",
        "optimizer":"Optimizer","scheduler":"Scheduler"
      };
      return map[ch] || ch;
    }

    function drawChart(groups){
      const c = $("#anaChart");
      if (!c) return;
      const ctx = c.getContext("2d");
      const w = c.width = c.clientWidth;
      const h = c.height;
      ctx.clearRect(0,0,w,h);

      const labels = Object.keys(groups).filter(ch=>{
        const s = groups[ch]; return (s.generated+s.queued+s.published)>0;
      });
      const barW = Math.max(20, Math.floor((w - 40) / Math.max(1, labels.length)));
      const maxVal = Math.max(1, ...labels.map(ch=> (groups[ch].generated+groups[ch].queued+groups[ch].published)));

      labels.forEach((ch, i)=>{
        const x = 20 + i*barW;
        const s = groups[ch];
        const total = s.generated+s.queued+s.published;

        const hGen = Math.round((s.generated / maxVal) * (h-30));
        const hQue = Math.round((s.queued   / maxVal) * (h-30));
        const hPub = Math.round((s.published/ maxVal) * (h-30));

        // stack bars: generated (left), queued (middle), published (right)
        ctx.fillRect(x+2,        h-10-hGen, Math.floor(barW/3)-4, hGen);
        ctx.fillRect(x+2+Math.floor(barW/3), h-10-hQue, Math.floor(barW/3)-4, hQue);
        ctx.fillRect(x+2+2*Math.floor(barW/3), h-10-hPub, Math.floor(barW/3)-4, hPub);

        ctx.font = "10px system-ui";
        ctx.textAlign = "center";
        ctx.fillText(shortLabel(ch), x + barW/2, h-2);
      });
    }
    function shortLabel(ch){
      const map = { "linkedin-article":"LI Art", "optimizer":"Opt" };
      return map[ch] || ch.slice(0,6);
    }

    $("#anaRange")?.addEventListener("change", renderAnalytics);
    loadLog(); renderAnalytics();

    // Expose for other parts (Scheduler/Generator) to log:
    window.ContentLog = { log: logActivity, render: renderAnalytics };
  })();
  </script>
  <!-- ===================== VIEW: BUSINESS TEAMS + PROFILES + BATCH ===================== -->
  <section id="view-teams-profiles-batch" class="mt-4 hidden">
    <div class="max-w-7xl mx-auto px-4 md:px-5 grid xl:grid-cols-12 gap-6">

      <!-- ================== LEFT: BUSINESS TEAMS ================== -->
      <div class="xl:col-span-6 grid gap-4">
        <div class="card p-4 md:p-5" id="teamsCard" data-min-plan="business">
          <div class="flex items-center justify-between gap-2">
            <h3 class="text-lg font-semibold">Business Teams</h3>
            <span class="badge">Business</span>
          </div>
          <p class="text-sm text-slate-500 mt-1">
            Invite teammates, manage seats, and share integrations (Notion/Trello) under one team.
          </p>

          <div class="mt-3 flex items-center gap-2">
            <button id="btnTeamEnsure" class="btn btn-primary">Enable / Ensure Team</button>
            <button id="btnTeamRefresh" class="btn">Refresh</button>
            <span id="teamSeatInfo" class="text-xs text-slate-500"></span>
          </div>

          <div class="mt-4">
            <h4 class="font-medium">Members</h4>
            <div id="teamMembers" class="mt-2 grid gap-2"></div>
          </div>

          <div class="mt-4">
            <h4 class="font-medium">Pending Invites</h4>
            <div id="teamInvites" class="mt-2 grid gap-2"></div>
          </div>

          <div class="mt-4 grid md:grid-cols-2 gap-3">
            <div class="rounded-lg border p-3">
              <label class="text-sm">Invite teammate by email</label>
              <input id="invEmail" class="w-full rounded-lg border bg-transparent p-2 mt-1" placeholder="teammate@company.com">
              <button id="btnInvite" class="btn btn-primary mt-2">Send Invite</button>
              <div id="invStatus" class="text-xs text-slate-500 mt-1"></div>
            </div>
            <div class="rounded-lg border p-3">
              <label class="text-sm">Have a code? Accept invite</label>
              <input id="invCode" class="w-full rounded-lg border bg-transparent p-2 mt-1" placeholder="iv_abcdef123">
              <button id="btnAcceptInvite" class="btn mt-2">Accept</button>
              <div id="accStatus" class="text-xs text-slate-500 mt-1"></div>
            </div>
          </div>
        </div>

        <!-- ================== PROFILES (Multi-profile for Scheduler) ================== -->
        <div class="card p-4 md:p-5" id="profilesCard" data-min-plan="starter">
          <div class="flex items-center justify-between gap-2">
            <h3 class="text-lg font-semibold">Profiles (for Scheduler & Publishing)</h3>
            <span class="badge">Starter+</span>
          </div>
          <p class="text-sm text-slate-500 mt-1">
            Add the channels you publish to, then pick multiple profiles when scheduling or publishing.
          </p>

          <div class="grid md:grid-cols-3 gap-3 mt-3">
            <div>
              <label class="text-sm">Profile name</label>
              <input id="profName" class="w-full rounded-lg border bg-transparent p-2 mt-1" placeholder="Acme – LinkedIn">
            </div>
            <div>
              <label class="text-sm">Channel</label>
              <select id="profChannel" class="w-full rounded-lg border bg-transparent p-2 mt-1">
                <option value="linkedin">LinkedIn</option>
                <option value="linkedin-article">LinkedIn Article</option>
                <option value="x">X / Twitter</option>
                <option value="reddit">Reddit</option>
                <option value="quora">Quora</option>
                <option value="email">Email</option>
                <option value="notion">Notion</option>
                <option value="trello">Trello</option>
              </select>
            </div>
            <div class="flex items-end">
              <button id="btnAddProfile" class="btn btn-primary w-full">Add profile</button>
            </div>
          </div>

          <div class="mt-3">
            <div class="flex items-center justify-between">
              <label class="text-sm">Your profiles</label>
              <div class="text-xs text-slate-500">Tip: drag to reorder</div>
            </div>
            <div id="profilesList" class="mt-2 grid gap-2"></div>
          </div>

          <div class="mt-3">
            <label class="text-sm">Select profiles for Scheduler</label>
            <div id="profilesSelect" class="mt-2 grid sm:grid-cols-2 lg:grid-cols-3 gap-2"></div>
          </div>

          <div class="mt-3 text-xs text-slate-500">
            These selections are used as defaults in Scheduler. You can still toggle per-schedule.
          </div>
        </div>
      </div>
      <!-- ================== /LEFT ================== -->

      <!-- ================== RIGHT: BATCH INPUT GENERATOR ================== -->
      <div class="xl:col-span-6 grid gap-4">
        <div class="card p-4 md:p-5" id="batchCard" data-min-plan="creator">
          <div class="flex items-center justify-between gap-2">
            <h3 class="text-lg font-semibold">Batch Generator</h3>
            <span class="badge">Creator+</span>
          </div>
          <p class="text-sm text-slate-500 mt-1">
            Generate multiple pieces at once. Each line is one item, or separate with <code>---</code>. Actions (Submit/Export) are injected on each result.
          </p>

          <div class="mt-3 grid md:grid-cols-3 gap-3">
            <div>
              <label class="text-sm">Max items this batch</label>
              <input id="batchMax" type="number" class="w-full rounded-lg border bg-transparent p-2 mt-1" value="10" min="1">
              <div class="text-xs text-slate-500 mt-1">Plan caps: Starter 5 · Creator 20 · Business 50</div>
            </div>
            <div>
              <label class="text-sm">Temperature</label>
              <input id="batchTemp" type="number" step="0.1" min="0" max="1" class="w-full rounded-lg border bg-transparent p-2 mt-1" value="0.7">
            </div>
            <div class="flex items-end">
              <button id="btnBatchRun" class="btn btn-primary w-full">Run batch</button>
            </div>
          </div>

          <div class="mt-3">
            <label class="text-sm">Batch input</label>
            <textarea id="batchInput" rows="10" class="w-full rounded-lg border bg-transparent p-3"
              placeholder="Each line = separate request\nOr use --- on its own line to split larger items."></textarea>
          </div>

          <div class="mt-3 hidden" id="batchProgressWrap">
            <div class="rounded-lg border p-3 flex items-center justify-between">
              <div class="text-sm"><span id="batchDone">0</span>/<span id="batchTotal">0</span> completed</div>
              <div class="text-xs text-slate-500" id="batchStatusMsg"></div>
            </div>
          </div>

          <div class="mt-3">
            <label class="text-sm">Results</label>
            <div id="batchResults" class="mt-2 grid gap-3"></div>
          </div>
        </div>

        <!-- Small plan-gating explainer -->
        <div class="rounded-lg border p-4">
          <div class="text-sm font-medium">Plan access</div>
          <ul class="text-sm text-slate-500 list-disc ml-5 mt-1">
            <li><b>Starter</b>: Profiles, Scheduler single-profile, Batch up to 5.</li>
            <li><b>Creator</b>: Everything in Starter + Multi-profile Scheduler, Analytics Pro, Optimizer 15/day, Batch up to 20.</li>
            <li><b>Business</b>: Everything in Creator + Teams (seats), White-label, Batch up to 50.</li>
          </ul>
        </div>
      </div>
      <!-- ================== /RIGHT ================== -->

    </div>
  </section>
  <!-- ===================== /VIEW: BUSINESS TEAMS + PROFILES + BATCH ===================== -->

  <script>
  (function(){
    const $ = (s,el=document)=>el.querySelector(s);
    const $$ = (s,el=document)=>Array.from(el.querySelectorAll(s));
    const App = window.App = window.App || {};
    App.plan   = App.plan || "free";
    App.userId = App.userId || null;

    // ---------------------- Plan gating polish ----------------------
    function planOrder(p){ return ({free:0,starter:1,creator:2,business:3})[(p||"free").toLowerCase()] ?? 0; }
    function applyPlanGates(scope=document){
      const my = planOrder(App.plan);
      $$("[data-min-plan]", scope).forEach(card=>{
        const need = planOrder(card.getAttribute("data-min-plan"));
        const btns = $$("button,a,input,select,textarea", card);
        if (my < need){
          card.classList.add("opacity-60","pointer-events-none");
          const bar = document.createElement("div");
          bar.className = "mt-3 rounded-lg border border-amber-300/40 bg-amber-50/5 p-3";
          bar.innerHTML = `
            <div class="text-sm">
              This feature requires <b>${card.getAttribute("data-min-plan")}</b>.
              <a id="upgradeCta" class="underline">See plans</a>
            </div>`;
          card.appendChild(bar);
          btns.forEach(b=>b.disabled=true);
          bar.querySelector("#upgradeCta").addEventListener("click", ()=> window.open("/pricing","_blank","noopener"));
        }
      });
    }

    (async function hydrateIdentity(){
      try{
        const who = await fetch("/api/whoami").then(r=>r.json());
        if (who?.plan) App.plan = who.plan;
        if (who?.userId) App.userId = who.userId;
      }catch{}
      applyPlanGates($("#view-teams-profiles-batch"));
    })();

    // ---------------------- Business Teams ----------------------
    const seatsText = (m, s)=> s ? `${m}/${s} seats used` : `${m} members`;
    function k(n){ return `crp:${n}:${App.userId||"anon"}`; }
    async function teamEnsure(){
      setStatus("#teamSeatInfo","Ensuring team…");
      try{
        const r = await fetch("/api/org/ensure",{method:"POST"}).then(r=>r.json());
        if (r?.org){ localStorage.setItem(k("orgId"), r.org.id); }
        await teamRefresh();
      }catch{ setStatus("#teamSeatInfo","Failed to ensure team."); }
    }
    async function teamRefresh(){
      setStatus("#teamSeatInfo","Loading…");
      try{
        const r = await fetch("/api/org/members").then(r=>r.json());
        renderMembers(r);
      }catch{ setStatus("#teamSeatInfo","Failed to load."); }
    }
    function renderMembers(r){
      const members = r?.members||[];
      const invites = r?.invites||[];
      const seats   = r?.seats||0;
      const ownerId = r?.owner_id||"";
      $("#teamSeatInfo").textContent = seatsText(members.length, seats);

      const list = $("#teamMembers"); list.innerHTML="";
      members.forEach(m=>{
        const row = document.createElement("div");
        row.className = "rounded-lg border p-3 flex items-center justify-between gap-2";
        row.innerHTML = `
          <div class="text-sm">
            <div class="font-medium">${m.email || m.user_id}</div>
            <div class="text-xs text-slate-500">${m.role||"member"}</div>
          </div>
          <div>
            ${(m.user_id!==ownerId && ownerId===App.userId) ? `<button class="btn btn-xs danger" data-remove="${m.user_id}">Remove</button>` : ""}
          </div>`;
        list.appendChild(row);
      });
      list.querySelectorAll("[data-remove]").forEach(b=>{
        b.addEventListener("click", async()=>{
          const uid = b.getAttribute("data-remove");
          b.disabled = true;
          const res = await fetch("/api/org/remove",{method:"POST", headers:{'Content-Type':'application/json'}, body: JSON.stringify({user_id:uid})}).then(r=>r.json());
          b.disabled = false;
          await teamRefresh();
        });
      });

      const invList = $("#teamInvites"); invList.innerHTML="";
      invites.forEach(i=>{
        const row = document.createElement("div");
        row.className = "rounded-lg border p-3 flex items-center justify-between gap-2";
        row.innerHTML = `
          <div class="text-sm">
            <div class="font-medium">${i.email}</div>
            <div class="text-xs text-slate-500">Code: <code>${i.code}</code></div>
          </div>
          <div class="flex items-center gap-2">
            <button class="btn btn-xs" data-copy-code="${i.code}">Copy code</button>
          </div>`;
        invList.appendChild(row);
      });
      invList.querySelectorAll("[data-copy-code]").forEach(b=>{
        b.addEventListener("click", ()=> navigator.clipboard?.writeText(b.getAttribute("data-copy-code")));
      });
    }
    function setStatus(sel, txt){ const el=$(sel); if (el) el.textContent = txt; }

    $("#btnTeamEnsure")?.addEventListener("click", teamEnsure);
    $("#btnTeamRefresh")?.addEventListener("click", teamRefresh);
    $("#btnInvite")?.addEventListener("click", async()=>{
      const email = $("#invEmail").value.trim();
      if (!email){ $("#invStatus").textContent="Enter an email."; return; }
      $("#invStatus").textContent="Sending…";
      try{
        const r = await fetch("/api/org/invite",{method:"POST", headers:{'Content-Type':'application/json'}, body: JSON.stringify({ email })}).then(r=>r.json());
        $("#invStatus").textContent = r?.code ? `Invite created. Code: ${r.code}` : (r?.error?.message || "Failed.");
        await teamRefresh();
      }catch{ $("#invStatus").textContent="Failed."; }
    });
    $("#btnAcceptInvite")?.addEventListener("click", async()=>{
      const code = $("#invCode").value.trim();
      if (!code){ $("#accStatus").textContent="Enter the code."; return; }
      $("#accStatus").textContent="Accepting…";
      try{
        const r = await fetch("/api/org/accept",{method:"POST", headers:{'Content-Type':'application/json'}, body: JSON.stringify({ code })}).then(r=>r.json());
        $("#accStatus").textContent = r?.ok ? "Joined team." : (r?.error?.message || "Failed.");
        await teamRefresh();
      }catch{ $("#accStatus").textContent="Failed."; }
    });

    // ---------------------- Profiles (for Scheduler & Publishing) ----------------------
    function loadProfiles(){
      try{ return JSON.parse(localStorage.getItem(k("profiles"))||"[]"); }catch{ return []; }
    }
    function saveProfiles(list){
      try{ localStorage.setItem(k("profiles"), JSON.stringify(list)); }catch{}
      renderProfiles();
      hydrateSchedulerSelection();
    }
    function renderProfiles(){
      const list = loadProfiles();
      const wrap = $("#profilesList");
      const sel  = $("#profilesSelect");
      wrap.innerHTML = ""; sel.innerHTML="";

      list.forEach((p, idx)=>{
        const row = document.createElement("div");
        row.className = "rounded-lg border p-2 flex items-center justify-between gap-2";
        row.draggable = true;
        row.innerHTML = `
          <div class="text-sm">
            <div class="font-medium">${p.name}</div>
            <div class="text-xs text-slate-500">${p.channel}</div>
          </div>
          <div class="flex items-center gap-2">
            <button class="btn btn-xs" data-up="${idx}">↑</button>
            <button class="btn btn-xs" data-down="${idx}">↓</button>
            <button class="btn btn-xs danger" data-del="${idx}">Delete</button>
          </div>`;
        wrap.appendChild(row);

        const opt = document.createElement("label");
        opt.className = "rounded-lg border p-2 flex items-center gap-2";
        opt.innerHTML = `<input type="checkbox" data-pick="${idx}"><span class="text-sm">${p.name} · <span class="text-xs text-slate-500">${p.channel}</span></span>`;
        sel.appendChild(opt);
      });

      wrap.querySelectorAll("[data-del]").forEach(b=>{
        b.addEventListener("click", ()=>{
          const i = Number(b.getAttribute("data-del"));
          const l = loadProfiles(); l.splice(i,1); saveProfiles(l);
        });
      });
      wrap.querySelectorAll("[data-up]").forEach(b=>{
        b.addEventListener("click", ()=>{
          const i = Number(b.getAttribute("data-up"));
          const l = loadProfiles(); if (i>0){ const t=l[i-1]; l[i-1]=l[i]; l[i]=t; saveProfiles(l); }
        });
      });
      wrap.querySelectorAll("[data-down]").forEach(b=>{
        b.addEventListener("click", ()=>{
          const i = Number(b.getAttribute("data-down"));
          const l = loadProfiles(); if (i<l.length-1){ const t=l[i+1]; l[i+1]=l[i]; l[i]=t; saveProfiles(l); }
        });
      });
    }
    $("#btnAddProfile")?.addEventListener("click", ()=>{
      const name = $("#profName").value.trim();
      const channel = $("#profChannel").value;
      if (!name){ $("#profName").focus(); return; }
      const list = loadProfiles();
      list.push({ name, channel, id: "pf_"+Math.random().toString(36).slice(2,8) });
      saveProfiles(list);
      $("#profName").value="";
    });

    // Bridge to Scheduler (if present in the DOM)
    function hydrateSchedulerSelection(){
      const picks = $$("#profilesSelect [data-pick]");
      const ids = picks.filter(x=>x.checked).map(x=> Number(x.getAttribute("data-pick")));
      const selected = ids.map(i => loadProfiles()[i]).filter(Boolean);
      // Save defaults for scheduler to consume
      try{ localStorage.setItem(k("schedProfiles"), JSON.stringify(selected)); }catch{}

      // If scheduler page has a placeholder, render checkboxes there too:
      const mount = document.getElementById("schedProfilesMulti");
      if (mount){
        mount.innerHTML = "";
        loadProfiles().forEach((p, idx)=>{
          const lbl = document.createElement("label");
          lbl.className = "rounded-lg border p-2 flex items-center gap-2";
          const checked = selected.some(s=> s.id===p.id);
          lbl.innerHTML = `<input type="checkbox" data-sel="${p.id}" ${checked?'checked':''}><span>${p.name} <span class="text-xs text-slate-500">· ${p.channel}</span></span>`;
          mount.appendChild(lbl);
        });
        mount.querySelectorAll("[data-sel]").forEach(cb=>{
          cb.addEventListener("change", ()=>{
            const id = cb.getAttribute("data-sel");
            const list = loadProfiles();
            const cur = JSON.parse(localStorage.getItem(k("schedProfiles"))||"[]");
            const profile = list.find(p=>p.id===id);
            if (!profile) return;
            const exists = cur.some(p=>p.id===id);
            const next = cb.checked ? (exists?cur:[...cur, profile]) : cur.filter(p=>p.id!==id);
            localStorage.setItem(k("schedProfiles"), JSON.stringify(next));
          });
        });
      }
    }
    $("#profilesSelect")?.addEventListener("change", hydrateSchedulerSelection);

    renderProfiles(); hydrateSchedulerSelection();

    // ---------------------- Batch Generator ----------------------
    function planCap(){
      const p = (App.plan||"free").toLowerCase();
      if (p==="business") return 50;
      if (p==="creator") return 20;
      if (p==="starter") return 5;
      return 3; // free (fallback)
    }
    function splitBatch(txt){
      const trimmed = (txt||"").trim();
      if (!trimmed) return [];
      if (/\n-{3,}\n/.test(trimmed)) return trimmed.split(/\n-{3,}\n/).map(s=>s.trim()).filter(Boolean);
      return trimmed.split(/\n+/).map(s=>s.trim()).filter(Boolean);
    }
    function promptFor(item){
      return [
        { role:"system", content:"You are a content assistant. Produce a clear, platform-ready piece for the user's request." },
        { role:"user", content:item }
      ];
    }
    function makeCard(text, idx){
      const card = document.createElement("div");
      card.className = "template-card rounded-lg border p-3";
      card.innerHTML = `
        <div class="text-sm text-slate-500 mb-2">Item #${idx+1}</div>
        <textarea rows="10" class="w-full rounded-lg border bg-transparent p-3">${(text||"").replace(/</g,"&lt;")}</textarea>
      `;
      return card;
    }
    function setBatchStatus(done, total, msg){
      $("#batchDone").textContent = String(done);
      $("#batchTotal").textContent = String(total);
      $("#batchStatusMsg").textContent = msg||"";
    }

    $("#btnBatchRun")?.addEventListener("click", async()=>{
      const inputs = splitBatch($("#batchInput").value);
      const cap = Math.min(planCap(), Number($("#batchMax").value||10));
      const items = inputs.slice(0, cap);
      if (!items.length){ alert("No items to run."); return; }

      $("#batchResults").innerHTML = "";
      $("#batchProgressWrap").classList.remove("hidden");
      setBatchStatus(0, items.length, "Starting…");

      let done = 0;
      for (let i=0;i<items.length;i++){
        setBatchStatus(done, items.length, `Generating item ${i+1}…`);
        try{
          const res = await fetch("/api/generate",{
            method:"POST",
            headers:{ "Content-Type":"application/json" },
            body: JSON.stringify({ messages: promptFor(items[i]), temperature: Number($("#batchTemp").value||0.7) })
          }).then(r=>r.json());
          const text = res?.choices?.[0]?.message?.content || res?.error?.message || "Failed to generate.";
          $("#batchResults").appendChild(makeCard(text, i));
          done++; setBatchStatus(done, items.length, "OK");
          window.ContentLog?.log?.("optimizer","generated");
        }catch(e){
          $("#batchResults").appendChild(makeCard("Failed to generate.", i));
          done++; setBatchStatus(done, items.length, "Error");
        }
      }
      setBatchStatus(done, items.length, "Complete");
    });

    // Expose a tiny hook Scheduler can reuse
    window.MultiProfile = {
      getSelected: ()=> {
        try{ return JSON.parse(localStorage.getItem(k("schedProfiles"))||"[]"); }catch{ return []; }
      },
      getAll: loadProfiles
    };
  })();
  </script>
  <!-- ===================== VIEW: ANALYTICS PRO (Per-channel) ===================== -->
  <section id="view-analytics" class="mt-4 hidden" data-min-plan="creator">
    <div class="max-w-6xl mx-auto px-4 md:px-5">
      <div class="card p-4 md:p-5">
        <div class="flex items-center justify-between gap-2">
          <h3 class="text-lg font-semibold">Analytics Pro</h3>
          <span class="badge">Creator+</span>
        </div>
        <p class="text-sm text-slate-500 mt-1">
          Lightweight, privacy-friendly counters tracked client-side + today’s global platform ticker from the API.
        </p>

        <div class="grid md:grid-cols-2 gap-4 mt-4">
          <div class="rounded-lg border p-3">
            <div class="text-sm font-medium mb-2">Your per-channel activity</div>
            <div id="analyticsTable" class="text-sm"></div>
          </div>
          <div class="rounded-lg border p-3">
            <div class="text-sm font-medium mb-2">Global today (free-pool)</div>
            <div id="analyticsGlobal" class="text-sm text-slate-500">Loading…</div>
            <button id="btnRefreshGlobal" class="btn btn-xs mt-2">Refresh</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- ===================== BILLING & PLANS MODAL ===================== -->
  <div id="billingModal" class="hidden fixed inset-0 z-50">
    <div class="absolute inset-0 bg-black/60"></div>
    <div class="relative max-w-3xl mx-auto mt-16 card p-4 md:p-6">
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-semibold">Plans & Billing</h3>
        <button class="btn btn-xs" id="closeBilling">Close</button>
      </div>
      <p class="text-sm text-slate-500 mt-1">Upgrade to unlock Scheduler (multi-profile), Optimizer 15/day, Analytics Pro, Teams, and more.</p>

      <div class="grid md:grid-cols-3 gap-4 mt-4">
        <div class="rounded-lg border p-4">
          <div class="font-medium">Starter</div>
          <div class="text-xs text-slate-500">Profiles • Scheduler (1) • Batch to 5</div>
          <button class="btn btn-primary mt-3 w-full"
                  data-checkout
                  data-price-id="price_1S7y58JYjIKHzKcjzL7cIKiB">Choose Starter</button>
        </div>
        <div class="rounded-lg border p-4">
          <div class="font-medium">Creator</div>
          <div class="text-xs text-slate-500">Multi-profile Scheduler • Optimizer 15/day • Analytics Pro • Batch to 20</div>
          <button class="btn btn-primary mt-3 w-full"
                  data-checkout
                  data-price-id="price_1S7y77JYjIKHzKcjKQYjiqZH">Choose Creator</button>
        </div>
        <div class="rounded-lg border p-4">
          <div class="font-medium">Business</div>
          <div class="text-xs text-slate-500">Teams & seats • White-label • Batch to 50</div>
          <button class="btn btn-primary mt-3 w-full"
                  data-checkout
                  data-price-id="price_1S7y8OJYjIKHzKcjqA9uJdyh">Choose Business</button>
        </div>
      </div>

      <div class="mt-4 flex items-center justify-between">
        <div id="billingPlanBadge" class="text-sm text-slate-500">Checking subscription…</div>
        <button id="btnBillingPortal" class="btn">Manage Billing</button>
      </div>
    </div>
  </div>

  <!-- ===================== PRESETS DRAWER ===================== -->
  <div id="presetsDrawer" class="hidden fixed inset-0 z-40">
    <div class="absolute inset-0 bg-black/50"></div>
    <div class="absolute right-0 top-0 h-full w-full sm:w-[420px] card p-4 md:p-5 overflow-auto">
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-semibold">Saved Presets</h3>
        <button id="closePresets" class="btn btn-xs">Close</button>
      </div>
      <div class="mt-3 rounded-lg border p-3">
        <label class="text-sm">Preset title</label>
        <input id="presetTitle" class="w-full rounded-lg border bg-transparent p-2 mt-1" placeholder="My YouTube → LinkedIn preset">
        <button id="btnSavePreset" class="btn btn-primary mt-2 w-full">Save current settings</button>
        <div class="text-xs text-slate-500 mt-1">Saves your current channel, tone, options & prompt. (No private API keys.)</div>
      </div>
      <div class="mt-3">
        <div class="text-sm font-medium mb-1">Your presets</div>
        <div id="presetsListWrap" class="grid gap-2"></div>
      </div>
    </div>
  </div>

  <!-- ===================== SIGN-IN HELP BANNER ===================== -->
  <div id="signinHelpBanner" class="hidden fixed bottom-3 right-3 z-40">
    <div class="rounded-xl border border-amber-300/40 bg-amber-50/10 backdrop-blur p-4 shadow-lg max-w-md">
      <div class="text-sm">
        <div class="font-medium">You’re in demo mode</div>
        <p class="text-slate-500 mt-1">
          Some features are hidden (Scheduler multi-profile, Optimizer 15/day, Analytics, Teams, Notion/Trello export).
          Sign in to unlock your plan and billing.
        </p>
      </div>
      <div class="mt-2 flex items-center gap-2">
        <button class="btn btn-primary btn-sm" id="openSignin">Sign in</button>
        <button class="btn btn-sm" id="openPlans">See plans</button>
      </div>
      <div class="text-[11px] text-slate-500 mt-2">
        Trouble signing in? Disable strict tracking blockers for this site and ensure third-party cookies are allowed for auth.
      </div>
    </div>
  </div>

  <!-- ===================== FINAL WIRING SCRIPT ===================== -->
  <script>
  (function(){
    const $  = (s,el=document)=>el.querySelector(s);
    const $$ = (s,el=document)=>Array.from(el.querySelectorAll(s));
    const App = window.App = window.App || {};
    App.plan   = App.plan || "free";
    App.userId = App.userId || null;

    /* ------------------------ ROUTER ------------------------ */
    const VIEWS = [
      "view-generator",
      "view-templates",
      "view-scheduler",
      "view-optimizer",
      "view-integrations",
      "view-teams-profiles-batch",
      "view-analytics"
    ];
    function show(id){
      VIEWS.forEach(v=>{ const el = $("#"+v); if (el) el.classList.toggle("hidden", v!==id); });
      // persist
      try{ localStorage.setItem("crp:lastView", id); }catch{}
      // plan gates inside newly shown view
      const apply = window.applyPlanGates || (scope=>scope);
      const scope = $("#"+id);
      if (scope && window.App && window.App.plan) {
        // Reuse gate from Part 7 if available
        const myOrder = ({free:0,starter:1,creator:2,business:3})[(App.plan||"free")] ?? 0;
        $$("[data-min-plan]", scope).forEach(card=>{
          const need = ({free:0,starter:1,creator:2,business:3})[card.getAttribute("data-min-plan")] ?? 0;
          const btns = $$("button,a,input,select,textarea", card);
          if (myOrder < need){
            card.classList.add("opacity-60","pointer-events-none");
            if (!card.querySelector("[data-upgrade-note]")){
              const bar = document.createElement("div");
              bar.setAttribute("data-upgrade-note","1");
              bar.className = "mt-3 rounded-lg border border-amber-300/40 bg-amber-50/5 p-3";
              bar.innerHTML = `<div class="text-sm">Requires <b>${card.getAttribute("data-min-plan")}</b>. <a class="underline" id="routePlans">See plans</a></div>`;
              card.appendChild(bar);
              bar.querySelector("#routePlans").addEventListener("click", openBilling);
            }
            btns.forEach(b=>b.disabled=true);
          }
        });
      }
    }
    // attach generic nav by data-route attr (if present in header)
    $$("[data-route]").forEach(a=>{
      a.addEventListener("click", (e)=>{ e.preventDefault(); show(a.getAttribute("data-route")); });
    });

    /* ------------------------ AUTH / WHOAMI ------------------------ */
    async function hydrateAuth(){
      try{
        const who = await fetch("/api/whoami").then(r=>r.json());
        if (who?.plan)   App.plan = who.plan;
        if (who?.userId) App.userId = who.userId;
        if (who?.kind === "ip") $("#signinHelpBanner")?.classList.remove("hidden");
      }catch{
        $("#signinHelpBanner")?.classList.remove("hidden");
      }
      // show last view or default
      const last = localStorage.getItem("crp:lastView") || "view-generator";
      show(last);
      updateBillingBadge();
      // set badge in header (if exists)
      const planSpot = $("#headerPlan"); if (planSpot){ planSpot.textContent = (App.plan||"free").toUpperCase(); }
    }

    $("#openSignin")?.addEventListener("click", ()=>{
      // Let your existing auth listener handle this event if you have one.
      window.dispatchEvent(new CustomEvent("crp:auth:signin"));
      // fallback:
      location.href = "/login";
    });
    $("#openPlans")?.addEventListener("click", ()=> openBilling());

    /* ------------------------ BILLING ------------------------ */
    function openBilling(){ $("#billingModal")?.classList.remove("hidden"); }
    function closeBilling(){ $("#billingModal")?.classList.add("hidden"); }
    $("#closeBilling")?.addEventListener("click", closeBilling);
    $$("#billingModal [data-checkout]").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const price = btn.getAttribute("data-price-id");
        btn.disabled = true;
        try{
          const r = await fetch("/api/billing/checkout",{
            method:"POST",
            headers:{ "Content-Type":"application/json" },
            body: JSON.stringify({ price })
          }).then(r=>r.json());
          if (r?.url) location.href = r.url;
          else alert(r?.error?.message || "Checkout failed");
        }finally{ btn.disabled = false; }
      });
    });
    $("#btnBillingPortal")?.addEventListener("click", async ()=>{
      try{
        const r = await fetch("/api/billing/portal",{ method:"POST", headers:{ "Content-Type":"application/json" }, body: "{}" }).then(r=>r.json());
        if (r?.url) location.href = r.url; else alert(r?.error?.message || "No billing portal");
      }catch(e){ alert("Unable to open billing portal"); }
    });
    async function updateBillingBadge(){
      try{
        const s = await fetch("/api/billing/status").then(r=>r.json());
        const el = $("#billingPlanBadge");
        if (el){ el.textContent = s?.plan ? `Your plan: ${s.plan.toUpperCase()} ${s.is_subscribed?'(active)':''}` : "Not signed in"; }
      }catch{}
    }

    /* ------------------------ PRESETS (save/list/delete/load) ------------------------ */
    function ensurePresetsButton(){
      if ($("#btnOpenPresets")) return;
      // Add a floating button if no preset button exists in your header
      const floater = document.createElement("button");
      floater.id = "btnOpenPresets";
      floater.className = "fixed bottom-3 left-3 z-40 btn btn-sm";
      floater.textContent = "Presets";
      document.body.appendChild(floater);
      floater.addEventListener("click", ()=> $("#presetsDrawer").classList.remove("hidden"));
    }
    ensurePresetsButton();
    $("#closePresets")?.addEventListener("click", ()=> $("#presetsDrawer").classList.add("hidden"));
    $("#btnOpenPresets")?.addEventListener("click", ()=> $("#presetsDrawer").classList.remove("hidden"));

    // Extract current generator settings safely (best-effort)
    function readCurrentSettings(){
      const o = {};
      o.channel      = $("#genChannel")?.value || $("#schedChannel")?.value || "linkedin";
      o.temperature  = Number($("#genTemp")?.value || 0.7);
      o.tone         = $("#genTone")?.value || "neutral";
      o.prompt       = $("#genInput")?.value || $("#batchInput")?.value || "";
      o.options = {
        linkedinArticle: !!$("#optLinkedInArticle")?.checked,
        humanize: !!$("#optHumanize")?.checked,
        addFaqs:  !!$("#optAddFaqs")?.checked,
        autoH2:   !!$("#optAutoH2")?.checked
      };
      return o;
    }
    async function refreshPresets(){
      const wrap = $("#presetsListWrap");
      if (!wrap) return;
      wrap.innerHTML = "Loading…";
      try{
        const r = await fetch("/api/presets/list").then(r=>r.json());
        const list = r?.presets || [];
        wrap.innerHTML = "";
        list.forEach(p=>{
          const row = document.createElement("div");
          row.className = "rounded-lg border p-3 flex items-center justify-between gap-2";
          row.innerHTML = `
            <div class="text-sm">
              <div class="font-medium">${p.title}</div>
              <div class="text-xs text-slate-500">${new Date(p.created_at||Date.now()).toLocaleString()}</div>
            </div>
            <div class="flex items-center gap-2">
              <button class="btn btn-xs" data-load="${p.id}">Load</button>
              <button class="btn btn-xs danger" data-del="${p.id}">Delete</button>
            </div>
          `;
          wrap.appendChild(row);
        });
        wrap.querySelectorAll("[data-del]").forEach(b=>{
          b.addEventListener("click", async ()=>{
            const id = b.getAttribute("data-del");
            b.disabled = true;
            await fetch("/api/presets/delete",{ method:"POST", headers:{'Content-Type':'application/json'}, body: JSON.stringify({ id }) });
            b.disabled = false;
            refreshPresets();
          });
        });
        wrap.querySelectorAll("[data-load]").forEach(b=>{
          b.addEventListener("click", async ()=>{
            const id = b.getAttribute("data-load");
            const r = await fetch("/api/presets/list").then(r=>r.json());
            const item = (r?.presets||[]).find(x=>x.id===id);
            if (!item) return;
            // Try to push back into generator inputs if present
            try{
              if ($("#genChannel")) $("#genChannel").value = item.data?.channel || "linkedin";
              if ($("#genTemp"))    $("#genTemp").value    = item.data?.temperature ?? 0.7;
              if ($("#genTone"))    $("#genTone").value    = item.data?.tone || "neutral";
              if ($("#genInput"))   $("#genInput").value   = item.data?.prompt || "";
              if ($("#optLinkedInArticle")) $("#optLinkedInArticle").checked = !!item.data?.options?.linkedinArticle;
              if ($("#optHumanize"))        $("#optHumanize").checked        = !!item.data?.options?.humanize;
              if ($("#optAddFaqs"))         $("#optAddFaqs").checked         = !!item.data?.options?.addFaqs;
              if ($("#optAutoH2"))          $("#optAutoH2").checked          = !!item.data?.options?.autoH2;
              show("view-generator");
            }catch{}
          });
        });
      }catch{
        if (wrap) wrap.innerHTML = `<div class="text-sm text-rose-500">Failed to load presets (sign in required).</div>`;
      }
    }
    $("#btnSavePreset")?.addEventListener("click", async ()=>{
      const title = $("#presetTitle").value.trim() || "Untitled";
      const data  = readCurrentSettings();
      const r = await fetch("/api/presets/save",{ method:"POST", headers:{'Content-Type':'application/json'}, body: JSON.stringify({ title, data }) }).then(r=>r.json());
      if (r?.id){ $("#presetTitle").value = ""; refreshPresets(); }
      else alert(r?.error?.message || "Could not save preset.");
    });
    // auto-load on open
    $("#presetsDrawer")?.addEventListener("transitionstart", refreshPresets);
    refreshPresets();

    /* ------------------------ TEMPLATE ACTIONS (Submit / Export) ------------------------ */
    // Helper: make Notion blocks from text (H2 lines become headings)
    function textToNotionBlocks(text){
      const lines = (text||"").split(/\r?\n/);
      const blocks=[];
      lines.forEach(l=>{
        if (/^##\s+/.test(l)) blocks.push({type:"heading", text:l.replace(/^##\s+/,"")});
        else blocks.push({type:"paragraph", text:l});
      });
      return blocks;
    }
    async function exportToNotion(text, title){
      const res = await fetch("/api/integrations/notion/export",{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ title: title || "ContentRepurpose Export", blocks: textToNotionBlocks(text) })
      }).then(r=>r.json());
      if (res?.url) window.open(res.url, "_blank","noopener");
      else alert(res?.error?.message || "Notion export failed (connect Notion in Integrations).");
    }
    async function exportToTrello(text, title){
      const listId = localStorage.getItem("crp:trello:list") || ""; // let user set elsewhere in your UI
      const boardId = localStorage.getItem("crp:trello:board") || "";
      const res = await fetch("/api/integrations/trello/export",{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ board_id: boardId, list_id: listId, title: title||"ContentRepurpose Draft", description: text })
      }).then(r=>r.json());
      if (res?.url) window.open(res.url, "_blank","noopener");
      else alert(res?.error?.message || "Trello export failed (connect Trello in Integrations).");
    }
    function downloadPack(filename, dataObj){
      const blob = new Blob([JSON.stringify(dataObj,null,2)], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = filename || "project-pack.json";
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    }
    function ensureActionsForCard(card){
      if (card.querySelector("[data-actions]")) return;
      const ta = card.querySelector("textarea");
      const title = card.getAttribute("data-title") || "Draft";
      const bar = document.createElement("div");
      bar.setAttribute("data-actions","1");
      bar.className = "mt-2 flex flex-wrap items-center gap-2";
      bar.innerHTML = `
        <button class="btn btn-xs" data-submit>Submit</button>
        <button class="btn btn-xs" data-notion>Export → Notion</button>
        <button class="btn btn-xs" data-trello>Export → Trello</button>
        <button class="btn btn-xs" data-copy>Copy</button>
        <button class="btn btn-xs" data-pack>Project Pack</button>
        <button class="btn btn-xs" data-quora>Open Quora</button>
        <button class="btn btn-xs" data-li-article>Make LinkedIn Article</button>
      `;
      card.appendChild(bar);

      bar.querySelector("[data-submit]").addEventListener("click",()=>{
        // Minimal “submit” → place into Scheduler text field or Selected queue
        const t = ta.value;
        const schedText = $("#schedText");
        if (schedText){ schedText.value = t; show("view-scheduler"); }
        // Track
        track("submit");
      });
      bar.querySelector("[data-copy]").addEventListener("click", async ()=>{
        try{ await navigator.clipboard.writeText(ta.value); }catch{}
      });
      bar.querySelector("[data-notion]").addEventListener("click", ()=> exportToNotion(ta.value, title));
      bar.querySelector("[data-trello]").addEventListener("click", ()=> exportToTrello(ta.value, title));
      bar.querySelector("[data-pack]").addEventListener("click", ()=>{
        downloadPack("project-pack.json", { title, content: ta.value, created_at: new Date().toISOString() });
      });
      bar.querySelector("[data-quora]").addEventListener("click", async ()=>{
        try{ await navigator.clipboard.writeText(ta.value); }catch{}
        window.open("https://www.quora.com/","_blank","noopener");
      });
      bar.querySelector("[data-li-article]").addEventListener("click", ()=> makeLinkedInArticleFrom(ta.value));
    }
    // Observe template cards created by Generator or Batch
    const observer = new MutationObserver(muts=>{
      muts.forEach(m=>{
        m.addedNodes.forEach(n=>{
          if (n.nodeType===1 && n.classList.contains("template-card")) ensureActionsForCard(n);
          // also nested
          $$(".template-card", n).forEach(ensureActionsForCard);
        });
      });
    });
    observer.observe(document.body,{ childList:true, subtree:true });

    /* ------------------------ LINKEDIN ARTICLE (Generator hook) ------------------------ */
    async function makeLinkedInArticleFrom(text){
      const sys = "You are a professional B2B content editor. Turn the user's material into a polished LinkedIn Article with a strong headline, 3-6 H2 sections, short paragraphs, bullet points where helpful, and a concise conclusion. Return as plain markdown.";
      const messages = [
        { role:"system", content: sys },
        { role:"user",   content: `Draft/article/notes:\n\n${text}` }
      ];
      const res = await fetch("/api/generate",{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ messages, temperature: 0.7, max_tokens: 1200 })
      }).then(r=>r.json());
      const out = res?.choices?.[0]?.message?.content || res?.error?.message || "Failed to generate article.";
      const grid = $("#templatesGrid") || $("#batchResults") || $("#optimizerOut") || document.body;
      const card = document.createElement("div");
      card.className = "template-card rounded-lg border p-3";
      card.setAttribute("data-title","LinkedIn Article");
      card.innerHTML = `
        <div class="text-sm text-slate-500 mb-2">LinkedIn Article</div>
        <textarea rows="16" class="w-full rounded-lg border bg-transparent p-3">${out.replace(/</g,"&lt;")}</textarea>
      `;
      grid.prepend(card);
      ensureActionsForCard(card);
      track("gen_linkedin_article");
    }

    // If generator has a checkbox “Also generate LinkedIn Article”
    $("#optLinkedInArticle")?.addEventListener("change", (e)=>{
      // No immediate action; generation flow in your Generator should call makeLinkedInArticleFrom after main output.
    });
    // Expose globally so your Generator can call it after main generate:
    window.makeLinkedInArticleFrom = makeLinkedInArticleFrom;

    /* ------------------------ OPTIMIZER CAP (15/day, Creator+) ------------------------ */
    function todayKey(){ return new Date().toISOString().slice(0,10); }
    function optKey(){ return `crp:opt:${todayKey()}:${App.userId||"anon"}`; }
    function getOptUsed(){ return Number(localStorage.getItem(optKey())||"0"); }
    function incOptUsed(){ const n=getOptUsed()+1; localStorage.setItem(optKey(), String(n)); return n; }
    function capForPlan(){
      const p = (App.plan||"free").toLowerCase();
      if (p==="creator" || p==="business") return 15;
      if (p==="starter") return 5;
      return 2; // demo/fallback
    }
    // If optimizer action buttons exist, guard them:
    function guardOptimizer(){
      const used = getOptUsed();
      const cap  = capForPlan();
      const btns = $$("#optimizer [data-opt-action], #optimizerCard [data-opt-action]");
      btns.forEach(b=>{
        b.disabled = used >= cap;
        if (used >= cap) b.setAttribute("title", `Daily optimizer limit reached (${cap}/day).`);
      });
      const badge = $("#optCapBadge");
      if (badge) badge.textContent = `${Math.min(used,cap)} / ${cap} used today`;
    }
    // Call this after each optimizer run:
    window._optimizerDidRun = function(){
      incOptUsed();
      guardOptimizer();
      track("optimizer");
    };
    // initial set
    guardOptimizer();

    /* ------------------------ SCHEDULER MULTI-PROFILE (final tie-in) ------------------------ */
    // If your Scheduler view has a mount #schedProfilesMulti (Part 7), it’s already hydrated.
    // On “Publish selected”, attach selected profiles to queue items (local, demo-friendly).
    $("#btnSchedQueuePublish")?.addEventListener("click", ()=>{
      try{
        const picks = window.MultiProfile?.getSelected?.() || [];
        const queueItems = $$("#schedQueue [data-item]");
        queueItems.forEach(q=>{
          q.setAttribute("data-profiles", JSON.stringify(picks));
        });
        alert("Queued with selected profiles.");
        track("schedule_publish");
      }catch{}
    });

    /* ------------------------ ANALYTICS PRO ------------------------ */
    const STAT_KEYS = ["generated","submit","optimizer","gen_linkedin_article","schedule_publish","export_notion","export_trello"];
    function statKey(k){ return `crp:stat:${k}:${App.userId||"anon"}`; }
    function track(k){
      if (!STAT_KEYS.includes(k)) return;
      const n = Number(localStorage.getItem(statKey(k))||"0")+1;
      localStorage.setItem(statKey(k), String(n));
      if (k==="export_notion"||k==="export_trello"||k==="schedule_publish") renderAnalytics();
    }
    window.ContentLog = { log: track }; // used in Part 7 batch
    function renderAnalytics(){
      const el = $("#analyticsTable");
      if (!el) return;
      const rows = [
        ["Generated", Number(localStorage.getItem(statKey("generated"))||"0")],
        ["Optimizer runs", Number(localStorage.getItem(statKey("optimizer"))||"0")],
        ["LI Articles", Number(localStorage.getItem(statKey("gen_linkedin_article"))||"0")],
        ["Submissions (to Scheduler)", Number(localStorage.getItem(statKey("submit"))||"0")],
        ["Exports → Notion", Number(localStorage.getItem(statKey("export_notion"))||"0")],
        ["Exports → Trello", Number(localStorage.getItem(statKey("export_trello"))||"0")],
        ["Publish actions", Number(localStorage.getItem(statKey("schedule_publish"))||"0")]
      ];
      el.innerHTML = `
        <table class="w-full text-sm">
          <thead><tr class="text-left"><th class="py-1">Event</th><th class="py-1">Count</th></tr></thead>
          <tbody>
            ${rows.map(r=>`<tr><td class="py-1">${r[0]}</td><td class="py-1">${r[1]}</td></tr>`).join("")}
          </tbody>
        </table>`;
    }
    $("#btnRefreshGlobal")?.addEventListener("click", loadGlobal);
    async function loadGlobal(){
      try{
        const s = await fetch("/api/stats").then(r=>r.json());
        $("#analyticsGlobal").textContent = s?.today_count!=null ? `${s.today_count} free-pool generations today` : "—";
      }catch{ $("#analyticsGlobal").textContent = "Failed."; }
    }
    renderAnalytics(); loadGlobal();

    /* ------------------------ LITTLE POLISH ------------------------ */
    // If your generator finishes, call track("generated"). To be safe, auto-bind any “Generate” button:
    $$("#btnGenerate, [data-role='generate']").forEach(b=>{
      b.addEventListener("click", ()=> setTimeout(()=>track("generated"), 150));
    });

    // Hook Notion/Trello export buttons inside template cards to track analytics
    document.addEventListener("click",(e)=>{
      const t = e.target;
      if (!(t instanceof HTMLElement)) return;
      if (t.matches("[data-notion]")) track("export_notion");
      if (t.matches("[data-trello]")) track("export_trello");
    });

    // Restore last visited view if user navigates via back/forward
    window.addEventListener("popstate", ()=>{
      const last = localStorage.getItem("crp:lastView") || "view-generator";
      show(last);
    });

    // Start
    hydrateAuth();
  })();
  </script>

  <!-- (Optional) Tiny fallback styles if some utilities weren’t defined earlier -->
  <style>
    .btn{padding:.5rem .75rem;border-radius:.6rem;border:1px solid #2b3445;background:#0f172a;color:#e7ecf6}
    .btn:hover{filter:brightness(1.1)}
    .btn-xs{padding:.25rem .5rem;font-size:.75rem}
    .btn-sm{padding:.375rem .6rem;font-size:.85rem}
    .btn-primary{background:#2563eb;border-color:#1e40af}
    .danger{background:#9f1239;border-color:#7f0f2f}
    .badge{font-size:.7rem;padding:.15rem .45rem;border-radius:.5rem;border:1px solid #334155}
    .card{background:#0b0e17;border:1px solid #1e293b;border-radius:1rem}
  </style>
</body>
</html>
