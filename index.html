<!doctype html>
<html lang="en" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ContentRepurpose.pro — AI Content Repurposing Tool & Generator</title>
  <meta name="description" content="Repurpose content with AI. LinkedIn, X, Email, Instagram, Reddit, Facebook, Quora, TikTok — plus LinkedIn Article & Article Optimizer. Export to Notion & Trello. BYOK supported." />
  <link rel="canonical" href="https://contentrepurpose.pro/">
  <meta name="theme-color" content="#0a0d18"><meta name="color-scheme" content="dark light">
  <meta name="robots" content="index,follow,max-video-preview:-1,max-image-preview:large,max-snippet:-1">
  <meta property="og:type" content="website"><meta property="og:title" content="ContentRepurpose.pro — AI Content Repurposing Tool">
  <meta property="og:description" content="Turn one idea into everywhere content. Multi-channel drafts + Article Optimizer. Export to Notion & Trello. BYOK supported.">
  <meta property="og:url" content="https://contentrepurpose.pro/"><meta property="og:image" content="/og-cover.png">
  <meta name="twitter:card" content="summary_large_image"><meta name="twitter:title" content="ContentRepurpose.pro — AI Content Generator">
  <meta name="twitter:description" content="Repurpose content with AI across LinkedIn, X, Email, Instagram, Reddit, Facebook, Quora, TikTok. Export to Notion & Trello."><meta name="twitter:image" content="/og-cover.png">

  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Supabase UMD (no ESM/module issues on iOS Safari) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js" defer></script>

  <style>
    :root{ --brandA:#7AA2FF; --brandB:#FF2D2D; --ink:#0a0d18 }
    html,body{font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .txt-grad{background:linear-gradient(135deg,var(--brandA),var(--brandB));-webkit-background-clip:text;background-clip:text;color:transparent}
    .bg-grad{background:linear-gradient(135deg,var(--brandA),var(--brandB))}
    .card{border-radius:1.25rem;border:1px solid rgba(15,23,42,.10);background:rgba(255,255,255,.80);box-shadow:0 12px 40px rgba(2,6,23,.08)}
    .badge{display:inline-flex;align-items:center;gap:.5rem;padding:.35rem .6rem;border-radius:9999px;border:1px solid rgba(255,255,255,.15);font-size:.75rem;background:rgba(255,255,255,.65)}
    .chip{font-size:.7rem;padding:.2rem .5rem;border-radius:9999px;border:1px solid rgba(148,163,184,.35)}
    .btn{padding:.65rem .95rem;border-radius:.9rem;border:1px solid rgba(148,163,184,.35)}
    .btn-primary{background:black;color:white}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    @media (prefers-color-scheme:dark){
      body{background:var(--ink);color:#e9eef6}
      .card{background:rgba(14,16,22,.6);border-color:rgba(255,255,255,.08);box-shadow:0 24px 96px rgba(122,162,255,.08),0 14px 60px rgba(255,45,45,.06)}
      .badge{background:rgba(255,255,255,.06);border-color:rgba(255,255,255,.12)}
    }
    :focus-visible{ outline:2px solid var(--brandA); outline-offset:2px }

    .only-guest{display:revert}.only-authed{display:none}
    .plan-starter-plus{display:none}.plan-creator-plus{display:none}.plan-business-only{display:none}
    body[data-auth="authed"] .only-guest{display:none} body[data-auth="authed"] .only-authed{display:revert}
    body[data-plan="starter"] .plan-starter-plus,
    body[data-plan="creator"] .plan-starter-plus,
    body[data-plan="business"] .plan-starter-plus{display:revert}
    body[data-plan="creator"] .plan-creator-plus,
    body[data-plan="business"] .plan-creator-plus{display:revert}
    body[data-plan="business"] .plan-business-only{display:revert}

    /* Auth sheet (custom, not <dialog>) */
    .sheet{position:fixed; inset:0; display:none; z-index:60; background:rgba(0,0,0,.5); backdrop-filter:blur(6px)}
    .sheet.open{display:block}
    .panel{position:absolute; left:50%; top:8%; transform:translateX(-50%); width:min(92vw,480px);
      border-radius:16px; border:1px solid rgba(255,255,255,.12); background:rgba(14,16,22,.98); color:#fff; padding:16px}
    .touch-target{min-height:40px; min-width:40px}
  </style>

  <script>
    /* Worker base, site and stripe price ids */
    window.WORKER_BASE = "https://contentflow-worker.frank-couchman.workers.dev";
    window.SITE_ORIGIN = "https://contentrepurpose.pro";
    window.PRICE_IDS = {
      starter:  "price_1S7y58JYjIKHzKcjzL7cIKiB",
      creator:  "price_1S7y77JYjIKHzKcjKQYjiqZH",
      business: "price_1S7y8OJYjIKHzKcjqA9uJdyh"
    };
  </script>
</head>
<body class="min-h-full" data-auth="guest" data-plan="free">
  <header class="sticky top-0 z-40 backdrop-blur bg-white/60 dark:bg-black/20 border-b border-white/30">
    <div class="max-w-7xl mx-auto px-4 md:px-5 py-4 flex items-center justify-between">
      <a href="/" class="flex items-center gap-3" aria-label="ContentRepurpose home">
        <svg width="36" height="36" viewBox="0 0 48 48" class="rounded-xl" aria-hidden="true">
          <defs><linearGradient id="g" x1="0" y="0" x2="1" y1="0" y2="1"><stop offset="0%" stop-color="#7AA2FF"/><stop offset="100%" stop-color="#FF2D2D"/></linearGradient></defs>
          <rect x="0" y="0" width="48" height="48" rx="12" fill="url(#g)"/><path d="M14 16h10a6 6 0 0 1 0 12H20v4h-6V16zm6 6v4h4a2 2 0 1 0 0-4h-4z" fill="white"/><path d="M28 16h6v16h-6z" fill="white" opacity=".9"/>
        </svg>
        <span class="font-semibold tracking-tight">Content<span class="txt-grad">Repurpose</span></span>
      </a>

      <nav class="hidden md:flex items-center gap-6 text-sm">
        <a href="#demo" class="hover:opacity-80">Generator</a>
        <a href="#optimizer" class="hover:opacity-80">Article Optimizer</a>
        <a href="#integrations" class="hover:opacity-80">Integrations</a>
        <a href="#pricing" class="hover:opacity-80">Pricing</a>

        <span id="planbadge" class="px-3 py-1 rounded-full text-xs bg-white/70 dark:bg-white/10 border border-white/50">Plan: Free</span>
        <button id="manageBilling" class="px-3 py-1 rounded-lg border hidden">Manage billing</button>
        <div class="flex items-center gap-2">
          <button id="loginBtn"  class="px-3 py-1 rounded-lg border only-guest">Sign in</button>
          <button id="logoutBtn" class="px-3 py-1 rounded-lg border only-authed hidden">Sign out</button>
        </div>
      </nav>

      <button id="navToggle" class="md:hidden touch-target px-3 py-2 rounded-lg border" aria-expanded="false" aria-controls="mobileNav" aria-label="Open menu">☰</button>
    </div>

    <!-- Mobile sheet -->
    <div id="mobileNav" class="sheet" aria-hidden="true">
      <div class="panel text-sm">
        <div class="flex items-center justify-between">
          <span class="font-semibold">Menu</span>
          <button id="navClose" class="touch-target px-3 py-2 rounded-lg border border-white/20" aria-label="Close menu">✕</button>
        </div>
        <nav class="mt-4 grid gap-2">
          <a href="#demo" class="px-3 py-2 rounded-lg hover:bg-white/10">Generator</a>
          <a href="#optimizer" class="px-3 py-2 rounded-lg hover:bg-white/10">Article Optimizer</a>
          <a href="#integrations" class="px-3 py-2 rounded-lg hover:bg-white/10">Integrations</a>
          <a href="#pricing" class="px-3 py-2 rounded-lg hover:bg-white/10">Pricing</a>
        </nav>
        <div class="mt-6 grid gap-2">
          <span id="planbadge_m" class="px-3 py-1 rounded-full text-xs bg-white/10 border border-white/20 w-fit">Plan: Free</span>
          <button id="manageBilling_m" class="px-3 py-2 rounded-lg border border-white/20 hidden">Manage billing</button>
          <button id="loginBtn_m" class="px-3 py-2 rounded-lg border border-white/20 only-guest">Sign in</button>
          <button id="logoutBtn_m" class="px-3 py-2 rounded-lg border border-white/20 only-authed hidden">Sign out</button>
        </div>
      </div>
    </div>
  </header>

  <main>
    <!-- Sign-in sheet -->
    <div id="authSheet" class="sheet" role="dialog" aria-modal="true" aria-labelledby="authTitle" aria-hidden="true">
      <div class="panel">
        <div class="flex items-center justify-between">
          <h3 id="authTitle" class="text-lg font-semibold">Sign in</h3>
          <button id="authClose" class="btn" type="button">Close</button>
        </div>
        <p class="mt-1 text-sm text-slate-300">Use Google or get a magic link.</p>
        <div class="mt-3 grid gap-3">
          <label class="grid gap-1">
            <span class="text-xs text-slate-400">Email</span>
            <input id="authEmail" type="email" inputmode="email" autocomplete="email" placeholder="you@domain.com" class="border rounded-lg px-3 py-2 bg-white/10 placeholder-slate-400 w-full">
          </label>
          <div class="grid grid-cols-2 gap-2">
            <button id="authSend"   class="btn btn-primary" type="button">Send magic link</button>
            <button id="authGoogle" class="btn" type="button">Continue with Google</button>
          </div>
          <p id="authNote" class="text-xs text-slate-400">We’ll never share your email.</p>
        </div>
      </div>
    </div>

    <!-- Generator -->
    <section id="demo" class="relative scroll-mt-24">
      <div class="max-w-7xl mx-auto px-4 md:px-5 py-10 md:py-14">
        <div class="flex items-end justify-between gap-4 mb-4">
          <div>
            <h2 class="text-2xl md:text-3xl font-black tracking-tight">Generator</h2>
            <p class="mt-1 text-slate-500 dark:text-slate-300 text-sm only-guest">
              No login needed — <span class="font-semibold">5 runs / month</span> (demo).
            </p>
            <p class="mt-1 text-slate-500 dark:text-slate-300 text-sm only-authed hidden">
              Free plan: <span class="chip">5 / day</span> • upgrade for higher caps.
            </p>
          </div>
          <div class="flex items-center gap-3">
            <a href="#pricing" class="btn">See pricing</a>
            <button class="btn btn-primary only-guest js-open-auth" type="button">Sign in</button>
          </div>
        </div>

        <div class="card p-5 md:p-6">
          <form id="demoForm" class="grid gap-5" autocomplete="off">
            <label class="grid gap-1">
              <span class="text-sm font-semibold">Source</span>
              <textarea id="sourceText" class="w-full rounded-xl border p-4 min-h-[140px] touch-target" placeholder="Paste a paragraph, an article, or a URL…"></textarea>
            </label>

            <fieldset>
              <legend class="text-sm font-semibold">Channels</legend>
              <div class="mt-2 grid sm:grid-cols-2 lg:grid-cols-4 gap-2">
                <label class="flex items-center gap-2"><input type="checkbox" name="ch_linkedin" checked> LinkedIn</label>
                <label class="flex items-center gap-2"><input type="checkbox" name="ch_x" checked> X (Twitter)</label>
                <label class="flex items-center gap-2"><input type="checkbox" name="ch_email" checked> Email</label>
                <label class="flex items-center gap-2"><input type="checkbox" name="ch_instagram"> Instagram</label>
                <label class="flex items-center gap-2"><input type="checkbox" name="ch_reddit" checked> Reddit</label>
                <label class="flex items-center gap-2"><input type="checkbox" name="ch_facebook"> Facebook</label>
                <label class="flex items-center gap-2"><input type="checkbox" name="ch_quora"> Quora</label>
                <label class="flex items-center gap-2"><input type="checkbox" name="ch_tiktok"> TikTok</label>
              </div>
            </fieldset>

            <div class="flex flex-wrap items-center gap-3">
              <button id="generateBtn_guest"   type="button" class="px-4 py-3 rounded-xl font-semibold text-white bg-black hover:opacity-90 only-guest">Generate (demo)</button>
              <button id="generateBtn_member"  type="button" class="px-4 py-3 rounded-xl font-semibold text-white bg-black hover:opacity-90 only-authed hidden">Generate</button>
              <button id="clearBtn"            type="button" class="px-4 py-3 rounded-xl font-semibold border">Clear</button>
              <div class="text-sm text-slate-500 only-guest">You have <span id="demoQuota">—</span> runs left this month.</div>
              <div class="text-sm text-slate-500 only-authed hidden">You have <span id="memberQuota">—</span> runs left today.</div>
              <a href="#pricing" class="text-sm underline hover:opacity-80 ml-auto">Need more? See plans</a>
            </div>
          </form>
        </div>

        <div id="demoOutput" class="mt-6 grid gap-6" aria-live="polite" aria-busy="false"></div>
      </div>
    </section>

    <!-- Optimizer -->
    <section id="optimizer" class="relative scroll-mt-24">
      <div class="max-w-7xl mx-auto px-4 md:px-5 pb-12">
        <div class="flex items-end justify-between gap-4 mb-4">
          <div>
            <h2 class="text-2xl md:text-3xl font-black tracking-tight">Article Optimizer</h2>
            <p class="mt-1 text-slate-500 dark:text-slate-300 text-sm">Paste HTML or Markdown. We'll return improved HTML + SEO assets.</p>
          </div>
          <div class="flex items-center gap-3">
            <a href="#pricing" class="btn">See pricing</a>
            <button class="btn btn-primary js-open-auth only-guest" type="button">Sign in</button>
          </div>
        </div>

        <div class="card p-5 md:p-6">
          <form id="optForm" class="grid gap-5" autocomplete="off">
            <label class="grid gap-1">
              <span class="text-sm font-semibold">Paste HTML or Markdown</span>
              <textarea id="optSource" class="w-full rounded-xl border p-4 min-h-[140px] touch-target" placeholder="Paste article here…"></textarea>
            </label>
            <div class="flex items-center gap-3">
              <button id="optRun"   class="btn btn-primary" type="button">Optimize</button>
              <button id="optClear" class="btn" type="button">Clear</button>
            </div>
          </form>
        </div>

        <div id="optOutput" class="mt-6 grid gap-6" aria-live="polite" aria-busy="false"></div>
      </div>
    </section>

    <!-- Integrations -->
    <section id="integrations" class="relative scroll-mt-24">
      <div class="max-w-7xl mx-auto px-4 md:px-5 pb-16">
        <h2 class="text-2xl md:text-3xl font-black tracking-tight">Integrations</h2>
        <p class="mt-1 text-slate-500 dark:text-slate-300 text-sm">Export drafts to Notion & Trello.</p>
        <div class="grid md:grid-cols-2 gap-6 mt-6">
          <div class="card p-5">
            <div class="flex items-center justify-between">
              <strong>Notion</strong>
              <div class="flex gap-2">
                <span id="notionStatus" class="chip">status: —</span>
                <button id="connectNotion" class="btn">Connect</button>
                <button id="disconnectNotion" class="btn">Disconnect</button>
              </div>
            </div>
          </div>
          <div class="card p-5">
            <div class="flex items-center justify-between">
              <strong>Trello</strong>
              <div class="flex gap-2">
                <span id="trelloStatus" class="chip">status: —</span>
                <button id="connectTrello" class="btn">Connect</button>
                <button id="disconnectTrello" class="btn">Disconnect</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Pricing (short) -->
    <section id="pricing" class="relative scroll-mt-24">
      <div class="max-w-7xl mx-auto px-4 md:px-5 pb-20">
        <h2 class="text-2xl md:text-3xl font-black tracking-tight">Pricing</h2>
        <div class="grid lg:grid-cols-4 gap-6 mt-6">
          <div class="card p-5"><strong>Free</strong><p class="mt-2 text-sm">Generator: 5/day (signed-in) or 5/month (guest). Optimizer: 1/day.</p></div>
          <div class="card p-5 border-2 border-emerald-300/40">
            <div class="flex items-center justify-between"><strong>Starter</strong><span class="badge">Most popular</span></div>
            <div class="mt-2 text-3xl font-black">$9 <span class="text-sm font-semibold text-slate-500">/ mo</span></div>
            <button class="btn btn-primary mt-4 js-checkout" data-plan="starter" type="button">Choose Starter</button>
          </div>
          <div class="card p-5">
            <strong>Creator</strong>
            <div class="mt-2 text-3xl font-black">$19 <span class="text-sm font-semibold text-slate-500">/ mo</span></div>
            <button class="btn btn-primary mt-4 js-checkout" data-plan="creator" type="button">Choose Creator</button>
          </div>
          <div class="card p-5">
            <strong>Business</strong>
            <div class="mt-2 text-3xl font-black">$49 <span class="text-sm font-semibold text-slate-500">/ mo</span></div>
            <button class="btn btn-primary mt-4 js-checkout" data-plan="business" type="button">Choose Business</button>
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer class="mt-10 border-t">
    <div class="max-w-7xl mx-auto px-4 md:px-5 py-10 text-sm flex flex-wrap items-center justify-between gap-3">
      <div class="opacity-80">© <span id="year">2025</span> ContentRepurpose.pro</div>
      <nav class="flex items-center gap-4 opacity-80">
        <a href="#pricing" class="hover:opacity-100">Pricing</a>
        <a href="#integrations" class="hover:opacity-100">Integrations</a>
        <a href="mailto:hello@contentrepurpose.pro" class="hover:opacity-100">Contact</a>
      </nav>
    </div>
  </footer>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-4 left-1/2 -translate-x-1/2 hidden">
    <div class="px-4 py-2 rounded-lg bg-black text-white text-sm shadow">
      <span id="toastMsg">…</span>
    </div>
  </div>

  <!-- App script (no module) -->
  <script>
  (function(){
    const $  = (s, el=document)=> el.querySelector(s);
    const $$ = (s, el=document)=> Array.from(el.querySelectorAll(s));
    const byId = (id)=> document.getElementById(id);
    const toast = (msg)=>{ const t=byId("toast"), m=byId("toastMsg"); if(!t||!m) return alert(msg); m.textContent=msg; t.classList.remove("hidden"); setTimeout(()=>t.classList.add("hidden"),2200); };
    const cap = (s)=> (s||"").slice(0,1).toUpperCase()+(s||"").slice(1);

    const WORKER_BASE = window.WORKER_BASE || location.origin;
    const SITE_ORIGIN = window.SITE_ORIGIN || location.origin;

    /* ---------- Supabase ---------- */
    const SUPABASE_URL  = "https://ynkoavaeadlzlwylmfmu.supabase.co";
    const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlua29hdmFlYWRsemx3eWxtZm11Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5OTAxNDgsImV4cCI6MjA3MzU2NjE0OH0.1yM5yDo0MI9Upzt4GkLyf1mqvDXfb3DXvC0ouOLtRoU";
    let supabase=null, AUTHTED=false, USER_ID=null, CURRENT_PLAN="free";

    function setAuthFlag(on){ AUTHTED=!!on; document.body.setAttribute("data-auth", on? "authed":"guest"); }
    function setPlan(plan){
      const p=["free","starter","creator","business"].includes((plan||"").toLowerCase())? plan.toLowerCase() : "free";
      CURRENT_PLAN=p; document.body.setAttribute("data-plan", p);
      const label=`Plan: ${cap(p)}`;
      byId("planbadge")&&(byId("planbadge").textContent=label);
      byId("planbadge_m")&&(byId("planbadge_m").textContent=label);
      ["manageBilling","manageBilling_m"].forEach(id=> byId(id)?.classList.toggle("hidden", !AUTHTED));
      byId("generateBtn_guest")?.classList.toggle("hidden", AUTHTED);
      byId("generateBtn_member")?.classList.toggle("hidden", !AUTHTED);
    }
    function paintGuestUi(){ $$(".only-guest").forEach(el=> el.classList.remove("hidden")); $$(".only-authed").forEach(el=> el.classList.add("hidden")); }
    function paintAuthedUi(){ $$(".only-guest").forEach(el=> el.classList.add("hidden")); $$(".only-authed").forEach(el=> el.classList.remove("hidden")); }

    async function createSupabase(){
      await new Promise(r=>{ if(window.supabase) r(); else window.addEventListener("load", r, {once:true}); });
      supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON, {
        auth:{ persistSession:true, autoRefreshToken:true, detectSessionInUrl:true }
      });
    }
    async function finishOAuthAndCleanUrl(){
      try{
        const u=new URL(location.href);
        const code=u.searchParams.get("code");
        if(code){
          const { error } = await supabase.auth.exchangeCodeForSession({ code });
          if(error) toast(error.message||"Sign-in error");
          ["code","state","scope","provider_id","redirected_from"].forEach(p=>u.searchParams.delete(p));
          history.replaceState({}, "", u.toString());
        }
      }catch{}
    }
    async function getAuthHeaders(extra={}){
      const h={ "Content-Type":"application/json", ...extra };
      try{
        const { data } = await supabase.auth.getSession();
        const tok=data?.session?.access_token; const uid=data?.session?.user?.id;
        if(tok) h["Authorization"] = `Bearer ${tok}`;
        if(uid) h["X-User-Id"] = uid;
      }catch{}
      return h;
    }

    /* ---------- Nav & Auth Sheet ---------- */
    function openSheet(id){ const s=byId(id); if(!s) return; s.classList.add("open"); s.setAttribute("aria-hidden","false"); }
    function closeSheet(id){ const s=byId(id); if(!s) return; s.classList.remove("open"); s.setAttribute("aria-hidden","true"); }

    function wireNav(){
      const toggle=byId("navToggle"), sheet=byId("mobileNav"), close=byId("navClose");
      toggle&&toggle.addEventListener("click",()=>{ sheet.classList.add("open"); toggle.setAttribute("aria-expanded","true"); });
      close&&close.addEventListener("click",()=>{ sheet.classList.remove("open"); toggle.setAttribute("aria-expanded","false"); });
      sheet&&sheet.addEventListener("click",(e)=>{ if(e.target===sheet) sheet.classList.remove("open"); });

      $$('a[href^="#"]').forEach(a=> a.addEventListener("click",(e)=>{
        const id=a.getAttribute("href"); if(!id||id==="#") return;
        const el=document.querySelector(id); if(el){ e.preventDefault(); el.scrollIntoView({behavior:"smooth", block:"start"}); sheet?.classList.remove("open"); history.replaceState(null,"",id); }
      }));
    }
    function wireAuthUi(){
      const open=()=> openSheet("authSheet");
      const close=()=> closeSheet("authSheet");
      ["loginBtn","loginBtn_m"].forEach(id=> byId(id)?.addEventListener("click", open));
      $$(".js-open-auth").forEach(b=> b.addEventListener("click", open));
      byId("authClose")?.addEventListener("click", close);
      byId("authSheet")?.addEventListener("click",(e)=>{ if(e.target===byId("authSheet")) close(); });

      byId("authGoogle")?.addEventListener("click", async ()=>{
        try{ await supabase.auth.signInWithOAuth({ provider:"google", options:{ redirectTo: SITE_ORIGIN } }); }
        catch(e){ toast(e?.message||"Google sign-in failed"); }
      });
      byId("authSend")?.addEventListener("click", async ()=>{
        const email=byId("authEmail")?.value?.trim(); if(!email) return toast("Enter your email");
        try{
          const { error } = await supabase.auth.signInWithOtp({ email, options:{ emailRedirectTo: SITE_ORIGIN } });
          if(error) throw error; toast("Magic link sent ✅"); close();
        }catch(e){ toast(e?.message||"Sign-in error"); }
      });
      ["logoutBtn","logoutBtn_m"].forEach(id=> byId(id)?.addEventListener("click", async ()=>{ try{ await supabase.auth.signOut(); toast("Signed out"); }catch{} }));
    }

    /* ---------- Status & quotas ---------- */
    async function fetchStatus(){
      try{
        const r=await fetch(`${WORKER_BASE}/api/billing/status`, { headers: await getAuthHeaders() });
        const j=await r.json();
        const authed=j.scope==="user";
        setAuthFlag(authed); USER_ID = authed? (j.userId||null) : null; setPlan((j.plan||"free").toLowerCase());
        if(!authed){
          byId("demoQuota")&&(byId("demoQuota").textContent=String(Math.max(0, (j?.freepool_remaining ?? 1000) >= 0 ? 5 - (j?.platform?.monthly?.used||0) : 0)));
          paintGuestUi();
        } else {
          const cap=j.platform?.daily?.cap; const used=j.platform?.daily?.used ?? 0;
          byId("memberQuota")&&(byId("memberQuota").textContent=(cap==null? "∞" : Math.max(0,cap-used)));
          paintAuthedUi();
        }
        byId("notionStatus")&&(byId("notionStatus").textContent=`status: ${j?.integrations?.notion? "connected":"—"}`);
        byId("trelloStatus")&&(byId("trelloStatus").textContent=`status: ${j?.integrations?.trello? "connected":"—"}`);
      }catch{
        setAuthFlag(false); setPlan("free"); paintGuestUi();
      }
    }

    /* ---------- Generator ---------- */
    const parseJsonLoose = (txt)=>{ if(!txt) return null; let s=String(txt).trim();
      s=s.replace(/^```(?:json)?/i,"").replace(/```$/i,"").trim(); const a=s.indexOf("{"), b=s.lastIndexOf("}"); if(a>=0&&b>a) s=s.slice(a,b+1);
      try{ return JSON.parse(s);}catch{} s=s.replace(/,\s*([}\]])/g,"$1"); try{ return JSON.parse(s);}catch{} return null; };

    function readToggles(){
      const form=byId("demoForm");
      const g=(n)=> form.elements[n];
      return {
        ch:{
          linkedin:g?.("ch_linkedin")?.checked, x:g?.("ch_x")?.checked, email:g?.("ch_email")?.checked,
          instagram:g?.("ch_instagram")?.checked, reddit:g?.("ch_reddit")?.checked, facebook:g?.("ch_facebook")?.checked, quora:g?.("ch_quora")?.checked, tiktok:g?.("ch_tiktok")?.checked
        }
      };
    }
    function systemPrompt(tog){ return { role:"system", content:
`You are a senior social copywriter.
Return ONLY valid JSON with this shape:
{
  "outline": string,
  "linkedin": string|null,
  "x": string[]|null,
  "email": { "subject": string, "body": string }|null,
  "instagram": { "caption": string, "hashtags": string[] }|null,
  "reddit": { "title": string, "body": string }|null,
  "facebook": { "primary": string }|null,
  "quora": { "answer": string }|null,
  "tiktok": { "script": string }|null
}
No prose outside the JSON.` }; }
    function userPrompt(raw, tog){
      const channels = Object.entries(tog.ch).filter(([,v])=>v).map(([k])=>k).join(", ");
      return { role:"user", content:
`Source:
${raw}

Task:
1) Create a one-line outline.
2) Generate content ONLY for these channels: ${channels||"linkedin,x,email"}.`};
    }
    function addCard(wrap, title, text){
      const id=`card_${Math.random().toString(36).slice(2,8)}`;
      wrap.insertAdjacentHTML("beforeend", `
        <div class="card p-5" id="${id}">
          <div class="flex justify-between items-center gap-2 flex-wrap">
            <strong class="tracking-tight">${title}</strong>
            <div class="flex gap-2">
              <button class="btn copy" type="button">Copy</button>
              <button class="btn" type="button" data-publish>Publish</button>
            </div>
          </div>
          <pre class="whitespace-pre-wrap text-sm mt-3 content">${text}</pre>
        </div>`);
      const el=byId(id);
      $(".btn.copy", el)?.addEventListener("click", async ()=>{
        try{ await navigator.clipboard.writeText($(".content",el)?.innerText||""); toast("Copied ✅"); }catch{ toast("Copy failed"); }
      });
      $("[data-publish]", el)?.addEventListener("click", async ()=>{
        const txt=$(".content",el)?.innerText||""; if(!txt) return toast("Nothing to publish");
        try{
          const r=await fetch(`${WORKER_BASE}/api/publish/quick`, { method:"POST", headers: await getAuthHeaders(), body: JSON.stringify({ text: txt }) });
          const j=await r.json(); if(!r.ok) throw new Error(j?.error?.message||"Publish failed");
          toast("Published / queued ✅");
        }catch(e){ toast(e.message||"Publish failed"); }
      });
    }
    function paintOutput(obj){
      const wrap=byId("demoOutput"); wrap.innerHTML="";
      if(obj.linkedin) addCard(wrap, "LinkedIn", obj.linkedin);
      if(Array.isArray(obj.x)&&obj.x.length) addCard(wrap, "X (Twitter)", obj.x.map((t,i)=>`Post ${i+1}: ${t}`).join("\n\n"));
      if(obj.email) addCard(wrap, "Email", `Subject: ${obj.email.subject||""}\n\n${obj.email.body||""}`);
      if(obj.instagram) addCard(wrap, "Instagram", `${obj.instagram.caption||""}\n\n${(obj.instagram.hashtags||[]).map(h=>h.startsWith("#")?h:"#"+h).join(" ")}`);
      if(obj.reddit) addCard(wrap, "Reddit", `${obj.reddit.title||""}\n\n${obj.reddit.body||""}`);
      if(obj.facebook) addCard(wrap, "Facebook", obj.facebook.primary||"");
      if(obj.quora) addCard(wrap, "Quora", obj.quora.answer||"");
      if(obj.tiktok) addCard(wrap, "TikTok", obj.tiktok.script||"");
    }
    async function runGenerate(){
      const src=(byId("sourceText")?.value||"").trim(); if(!src) return toast("Paste some content first");
      const btn = AUTHTED? byId("generateBtn_member") : byId("generateBtn_guest");
      const old=btn.textContent; btn.disabled=true; btn.textContent="Generating…";
      try{
        const toggles=readToggles();
        const messages=[ systemPrompt(toggles), userPrompt(src, toggles) ];
        const lane = (!AUTHTED || CURRENT_PLAN==="free") ? "free" : "pro";
        const headers = await getAuthHeaders();
        const r=await fetch(`${WORKER_BASE}/api/generate`, {
          method:"POST", headers, body: JSON.stringify({ plan: lane, temperature:0.5, messages })
        });
        const data=await r.json(); if(!r.ok) throw new Error(data?.error?.message||"Generation failed");
        const content=data?.choices?.[0]?.message?.content||"";
        const j=parseJsonLoose(content); if(!j) throw new Error("Model did not return JSON");
        paintOutput(j); toast("Done ✅"); fetchStatus().catch(()=>{});
      }catch(e){ byId("demoOutput").innerHTML=`<div class="card p-5 text-sm text-red-500">Error: ${e.message||e}</div>`; }
      finally{ btn.disabled=false; btn.textContent=old; }
    }

    /* ---------- Optimizer ---------- */
    function paintOptOutput(obj){
      const wrap=byId("optOutput"); wrap.innerHTML="";
      const add=(title, content)=>{ wrap.insertAdjacentHTML("beforeend", `<div class="card p-5"><div class="flex justify-between items-center gap-2 flex-wrap"><strong class="tracking-tight">${title}</strong><button class="btn copy" type="button">Copy</button></div>${content}</div>`); const c=wrap.lastElementChild; $(".btn.copy",c)?.addEventListener("click", async ()=>{ try{ await navigator.clipboard.writeText(c.querySelector(".content")?.innerText||c.querySelector(".content")?.textContent||""); toast("Copied ✅"); }catch{ toast("Copy failed"); } }); };
      if(obj.title || obj.meta_description) add("Title & Meta", `<div class="text-xs text-slate-400">Title</div><pre class="whitespace-pre-wrap text-sm mt-1 content">${obj.title||""}</pre><div class="text-xs text-slate-400 mt-3">Meta</div><pre class="whitespace-pre-wrap text-sm mt-1">${obj.meta_description||""}</pre>`);
      if(obj.html) add("Improved Article (HTML)", `<pre class="whitespace-pre-wrap text-xs mt-3 content">${obj.html}</pre>`);
    }
    async function runOptimize(){
      const src=(byId("optSource")?.value||"").trim(); if(!src) return toast("Paste HTML or Markdown first");
      const btn=byId("optRun"); const old=btn.textContent; btn.disabled=true; btn.textContent="Optimizing…";
      try{
        const messages=[ {role:"system",content:
`You are an expert editor & SEO. Return ONLY valid JSON with:
{ "html": string, "title": string, "meta_description": string }
No text outside JSON.`}, {role:"user",content:`Source:\n${src}`} ];
        const lane = (!AUTHTED || CURRENT_PLAN==="free") ? "free" : "pro";
        const headers = await getAuthHeaders();
        const r=await fetch(`${WORKER_BASE}/api/optimize`, { method:"POST", headers, body: JSON.stringify({ plan: lane, temperature:0.4, messages }) });
        const j=await r.json(); if(!r.ok) throw new Error(j?.error?.message||"Optimize failed");
        const content=j?.choices?.[0]?.message?.content||""; const obj=parseJsonLoose(content); if(!obj) throw new Error("Model did not return JSON");
        paintOptOutput(obj); toast("Optimized ✅");
      }catch(e){ byId("optOutput").innerHTML=`<div class="card p-5 text-sm text-red-500">Error: ${e.message||e}</div>`; }
      finally{ btn.disabled=false; btn.textContent=old; }
    }

    /* ---------- Integrations ---------- */
    function wireIntegrations(){
      byId("connectNotion")?.addEventListener("click", async ()=>{
        try{
          const r=await fetch(`${WORKER_BASE}/api/integrations/notion/connect`, { method:"POST", headers: await getAuthHeaders(), body: JSON.stringify({ return_url: location.href }) });
          const j=await r.json(); if(!r.ok) throw new Error(j?.error?.message||"Notion connect failed");
          location.href=j.url;
        }catch(e){ toast(e.message||"Notion connect failed"); }
      });
      byId("disconnectNotion")?.addEventListener("click", async ()=>{
        try{
          const r=await fetch(`${WORKER_BASE}/api/integrations/notion/disconnect`, { method:"POST", headers: await getAuthHeaders() });
          const j=await r.json(); if(!r.ok) throw new Error(j?.error?.message||"Notion disconnect failed");
          toast("Notion disconnected"); fetchStatus();
        }catch(e){ toast(e.message||"Notion disconnect failed"); }
      });

      byId("connectTrello")?.addEventListener("click", async ()=>{
        try{
          const r=await fetch(`${WORKER_BASE}/api/integrations/trello/connect`, { method:"POST", headers: await getAuthHeaders(), body: JSON.stringify({ return_url: location.href }) });
          const j=await r.json(); if(!r.ok) throw new Error(j?.error?.message||"Trello connect failed");
          location.href=j.url;
        }catch(e){ toast(e.message||"Trello connect failed"); }
      });
      byId("disconnectTrello")?.addEventListener("click", async ()=>{
        try{
          const r=await fetch(`${WORKER_BASE}/api/integrations/trello/disconnect`, { method:"POST", headers: await getAuthHeaders() });
          const j=await r.json(); if(!r.ok) throw new Error(j?.error?.message||"Trello disconnect failed");
          toast("Trello disconnected"); fetchStatus();
        }catch(e){ toast(e.message||"Trello disconnect failed"); }
      });
    }

    /* ---------- Checkout ---------- */
    function wireCheckout(){
      $$(".js-checkout").forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          const plan=btn.getAttribute("data-plan")||"starter";
          const priceId=(window.PRICE_IDS||{})[plan];
          if(!priceId) return toast("Missing price id");
          try{
            btn.disabled=true; const old=btn.textContent; btn.textContent="Redirecting…";
            const r=await fetch(`${WORKER_BASE}/api/billing/checkout`, {
              method:"POST",
              headers: await getAuthHeaders(),
              body: JSON.stringify({
                price_id: priceId,
                mode: "subscription",
                success_url: location.origin + location.pathname + "?billing=success",
                cancel_url:  location.origin + location.pathname + "?billing=cancel"
              })
            });
            const j=await r.json();
            if(!r.ok) throw new Error(j?.error?.message||"Checkout failed");
            if(j?.url) location.href=j.url; else throw new Error("Missing checkout url");
            btn.textContent=old; btn.disabled=false;
          }catch(e){ toast(e.message||"Checkout error"); btn.disabled=false; }
        });
      });
      ["manageBilling","manageBilling_m"].forEach(id=>{
        const b=byId(id); if(!b) return;
        b.addEventListener("click", async ()=>{
          const old=b.textContent; b.disabled=true; b.textContent="Opening…";
          try{
            const r=await fetch(`${WORKER_BASE}/api/billing/portal`,{ method:"POST", headers: await getAuthHeaders(), body: JSON.stringify({ return_url: location.href }) });
            const j=await r.json(); if(!r.ok) throw new Error(j?.error?.message||"Portal error");
            location.href=j.url;
          }catch(e){ toast(e.message||"Portal error"); b.disabled=false; b.textContent=old; }
        });
      });
    }

    /* ---------- Boot ---------- */
    document.addEventListener("DOMContentLoaded", async ()=>{
      const y=byId("year"); y&&(y.textContent=new Date().getFullYear());
      wireNav(); wireAuthUi(); wireIntegrations(); wireCheckout();

      await createSupabase();
      await finishOAuthAndCleanUrl();
      supabase.auth.onAuthStateChange(()=>{ fetchStatus().catch(()=>{}); closeSheet("authSheet"); });

      byId("generateBtn_guest")?.addEventListener("click", runGenerate);
      byId("generateBtn_member")?.addEventListener("click", runGenerate);
      byId("clearBtn")?.addEventListener("click", ()=>{ byId("sourceText").value=""; byId("demoOutput").innerHTML=""; });
      byId("optRun")?.addEventListener("click", runOptimize);
      byId("optClear")?.addEventListener("click", ()=>{ byId("optSource").value=""; byId("optOutput").innerHTML=""; });

      // prevent accidental form submits -> reload
      byId("demoForm")?.addEventListener("submit",(e)=> e.preventDefault());
      byId("optForm")?.addEventListener("submit",(e)=> e.preventDefault());

      await fetchStatus();
    });
  })();
  </script>
</body>
</html>
